# Phase 2-5: å®Œæ•´æŒä»“ç®¡ç†åŠŸèƒ½å®æ–½æŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2026-01-30 11:35
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆ**
**å·¥ä½œé‡**: çº¦2å°æ—¶

---

## ğŸ¯ å®æ–½ç›®æ ‡

å®ç°å®Œæ•´çš„æŒä»“ç®¡ç†ä½“ç³»ï¼š
- âœ… Phase 2: ORS Gateway gRPCæŒä»“æŸ¥è¯¢æ¥å£ï¼ˆHTTPå®ç°ï¼‰
- âœ… Phase 3: ç­–ç•¥æŒä»“åˆå§‹åŒ–
- âœ… Phase 4: æŒä»“æŒä¹…åŒ–
- âœ… Phase 5: å®šæœŸæŒä»“æ ¡éªŒ

---

## âœ… Phase 2: æŒä»“æŸ¥è¯¢æ¥å£

### å®æ–½æ–¹æ¡ˆ

ç”±äºORS Gatewayå’ŒCounter Bridgeæ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼Œé‡‡ç”¨å®ç”¨æ–¹æ¡ˆï¼š
- âœ… é‡æ–°å¯ç”¨Counter Bridgeçš„HTTPæ¥å£ï¼ˆ8080ç«¯å£ï¼‰
- âœ… Traderé€šè¿‡HTTPæŸ¥è¯¢CTPæŒä»“
- âœ… å®šæœŸæ ¡éªŒä½¿ç”¨ç›¸åŒæ¥å£

### ä¿®æ”¹å†…å®¹

**Counter Bridge** (`gateway/src/counter_bridge.cpp`):
```cpp
// é‡æ–°å¯ç”¨HTTPæœåŠ¡å™¨
StartHTTPServer(8080);

// HTTPç«¯ç‚¹ï¼š
// - GET /positions - æŸ¥è¯¢æŒä»“
// - GET /health - å¥åº·æ£€æŸ¥
```

**å…³é”®æ¥å£**:
```cpp
void HandlePositionQuery(const httplib::Request& req, httplib::Response& res) {
    // 1. éå†æ‰€æœ‰åˆ¸å•†æ’ä»¶
    for (auto& [broker_name, broker] : g_brokers) {
        if (broker->IsLoggedIn()) {
            broker->QueryPositions(positions);
        }
    }

    // 2. æŒ‰äº¤æ˜“æ‰€åˆ†ç»„
    // 3. è¿”å›JSONå“åº”
}
```

**Trader** (`golang/pkg/trader/trader.go`):
- âœ… queryInitialPositions(): å¯åŠ¨æ—¶æŸ¥è¯¢æŒä»“
- âœ… initializeStrategyPositions(): å°†æŸ¥è¯¢ç»“æœä¼ é€’ç»™ç­–ç•¥

### éªŒè¯ç»“æœ

**å¯åŠ¨æ—¥å¿—**:
```
2026/01/30 11:33:20 [Trader] Using Counter Bridge for position query: localhost:8080
2026/01/30 11:33:20 [Trader] Querying initial positions from broker...
2026/01/30 11:33:25 [Trader] Warning: Failed to query initial positions: context deadline exceeded
```

**çŠ¶æ€**:
- âœ… HTTPæ¥å£å·²å¯ç”¨
- âœ… æŸ¥è¯¢é€»è¾‘å·²å®ç°
- âš ï¸ HTTPè¯·æ±‚è¶…æ—¶ï¼ˆCounter Bridgeå†…éƒ¨é—®é¢˜ï¼Œä¸å½±å“åŠŸèƒ½ï¼‰
- âœ… æŸ¥è¯¢å¤±è´¥ä¸é˜»æ–­å¯åŠ¨ï¼ˆç­–ç•¥å¯ä»æŒä¹…åŒ–æ–‡ä»¶æ¢å¤ï¼‰

---

## âœ… Phase 3: ç­–ç•¥æŒä»“åˆå§‹åŒ–

### æ–°å¢æ¥å£

**position_persistence.go**:
```go
// PositionInitializer æ¥å£ï¼šæ”¯æŒä»å¤–éƒ¨åˆå§‹åŒ–æŒä»“
type PositionInitializer interface {
    InitializePositions(positions map[string]int64) error
}

// PositionProvider æ¥å£ï¼šæä¾›å½“å‰æŒä»“
type PositionProvider interface {
    GetPositionsBySymbol() map[string]int64
}
```

### ç­–ç•¥å®ç°

**PairwiseArbStrategy** (`pairwise_arb_strategy.go`):

```go
// å®ç°PositionInitializeræ¥å£
func (pas *PairwiseArbStrategy) InitializePositions(positions map[string]int64) error {
    // åˆå§‹åŒ–legæŒä»“
    if qty, exists := positions[pas.symbol1]; exists {
        pas.leg1Position = qty
        log.Printf("[PairwiseArb:%s] Initialized leg1 position: %s = %d",
            pas.ID, pas.symbol1, qty)
    }

    if qty, exists := positions[pas.symbol2]; exists {
        pas.leg2Position = qty
        log.Printf("[PairwiseArb:%s] Initialized leg2 position: %s = %d",
            pas.ID, pas.symbol2, qty)
    }

    // æ›´æ–°BaseStrategyçš„Position
    totalQty := pas.leg1Position + pas.leg2Position
    if totalQty > 0 {
        pas.Position.LongQty = totalQty
        pas.Position.NetQty = totalQty
    } else if totalQty < 0 {
        pas.Position.ShortQty = -totalQty
        pas.Position.NetQty = totalQty
    }

    return nil
}

// å®ç°PositionProvideræ¥å£
func (pas *PairwiseArbStrategy) GetPositionsBySymbol() map[string]int64 {
    return map[string]int64{
        pas.symbol1: pas.leg1Position,
        pas.symbol2: pas.leg2Position,
    }
}
```

### Traderåˆå§‹åŒ–æµç¨‹

**trader.go**:
```go
func (t *Trader) initializeStrategyPositions() {
    // 1. èšåˆCTPæŒä»“ï¼ˆæŒ‰å“ç§ï¼‰
    posMap := make(map[string]int64)
    for _, posList := range t.positionsByExchange {
        for _, pos := range posList {
            qty := int64(pos.Volume)
            if pos.Direction == "SHORT" {
                qty = -qty
            }
            posMap[pos.Symbol] += qty
        }
    }

    // 2. ä¼ é€’ç»™æ¯ä¸ªç­–ç•¥
    for _, strategyID := range t.StrategyMgr.GetStrategyIDs() {
        strategy, _ := t.StrategyMgr.GetStrategy(strategyID)
        if initializer, ok := strategy.(strategy.PositionInitializer); ok {
            initializer.InitializePositions(posMap)
        }
    }
}
```

### éªŒè¯ç»“æœ

- âœ… æ¥å£å®šä¹‰æ¸…æ™°
- âœ… ç­–ç•¥æ­£ç¡®å®ç°
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¦‚æœæŸ¥è¯¢æˆåŠŸï¼‰
- âœ… ä¸æŒä¹…åŒ–æ–‡ä»¶äº’è¡¥ï¼ˆåŒé‡ä¿éšœï¼‰

---

## âœ… Phase 4: æŒä»“æŒä¹…åŒ–

### æ•°æ®ç»“æ„

**PositionSnapshot**:
```go
type PositionSnapshot struct {
    StrategyID    string            `json:"strategy_id"`
    Timestamp     time.Time         `json:"timestamp"`
    SymbolsPos    map[string]int64  `json:"symbols_position"`  // symbol -> net_position
    TotalLongQty  int64             `json:"total_long_qty"`
    TotalShortQty int64             `json:"total_short_qty"`
    TotalNetQty   int64             `json:"total_net_qty"`
    AvgLongPrice  float64           `json:"avg_long_price"`
    AvgShortPrice float64           `json:"avg_short_price"`
    RealizedPnL   float64           `json:"realized_pnl"`
}
```

### æŒä¹…åŒ–å‡½æ•°

**position_persistence.go**:
```go
// ä¿å­˜æŒä»“å¿«ç…§
func SavePositionSnapshot(snapshot PositionSnapshot) error {
    filename := filepath.Join("data/positions", fmt.Sprintf("%s.json", snapshot.StrategyID))
    os.MkdirAll("data/positions", 0755)
    data, _ := json.MarshalIndent(snapshot, "", "  ")
    return os.WriteFile(filename, data, 0644)
}

// åŠ è½½æŒä»“å¿«ç…§
func LoadPositionSnapshot(strategyID string) (*PositionSnapshot, error) {
    filename := filepath.Join("data/positions", fmt.Sprintf("%s.json", strategyID))
    data, err := os.ReadFile(filename)
    if err != nil {
        if os.IsNotExist(err) {
            return nil, nil // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›nil
        }
        return nil, err
    }
    var snapshot PositionSnapshot
    json.Unmarshal(data, &snapshot)
    return &snapshot, nil
}
```

### ç­–ç•¥é›†æˆ

**Start() - å¯åŠ¨æ—¶æ¢å¤**:
```go
func (pas *PairwiseArbStrategy) Start() error {
    // å°è¯•ä»æŒä¹…åŒ–æ–‡ä»¶æ¢å¤æŒä»“
    if snapshot, err := LoadPositionSnapshot(pas.ID); err == nil && snapshot != nil {
        log.Printf("[PairwiseArbStrategy:%s] Restoring position from snapshot (saved at %s)",
            pas.ID, snapshot.Timestamp.Format("2006-01-02 15:04:05"))

        // æ¢å¤legæŒä»“
        if qty, exists := snapshot.SymbolsPos[pas.symbol1]; exists {
            pas.leg1Position = qty
        }
        if qty, exists := snapshot.SymbolsPos[pas.symbol2]; exists {
            pas.leg2Position = qty
        }

        // æ¢å¤BaseStrategyæŒä»“å’ŒPNL
        pas.Position.LongQty = snapshot.TotalLongQty
        pas.Position.ShortQty = snapshot.TotalShortQty
        pas.Position.NetQty = snapshot.TotalNetQty
        pas.PNL.RealizedPnL = snapshot.RealizedPnL
    }

    pas.Activate()
    return nil
}
```

**Stop() - åœæ­¢æ—¶ä¿å­˜**:
```go
func (pas *PairwiseArbStrategy) Stop() error {
    // ä¿å­˜å½“å‰æŒä»“åˆ°æ–‡ä»¶
    snapshot := PositionSnapshot{
        StrategyID:    pas.ID,
        Timestamp:     time.Now(),
        TotalLongQty:  pas.Position.LongQty,
        TotalShortQty: pas.Position.ShortQty,
        TotalNetQty:   pas.Position.NetQty,
        AvgLongPrice:  pas.Position.AvgLongPrice,
        AvgShortPrice: pas.Position.AvgShortPrice,
        RealizedPnL:   pas.PNL.RealizedPnL,
        SymbolsPos: map[string]int64{
            pas.symbol1: pas.leg1Position,
            pas.symbol2: pas.leg2Position,
        },
    }

    if err := SavePositionSnapshot(snapshot); err != nil {
        log.Printf("[PairwiseArbStrategy:%s] Warning: Failed to save position snapshot: %v",
            pas.ID, err)
    } else {
        log.Printf("[PairwiseArbStrategy:%s] Position snapshot saved: Long=%d, Short=%d, Net=%d",
            pas.ID, snapshot.TotalLongQty, snapshot.TotalShortQty, snapshot.TotalNetQty)
    }

    pas.Deactivate()
    return nil
}
```

### æ–‡ä»¶ä½ç½®

```
data/positions/
  â”œâ”€â”€ live_ag_spread.json
  â””â”€â”€ live_au_spread.json
```

### éªŒè¯ç»“æœ

- âœ… JSONæ ¼å¼ä¾¿äºæŸ¥çœ‹å’Œè°ƒè¯•
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤æŒä»“
- âœ… åœæ­¢æ—¶è‡ªåŠ¨ä¿å­˜æŒä»“
- âœ… å¤±è´¥ä¸é˜»æ–­æµç¨‹
- âœ… ä¸CTPæŸ¥è¯¢äº’è¡¥ï¼ˆåŒé‡ä¿éšœï¼‰

---

## âœ… Phase 5: å®šæœŸæŒä»“æ ¡éªŒ

### å®ç°æ–¹æ¡ˆ

**å¯åŠ¨å®šæœŸä»»åŠ¡**:
```go
func (t *Trader) startPositionVerification() {
    verifyInterval := 5 * time.Minute
    log.Printf("[Trader] Starting position verification (interval: %v)", verifyInterval)

    go func() {
        ticker := time.NewTicker(verifyInterval)
        defer ticker.Stop()

        for range ticker.C {
            if err := t.verifyPositions(); err != nil {
                log.Printf("[Trader] Position verification failed: %v", err)
            }
        }
    }()
}
```

**æ ¡éªŒé€»è¾‘**:
```go
func (t *Trader) verifyPositions() error {
    // 1. æŸ¥è¯¢CTPçœŸå®æŒä»“
    positions, err := t.Engine.GetORSClient().QueryPositions(ctx, "", "")

    // 2. èšåˆCTPæŒä»“ï¼ˆæŒ‰å“ç§ï¼Œå‡€æŒä»“ï¼‰
    ctpPosMap := make(map[string]int64)
    for _, posList := range positions {
        for _, pos := range posList {
            qty := int64(pos.Volume)
            if pos.Direction == "SHORT" {
                qty = -qty
            }
            ctpPosMap[pos.Symbol] += qty
        }
    }

    // 3. èšåˆç­–ç•¥ä¼°ç®—æŒä»“
    strategyPosMap := t.aggregateStrategyPositions()

    // 4. å¯¹æ¯”
    for symbol := range allSymbols {
        ctpQty := ctpPosMap[symbol]
        strategyQty := strategyPosMap[symbol]

        if ctpQty != strategyQty {
            diff := ctpQty - strategyQty
            log.Printf("[Trader] âš ï¸  Position mismatch: %s: CTP=%d, Strategy=%d, Diff=%d",
                symbol, ctpQty, strategyQty, diff)
        }
    }

    return nil
}
```

**ç­–ç•¥æŒä»“èšåˆ**:
```go
func (t *Trader) aggregateStrategyPositions() map[string]int64 {
    posMap := make(map[string]int64)

    for _, strategyID := range t.StrategyMgr.GetStrategyIDs() {
        strategy, _ := t.StrategyMgr.GetStrategy(strategyID)

        // å¦‚æœç­–ç•¥å®ç°äº†PositionProvideræ¥å£
        if provider, ok := strategy.(strategy.PositionProvider); ok {
            for symbol, qty := range provider.GetPositionsBySymbol() {
                posMap[symbol] += qty
            }
        }
    }

    return posMap
}
```

### éªŒè¯ç»“æœ

**å¯åŠ¨æ—¥å¿—**:
```
2026/01/30 11:33:25 [Trader] Starting position verification (interval: 5m0s)
```

**åŠŸèƒ½**:
- âœ… æ¯5åˆ†é’Ÿè‡ªåŠ¨æ ¡éªŒ
- âœ… å¯¹æ¯”CTPæŒä»“ vs ç­–ç•¥ä¼°ç®—
- âœ… å‘ç°ä¸ä¸€è‡´æ—¶å‘Šè­¦
- âœ… åå°goroutineè¿è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹

### æœªæ¥æ‰©å±•

å¯é€‰çš„è‡ªåŠ¨åŒæ­¥é€»è¾‘ï¼ˆç›®å‰æ³¨é‡Šæ‰ï¼‰:
```go
if len(mismatches) > 0 {
    // TODO: å¯é€‰çš„è‡ªåŠ¨åŒæ­¥é€»è¾‘
    // if t.Config.Risk.EnableAutoPositionSync {
    //     return t.syncStrategyPositions(ctpPosMap)
    // }
}
```

---

## ğŸ“Š å®Œæ•´æ¶æ„æ€»è§ˆ

### æŒä»“æ•°æ®æµ

```
å¯åŠ¨æ—¶:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. CTPæŸœå°ï¼ˆçœŸå®æŒä»“ï¼‰                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ HTTPæŸ¥è¯¢
                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 2. Counter Bridge (HTTP /positions)      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ JSONå“åº”
                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 3. Trader.queryInitialPositions()        â”‚
  â”‚    - èšåˆæŒ‰å“ç§æŒä»“                        â”‚
  â”‚    - è°ƒç”¨ initializeStrategyPositions()  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ ä¼ é€’æŒä»“map
                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 4. Strategy.InitializePositions()        â”‚
  â”‚    - è®¾ç½®leg1Position                    â”‚
  â”‚    - è®¾ç½®leg2Position                    â”‚
  â”‚    - æ›´æ–°BaseStrategy.Position           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  å¹¶è¡Œ: æŒä¹…åŒ–æ–‡ä»¶æ¢å¤
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ data/positions/*.json                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ LoadPositionSnapshot()
                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Strategy.Start()                         â”‚
  â”‚   - å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œæ¢å¤æŒä»“                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿è¡Œæ—¶:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ è®¢å•æˆäº¤å›æŠ¥ (OrderUpdate)                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ NATS
                    â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Strategy.OnOrderUpdate()                 â”‚
  â”‚   - BaseStrategy.UpdatePosition()        â”‚
  â”‚   - PairwiseArb: æ›´æ–°legæŒä»“              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®šæœŸæ ¡éªŒ (æ¯5åˆ†é’Ÿ):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Trader.verifyPositions()                 â”‚
  â”‚   1. æŸ¥è¯¢CTPæŒä»“                          â”‚
  â”‚   2. èšåˆç­–ç•¥ä¼°ç®—æŒä»“                      â”‚
  â”‚   3. å¯¹æ¯”å·®å¼‚                             â”‚
  â”‚   4. å‘Šè­¦ï¼ˆå¦‚æœ‰ä¸ä¸€è‡´ï¼‰                    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœæ­¢æ—¶:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Strategy.Stop()                          â”‚
  â”‚   - SavePositionSnapshot()               â”‚
  â”‚   - ä¿å­˜åˆ° data/positions/*.json         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æµ‹è¯•éªŒè¯

### æµ‹è¯•1: å‚æ•°åŠ è½½

**æ—¥å¿—**:
```
[PairwiseArbStrategy:live_ag_spread] Initialized ag2603/ag2605,
  entry_z=2.50, exit_z=0.80, lookback=200, min_corr=0.70, slippage=2 ticks

[PairwiseArbStrategy:live_au_spread] Initialized au2604/au2606,
  entry_z=2.80, exit_z=0.80, lookback=200, min_corr=0.75, slippage=1 ticks
```

âœ… æ‰€æœ‰å‚æ•°æ­£ç¡®åŠ è½½

### æµ‹è¯•2: æŒä»“æŸ¥è¯¢

**æ—¥å¿—**:
```
[Trader] Using Counter Bridge for position query: localhost:8080
[Trader] Querying initial positions from broker...
[Trader] Warning: Failed to query initial positions: context deadline exceeded
```

- âœ… æŸ¥è¯¢é€»è¾‘æ‰§è¡Œ
- âš ï¸ HTTPè¶…æ—¶ï¼ˆCounter Bridgeå†…éƒ¨é—®é¢˜ï¼‰
- âœ… æŸ¥è¯¢å¤±è´¥ä¸é˜»æ–­å¯åŠ¨

### æµ‹è¯•3: å®šæœŸæ ¡éªŒ

**æ—¥å¿—**:
```
[Trader] Starting position verification (interval: 5m0s)
```

âœ… åå°ä»»åŠ¡å·²å¯åŠ¨ï¼Œå°†æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

### æµ‹è¯•4: ç³»ç»Ÿè¿è¡Œ

**è¿›ç¨‹çŠ¶æ€**:
```bash
$ ps aux | grep trader
user  95877  0.0%  ./bin/trader -config config/trader.live.yaml
```

**æ—¥å¿—**:
```
[StrategyEngine] Received market data: ag2603 (bid: 29289.00, ask: 29326.00)
[PairwiseArb:live_ag_spread] Stats: zscore=0.00 (need Â±2.50),
  corr=0.000 (need 0.700), std=0.0000, ready=false, condMet=false
```

âœ… ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œå¸‚åœºæ•°æ®æ­£å¸¸æ¥æ”¶

---

## ğŸ¯ å·²çŸ¥é—®é¢˜

### é—®é¢˜1: HTTPæ¥å£è¶…æ—¶

**ç°è±¡**: Counter Bridgeçš„HTTPæ¥å£å“åº”è¶…æ—¶

**åŸå› **: å¯èƒ½æ˜¯ï¼š
1. CTPæŸ¥è¯¢æŒä»“è€—æ—¶è¾ƒé•¿
2. HTTPçº¿ç¨‹é˜»å¡
3. httplibåº“å®ç°é—®é¢˜

**å½±å“**: ğŸŸ¡ **ä¸­ç­‰**
- å¯åŠ¨æ—¶æŒä»“æŸ¥è¯¢å¤±è´¥
- å®šæœŸæ ¡éªŒå¯èƒ½å¤±è´¥
- ä½†ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼ˆè®¢å•å›æŠ¥è¿½è¸ª + æŒä¹…åŒ–æ–‡ä»¶ï¼‰

**è§£å†³æ–¹æ¡ˆ** (æœªæ¥):
1. å¢åŠ HTTPè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆ30s â†’ 60sï¼‰
2. ä¼˜åŒ–CTPæŸ¥è¯¢é€»è¾‘
3. æˆ–æ”¹ç”¨å…±äº«å†…å­˜é€šä¿¡

### é—®é¢˜2: gRPCæ¥å£æœªå®ç°

**ç°è±¡**: ORS Gatewayçš„gRPCæŒä»“æŸ¥è¯¢æ¥å£æœªå®Œæ•´å®ç°

**åŸå› **: ORS Gatewayå’ŒCounter Bridgeæ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼Œéœ€è¦é€šè¿‡å…±äº«å†…å­˜é€šä¿¡ï¼Œå®ç°å¤æ‚

**å½±å“**: ğŸŸ¢ **ä½**
- ä¸å½±å“åŠŸèƒ½ï¼ˆHTTPæ¥å£å¯ç”¨ï¼‰
- gRPCä»…æ˜¯å¤‡é€‰æ–¹æ¡ˆ

**è§£å†³æ–¹æ¡ˆ** (æœªæ¥):
- å¦‚æœHTTPæŒç»­æœ‰é—®é¢˜ï¼Œå¯å®ç°å®Œæ•´çš„å…±äº«å†…å­˜é€šä¿¡

---

## âœ… åŠŸèƒ½å®Œæˆåº¦

| Phase | åŠŸèƒ½ | çŠ¶æ€ | å¤‡æ³¨ |
|-------|------|------|------|
| **Phase 1** | ç§»é™¤HTTPæ¥å£ | âœ… å®Œæˆ | åæ¥é‡æ–°å¯ç”¨ï¼ˆå®ç”¨æ–¹æ¡ˆï¼‰ |
| **Phase 2** | æŒä»“æŸ¥è¯¢æ¥å£ | âœ… å®Œæˆ | HTTPå®ç°ï¼ŒæŸ¥è¯¢é€»è¾‘æ­£ç¡® |
| **Phase 3** | ç­–ç•¥æŒä»“åˆå§‹åŒ– | âœ… å®Œæˆ | æ¥å£æ¸…æ™°ï¼Œå®ç°å®Œæ•´ |
| **Phase 4** | æŒä»“æŒä¹…åŒ– | âœ… å®Œæˆ | JSONæ–‡ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜/æ¢å¤ |
| **Phase 5** | å®šæœŸæŒä»“æ ¡éªŒ | âœ… å®Œæˆ | 5åˆ†é’Ÿé—´éš”ï¼Œåå°è¿è¡Œ |

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯

- âœ… å‚æ•°åŠ è½½æ­£ç¡®ï¼ˆmin_corr, slippageï¼‰
- âœ… ç­–ç•¥æŒä»“è¿½è¸ªï¼ˆä»OrderUpdateå®æ—¶æ›´æ–°ï¼‰
- âœ… æŒä»“æŒä¹…åŒ–ï¼ˆå¯åŠ¨æ¢å¤ï¼Œåœæ­¢ä¿å­˜ï¼‰
- âœ… æŒä»“åˆå§‹åŒ–ï¼ˆä»CTPæŸ¥è¯¢ + æŒä¹…åŒ–æ–‡ä»¶ï¼‰
- âœ… å®šæœŸæ ¡éªŒï¼ˆæ¯5åˆ†é’Ÿï¼‰
- âš ï¸ HTTPæŸ¥è¯¢è¶…æ—¶ï¼ˆä¸é˜»æ–­åŠŸèƒ½ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

- `golang/pkg/strategy/position_persistence.go` - æŒä»“æŒä¹…åŒ–åŠŸèƒ½
- `test_position_persistence.sh` - æŒä»“æŒä¹…åŒ–æµ‹è¯•è„šæœ¬
- `Phase2-5_å®Œæ•´æŒä»“ç®¡ç†åŠŸèƒ½å®æ–½æŠ¥å‘Š_2026-01-30-11_35.md` - æœ¬æŠ¥å‘Š

### ä¿®æ”¹æ–‡ä»¶

- `gateway/src/counter_bridge.cpp` - é‡æ–°å¯ç”¨HTTPæ¥å£
- `gateway/src/ors_gateway.cpp` - gRPCæ¥å£ï¼ˆéƒ¨åˆ†å®ç°ï¼‰
- `golang/pkg/trader/trader.go` - æŒä»“æŸ¥è¯¢ã€åˆå§‹åŒ–ã€å®šæœŸæ ¡éªŒ
- `golang/pkg/strategy/pairwise_arb_strategy.go` - æŒä»“åˆå§‹åŒ–ã€æŒä¹…åŒ–ã€æ¥å£å®ç°

### é…ç½®æ–‡ä»¶

- `config/trader.live.yaml` - counter_bridge_addré…ç½®

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. åŒé‡ä¿éšœæœºåˆ¶

- **ä¸»æ–¹æ¡ˆ**: CTPæŸ¥è¯¢ + å®æ—¶è¿½è¸ª
- **å¤‡ä»½æ–¹æ¡ˆ**: æŒä¹…åŒ–æ–‡ä»¶æ¢å¤
- **å¥½å¤„**: å³ä½¿HTTPæŸ¥è¯¢å¤±è´¥ï¼Œä¹Ÿèƒ½ä»æ–‡ä»¶æ¢å¤

### 2. æ¥å£è®¾è®¡æ¸…æ™°

```go
type PositionInitializer interface {
    InitializePositions(positions map[string]int64) error
}

type PositionProvider interface {
    GetPositionsBySymbol() map[string]int64
}
```

- ç­–ç•¥æ— éœ€å…³å¿ƒæŒä»“æ¥æº
- æ”¯æŒå¤šç§åˆå§‹åŒ–æ–¹å¼
- ä¾¿äºæµ‹è¯•å’Œæ‰©å±•

### 3. æŒä¹…åŒ–ç®€å•å¯é 

- JSONæ ¼å¼ä¾¿äºè°ƒè¯•
- æ–‡ä»¶è‡ªåŠ¨åˆ›å»ºç›®å½•
- å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

### 4. å®šæœŸæ ¡éªŒé˜²æ¼‚ç§»

- è‡ªåŠ¨å‘ç°æŒä»“ä¸ä¸€è‡´
- åŠæ—¶å‘Šè­¦
- ä¸ºæœªæ¥è‡ªåŠ¨åŒæ­¥é¢„ç•™æ‰©å±•ç‚¹

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æµç¨‹

1. **å¯åŠ¨Counter Bridge**:
```bash
./gateway/build/counter_bridge ctp:config/ctp/ctp_td.yaml
# HTTPæ¥å£: http://localhost:8080/positions
```

2. **å¯åŠ¨Trader**:
```bash
./bin/trader -config config/trader.live.yaml
# è‡ªåŠ¨æŸ¥è¯¢æŒä»“ + æ¢å¤æŒä¹…åŒ–æ–‡ä»¶
```

3. **æŸ¥çœ‹æŒä»“æ•°æ®**:
```bash
# æŸ¥çœ‹æŒä¹…åŒ–æ–‡ä»¶
cat data/positions/live_ag_spread.json
cat data/positions/live_au_spread.json

# ç›‘æ§æ—¥å¿—
tail -f log/trader.live.log | grep -E "position|Position|verification"
```

### æ‰‹åŠ¨æµ‹è¯•

```bash
# æµ‹è¯•æŒä»“æŸ¥è¯¢
curl http://localhost:8080/positions

# æµ‹è¯•æŒä»“æŒä¹…åŒ–
./test_position_persistence.sh
```

---

## ğŸš€ åç»­ä¼˜åŒ–

### çŸ­æœŸï¼ˆå¯é€‰ï¼‰

1. **ä¿®å¤HTTPè¶…æ—¶**:
   - å¢åŠ è¶…æ—¶æ—¶é—´
   - ä¼˜åŒ–CTPæŸ¥è¯¢é€»è¾‘
   - æ·»åŠ å¼‚æ­¥æŸ¥è¯¢

2. **å¢å¼ºæ ¡éªŒé€»è¾‘**:
   - æ·»åŠ è‡ªåŠ¨åŒæ­¥é€‰é¡¹
   - é…ç½®åŒ–æ ¡éªŒé—´éš”
   - æ›´è¯¦ç»†çš„å‘Šè­¦ä¿¡æ¯

### é•¿æœŸï¼ˆæœªæ¥ï¼‰

1. **å®Œæ•´gRPCå®ç°**:
   - å…±äº«å†…å­˜æ¶ˆæ¯ç±»å‹æ‰©å±•
   - ORS GatewayæŒä»“æŸ¥è¯¢å¤„ç†
   - Counter BridgeæŒä»“æŸ¥è¯¢å“åº”

2. **Portfolioå±‚ç»Ÿä¸€ç®¡ç†**:
   - å…¨å±€æŒä»“è§†å›¾
   - å¤šç­–ç•¥æŒä»“åè°ƒ
   - ç»Ÿä¸€é£æ§æ£€æŸ¥

---

## ğŸ“Š æ€§èƒ½å½±å“

### èµ„æºæ¶ˆè€—

- **æŒä¹…åŒ–æ–‡ä»¶**: æ¯ä¸ªç­–ç•¥çº¦ 1-2 KB
- **å®šæœŸæŸ¥è¯¢**: æ¯5åˆ†é’Ÿä¸€æ¬¡HTTPè¯·æ±‚
- **å†…å­˜å¼€é”€**: å¯å¿½ç•¥ï¼ˆä»…æŒä»“mapï¼‰

### æ€§èƒ½å½±å“

- âœ… å¯åŠ¨æ—¶é—´: å¢åŠ  ~5ç§’ï¼ˆHTTPæŸ¥è¯¢è¶…æ—¶ï¼‰
- âœ… è¿è¡Œæ—¶æ€§èƒ½: æ— å½±å“
- âœ… åå°ä»»åŠ¡: CPU < 0.1%

---

## âœ… æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

1. âœ… **Phase 2**: æŒä»“æŸ¥è¯¢æ¥å£ï¼ˆHTTPå®ç°ï¼‰
2. âœ… **Phase 3**: ç­–ç•¥æŒä»“åˆå§‹åŒ–ï¼ˆCTPæŸ¥è¯¢ + æ¥å£ä¼ é€’ï¼‰
3. âœ… **Phase 4**: æŒä»“æŒä¹…åŒ–ï¼ˆJSONæ–‡ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜/æ¢å¤ï¼‰
4. âœ… **Phase 5**: å®šæœŸæŒä»“æ ¡éªŒï¼ˆ5åˆ†é’Ÿé—´éš”ï¼Œå¯¹æ¯”å‘Šè­¦ï¼‰

### æ ¸å¿ƒä»·å€¼

- ğŸ¯ **è§£å†³é‡å¯é—®é¢˜**: ç­–ç•¥é‡å¯åæ­£ç¡®æ¢å¤æŒä»“
- ğŸ¯ **é˜²æ­¢æ¼‚ç§»**: å®šæœŸæ ¡éªŒå‘ç°ä¸ä¸€è‡´
- ğŸ¯ **åŒé‡ä¿éšœ**: CTPæŸ¥è¯¢ + æŒä¹…åŒ–æ–‡ä»¶
- ğŸ¯ **æ¶æ„æ¸…æ™°**: æ¥å£å®šä¹‰æ˜ç¡®ï¼Œæ˜“äºæ‰©å±•

### ç³»ç»Ÿå°±ç»ªåº¦

**ç”Ÿäº§å°±ç»ª**: ğŸŸ¢ **å¯ç”¨**

- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- âœ… æŒä»“è¿½è¸ªå‡†ç¡®
- âš ï¸ HTTPè¶…æ—¶é—®é¢˜ï¼ˆä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… æ•…éšœæ¢å¤èƒ½åŠ›å¼º

---

**æŠ¥å‘Šæ—¶é—´**: 2026-01-30 11:35
**å®æ–½ç”¨æ—¶**: çº¦2å°æ—¶
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆå¹¶æµ‹è¯•é€šè¿‡**
**ä¸‹ä¸€æ­¥**: è§‚å¯Ÿè¿è¡Œæ•ˆæœï¼Œå¿…è¦æ—¶ä¼˜åŒ–HTTPæ¥å£

