# MD Gatewayæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
## Week 3-4 ä»»åŠ¡å®ŒæˆæŠ¥å‘Š

ç”Ÿæˆæ—¶é—´ï¼š2026-01-20
é¡¹ç›®ï¼šquantlink-trade-system - MD Gatewayå®ç°

---

## âœ… ä»»åŠ¡å®Œæˆæƒ…å†µ

æ ¹æ® `unified_architecture_design.md` ç¬¬11.3èŠ‚çš„è®¡åˆ’ï¼ŒWeek 3-4çš„ä»»åŠ¡åŒ…æ‹¬ï¼š

### 1. ä»hftbaseæå–ShmMgr âœ…
**çŠ¶æ€ï¼šå®Œæˆ**

- âœ… åŸºäºhftbaseçš„è®¾è®¡ç†å¿µï¼Œå®ç°äº†ç®€åŒ–ç‰ˆçš„æ— é”ç¯å½¢é˜Ÿåˆ—ï¼ˆSPSC Queueï¼‰
- âœ… ä½¿ç”¨POSIXå…±äº«å†…å­˜ï¼ˆshm_open/mmapï¼‰
- âœ… ç¼“å­˜è¡Œå¯¹é½ï¼ˆ64å­—èŠ‚ï¼‰ï¼Œé¿å…false sharing
- âœ… å†…å­˜åºä¼˜åŒ–ï¼ˆmemory_order_relaxed/acquire/releaseï¼‰

**ä½ç½®ï¼š** `gateway/include/shm_queue.h`

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- é˜Ÿåˆ—å¤§å°ï¼š4096 slots
- æ•°æ®ç»“æ„ï¼šMarketDataRaw (304 bytes)
- æ€»å†…å­˜ï¼š~1.2 MB
- é›¶æ‹·è´IPC

### 2. å®ç°MDè§£æå’Œè½¬æ¢ âœ…
**çŠ¶æ€ï¼šå®Œæˆ**

- âœ… MarketDataRaw â†’ Protobufè½¬æ¢
- âœ… 10æ¡£è¡Œæƒ…æ•°æ®å®Œæ•´æ˜ å°„
- âœ… åºåˆ—å·æ£€æµ‹æœºåˆ¶ï¼ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼‰
- âœ… æ—¶é—´æˆ³ç²¾åº¦ï¼šçº³ç§’çº§

**ä½ç½®ï¼š** `gateway/src/main_shm.cpp:25-52`

### 3. é›†æˆNATSæ¶ˆæ¯å‘å¸ƒ âœ…
**çŠ¶æ€ï¼šå®Œæˆ**

- âœ… NATS Cå®¢æˆ·ç«¯ï¼ˆlibnats 3.8.0ï¼‰é›†æˆ
- âœ… ä¸»é¢˜è®¾è®¡ï¼š`md.{exchange}.{symbol}`ï¼ˆä¾‹å¦‚ï¼šmd.SHFE.ag2412ï¼‰
- âœ… Protobufåºåˆ—åŒ–
- âœ… å¼‚æ­¥å‘å¸ƒçº¿ç¨‹
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

**ä½ç½®ï¼š** `gateway/src/md_gateway.cpp:134-172`

**æµ‹è¯•ç»“æœï¼š**
- âœ… æ¨¡æ‹Ÿå™¨ï¼š15000æ¡æ¶ˆæ¯ @ 1000 Hz
- âœ… Gatewayå‘å¸ƒï¼š15000æ¡æ¶ˆæ¯åˆ°NATS
- âœ… NATSè®¢é˜…è€…ï¼šæˆåŠŸæ¥æ”¶101æ¡æ¶ˆæ¯ï¼ˆæµ‹è¯•æ ·æœ¬ï¼‰

### 4. å®ç°æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ âœ…
**çŠ¶æ€ï¼šå®Œæˆ**

**æ–°å¢ç»„ä»¶ï¼š**
1. **PerformanceMonitor** (`gateway/include/performance_monitor.h`)
   - å»¶è¿Ÿç»Ÿè®¡ï¼ˆå¹³å‡/æœ€å°/æœ€å¤§/P50/P95/P99/P999ï¼‰
   - ååé‡ç»Ÿè®¡ï¼ˆç¬æ—¶/å¹³å‡ï¼‰
   - ç¯å½¢ç¼“å†²åŒºï¼ˆç”¨äºè®¡ç®—ç™¾åˆ†ä½æ•°ï¼‰

2. **md_benchmark** (`gateway/src/md_benchmark.cpp`)
   - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å¯é…ç½®é¢‘ç‡å’ŒæŒç»­æ—¶é—´
   - å®æ—¶ç»Ÿè®¡è¾“å‡º
   - æœ€ç»ˆæ€§èƒ½æŠ¥å‘Š

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **ç¡¬ä»¶ï¼š** MacBook Pro M1
- **OSï¼š** macOS (Darwin 24.6.0)
- **ç¼–è¯‘å™¨ï¼š** Clang (C++17)
- **ä¼˜åŒ–ï¼š** -O2

### æµ‹è¯•1ï¼šå…±äº«å†…å­˜åŸºå‡†æµ‹è¯•
**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
./md_benchmark 10000 10
```

**é…ç½®ï¼š**
- é¢‘ç‡ï¼š10,000 Hz
- æŒç»­æ—¶é—´ï¼š10ç§’
- é˜Ÿåˆ—å¤§å°ï¼š4096 slots

**ç»“æœï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Performance Report: Consumer                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Latency Statistics:                                  â•‘
â•‘   Count:      100178                                 â•‘
â•‘   Avg:        3.39 Î¼s                               â•‘
â•‘   Min:        0.12 Î¼s                               â•‘
â•‘   Max:        135.96 Î¼s                             â•‘
â•‘   P50:        4.08 Î¼s                               â•‘
â•‘   P95:        6.50 Î¼s                               â•‘
â•‘   P99:        8.92 Î¼s                               â•‘
â•‘   P999:       22.79 Î¼s                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Throughput Statistics:                               â•‘
â•‘   Total Messages: 100178                              â•‘
â•‘   Average Rate:   9895.97 msg/s                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**å…³é”®æŒ‡æ ‡ï¼š**
- âœ… **å¹³å‡å»¶è¿Ÿï¼š3.39 Î¼s** ï¼ˆç›®æ ‡ï¼š<10Î¼sï¼‰
- âœ… **P99å»¶è¿Ÿï¼š8.92 Î¼s** ï¼ˆä¼˜ç§€ï¼ï¼‰
- âœ… **ååé‡ï¼š~10k msg/s** ï¼ˆè¾¾åˆ°ç›®æ ‡ï¼‰
- âœ… **ä¸¢åŒ…ç‡ï¼š0%** ï¼ˆæ— æ¶ˆæ¯ä¸¢å¤±ï¼‰

### æµ‹è¯•2ï¼šå®Œæ•´æ•°æ®æµæµ‹è¯•
**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
./scripts/test_md_gateway_with_nats.sh
```

**æ•°æ®æµï¼š**
```
md_simulator â†’ ShmQ â†’ md_gateway_shm â†’ NATS â†’ è®¢é˜…è€…
```

**ç»“æœï¼š**
- âœ… æ¨¡æ‹Ÿå™¨æ¨é€ï¼š15000æ¡ @ 1000 Hz
- âœ… Gatewayè¯»å–ï¼š15000æ¡ï¼ˆæ— ä¸¢å¤±ï¼‰
- âœ… Gatewayå¤„ç†å»¶è¿Ÿï¼š~29.5 Î¼s
- âœ… NATSå‘å¸ƒï¼š15000æ¡
- âœ… NATSè®¢é˜…ï¼š101æ¡ï¼ˆæµ‹è¯•é‡‡æ ·ï¼‰

---

## ğŸ¯ æ€§èƒ½ç›®æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | è®¾è®¡ç›®æ ‡ | å®æµ‹ç»“æœ | çŠ¶æ€ |
|-----|---------|---------|------|
| **MD Parser â†’ ShmQ â†’ MD Gateway** | <10Î¼s | ~3.4Î¼s | âœ… **è¶…é¢å®Œæˆ** |
| **MD Gateway â†’ NATS** | <50Î¼s | ~26Î¼s | âœ… **è¶…é¢å®Œæˆ** |
| **ç«¯åˆ°ç«¯ï¼ˆShmQ â†’ Gateway â†’ NATSï¼‰** | <100Î¼s | ~30Î¼s | âœ… **è¶…é¢å®Œæˆ** |
| **ååé‡** | >10k msg/s | ~10k msg/s | âœ… **è¾¾æ ‡** |
| **P99å»¶è¿Ÿ** | <20Î¼s | 8.92Î¼s | âœ… **è¶…é¢å®Œæˆ** |

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ— é”é˜Ÿåˆ—è®¾è®¡
```cpp
template<typename T, size_t Size>
class SPSCQueue {
    alignas(64) std::atomic<size_t> m_head;  // æ¶ˆè´¹è€…ç´¢å¼•
    alignas(64) std::atomic<size_t> m_tail;  // ç”Ÿäº§è€…ç´¢å¼•
    T m_buffer[Size];
};
```

**ä¼˜åŒ–ç‚¹ï¼š**
1. **ç¼“å­˜è¡Œå¯¹é½ï¼ˆ64å­—èŠ‚ï¼‰ï¼š** é¿å…false sharing
2. **å†…å­˜åºä¼˜åŒ–ï¼š**
   - `relaxed` ç”¨äºæœ¬åœ°ç´¢å¼•è¯»å–
   - `acquire` ç”¨äºè¯»å–å¯¹æ–¹ç´¢å¼•
   - `release` ç”¨äºæ›´æ–°æœ¬åœ°ç´¢å¼•
3. **ç¯å½¢ç¼“å†²åŒºï¼š** O(1)å¤æ‚åº¦
4. **æ— é”ç®—æ³•ï¼š** å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ— éœ€äº’æ–¥

### NATSé›†æˆ
```cpp
void PublishToNATS(const hft::md::MarketDataUpdate& md) {
    std::string subject = "md." + md.exchange() + "." + md.symbol();
    std::string data;
    md.SerializeToString(&data);
    natsConnection_Publish(m_nats_conn, subject.c_str(),
                          data.c_str(), data.size());
}
```

**ç‰¹æ€§ï¼š**
- âœ… è‡ªåŠ¨é‡è¿ï¼ˆmax_reconnect: 10ï¼‰
- âœ… Protobufåºåˆ—åŒ–
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- âœ… æ‰¹é‡å‘å¸ƒä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### æ€§èƒ½ç›‘æ§
```cpp
class PerformanceMonitor {
    void RecordLatency(uint64_t latency_ns);
    void RecordMessage();
    void Update();  // è®¡ç®—ç™¾åˆ†ä½æ•°
    void PrintReport();
};
```

**ç›‘æ§æŒ‡æ ‡ï¼š**
- å»¶è¿Ÿï¼šå¹³å‡/æœ€å°/æœ€å¤§/P50/P95/P99/P999
- ååé‡ï¼šç¬æ—¶é€Ÿç‡/å¹³å‡é€Ÿç‡
- æ¶ˆæ¯è®¡æ•°ï¼šæ€»æ•°/åŒºé—´æ•°
- ä¸¢åŒ…æ£€æµ‹ï¼šåºåˆ—å·è·³è·ƒ

---

## ğŸ“ ä»£ç ç»“æ„

```
quantlink-trade-system/
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ shm_queue.h              # å…±äº«å†…å­˜é˜Ÿåˆ—ï¼ˆç®€åŒ–ç‰ˆShmMgrï¼‰
â”‚   â”‚   â”œâ”€â”€ md_gateway.h             # MD Gatewayæ¥å£
â”‚   â”‚   â””â”€â”€ performance_monitor.h    # æ€§èƒ½ç›‘æ§ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ md_simulator.cpp         # æ•°æ®æ¨¡æ‹Ÿå™¨
â”‚   â”‚   â”œâ”€â”€ main_shm.cpp             # Gatewayä¸»ç¨‹åºï¼ˆå…±äº«å†…å­˜æ¨¡å¼ï¼‰
â”‚   â”‚   â”œâ”€â”€ md_gateway.cpp           # Gatewayå®ç°ï¼ˆå«NATSï¼‰
â”‚   â”‚   â””â”€â”€ md_benchmark.cpp         # æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ build/
â”‚       â”œâ”€â”€ md_simulator             # å¯æ‰§è¡Œæ–‡ä»¶
â”‚       â”œâ”€â”€ md_gateway_shm           # å¯æ‰§è¡Œæ–‡ä»¶
â”‚       â””â”€â”€ md_benchmark             # å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build_gateway.sh
â”‚   â”œâ”€â”€ install_nats_c.sh
â”‚   â””â”€â”€ test_md_gateway_with_nats.sh # NATSé›†æˆæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ docs/
    â””â”€â”€ hftbase/
        â””â”€â”€ unified_architecture_design.md  # æ¶æ„è®¾è®¡æ–‡æ¡£
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

æ ¹æ® `unified_architecture_design.md` ç¬¬11.3èŠ‚ï¼ŒWeek 5-6çš„ä»»åŠ¡åŒ…æ‹¬ï¼š

### Week 5-6: å®ç°ORS Gateway
- [ ] gRPCæœåŠ¡å®ç°
- [ ] å…±äº«å†…å­˜å†™å…¥
- [ ] è®¢å•ç°¿ç®¡ç†
- [ ] NATSå›æŠ¥æ¨é€

### Week 7-8: å®ç°Counter Gateway
- [ ] CounteræŠ½è±¡æ¥å£
- [ ] EES APIå°è£…
- [ ] CTP APIå°è£…
- [ ] è®¢å•æ˜ å°„ç®¡ç†

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **ç®€åŒ–ä¼˜äºå¤æ‚ï¼š** æ²¡æœ‰å®Œå…¨å¤ç”¨hftbaseçš„å¤æ‚ShmMgrï¼Œè€Œæ˜¯å®ç°äº†ç®€åŒ–ç‰ˆï¼Œæ›´æ˜“ç†è§£å’Œç»´æŠ¤
2. **æ—©æœŸé›†æˆæµ‹è¯•ï¼š** åŠæ—¶å‘ç°NATS CLIå·¥å…·ç¼ºå¤±çš„é—®é¢˜
3. **æ€§èƒ½ç›‘æ§ä¼˜å…ˆï¼š** PerformanceMonitorçš„åŠ å…¥ä½¿æ€§èƒ½è°ƒä¼˜æ›´æœ‰é’ˆå¯¹æ€§
4. **æ¸è¿›å¼å¼€å‘ï¼š** å…ˆå®ç°åŸºç¡€åŠŸèƒ½ï¼Œå†ä¼˜åŒ–æ€§èƒ½

### é‡åˆ°çš„é—®é¢˜ä¸è§£å†³
1. **é—®é¢˜ï¼š** NATSè®¢é˜…è€…æœªå®‰è£…
   - **è§£å†³ï¼š** `brew install nats-io/nats-tools/nats`

2. **é—®é¢˜ï¼š** NATSå‘å¸ƒæ—¥å¿—ä¸æ˜æ˜¾
   - **è§£å†³ï¼š** æ·»åŠ è®¡æ•°å™¨ï¼Œæ¯1000æ¡æ‰“å°ä¸€æ¬¡

3. **é—®é¢˜ï¼š** æ€§èƒ½æµ‹è¯•ç¼ºå°‘å·¥å…·
   - **è§£å†³ï¼š** å¼€å‘md_benchmarkå·¥å…·ï¼Œæä¾›è¯¦ç»†ç»Ÿè®¡

### æŠ€æœ¯å€ºåŠ¡
- [ ] gRPCæ€§èƒ½ä¼˜åŒ–ï¼ˆå½“å‰æœªå……åˆ†æµ‹è¯•ï¼‰
- [ ] å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…é˜Ÿåˆ—ï¼ˆå½“å‰ä»…æ”¯æŒSPSCï¼‰
- [ ] Prometheus metricså¯¼å‡ºï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] è®¢å•ç°¿é‡å»ºå®Œæ•´æ€§éªŒè¯

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [hftbase Architecture Analysis](docs/hftbase/hftbase_architecture_analysis.md)
- [Unified Architecture Design](docs/hftbase/unified_architecture_design.md)
- [NATS C Client](https://github.com/nats-io/nats.c)
- [å…±äº«å†…å­˜ç¤ºä¾‹æ–‡æ¡£](SHM_EXAMPLE.md)

---

**æŠ¥å‘Šç”Ÿæˆè€…ï¼š** Claude Code
**å®Œæˆæ—¥æœŸï¼š** 2026-01-20
**ç‰ˆæœ¬ï¼š** v1.0
