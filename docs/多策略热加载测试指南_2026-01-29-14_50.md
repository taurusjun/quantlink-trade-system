# 多策略热加载端到端测试指南

**测试日期**: 2026-01-29
**功能**: 多策略运行 + Model参数热加载
**状态**: ✅ 已就绪

---

## 一、测试目标

本测试验证以下功能:

1. ✅ **多策略并行运行** - 在同一个Trader实例中运行多个策略
2. ✅ **Model文件热加载** - 无需重启进程即可更新策略参数
3. ✅ **参数隔离** - 每个策略独立的model文件和参数
4. ✅ **HTTP API控制** - 通过REST API手动触发热加载
5. ✅ **参数验证与回滚** - 无效参数自动拒绝和回滚

---

## 二、测试架构

### 2.1 策略配置

测试包含3个并行策略:

| 策略ID | 策略类型 | 交易品种 | Model文件 | 初始参数 |
|--------|---------|---------|-----------|---------|
| ag_pairwise | 配对套利 | ag2603/ag2605 | model.ag_pairwise.txt | entry=2.0, size=4 |
| ag_passive | 被动做市 | ag2603 | model.ag_passive.txt | entry=1.5, size=2 |
| au_pairwise | 配对套利 | au2604/au2606 | model.au_pairwise.txt | entry=1.0, size=1 |

### 2.2 Model文件格式

```
# Model文件示例 (KEY VALUE格式)
BEGIN_PLACE 2.0          # entry_zscore
BEGIN_REMOVE 0.5         # exit_zscore
SIZE 4                   # order_size
MAX_SIZE 16              # max_position_size
STOP_LOSS 50000          # 止损金额
MAX_LOSS 100000          # 最大亏损
LOOKBACK_PERIOD 100      # 回看周期
```

### 2.3 热加载API

```bash
# 触发热加载 (POST)
curl -X POST http://localhost:9301/api/v1/strategies/{策略ID}/model/reload

# 查看策略状态 (GET)
curl http://localhost:9301/api/v1/strategies/{策略ID}

# 查看热加载历史 (GET)
curl http://localhost:9301/api/v1/strategies/{策略ID}/model/history
```

---

## 三、快速开始

### 3.1 一键运行测试

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system
./test_multi_strategy_hot_reload.sh
```

**测试流程**:
1. ✅ 创建3个Model文件
2. ✅ 生成支持热加载的配置文件
3. ✅ 检查前置服务 (NATS)
4. ✅ 启动多策略Trader
5. ✅ 查看初始参数
6. ✅ 逐个测试每个策略的热加载
7. ✅ 验证参数更新
8. ✅ 查看热加载历史
9. ✅ 测试无效参数回滚
10. ✅ 输出测试结果汇总

### 3.2 测试输出示例

```
╔═══════════════════════════════════════════════════════════╗
║     多策略热加载端到端测试                                  ║
║     Multi-Strategy Hot Reload E2E Test                   ║
╚═══════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════
Step 1: 创建测试Model文件
═══════════════════════════════════════════════════════════

✓ 创建 model.ag_pairwise.txt
  entry_zscore: 2.0, exit_zscore: 0.5, size: 4

✓ 创建 model.ag_passive.txt
  entry_zscore: 1.5, exit_zscore: 0.3, size: 2

✓ 创建 model.au_pairwise.txt
  entry_zscore: 1.0, exit_zscore: 0.3, size: 1

═══════════════════════════════════════════════════════════
Step 6: 测试热加载 - 策略1 (ag_pairwise)
═══════════════════════════════════════════════════════════

[1] 修改model文件
  修改前: entry_zscore=2.0, exit_zscore=0.5, size=4
  修改后: entry_zscore=1.5, exit_zscore=0.3, size=6

[2] 触发热加载
{
  "success": true,
  "message": "Model reloaded successfully",
  "timestamp": "2026-01-29T14:50:00+08:00"
}

✓ 热加载请求成功

[3] 验证参数更新
✓ entry_zscore 已更新为 1.5
✓ exit_zscore 已更新为 0.3
✓ order_size 已更新为 6

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 多策略热加载端到端测试完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 四、手动测试步骤

### 4.1 前置准备

```bash
# 1. 确保NATS运行
brew services start nats-server
# 或
nats-server &

# 2. 编译trader (如需要)
cd golang
go build -o ../bin/trader cmd/trader/main.go
cd ..

# 3. 创建日志目录
mkdir -p log test_logs golang/models
```

### 4.2 启动Trader

```bash
# 运行测试脚本（包含配置生成）
./test_multi_strategy_hot_reload.sh

# 或手动启动
./bin/trader -config config/trader.hot_reload.test.yaml
```

### 4.3 查看策略列表

```bash
# 获取所有策略
curl http://localhost:9301/api/v1/strategies | python3 -m json.tool

# 查看特定策略
curl http://localhost:9301/api/v1/strategies/ag_pairwise | python3 -m json.tool
```

### 4.4 测试热加载

**步骤1: 修改Model文件**

```bash
# 编辑model文件
vim golang/models/model.ag_pairwise.txt

# 修改参数，例如:
# BEGIN_PLACE 2.0 → 1.5
# SIZE 4 → 6
```

**步骤2: 触发热加载**

```bash
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload
```

**预期响应**:
```json
{
  "success": true,
  "message": "Model reloaded successfully",
  "data": {
    "timestamp": "2026-01-29T14:50:00+08:00"
  }
}
```

**步骤3: 验证参数更新**

```bash
curl http://localhost:9301/api/v1/strategies/ag_pairwise | python3 -m json.tool
```

**预期**: 参数已更新为新值

**步骤4: 查看热加载历史**

```bash
curl http://localhost:9301/api/v1/strategies/ag_pairwise/model/history | python3 -m json.tool
```

---

## 五、测试用例

### 测试用例1: 正常参数更新

**场景**: 修改合法参数并热加载

**操作**:
```bash
# 修改 model.ag_pairwise.txt
BEGIN_PLACE 1.5
SIZE 6

# 触发热加载
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload
```

**预期结果**: ✅ 参数成功更新

### 测试用例2: 多策略独立热加载

**场景**: 分别热加载不同策略,参数互不影响

**操作**:
```bash
# 热加载策略1
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload

# 热加载策略2
curl -X POST http://localhost:9301/api/v1/strategies/ag_passive/model/reload

# 验证策略1和策略2的参数独立
```

**预期结果**: ✅ 每个策略独立更新,互不干扰

### 测试用例3: 无效参数回滚

**场景**: 尝试加载无效参数(负数)

**操作**:
```bash
# 修改为无效参数
BEGIN_PLACE -1.0
SIZE -5

# 尝试热加载
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload
```

**预期结果**:
- ❌ 热加载失败
- ✅ 参数保持旧值(自动回滚)

### 测试用例4: 并发热加载

**场景**: 同时热加载多个策略

**操作**:
```bash
# 在3个终端并行执行
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload &
curl -X POST http://localhost:9301/api/v1/strategies/ag_passive/model/reload &
curl -X POST http://localhost:9301/api/v1/strategies/au_pairwise/model/reload &
```

**预期结果**: ✅ 所有策略热加载成功,无竞争条件

### 测试用例5: 持仓保持测试

**场景**: 策略持有仓位时进行热加载

**操作**:
```bash
# 1. 激活策略并等待建仓
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/activate
sleep 30

# 2. 查看持仓
curl http://localhost:9301/api/v1/positions

# 3. 热加载参数
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload

# 4. 再次查看持仓（应保持不变）
curl http://localhost:9301/api/v1/positions
```

**预期结果**: ✅ 持仓数量和订单不受影响

---

## 六、API端点参考

### 6.1 策略管理API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | /api/v1/strategies | 获取所有策略列表 |
| GET | /api/v1/strategies/{id} | 获取策略详情 |
| POST | /api/v1/strategies/{id}/activate | 激活策略 |
| POST | /api/v1/strategies/{id}/deactivate | 停止策略 |

### 6.2 热加载API

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | /api/v1/strategies/{id}/model/reload | 手动触发热加载 |
| GET | /api/v1/strategies/{id}/model/status | 查看Model状态 |
| GET | /api/v1/strategies/{id}/model/history | 查看热加载历史 |

### 6.3 Dashboard API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | /api/v1/dashboard/overview | Dashboard概览 |
| GET | /api/v1/indicators/realtime | 实时指标 |
| GET | /api/v1/positions | 持仓查询 |
| GET | /api/v1/positions/summary | 持仓汇总 |

---

## 七、配置文件说明

### 7.1 多策略配置结构

```yaml
system:
  mode: "live"

# 多策略数组
strategies:
  - id: "ag_pairwise"              # 策略唯一ID
    type: "pairwise_arb"           # 策略类型
    enabled: true                  # 是否启用

    # Model热加载配置
    model_file: "./golang/models/model.ag_pairwise.txt"
    hot_reload:
      enabled: true                # 启用热加载
      mode: "manual"               # 手动触发模式

    # 策略参数（初始值）
    parameters:
      entry_zscore: 2.0
      exit_zscore: 0.5
      order_size: 4.0
```

### 7.2 热加载配置项

| 配置项 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| enabled | bool | 是否启用热加载 | false |
| mode | string | 触发模式: manual(手动) | manual |
| model_file | string | Model文件路径 | 必填 |

---

## 八、故障排查

### 问题1: 热加载API返回404

**现象**:
```bash
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload
# {"error": "strategy not found"}
```

**原因**:
- 策略ID不正确
- Trader未正常启动

**解决**:
```bash
# 1. 检查策略列表
curl http://localhost:9301/api/v1/strategies

# 2. 确认策略ID
curl http://localhost:9301/api/v1/strategies/{正确的ID}
```

### 问题2: 热加载失败

**现象**:
```json
{
  "success": false,
  "error": "failed to parse model file"
}
```

**原因**:
- Model文件格式错误
- 文件路径不存在

**解决**:
```bash
# 1. 检查文件是否存在
ls -la golang/models/model.ag_pairwise.txt

# 2. 检查文件格式
cat golang/models/model.ag_pairwise.txt

# 3. 查看详细日志
tail -f log/trader.hot_reload.test.log
```

### 问题3: 参数未更新

**现象**: 热加载成功,但参数未变化

**原因**:
- Model文件未保存
- 参数映射错误

**解决**:
```bash
# 1. 确认文件修改时间
stat golang/models/model.ag_pairwise.txt

# 2. 检查Model文件内容
cat golang/models/model.ag_pairwise.txt

# 3. 查看热加载历史
curl http://localhost:9301/api/v1/strategies/ag_pairwise/model/history
```

### 问题4: NATS连接失败

**现象**:
```
[ERROR] Failed to connect to NATS
```

**解决**:
```bash
# 1. 检查NATS是否运行
lsof -i :4222

# 2. 启动NATS
brew services start nats-server
# 或
nats-server &

# 3. 重启Trader
```

---

## 九、性能指标

### 9.1 热加载性能

| 指标 | 目标 | 说明 |
|------|------|------|
| 加载延迟 | < 100ms | 从API请求到参数生效 |
| 策略中断 | 0ms | 热加载不中断策略运行 |
| 持仓保持 | 100% | 持仓和订单不受影响 |
| 并发安全 | 100% | 多策略并发热加载无问题 |

### 9.2 测试覆盖率

- ✅ 正常参数更新
- ✅ 无效参数回滚
- ✅ 多策略独立热加载
- ✅ 并发热加载测试
- ✅ 持仓保持测试
- ✅ 热加载历史记录

---

## 十、最佳实践

### 10.1 生产环境使用建议

1. **参数备份**
   ```bash
   # 热加载前备份
   cp golang/models/model.ag_pairwise.txt \
      golang/models/model.ag_pairwise.txt.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **小步迭代**
   - 避免一次性大幅修改参数
   - 逐步调整,观察效果
   - 保留历史版本供回滚

3. **监控告警**
   - 监控热加载历史接口
   - 设置参数变更告警
   - 记录操作审计日志

4. **非交易时段调整**
   - 优先在非交易时段调整
   - 避免在持仓时大幅修改
   - 测试环境先验证

### 10.2 安全建议

1. **参数验证**
   - 系统自动验证参数范围
   - 无效参数自动拒绝
   - 失败时自动回滚

2. **权限控制**
   - 生产环境限制API访问
   - 记录热加载操作人
   - 设置审批流程

3. **回滚能力**
   - 保留参数历史版本
   - 支持快速回滚到旧参数
   - 测试回滚流程

---

## 十一、相关文档

- [Legacy模式热加载演示](Legacy模式热加载演示_2026-01-26.md)
- [P1优化完成报告](P1优化_命令行兼容与热加载_完成报告_2026-01-26-13_37.md)
- [Trader使用指南](USAGE.md)
- [系统架构文档](CURRENT_ARCHITECTURE_FLOW.md)

---

## 十二、常用命令速查

```bash
# 快速启动测试
./test_multi_strategy_hot_reload.sh

# 查看所有策略
curl http://localhost:9301/api/v1/strategies | python3 -m json.tool

# 热加载策略1
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/model/reload

# 热加载策略2
curl -X POST http://localhost:9301/api/v1/strategies/ag_passive/model/reload

# 热加载策略3
curl -X POST http://localhost:9301/api/v1/strategies/au_pairwise/model/reload

# 查看策略参数
curl http://localhost:9301/api/v1/strategies/ag_pairwise | python3 -m json.tool

# 查看热加载历史
curl http://localhost:9301/api/v1/strategies/ag_pairwise/model/history | python3 -m json.tool

# 查看Dashboard
curl http://localhost:9301/api/v1/dashboard/overview | python3 -m json.tool

# 查看日志
tail -f log/trader.hot_reload.test.log

# 停止测试
pkill -f "bin/trader"
```

---

**文档版本**: v1.0
**最后更新**: 2026-01-29 14:50
**维护人**: Claude Code
**测试状态**: ✅ 已就绪
