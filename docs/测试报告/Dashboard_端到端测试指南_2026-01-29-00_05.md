# Dashboard 端到端测试指南

**文档日期**: 2026-01-29
**版本**: v1.0
**相关模块**: trader, dashboard, gateway

---

## 概述

本文档说明如何进行多策略 Dashboard 的端到端测试，包括模拟器测试和实盘测试两种方式。

---

## 测试方式对比

| 方式 | 数据源 | 下单 | 用途 |
|------|--------|------|------|
| 模拟器测试 | md_simulator | 模拟成交 | 功能验证、开发调试 |
| 实盘测试 | CTP行情 | 真实下单 | 生产验证 |

---

## 一、模拟器端到端测试

### 1.1 快速启动

```bash
cd /path/to/quantlink-trade-system
./test_dashboard_simulator.sh
```

### 1.2 手动启动步骤

**步骤 1: 启动 NATS**
```bash
nats-server &
```

**步骤 2: 启动行情模拟器**
```bash
./gateway/build/md_simulator 50 queue &
```
- 参数 `50`: 每秒生成50条行情
- 参数 `queue`: 共享内存队列名称
- 生成合约: `ag2602`, `ag2604`

**步骤 3: 启动 MD Gateway**
```bash
./gateway/build/md_gateway queue &
```
- 从共享内存读取行情
- 发布到 NATS (`md.SHFE.ag2602`, `md.SHFE.ag2604`)

**步骤 4: 启动 ORS Gateway**
```bash
./gateway/build/ors_gateway &
```
- 监听端口: 50052
- 接收订单请求

**步骤 5: 启动 Counter Gateway**
```bash
./gateway/build/counter_gateway &
```
- 模拟订单成交

**步骤 6: 启动 Trader**
```bash
cd golang
./trader -config config/trader.dashboard.sim.yaml &
```
- API 端口: 9301
- 模式: simulation

**步骤 7: 启动 HTTP 服务器**
```bash
cd golang/web
python3 -m http.server 8080 &
```

**步骤 8: 打开 Dashboard**
```bash
open http://localhost:8080/dashboard.html
```

### 1.3 模拟器配置

配置文件: `golang/config/trader.dashboard.sim.yaml`

```yaml
strategies:
  - id: "ag_pairwise"
    type: "pairwise_arb"
    symbols: ["ag2602", "ag2604"]
    parameters:
      entry_zscore: 1.5      # 低阈值便于触发
      min_correlation: 0.5

  - id: "ag_passive"
    type: "passive"
    symbols: ["ag2602"]

  - id: "ag_aggressive"
    type: "aggressive"
    symbols: ["ag2604"]
```

### 1.4 验证测试

```bash
# 检查 API 健康
curl http://localhost:9301/api/v1/health

# 查看策略列表
curl http://localhost:9301/api/v1/strategies | jq

# 查看实时指标
curl http://localhost:9301/api/v1/indicators/realtime | jq

# 激活策略
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/activate
```

---

## 二、实盘端到端测试

### 2.1 前置条件

- CTP 账户已配置 (`config/ctp/ctp_md.yaml`, `config/ctp/ctp_td.yaml`)
- 交易时段内运行

### 2.2 启动步骤

**步骤 1: 启动 NATS**
```bash
nats-server &
```

**步骤 2: 启动 CTP 行情网关**
```bash
./gateway/build/ctp_md_gateway -c config/ctp/ctp_md.yaml -s config/ctp/ctp_md.secret.yaml &
```
- 连接 CTP 前置
- 订阅真实合约行情

**步骤 3: 启动 MD Gateway**
```bash
./gateway/build/md_gateway queue &
```

**步骤 4: 启动 ORS Gateway**
```bash
./gateway/build/ors_gateway &
```

**步骤 5: 确认 Counter Bridge 运行**
```bash
ps aux | grep counter_bridge
# 如未运行:
./gateway/build/counter_bridge ctp:config/ctp/ctp_td.yaml &
```

**步骤 6: 启动 Trader (实盘模式)**
```bash
cd golang
./trader -config config/trader.multi.test.yaml &
```

配置文件需设置:
```yaml
system:
  mode: "live"    # 实盘模式
```

**步骤 7: 打开 Dashboard**
```bash
open http://localhost:8080/dashboard.html
```

### 2.3 实盘配置

配置文件: `golang/config/trader.multi.test.yaml`

```yaml
system:
  mode: "live"

strategies:
  - id: "ag_pairwise"
    type: "pairwise_arb"
    symbols: ["ag2603", "ag2605"]   # 当前主力合约
    parameters:
      entry_zscore: 2.0             # 保守阈值
      min_correlation: 0.7

  - id: "au_pairwise"
    type: "pairwise_arb"
    symbols: ["au2604", "au2606"]
```

### 2.4 激活与监控

```bash
# 查看策略状态
curl http://localhost:9301/api/v1/dashboard/overview | jq

# 激活策略 (⚠️ 将发送真实订单)
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/activate

# 停止策略
curl -X POST http://localhost:9301/api/v1/strategies/ag_pairwise/deactivate
```

---

## 三、Dashboard 功能说明

### 3.1 总览区域

- 策略总数 / 激活数 / 运行数
- 总盈亏统计
- 运行模式 (simulation / live)

### 3.2 策略卡片

每个策略显示:
- 策略ID、类型、品种
- 运行/激活状态
- 实时指标 (Z-Score, 相关系数等)
- 持仓和盈亏
- 激活/停止按钮

### 3.3 条件高亮

当策略满足交易条件时:
- 卡片边框变为绿色
- 显示闪烁动画
- 条件: Z-Score > entry_threshold 且 correlation > min_correlation

### 3.4 自动刷新

- 默认每 5 秒刷新数据
- 可手动点击"刷新数据"按钮

---

## 四、常见问题

### Q1: Dashboard 显示"无法连接"

**解决方案:**
1. 确认 Trader 运行中: `lsof -i :9301`
2. 通过 HTTP 服务器访问: `http://localhost:8080/dashboard.html`
3. 检查端口配置是否为 9301

### Q2: 策略无指标数据

**解决方案:**
1. 检查行情网关: `ps aux | grep md_gateway`
2. 检查 NATS 消息: `nats sub "md.>"`
3. 确认合约配置与行情源一致

### Q3: 激活后无订单

**解决方案:**
1. 检查模式是否为 `live`
2. 检查 ORS Gateway: `lsof -i :50052`
3. 查看日志: `tail -f test_logs/trader_dashboard.log`

---

## 五、测试脚本

| 脚本 | 用途 |
|------|------|
| `test_dashboard_simulator.sh` | 模拟器 Dashboard 测试 |
| `test_full_chain.sh` | 完整链路测试 (单策略) |
| `test_multi_strategy_api.sh` | API 接口测试 |

---

## 六、清理测试环境

```bash
# 停止所有测试进程
pkill -f md_simulator
pkill -f md_gateway
pkill -f ors_gateway
pkill -f counter_gateway
pkill -f "trader.*dashboard"

# 清理共享内存 (如需要)
ipcs -m | grep $USER | awk '{print $2}' | xargs -I{} ipcrm -m {}
```

---

**最后更新**: 2026-01-29 00:05
