# MacåŸç”Ÿå¼€å‘æŒ‡å— - CTPè¡Œæƒ…æ¥å…¥

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-26
**é€‚ç”¨ç¯å¢ƒ**: MacOS (Intel & Apple Silicon)
**CTPç‰ˆæœ¬**: v6.7.7 Universal Binary

---

## ğŸ‰ å¥½æ¶ˆæ¯

CTPå®˜æ–¹æä¾›äº†**MacOSåŸç”Ÿç‰ˆæœ¬**ï¼Œæ”¯æŒUniversal Binary (x86_64 + arm64)ï¼Œå¯ä»¥ç›´æ¥åœ¨Macä¸Šå¼€å‘ï¼Œæ— éœ€Dockerï¼

---

## âœ… ç¯å¢ƒæ£€æŸ¥

### æ£€æŸ¥Macæ¶æ„

```bash
uname -m
# arm64  â†’ Apple Silicon (M1/M2/M3) âœ…
# x86_64 â†’ Intel Mac âœ…
```

### æ£€æŸ¥CTP Framework

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system/gateway/third_party/ctp

# æŸ¥çœ‹framework
ls -lh *.framework

# æ£€æŸ¥æ¶æ„æ”¯æŒ
file thostmduserapi_se.framework/Versions/A/thostmduserapi_se

# åº”è¾“å‡º:
# Mach-O universal binary with 2 architectures: [x86_64] [arm64]
```

---

## ğŸ”§ CMakeé…ç½®

### æ–¹å¼1: ä½¿ç”¨Frameworkï¼ˆæ¨èï¼‰

æ›´æ–°`gateway/CMakeLists.txt`ï¼š

```cmake
# æŸ¥æ‰¾CTP Framework (MacOS)
if(APPLE)
    set(CTP_FRAMEWORK_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/ctp)

    # æ£€æŸ¥Frameworkæ˜¯å¦å­˜åœ¨
    if(EXISTS "${CTP_FRAMEWORK_DIR}/thostmduserapi_se.framework")
        message(STATUS "Found CTP MD Framework (MacOS)")

        # CTPè¡Œæƒ…ç½‘å…³
        add_executable(ctp_md_gateway
            src/ctp_md_gateway.cpp
            src/main_ctp_md.cpp
        )

        target_include_directories(ctp_md_gateway PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/include
            ${CTP_FRAMEWORK_DIR}/include
        )

        # é“¾æ¥Framework
        target_link_libraries(ctp_md_gateway
            ${CTP_FRAMEWORK_DIR}/thostmduserapi_se.framework/thostmduserapi_se
            yaml-cpp
            pthread
        )

        # è®¾ç½®RPATH
        set_target_properties(ctp_md_gateway PROPERTIES
            BUILD_WITH_INSTALL_RPATH TRUE
            INSTALL_RPATH "@executable_path/../third_party/ctp"
        )

        install(TARGETS ctp_md_gateway DESTINATION ${CMAKE_SOURCE_DIR}/../bin)
    else()
        message(WARNING "CTP Framework not found, ctp_md_gateway will not be built")
    endif()
endif()
```

### æ–¹å¼2: åŠ¨æ€é“¾æ¥dylib

å¦‚æœä½¿ç”¨frameworké‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥é“¾æ¥dylibï¼š

```cmake
target_link_libraries(ctp_md_gateway
    ${CTP_FRAMEWORK_DIR}/thostmduserapi_se.framework/Versions/A/thostmduserapi_se
    yaml-cpp
    pthread
)
```

---

## ğŸš€ ç¼–è¯‘

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system/gateway

# åˆ›å»ºæ„å»ºç›®å½•
mkdir -p build && cd build

# é…ç½®
cmake ..

# ç¼–è¯‘CTPç½‘å…³ï¼ˆç­‰ä»£ç å†™å¥½åï¼‰
make ctp_md_gateway -j4

# æ£€æŸ¥ç¼–è¯‘äº§ç‰©
ls -lh ctp_md_gateway

# æ£€æŸ¥é“¾æ¥
otool -L ctp_md_gateway
```

---

## ğŸ§ª åˆ›å»ºæµ‹è¯•ç¨‹åº

åˆ›å»ºä¸€ä¸ªç®€å•çš„CTPè¿æ¥æµ‹è¯•ï¼š

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system/gateway

# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > test_ctp_mac.cpp << 'EOF'
#include "ThostFtdcMdApi.h"
#include <iostream>
#include <thread>
#include <chrono>

class TestSpi : public CThostFtdcMdSpi {
public:
    void OnFrontConnected() override {
        std::cout << "âœ… CTPè¿æ¥æˆåŠŸï¼" << std::endl;
        std::cout << "å¼€å§‹ç™»å½•..." << std::endl;

        CThostFtdcReqUserLoginField req = {};
        strncpy(req.BrokerID, "9999", sizeof(req.BrokerID));
        strncpy(req.UserID, "YOUR_USER_ID", sizeof(req.UserID));
        strncpy(req.Password, "YOUR_PASSWORD", sizeof(req.Password));

        m_api->ReqUserLogin(&req, 1);
    }

    void OnFrontDisconnected(int nReason) override {
        std::cerr << "âŒ CTPæ–­å¼€è¿æ¥ï¼ŒåŸå› : " << nReason << std::endl;
    }

    void OnRspUserLogin(CThostFtdcRspUserLoginField* pRspUserLogin,
                        CThostFtdcRspInfoField* pRspInfo,
                        int nRequestID, bool bIsLast) override {
        if (pRspInfo && pRspInfo->ErrorID != 0) {
            std::cerr << "âŒ ç™»å½•å¤±è´¥: " << pRspInfo->ErrorMsg << std::endl;
        } else {
            std::cout << "âœ… ç™»å½•æˆåŠŸï¼" << std::endl;
            std::cout << "äº¤æ˜“æ—¥: " << (pRspUserLogin ? pRspUserLogin->TradingDay : "N/A") << std::endl;

            // è®¢é˜…è¡Œæƒ…
            char* instruments[] = {(char*)"ag2505"};
            m_api->SubscribeMarketData(instruments, 1);
            std::cout << "å·²è®¢é˜…: ag2505" << std::endl;
        }
    }

    void OnRspSubMarketData(CThostFtdcSpecificInstrumentField* pSpecificInstrument,
                           CThostFtdcRspInfoField* pRspInfo,
                           int nRequestID, bool bIsLast) override {
        if (pRspInfo && pRspInfo->ErrorID != 0) {
            std::cerr << "âŒ è®¢é˜…å¤±è´¥: " << pRspInfo->ErrorMsg << std::endl;
        } else {
            std::cout << "âœ… è®¢é˜…æˆåŠŸ: " << (pSpecificInstrument ? pSpecificInstrument->InstrumentID : "N/A") << std::endl;
        }
    }

    void OnRtnDepthMarketData(CThostFtdcDepthMarketDataField* pDepthMarketData) override {
        if (!pDepthMarketData) return;

        std::cout << "\nğŸ“Š æ”¶åˆ°è¡Œæƒ…æ•°æ®:" << std::endl;
        std::cout << "  åˆçº¦: " << pDepthMarketData->InstrumentID << std::endl;
        std::cout << "  æœ€æ–°ä»·: " << pDepthMarketData->LastPrice << std::endl;
        std::cout << "  ä¹°ä¸€ä»·: " << pDepthMarketData->BidPrice1 << " x " << pDepthMarketData->BidVolume1 << std::endl;
        std::cout << "  å–ä¸€ä»·: " << pDepthMarketData->AskPrice1 << " x " << pDepthMarketData->AskVolume1 << std::endl;
        std::cout << "  æ—¶é—´: " << pDepthMarketData->UpdateTime << "." << pDepthMarketData->UpdateMillisec << std::endl;

        m_count++;
        if (m_count >= 10) {
            std::cout << "\nâœ… å·²æ¥æ”¶10æ¡è¡Œæƒ…ï¼Œæµ‹è¯•é€šè¿‡ï¼" << std::endl;
            m_should_exit = true;
        }
    }

    void SetAPI(CThostFtdcMdApi* api) { m_api = api; }
    bool ShouldExit() const { return m_should_exit; }

private:
    CThostFtdcMdApi* m_api = nullptr;
    int m_count = 0;
    bool m_should_exit = false;
};

int main() {
    std::cout << R"(
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         CTPè¡Œæƒ…APIæµ‹è¯• - MacOSåŸç”Ÿç‰ˆæœ¬              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
)" << std::endl;

    // åˆ›å»ºAPIå®ä¾‹
    std::cout << "æ­£åœ¨åˆ›å»ºCTP APIå®ä¾‹..." << std::endl;
    CThostFtdcMdApi* api = CThostFtdcMdApi::CreateFtdcMdApi("./ctp_flow/");

    // åˆ›å»ºå›è°ƒå¤„ç†
    TestSpi spi;
    spi.SetAPI(api);
    api->RegisterSpi(&spi);

    // è¿æ¥CTPå‰ç½®ï¼ˆSimNow 7x24ç¯å¢ƒï¼‰
    std::cout << "æ­£åœ¨è¿æ¥CTPå‰ç½®..." << std::endl;
    api->RegisterFront((char*)"tcp://180.168.146.187:10211");
    api->Init();

    // ç­‰å¾…é€€å‡º
    while (!spi.ShouldExit()) {
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }

    std::cout << "\næ­£åœ¨é‡Šæ”¾èµ„æº..." << std::endl;
    api->Release();

    std::cout << "å†è§ï¼" << std::endl;
    return 0;
}
EOF

echo "âœ… æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ"
```

### ç¼–è¯‘æµ‹è¯•ç¨‹åº

```bash
# è®¾ç½®Frameworkè·¯å¾„
CTP_DIR=/Users/user/PWorks/RD/quantlink-trade-system/gateway/third_party/ctp

# ç¼–è¯‘
clang++ -std=c++11 test_ctp_mac.cpp -o test_ctp \
    -I$CTP_DIR/include \
    -F$CTP_DIR \
    -framework thostmduserapi_se \
    -Wl,-rpath,$CTP_DIR/thostmduserapi_se.framework/Versions/A

# æˆ–ä½¿ç”¨ç›´æ¥é“¾æ¥
clang++ -std=c++11 test_ctp_mac.cpp -o test_ctp \
    -I$CTP_DIR/include \
    $CTP_DIR/thostmduserapi_se.framework/Versions/A/thostmduserapi_se \
    -Wl,-rpath,$CTP_DIR/thostmduserapi_se.framework/Versions/A

# è¿è¡Œæµ‹è¯•
./test_ctp
```

**é¢„æœŸè¾“å‡º**:
```
âœ… CTPè¿æ¥æˆåŠŸï¼
âœ… ç™»å½•æˆåŠŸï¼
âœ… è®¢é˜…æˆåŠŸ: ag2505
ğŸ“Š æ”¶åˆ°è¡Œæƒ…æ•°æ®:
  åˆçº¦: ag2505
  æœ€æ–°ä»·: 5080.0
  ...
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### ä½¿ç”¨LLDBè°ƒè¯•

```bash
# å¯åŠ¨è°ƒè¯•
lldb ./test_ctp

# LLDBå‘½ä»¤
(lldb) breakpoint set --name main
(lldb) run
(lldb) next
(lldb) print variable
(lldb) continue
(lldb) quit
```

### ä½¿ç”¨Instrumentsæ€§èƒ½åˆ†æ

```bash
# æ—¶é—´åˆ†æ
instruments -t "Time Profiler" ./test_ctp

# å†…å­˜æ³„æ¼æ£€æŸ¥
instruments -t "Leaks" ./test_ctp
```

### æŸ¥çœ‹åŠ¨æ€åº“ä¾èµ–

```bash
otool -L ./test_ctp

# åº”è¾“å‡º:
# @rpath/thostmduserapi_se (compatibility version 0.0.0)
# /usr/lib/libSystem.B.dylib
# /usr/lib/libc++.1.dylib
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: dyld: Library not loaded

**é”™è¯¯**:
```
dyld: Library not loaded: @rpath/thostmduserapi_se
```

**è§£å†³**:
```bash
# è®¾ç½®RPATH
install_name_tool -add_rpath /Users/user/PWorks/RD/quantlink-trade-system/gateway/third_party/ctp/thostmduserapi_se.framework/Versions/A ./test_ctp

# æˆ–åœ¨ç¼–è¯‘æ—¶æŒ‡å®š
-Wl,-rpath,@executable_path/../third_party/ctp/thostmduserapi_se.framework/Versions/A
```

### Q2: æƒé™é—®é¢˜

**é”™è¯¯**:
```
App is not allowed to access network
```

**è§£å†³**:
åœ¨macOS Catalina+ï¼Œéœ€è¦æˆäºˆç½‘ç»œæƒé™ï¼š
- ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ éšç§ â†’ å®Œå…¨ç£ç›˜è®¿é—®
- æ·»åŠ æ‚¨çš„Terminalæˆ–IDE

### Q3: ç­¾åé—®é¢˜

**é”™è¯¯**:
```
code signature invalid
```

**è§£å†³**:
```bash
# ç§»é™¤ç­¾åé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
codesign --remove-signature ./test_ctp

# æˆ–è€…é‡æ–°ç­¾å
codesign --force --deep --sign - ./test_ctp
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| ç¯å¢ƒ | ç¼–è¯‘æ—¶é—´ | è¿è¡Œæ€§èƒ½ | è°ƒè¯•ä¾¿åˆ©æ€§ |
|------|----------|----------|------------|
| **MacOSåŸç”Ÿ** | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… |
| Docker (Linux) | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |

**ç»“è®º**: MacOSåŸç”Ÿå¼€å‘ä½“éªŒæœ€ä½³ï¼Œæ¨èä½¿ç”¨ï¼

---

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨å¯ä»¥å¼€å§‹ä»»åŠ¡#1çš„å®é™…å¼€å‘äº†ï¼š

1. âœ… CTP SDKå·²å®‰è£…ï¼ˆMacOSåŸç”Ÿï¼‰
2. âœ… æµ‹è¯•ç¨‹åºå¯ä»¥ç¼–è¯‘è¿è¡Œ
3. â³ ç”³è¯·SimNowæµ‹è¯•è´¦å·
4. â³ å¼€å§‹ç¼–å†™`ctp_md_gateway`ä»£ç 

å‚è€ƒå®æ–½æŒ‡å—ï¼š
- `docs/ä»»åŠ¡1_CTPè¡Œæƒ…æ¥å…¥å®æ–½æŒ‡å—_2026-01-26-15_40.md`

---

## ğŸ”— ç›¸å…³èµ„æº

- [CTP APIæ–‡æ¡£](http://www.sfit.com.cn/)
- [SimNowä»¿çœŸå¹³å°](https://www.simnow.com.cn/)
- [ä»»åŠ¡è·Ÿè¸ª TASKS.md](/Users/user/PWorks/RD/quantlink-trade-system/TASKS.md)

---

**æœ€åæ›´æ–°**: 2026-01-26 16:15
**ç¯å¢ƒ**: MacOS (Intel & Apple Silicon)
