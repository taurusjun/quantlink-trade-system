# 回测参数优化使用指南

**文档日期**: 2026-01-24 20:30
**版本**: v1.0
**状态**: ✅ **Phase 3 完成**

---

## 概述

参数优化模块（Phase 3）提供了从回测优化到生产部署的完整工作流，借鉴了旧系统 Control + Model 机制的成功经验。

### 核心功能

- ✅ **网格搜索优化** - 自动搜索最优参数组合
- ✅ **并行计算** - 多核并行加速优化过程
- ✅ **参数持久化** - 保存优化结果为 YAML 文件
- ✅ **历史追踪** - 归档参数演进历史
- ✅ **生产部署** - 一键生成生产配置文件
- ✅ **兼容旧系统** - 生成 Control + Model 文件格式

---

## 工作流

```
┌─────────────────┐
│  1. 参数优化     │  Grid Search 搜索最优参数组合
│  (optimize)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 结果导出     │  导出最优参数为 YAML 文件
│  (auto)         │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 生产配置     │  生成 trader.yaml, control, model 等
│  (export)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  4. 启动交易     │  运行生成的启动脚本
│  (deploy)       │
└─────────────────┘
```

---

## 1. 参数优化（Grid Search）

### 基本用法

```bash
./bin/backtest_optimize \
  -action optimize \
  -config config/backtest.yaml \
  -params "entry_zscore:1.5:3.0:0.1,exit_zscore:0.5:1.5:0.1" \
  -goal sharpe \
  -workers 8
```

### 参数说明

| 参数 | 说明 | 示例 |
|------|------|------|
| `-config` | 回测配置文件 | `config/backtest.yaml` |
| `-params` | 优化参数范围 | `name:min:max:step` |
| `-goal` | 优化目标 | `sharpe`, `pnl`, `win_rate` |
| `-workers` | 并行工作数 | `8` (建议 CPU 核心数) |
| `-output` | 输出目录 | `backtest_results/optimal_params` |
| `-top` | 导出Top N结果 | `10` |

### 优化目标

- `sharpe` - Sharpe Ratio（默认，推荐）
- `pnl` - 总盈亏
- `win_rate` - 胜率
- `profit_factor` - 盈亏比
- `calmar` - Calmar Ratio

### 参数格式

```bash
# 格式: name:min:max:step
-params "entry_zscore:1.5:3.0:0.1"

# 多个参数用逗号分隔
-params "entry_zscore:1.5:3.0:0.1,exit_zscore:0.5:1.5:0.1,lookback_window:60:240:20"

# 整数参数（step >= 1）
-params "position_size:1:10:1"
```

### 输出文件

```
backtest_results/optimal_params/
├── optimization_results_ag2502_ag2504_20260124_153045.yaml  # 所有测试结果
├── optimal_params_ag2502_ag2504_20260124.yaml               # Top 1 最优参数
├── optimal_params_ag2502_ag2504_20260124.yaml               # Top 2
└── ...
```

### 示例输出

```
[Optimizer] Starting grid search optimization...
[Optimizer] Optimization goal: sharpe
[Optimizer] Max workers: 8
[Optimizer] Total parameter combinations: 256
[Optimizer] Progress: 128/256 (50.0%) - Score: 2.3456
...
[Optimizer] Grid search completed in 15m32s
[Optimizer] Successful tests: 256/256

[Optimizer] Top 5 parameter combinations:
  #1: Score=2.4567, Sharpe=2.46, PNL=125600.00, Params=map[entry_zscore:2.1 exit_zscore:0.8]
  #2: Score=2.3891, Sharpe=2.39, PNL=118900.00, Params=map[entry_zscore:2.0 exit_zscore:0.7]
  ...

========================================
Best Parameter Combination
========================================
Optimization Score: 2.4567
Sharpe Ratio:       2.4567
Total PNL:          125600.00
Max Drawdown:       -0.0823
Win Rate:           67.34%
Profit Factor:      2.12
Total Trades:       158

Optimal Parameters:
  entry_zscore        : 2.1
  exit_zscore         : 0.8
  lookback_window     : 120
========================================
```

---

## 2. 生产配置导出

### 基本用法

```bash
./bin/backtest_optimize \
  -action export \
  -current backtest_results/optimal_params/optimal_params_ag2502_ag2504_20260124.yaml \
  -strategy-id 92201 \
  -output production_configs
```

### 生成的文件

```
production_configs/
├── config/
│   └── trader_92201_optimized_20260124.yaml    # Trader 配置文件（新系统）
├── controls/
│   └── control.ag2502.ag2504.par.txt.92201     # Control 文件（旧系统格式）
├── models/
│   └── model.ag2502.ag2504.par.txt.92201       # Model 文件（旧系统格式）
└── scripts/
    └── start_ag2502_ag2504.sh                   # 启动脚本
```

### trader.yaml 示例

```yaml
system:
  strategy_id: "92201"
  mode: "simulation"  # 默认仿真模式，生产改为 "live"

strategy:
  type: "pairwise_arb"
  symbols: ["ag2502", "ag2504"]
  parameters:
    entry_zscore: 2.1      # 优化后的参数
    exit_zscore: 0.8
    lookback_window: 120
    position_size: 4
  max_position_size: 10
  max_exposure: 1000000.0

session:
  start_time: "09:00:00"
  end_time: "15:00:00"
  timezone: "Asia/Shanghai"
  auto_activate: false     # 需要手动激活（安全）

risk:
  stop_loss: 100000
  max_loss: 100000
  max_drawdown: 0.1235     # 回测最大回撤 * 1.5
  daily_loss_limit: 12560  # 总盈利 * 10%

engine:
  ors_gateway_addr: "localhost:50051"
  nats_addr: "nats://localhost:4222"

api:
  enabled: true
  port: 9201
```

### Model 文件示例（兼容旧系统）

```
ag_F_2_SFE FUTCOM Dependant 0 MID_PX
ag_F_4_SFE FUTCOM Dependant 0 MID_PX
MAX_QUOTE_LEVEL 3
SIZE 4
MAX_SIZE 16
BEGIN_PLACE 2.100000
LONG_PLACE 3.150000
SHORT_PLACE 1.050000
BEGIN_REMOVE 0.800000
LONG_REMOVE 1.200000
SHORT_REMOVE 0.400000
CROSS 3
SUPPORTING_ORDERS 2
UPNL_LOSS 100000
STOP_LOSS 100000
MAX_LOSS 100000
ALPHA 0.0000240672
AVG_SPREAD_AWAY 24
```

### 启动脚本示例

```bash
#!/bin/bash
# Auto-generated start script from backtest optimization
# Generated: 2026-01-24 20:30:00
# Optimization goal: sharpe
# Sharpe Ratio: 2.46

# Check if NATS is running
if ! pgrep -x "nats-server" > /dev/null; then
    echo "Starting NATS server..."
    nats-server &
    sleep 2
fi

# Start trader
echo "Starting trader for ag2502/ag2504 (Strategy 92201)..."
nohup ./bin/trader -config config/trader_92201_optimized_20260124.yaml > log/nohup_92201.out 2>&1 &

# Display process info
sleep 2
echo "Trader started. PID: $(pgrep -f trader | tail -1)"
echo "Log file: log/trader_92201.log"
echo "API endpoint: http://localhost:9201"
echo ""
echo "To activate strategy, run:"
echo "  curl -X POST http://localhost:9201/api/v1/strategy/activate"
```

---

## 3. 参数对比

### 基本用法

```bash
./bin/backtest_optimize \
  -action compare \
  -baseline backtest_results/optimal_params/archive/optimal_params_ag2502_ag2504_20260115.yaml \
  -current backtest_results/optimal_params/optimal_params_ag2502_ag2504_20260124.yaml
```

### 输出示例

```
Parameter Comparison
===================

Strategy: pairwise_arb
Symbols: [ag2502 ag2504]

Performance Metrics:
  Sharpe Ratio:      2.1234 -> 2.4567 (15.69%)
  Total PNL:         118900.00 -> 125600.00 (5.63%)
  Max Drawdown:      -0.0856 -> -0.0823
  Win Rate:          65.23% -> 67.34%

Parameter Changes:
  entry_zscore        : 2.0 -> 2.1
  exit_zscore         : 0.7 -> 0.8
  lookback_window     : 100 -> 120
```

---

## 4. 完整工作流示例

### 步骤 1: 参数优化

```bash
# 1. 优化 entry_zscore 和 exit_zscore
./bin/backtest_optimize \
  -action optimize \
  -config config/backtest.yaml \
  -params "entry_zscore:1.5:3.0:0.1,exit_zscore:0.5:1.5:0.1" \
  -goal sharpe \
  -workers 8 \
  -top 5

# 输出:
# backtest_results/optimal_params/optimal_params_ag2502_ag2504_20260124.yaml
```

### 步骤 2: 导出生产配置

```bash
# 2. 生成生产配置文件
./bin/backtest_optimize \
  -action export \
  -current backtest_results/optimal_params/optimal_params_ag2502_ag2504_20260124.yaml \
  -strategy-id 92201 \
  -output production_configs

# 输出:
# production_configs/trader_92201_optimized_20260124.yaml
# production_configs/controls/control.ag2502.ag2504.par.txt.92201
# production_configs/models/model.ag2502.ag2504.par.txt.92201
# production_configs/scripts/start_ag2502_ag2504.sh
```

### 步骤 3: 部署到生产

```bash
# 3. 复制配置文件到生产目录
cp production_configs/config/trader_92201_optimized_20260124.yaml config/

# 4. 启动交易（仿真模式）
./bin/trader -config config/trader_92201_optimized_20260124.yaml

# 5. 等待启动完成（约5秒）
sleep 5

# 6. 手动激活策略
curl -X POST http://localhost:9201/api/v1/strategy/activate \
  -H "Content-Type: application/json" \
  -d '{"strategy_id": "92201"}'

# 7. 监控运行
tail -f log/trader_92201.log
```

### 步骤 4: 归档参数

```bash
# 定期归档优化参数
mkdir -p backtest_results/optimal_params/archive
cp backtest_results/optimal_params/optimal_params_ag2502_ag2504_20260124.yaml \
   backtest_results/optimal_params/archive/optimal_params_ag2502_ag2504_20260124_sharpe2.46.yaml
```

---

## 5. 高级用法

### 多参数优化

```bash
# 同时优化 4 个参数
./bin/backtest_optimize \
  -action optimize \
  -params "entry_zscore:1.5:3.0:0.2,\
exit_zscore:0.5:1.5:0.2,\
lookback_window:60:240:30,\
position_size:2:8:2" \
  -goal sharpe \
  -workers 16
```

**注意**: 参数组合数量 = (n1 × n2 × n3 × ...)
- 示例: (8 × 6 × 7 × 4) = **1,344** 次回测

### 批量日期优化

```bash
# 对多个日期进行优化
for date in 2026-01-{01..31}; do
  ./bin/backtest_optimize \
    -action optimize \
    -config config/backtest.yaml \
    -params "entry_zscore:1.5:3.0:0.1" \
    -goal sharpe \
    -workers 8 \
    -output "optimization_history/${date}"
done
```

### 参数稳定性测试

```bash
# Walk-forward 测试
# 1. 训练集优化（2025-01-01 to 2025-12-31）
./bin/backtest_optimize \
  -action optimize \
  -config config/backtest_train.yaml \
  -params "entry_zscore:1.5:3.0:0.1" \
  -goal sharpe

# 2. 测试集验证（2026-01-01 to 2026-01-31）
./bin/backtest \
  -config config/backtest_test.yaml \
  -start-date 2026-01-01 \
  -end-date 2026-01-31
```

---

## 6. 最佳实践

### ✅ 推荐做法

1. **参数范围合理** - 不要设置过大的搜索范围
   ```bash
   # ✅ 好: 合理范围
   -params "entry_zscore:1.5:3.0:0.1"

   # ❌ 差: 范围过大
   -params "entry_zscore:0.1:10.0:0.01"  # 990次测试
   ```

2. **使用并行计算** - 充分利用 CPU 核心
   ```bash
   # 查看 CPU 核心数
   sysctl -n hw.ncpu

   # 使用 80% 核心
   -workers 8  # 假设10核心
   ```

3. **定期归档参数** - 保持参数演进历史
   ```bash
   backtest_results/optimal_params/
   ├── current/              # 当前生产参数
   └── archive/              # 历史参数（带日期和score）
       ├── 20260115_sharpe2.12.yaml
       ├── 20260120_sharpe2.34.yaml
       └── 20260124_sharpe2.46.yaml
   ```

4. **先仿真再实盘** - 使用 simulation 模式验证
   ```yaml
   system:
     mode: "simulation"  # 先仿真验证
   ```

5. **保守的风控参数** - 留出安全边际
   ```yaml
   risk:
     max_drawdown: 0.1235    # 回测 * 1.5
     daily_loss_limit: 12560  # 总盈利 * 10%
   ```

### ❌ 避免的错误

1. **过度拟合** - 参数过于精细
   ```bash
   # ❌ 差: 步长太小，容易过拟合
   -params "entry_zscore:1.5:3.0:0.001"  # 1500次测试

   # ✅ 好: 合理步长
   -params "entry_zscore:1.5:3.0:0.1"    # 16次测试
   ```

2. **忽略样本外验证** - 只在训练集优化
3. **盲目追求高指标** - 关注稳定性而非单一指标
4. **跳过仿真直接实盘** - 高风险

---

## 7. 性能参考

### 优化速度

| 参数组合数 | 并行数 | 每次回测时间 | 总耗时（估算） |
|-----------|-------|-------------|--------------|
| 100       | 4     | 10s         | 4.2分钟      |
| 256       | 8     | 10s         | 5.3分钟      |
| 1,000     | 16    | 10s         | 10.4分钟     |
| 10,000    | 16    | 10s         | 1.7小时      |

**建议**:
- 首次粗粒度搜索（大步长）
- 在最优区域细化搜索（小步长）

---

## 8. 故障排查

### 问题: 优化太慢

```bash
# 解决: 增加并行数或减少参数组合
-workers 16  # 增加并行
-params "entry_zscore:1.5:3.0:0.2"  # 增大步长（减少组合数）
```

### 问题: 所有结果都不好

```bash
# 检查: 参数范围是否合理
# 扩大搜索范围
-params "entry_zscore:1.0:4.0:0.2"

# 或更换优化目标
-goal pnl  # 从 sharpe 改为 pnl
```

### 问题: 生成的配置文件不可用

```bash
# 检查: optimal_params 文件是否有效
./bin/backtest_optimize \
  -action compare \
  -baseline optimal_params/current.yaml \
  -current optimal_params/current.yaml
```

---

## 9. 相关文档

- [回测系统实施方案](系统_回测系统实施方案_2026-01-24-18_30.md)
- [回测使用指南](回测_使用指南_2026-01-24-19_00.md)
- [Trader 集成说明](回测_集成说明_2026-01-24-19_30.md)

---

**文档版本**: v1.0
**最后更新**: 2026-01-24 20:30
**优先级**: P1（生产必备）
