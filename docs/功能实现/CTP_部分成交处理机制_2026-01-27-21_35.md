# CTPéƒ¨åˆ†æˆäº¤å¤„ç†æœºåˆ¶

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-27
**ä½œè€…**: QuantLink Team
**ç‰ˆæœ¬**: v1.0

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜CTPäº¤æ˜“æ’ä»¶å¦‚ä½•å¤„ç†éƒ¨åˆ†æˆäº¤ï¼ˆPartial Fillï¼‰çš„æƒ…å†µï¼ŒåŒ…æ‹¬çŠ¶æ€è½¬æ¢ã€å›è°ƒæœºåˆ¶å’Œæ•°æ®ç»“æ„ã€‚

---

## ğŸ”„ è®¢å•çŠ¶æ€æšä¸¾

### OrderStatus å®šä¹‰

ä½ç½®: `gateway/include/plugin/td_plugin_interface.h`

```cpp
enum class OrderStatus {
    UNKNOWN = 0,        // æœªçŸ¥
    SUBMITTING = 1,     // æäº¤ä¸­
    SUBMITTED = 2,      // å·²æäº¤
    ACCEPTED = 3,       // å·²æ¥å—ï¼ˆåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æˆäº¤ï¼‰
    PARTIAL_FILLED = 4, // éƒ¨åˆ†æˆäº¤ â­
    FILLED = 5,         // å…¨éƒ¨æˆäº¤
    CANCELING = 6,      // æ’¤å•ä¸­
    CANCELED = 7,       // å·²æ’¤å•
    REJECTED = 8,       // å·²æ‹’ç»
    ERROR = 9           // é”™è¯¯
};
```

**å…³é”®çŠ¶æ€**ï¼š
- `ACCEPTED (3)`: è®¢å•å·²è¢«äº¤æ˜“æ‰€æ¥å—ï¼Œåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æˆäº¤
- `PARTIAL_FILLED (4)`: è®¢å•éƒ¨åˆ†æˆäº¤ï¼Œå‰©ä½™éƒ¨åˆ†ä»åœ¨é˜Ÿåˆ—ä¸­
- `FILLED (5)`: è®¢å•å…¨éƒ¨æˆäº¤

---

## ğŸ“Š è®¢å•ä¿¡æ¯ç»“æ„

### OrderInfo å­—æ®µ

```cpp
struct OrderInfo {
    char order_id[64];          // ç³»ç»Ÿè®¢å•ID
    char symbol[32];            // åˆçº¦ä»£ç 
    OrderDirection direction;   // ä¹°å–æ–¹å‘
    OffsetFlag offset;          // å¼€å¹³æ ‡å¿—
    double price;               // ä»·æ ¼
    uint32_t volume;            // æ€»æ•°é‡ â­
    uint32_t traded_volume;     // å·²æˆäº¤æ•°é‡ â­
    OrderStatus status;         // è®¢å•çŠ¶æ€
    // ...å…¶ä»–å­—æ®µ
};
```

**å…³é”®å­—æ®µ**ï¼š
- `volume`: è®¢å•æ€»æ•°é‡ï¼ˆä¸å˜ï¼‰
- `traded_volume`: å·²æˆäº¤æ•°é‡ï¼ˆç´¯è®¡å¢åŠ ï¼‰
- `status`: å½“å‰è®¢å•çŠ¶æ€

**éƒ¨åˆ†æˆäº¤åˆ¤æ–­**ï¼š
```
å¦‚æœ traded_volume > 0 ä¸” traded_volume < volumeï¼Œåˆ™ä¸ºéƒ¨åˆ†æˆäº¤
```

---

## ğŸ”” CTPå›è°ƒæœºåˆ¶

### 1. OnRtnOrder - è®¢å•çŠ¶æ€å›è°ƒ

**ä½ç½®**: `gateway/plugins/ctp/src/ctp_td_plugin.cpp:624`

```cpp
void CTPTDPlugin::OnRtnOrder(CThostFtdcOrderField* pOrder) {
    if (!pOrder) return;

    // è½¬æ¢è®¢å•ä¿¡æ¯
    OrderInfo order_info;
    ConvertOrder(pOrder, order_info);

    // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
    SaveOrder(order_info.order_id, order_info);

    // æ‰“å°è®¢å•æ›´æ–°ä¿¡æ¯
    std::cout << "[CTPTDPlugin] Order update: " << order_info.order_id
              << " status=" << static_cast<int>(order_info.status)
              << " traded=" << order_info.traded_volume << "/" << order_info.volume
              << std::endl;

    // è§¦å‘è®¢å•å›è°ƒ
    if (m_order_callback) {
        m_order_callback(order_info);
    }
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
- è®¢å•æäº¤æˆåŠŸ
- è®¢å•çŠ¶æ€å˜åŒ–ï¼ˆæ¥å—ã€éƒ¨åˆ†æˆäº¤ã€å…¨éƒ¨æˆäº¤ã€æ’¤å•ç­‰ï¼‰
- **æ¯æ¬¡éƒ¨åˆ†æˆäº¤éƒ½ä¼šè§¦å‘ä¸€æ¬¡å›è°ƒ** â­

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
[CTPTDPlugin] Order update: 1--1111719863-000000000002 status=3 traded=0/1
[CTPTDPlugin] Order update: 1--1111719863-000000000002 status=4 traded=1/3  // éƒ¨åˆ†æˆäº¤
[CTPTDPlugin] Order update: 1--1111719863-000000000002 status=4 traded=2/3  // å†æ¬¡éƒ¨åˆ†æˆäº¤
[CTPTDPlugin] Order update: 1--1111719863-000000000002 status=5 traded=3/3  // å…¨éƒ¨æˆäº¤
```

---

### 2. OnRtnTrade - æˆäº¤å›æŠ¥å›è°ƒ

**ä½ç½®**: `gateway/plugins/ctp/src/ctp_td_plugin.cpp:647`

```cpp
void CTPTDPlugin::OnRtnTrade(CThostFtdcTradeField* pTrade) {
    if (!pTrade) return;

    // è½¬æ¢æˆäº¤ä¿¡æ¯
    TradeInfo trade_info;
    ConvertTrade(pTrade, trade_info);

    std::cout << "[CTPTDPlugin] Trade: " << trade_info.trade_id
              << " " << trade_info.symbol
              << " " << (trade_info.direction == OrderDirection::BUY ? "BUY" : "SELL")
              << " " << trade_info.volume << "@" << trade_info.price << std::endl;

    m_trade_count.fetch_add(1);

    // è§¦å‘æˆäº¤å›è°ƒ
    if (m_trade_callback) {
        m_trade_callback(trade_info);
    }
}
```

**è°ƒç”¨æ—¶æœº**ï¼š
- **æ¯ç¬”æˆäº¤éƒ½ä¼šè§¦å‘ä¸€æ¬¡å›è°ƒ** â­
- å³ä½¿æ˜¯éƒ¨åˆ†æˆäº¤ï¼Œæ¯æ¬¡æˆäº¤çš„éƒ¨åˆ†éƒ½ä¼šå•ç‹¬å›è°ƒ

**ç¤ºä¾‹è¾“å‡º**ï¼ˆä¸€ä¸ª3æ‰‹è®¢å•åˆ†3æ¬¡æˆäº¤ï¼‰ï¼š
```
[CTPTDPlugin] Trade: 123456 ag2603 SELL 1@29600
[CTPTDPlugin] Trade: 123457 ag2603 SELL 1@29600
[CTPTDPlugin] Trade: 123458 ag2603 SELL 1@29600
```

---

## ğŸ”„ çŠ¶æ€è½¬æ¢é€»è¾‘

### ConvertOrder å‡½æ•°

**ä½ç½®**: `gateway/plugins/ctp/src/ctp_td_plugin.cpp:965`

```cpp
// è®¢å•çŠ¶æ€è½¬æ¢
switch (ctp_order->OrderStatus) {
    case THOST_FTDC_OST_AllTraded:
        order_info.status = OrderStatus::FILLED;        // å…¨éƒ¨æˆäº¤
        break;
    case THOST_FTDC_OST_PartTradedQueueing:
        order_info.status = OrderStatus::PARTIAL_FILLED; // éƒ¨åˆ†æˆäº¤ â­
        break;
    case THOST_FTDC_OST_NoTradeQueueing:
        order_info.status = OrderStatus::ACCEPTED;      // æœªæˆäº¤åœ¨é˜Ÿåˆ—ä¸­
        break;
    case THOST_FTDC_OST_Canceled:
        order_info.status = OrderStatus::CANCELED;      // å·²æ’¤å•
        break;
    default:
        order_info.status = OrderStatus::UNKNOWN;
}

// æˆäº¤æ•°é‡
order_info.volume = ctp_order->VolumeTotalOriginal;  // æ€»æ•°é‡
order_info.traded_volume = ctp_order->VolumeTraded;   // å·²æˆäº¤æ•°é‡ â­
```

**CTPçŠ¶æ€æ˜ å°„**ï¼š
- `THOST_FTDC_OST_NoTradeQueueing` â†’ `ACCEPTED` (æœªæˆäº¤)
- `THOST_FTDC_OST_PartTradedQueueing` â†’ `PARTIAL_FILLED` (éƒ¨åˆ†æˆäº¤) â­
- `THOST_FTDC_OST_AllTraded` â†’ `FILLED` (å…¨éƒ¨æˆäº¤)

---

## ğŸ“ˆ éƒ¨åˆ†æˆäº¤çš„å®Œæ•´æµç¨‹

### åœºæ™¯ï¼šä¸‹å•3æ‰‹ï¼Œåˆ†3æ¬¡æˆäº¤

```
1. æäº¤è®¢å•
   â†“
   OnRtnOrder: status=ACCEPTED, traded=0/3

2. ç¬¬ä¸€ç¬”æˆäº¤ï¼ˆ1æ‰‹ï¼‰
   â†“
   OnRtnTrade: volume=1 @ 29600    // æˆäº¤å›æŠ¥
   â†“
   OnRtnOrder: status=PARTIAL_FILLED, traded=1/3  // è®¢å•çŠ¶æ€æ›´æ–° â­

3. ç¬¬äºŒç¬”æˆäº¤ï¼ˆ1æ‰‹ï¼‰
   â†“
   OnRtnTrade: volume=1 @ 29600
   â†“
   OnRtnOrder: status=PARTIAL_FILLED, traded=2/3  // ä»æ˜¯éƒ¨åˆ†æˆäº¤ â­

4. ç¬¬ä¸‰ç¬”æˆäº¤ï¼ˆ1æ‰‹ï¼‰
   â†“
   OnRtnTrade: volume=1 @ 29600
   â†“
   OnRtnOrder: status=FILLED, traded=3/3         // å…¨éƒ¨æˆäº¤ âœ…
```

---

## ğŸ’¡ éƒ¨åˆ†æˆäº¤çš„å¤„ç†å»ºè®®

### 1. ç›‘æ§è®¢å•çŠ¶æ€

**æ–¹æ³•1ï¼šé€šè¿‡è®¢å•å›è°ƒ**

```cpp
void MyOrderCallback(const OrderInfo& order) {
    if (order.status == OrderStatus::PARTIAL_FILLED) {
        uint32_t remaining = order.volume - order.traded_volume;
        std::cout << "éƒ¨åˆ†æˆäº¤: " << order.symbol
                  << " å·²æˆäº¤=" << order.traded_volume
                  << " å‰©ä½™=" << remaining << std::endl;

        // å¯ä»¥é€‰æ‹©ï¼š
        // 1. ç­‰å¾…å‰©ä½™éƒ¨åˆ†æˆäº¤
        // 2. æ’¤é”€å‰©ä½™éƒ¨åˆ†
        // 3. è°ƒæ•´ç­–ç•¥
    }
}
```

**æ–¹æ³•2ï¼šç´¯è®¡æˆäº¤é‡**

```cpp
std::map<std::string, uint32_t> total_traded;

void MyTradeCallback(const TradeInfo& trade) {
    total_traded[trade.order_id] += trade.volume;
    std::cout << "è®¢å• " << trade.order_id
              << " ç´¯è®¡æˆäº¤: " << total_traded[trade.order_id] << std::endl;
}
```

---

### 2. æ’¤é”€éƒ¨åˆ†æˆäº¤çš„å‰©ä½™è®¢å•

å¦‚æœä¸æƒ³ç­‰å¾…å‰©ä½™éƒ¨åˆ†æˆäº¤ï¼Œå¯ä»¥æ’¤å•ï¼š

```cpp
void HandlePartialFill(const OrderInfo& order) {
    if (order.status == OrderStatus::PARTIAL_FILLED) {
        uint32_t remaining = order.volume - order.traded_volume;

        std::cout << "éƒ¨åˆ†æˆäº¤ï¼Œå‰©ä½™ " << remaining << " æ‰‹ï¼Œå°è¯•æ’¤å•..." << std::endl;

        if (plugin.CancelOrder(order.order_id)) {
            std::cout << "æ’¤å•è¯·æ±‚å·²å‘é€" << std::endl;
        }
    }
}
```

---

### 3. é‡æ–°å‘é€å‰©ä½™æ•°é‡

å¦‚æœå¸Œæœ›å°½å¿«æˆäº¤å‰©ä½™éƒ¨åˆ†ï¼Œå¯ä»¥æ”¹ä»·é‡å‘ï¼š

```cpp
void ResubmitRemaining(const OrderInfo& original_order) {
    if (original_order.status == OrderStatus::PARTIAL_FILLED) {
        uint32_t remaining = original_order.volume - original_order.traded_volume;

        // å…ˆæ’¤é”€åŸè®¢å•
        plugin.CancelOrder(original_order.order_id);

        // ç”¨æ›´æ¿€è¿›çš„ä»·æ ¼é‡æ–°å‘é€å‰©ä½™æ•°é‡
        OrderRequest new_request;
        strncpy(new_request.symbol, original_order.symbol, sizeof(new_request.symbol));
        new_request.direction = original_order.direction;
        new_request.offset = original_order.offset;
        new_request.price = original_order.price + 10; // æé«˜10ä¸ªç‚¹
        new_request.volume = remaining;

        plugin.SendOrder(new_request);
    }
}
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. å›è°ƒçš„å¼‚æ­¥æ€§

**é‡è¦**ï¼šOnRtnOrderå’ŒOnRtnTradeæ˜¯å¼‚æ­¥å›è°ƒï¼Œä¸èƒ½ä¿è¯é¡ºåºï¼

```cpp
// å¯èƒ½çš„æƒ…å†µ1ï¼šæ­£å¸¸é¡ºåº
OnRtnTrade â†’ OnRtnOrder (PARTIAL_FILLED)

// å¯èƒ½çš„æƒ…å†µ2ï¼šé¡ºåºé¢ å€’
OnRtnOrder (PARTIAL_FILLED) â†’ OnRtnTrade

// å¯èƒ½çš„æƒ…å†µ3ï¼šOnRtnOrderå»¶è¿Ÿ
OnRtnTrade â†’ OnRtnTrade â†’ OnRtnOrder (PARTIAL_FILLED)
```

**å»ºè®®**ï¼šä½¿ç”¨è®¢å•ç¼“å­˜æœºåˆ¶ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§ã€‚

---

### 2. æˆäº¤é€šçŸ¥å¯èƒ½å»¶è¿Ÿ

- è®¢å•æˆäº¤åï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ‰æ”¶åˆ°å›è°ƒ
- å¦‚æœç«‹å³æ–­å¼€è¿æ¥ï¼Œå¯èƒ½é”™è¿‡æˆäº¤é€šçŸ¥
- **å»ºè®®**ï¼šå‘å•åè‡³å°‘ç­‰å¾…5-10ç§’å†æ–­å¼€è¿æ¥

---

### 3. éƒ¨åˆ†æˆäº¤åæ’¤å•

```cpp
// éƒ¨åˆ†æˆäº¤çš„è®¢å•å¯ä»¥æ’¤å•
PARTIAL_FILLED â†’ CancelOrder â†’ CANCELED (å‰©ä½™éƒ¨åˆ†è¢«æ’¤é”€)

// æ’¤å•åçš„çŠ¶æ€ï¼š
// - å·²æˆäº¤éƒ¨åˆ†ï¼šä¿ç•™ï¼ˆä¸èƒ½æ’¤é”€ï¼‰
// - æœªæˆäº¤éƒ¨åˆ†ï¼šæ’¤é”€
```

---

### 4. ä»Šä»“å’Œæ˜¨ä»“çš„éƒ¨åˆ†æˆäº¤

å¦‚æœåŒæ—¶æŒæœ‰ä»Šä»“å’Œæ˜¨ä»“ï¼Œå¹³ä»“æ—¶å¯èƒ½å‡ºç°ï¼š

```cpp
// è®¢å•ï¼šå¹³ä»“2æ‰‹ï¼ˆ1æ‰‹ä»Šä»“ + 1æ‰‹æ˜¨ä»“ï¼‰
// å®é™…ï¼šéœ€è¦åˆ†å¼€å‘é€ï¼

// é”™è¯¯ç¤ºä¾‹ï¼š
SendOrder(symbol, SELL, CLOSE, price, 2);  // âŒ å¯èƒ½å¤±è´¥

// æ­£ç¡®ç¤ºä¾‹ï¼š
SendOrder(symbol, SELL, CLOSE_YESTERDAY, price, 1);  // âœ… å¹³æ˜¨ä»“1æ‰‹
SendOrder(symbol, SELL, CLOSE_TODAY, price, 1);      // âœ… å¹³ä»Šä»“1æ‰‹
```

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### æµ‹è¯•éƒ¨åˆ†æˆäº¤

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨è¾ƒä½çš„ä»·æ ¼ï¼ˆä¸å®¹æ˜“æˆäº¤ï¼‰
./gateway/build/plugins/ctp/ctp_close_simple config/ctp/ctp_td.yaml ag2603 28000

# æ–¹æ³•2ï¼šä½¿ç”¨å¤§å•ï¼ˆåˆ†æ‰¹æˆäº¤ï¼‰
./gateway/build/plugins/ctp/ctp_close_simple config/ctp/ctp_td.yaml ag2603 29600 --volume 10
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹è®¢å•çŠ¶æ€æ›´æ–°
grep "Order update" log/ctp_td.log

# æŸ¥çœ‹æˆäº¤è®°å½•
grep "Trade:" log/ctp_td.log

# æŸ¥çœ‹éƒ¨åˆ†æˆäº¤
grep "status=4" log/ctp_td.log  # status=4 å³ PARTIAL_FILLED
```

---

## ğŸ“ ä»£ç ç¤ºä¾‹ï¼šå®Œæ•´çš„éƒ¨åˆ†æˆäº¤å¤„ç†

```cpp
class MyTradeManager {
private:
    hft::plugin::ctp::CTPTDPlugin plugin;
    std::map<std::string, OrderInfo> active_orders;

public:
    void OnOrderUpdate(const OrderInfo& order) {
        active_orders[order.order_id] = order;

        switch (order.status) {
            case OrderStatus::ACCEPTED:
                std::cout << "è®¢å•å·²æ¥å—: " << order.order_id << std::endl;
                break;

            case OrderStatus::PARTIAL_FILLED: {
                uint32_t remaining = order.volume - order.traded_volume;
                std::cout << "éƒ¨åˆ†æˆäº¤: " << order.order_id
                          << " å·²=" << order.traded_volume
                          << " å‰©=" << remaining << std::endl;

                // ç­–ç•¥1ï¼šç­‰å¾…å‰©ä½™éƒ¨åˆ†æˆäº¤
                // ï¼ˆä¸åšä»»ä½•æ“ä½œï¼‰

                // ç­–ç•¥2ï¼šå¦‚æœå‰©ä½™å¾ˆå°‘ï¼Œæ’¤å•
                if (remaining <= 1) {
                    plugin.CancelOrder(order.order_id);
                }

                // ç­–ç•¥3ï¼šå¦‚æœç­‰å¾…å¤ªä¹…ï¼Œæ”¹ä»·é‡å‘
                // ï¼ˆéœ€è¦è®°å½•æ—¶é—´ï¼Œè¿™é‡Œç®€åŒ–ï¼‰
                break;
            }

            case OrderStatus::FILLED:
                std::cout << "å…¨éƒ¨æˆäº¤: " << order.order_id << std::endl;
                active_orders.erase(order.order_id);
                break;

            case OrderStatus::CANCELED:
                std::cout << "å·²æ’¤å•: " << order.order_id << std::endl;
                active_orders.erase(order.order_id);
                break;

            default:
                break;
        }
    }

    void OnTrade(const TradeInfo& trade) {
        std::cout << "æˆäº¤é€šçŸ¥: " << trade.trade_id
                  << " " << trade.symbol
                  << " " << trade.volume << "@" << trade.price << std::endl;
    }
};
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [CTPäº¤æ˜“æ’ä»¶å®ç°](../gateway/plugins/ctp/src/ctp_td_plugin.cpp)
- [äº¤æ˜“æ’ä»¶æ¥å£å®šä¹‰](../gateway/include/plugin/td_plugin_interface.h)
- [CTPæŒä»“æŸ¥è¯¢å’Œå¹³ä»“æŒ‡å—](../CTP_POSITION_GUIDE.md)

---

## æ€»ç»“

### å…³é”®è¦ç‚¹

1. âœ… **çŠ¶æ€è¯†åˆ«**ï¼š`PARTIAL_FILLED (status=4)` è¡¨ç¤ºéƒ¨åˆ†æˆäº¤
2. âœ… **æ•°é‡è·Ÿè¸ª**ï¼šé€šè¿‡ `traded_volume` å’Œ `volume` åˆ¤æ–­æˆäº¤è¿›åº¦
3. âœ… **åŒé‡å›è°ƒ**ï¼šæ¯æ¬¡æˆäº¤è§¦å‘ OnRtnTradeï¼ŒçŠ¶æ€å˜åŒ–è§¦å‘ OnRtnOrder
4. âœ… **å¼‚æ­¥å¤„ç†**ï¼šå›è°ƒé¡ºåºä¸ç¡®å®šï¼Œéœ€è¦ç”¨è®¢å•ç¼“å­˜
5. âœ… **çµæ´»å¤„ç†**ï¼šå¯ä»¥ç­‰å¾…ã€æ’¤å•æˆ–æ”¹ä»·é‡å‘

### æœ€ä½³å®è·µ

- æ€»æ˜¯æ³¨å†Œè®¢å•å›è°ƒå’Œæˆäº¤å›è°ƒ
- ä½¿ç”¨è®¢å•ç¼“å­˜è·Ÿè¸ªçŠ¶æ€
- å‘å•åç­‰å¾…è¶³å¤Ÿæ—¶é—´å†æ–­å¼€è¿æ¥ï¼ˆ5-10ç§’ï¼‰
- ä»Šä»“å’Œæ˜¨ä»“åˆ†å¼€å¹³ä»“
- è®°å½•æ—¥å¿—ä¾¿äºè¿½è¸ªé—®é¢˜

---

**æœ€åæ›´æ–°**: 2026-01-27 21:35
**ç»´æŠ¤è€…**: QuantLink Team
