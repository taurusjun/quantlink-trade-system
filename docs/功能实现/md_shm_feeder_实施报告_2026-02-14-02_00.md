# MD SHM Feeder 实施报告

**文档日期**: 2026-02-14
**版本**: v1.0
**相关模块**: gateway/src/md_shm_feeder.cpp, gateway/include/hftbase_md_types.h

---

## 概述

创建 `md_shm_feeder` 可执行文件，将市场数据（CTP 或模拟器）以 `MarketUpdateNew`（816 字节）格式写入 SysV MWMR 共享内存队列，供 Go trader (`tbsrc-golang`) 直接读取。

这是完成 Go trader → SysV MWMR 全链路的最后一块拼图：
- **订单路径**: Go trader → [SysV MWMR] → counter_bridge → CTP/Simulator（上一阶段已完成）
- **行情路径**: md_shm_feeder → [SysV MWMR] → Go trader（本阶段完成）

## 新增文件

### 1. gateway/include/hftbase_md_types.h

`MarketUpdateNew` 结构体定义，与 hftbase 和 Go types.go 二进制兼容。

| 结构体 | 大小 | 说明 |
|--------|------|------|
| `bookElement_t` | 16 bytes | 价格档位 (quantity + orderCount + price) |
| `MDHeaderPart` | 96 bytes | 行情头 (symbol, exchange, timestamps) |
| `MDDataPart` | 720 bytes | 行情数据 (20档买卖盘 + LTP + 成交量) |
| `MarketUpdateNew` | 816 bytes | 完整行情更新 (Header + Data) |

所有 offset 已通过 offsetof 测试验证：
- `m_symbol` at offset 40 ✅
- `m_exchangeName` at offset 90 ✅
- `m_bidUpdates` at offset 152 ✅
- `m_askUpdates` at offset 472 ✅
- `m_validBids` at offset 804 ✅

### 2. gateway/src/md_shm_feeder.cpp

两种运行模式：

#### Simulator 模式
```bash
md_shm_feeder simulator:ag2506,ag2512 --rate 5
```
- 为每个品种生成随机游走的 5 档行情
- 根据品种名自动推断交易所 (ag→SHFE, IF→CFFEX 等)
- 可配置 tick 频率 (--rate N, 默认 2Hz)

#### CTP 模式
```bash
md_shm_feeder ctp:config/ctp/ctp_md.secret.yaml
```
- 连接 CTP 行情前置，订阅合约
- CTP 5 档深度 → MarketUpdateNew 格式
- 需要编译时启用 ENABLE_CTP_MD

## SHM 配置

| 参数 | 值 | 说明 |
|------|---|------|
| MD queue key | 0x1001 | 与 Go trader.tbsrc.yaml md_shm_key 一致 |
| MD queue size | 65536 | 与 Go trader.tbsrc.yaml md_queue_size 一致 |
| Element size | 824 bytes | MarketUpdateNew(816) + seqNo(8) |

## 架构

### 改造前（旧 golang/ 架构）
```
CTP → ctp_md_gateway → [POSIX SHM: MarketDataRaw] → md_gateway → [NATS: Protobuf] → golang trader
```
三种数据格式，两次 IPC 跳转

### 改造后（tbsrc-golang 架构）
```
CTP → md_shm_feeder → [SysV MWMR: MarketUpdateNew, key=0x1001] → Go trader
```
一种数据格式，一次 IPC 跳转，零序列化开销

## 全链路数据流

```
行情:  CTP → md_shm_feeder → [SysV MWMR 0x1001] → Go Connector.pollMD() → Strategy
订单:  Strategy → Connector.reqQueue → [SysV MWMR 0x2001] → counter_bridge → CTP
回报:  CTP → counter_bridge → [SysV MWMR 0x3001] → Go Connector.pollORS() → Strategy
```

三条 SysV MWMR 共享内存通路，完全不依赖 NATS/gRPC。

## 验证

- hftbase_md_types.h: static_assert 全部通过，offsetof 验证与 Go types.go 一致
- md_shm_feeder: 编译通过 (macOS, Release, CTP + Simulator 模式)
- macOS SysV SHM 限制 (kern.sysv.shmmax=4MB) 导致 65536 元素队列创建失败，生产 Linux 无此限制

## macOS 测试注意事项

macOS 默认 SysV SHM 上限为 4MB，而 MD 队列需要 ~54MB (65536 × 824 字节)。测试时可:
1. 调小 queue_size（如 4096），或
2. 增大 macOS 限制：`sudo sysctl -w kern.sysv.shmmax=67108864`

生产 Linux 环境默认支持大 SHM 段，无需调整。

---

**最后更新**: 2026-02-14 02:00
