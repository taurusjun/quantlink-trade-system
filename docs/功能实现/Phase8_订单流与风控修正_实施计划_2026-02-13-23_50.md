# Phase 8：订单流与风控修正

**文档日期**: 2026-02-13
**版本**: v1.0
**相关模块**: tbsrc-golang/pkg/execution, tbsrc-golang/pkg/strategy

---

## 概述

Phase 8 修复 C++ ExecutionStrategy 基层中的四个关键正确性问题，涉及 PNL 计算、订单保护、自交叉防护和止损阈值管理。

## 修正内容

### 1. TransTotalValue 在 netpos==0 时重新计算（PNL 正确性修复）

**问题**: `processTrade` 在持仓归零时未重新计算 `TransTotalValue`（session 级手续费），导致后续 `NetPNL = GrossPNL - TransTotalValue` 使用过时的手续费值。

**修复方案**: 在 `processTrade` 中 `netpos == 0` 分支添加 `TransTotalValue` 重算：
```go
TransTotalValue = BuyExchTx*BuyTotalValue*PriceMultiplier +
    SellExchTx*SellTotalValue*PriceMultiplier +
    BuyExchContractTx*BuyTotalQty +
    SellExchContractTx*SellTotalQty
```

**C++ 参考**: `ExecutionStrategy.cpp:2067-2072`

### 2. CROSS 订单撤单保护

**问题**: `SendCancelOrderByID` 不区分订单类型，可能误撤正在执行的 CROSS（激进对冲）订单。C++ 中 CROSS 订单受保护，不允许通过常规路径撤销。

**修复方案**:
- `SendCancelOrderByID` 拒绝撤销 `HitCross` 类型订单
- 新增 `SendCancelOrderByIDForce` 强制撤销方法
- `cancelCrossOrders`（PairwiseArb 专用）使用 `Force` 变体
- 内部提取 `sendCancelOrderInternal` 避免代码重复

**C++ 参考**: `ExecutionStrategy.cpp:1760-1763`

### 3. 同价反向挂单撤销（自交叉防护）

**问题**: `SendNewOrder` 在下买单前不检查同价是否有卖单挂单（反之亦然），可能导致自交叉。

**修复方案**: 在 `SendNewOrder` 中，下买单前调用 `SendCancelOrderByPrice(inst, price, Sell)`，下卖单前调用 `SendCancelOrderByPrice(inst, price, Buy)`。

**C++ 参考**: `ExecutionStrategy.cpp:1347, 1477`

### 4. UPNL_LOSS/STOP_LOSS 阈值触发时翻倍

**问题**: 止损触发后阈值不变，15 分钟 auto-resume 后会立即重新触发同一阈值，形成触发-恢复-触发循环。

**修复方案**:
- `CheckSquareoff` 的 `upnlLoss` 和 `stopLoss` 参数改为 `*float64` 指针
- 触发时原地翻倍阈值（`*upnlLoss += *upnlLoss`）
- 调用方传递 `&pas.Thold1.UPNLLoss` 等字段地址，翻倍直接修改 ThresholdSet
- nil 指针表示不检查该条件

**C++ 参考**: `ExecutionStrategy.cpp:2291-2298`

## 修改文件

| 文件 | 修改内容 |
|------|---------|
| `pkg/execution/ors_callback.go` | processTrade: netpos==0 时重算 TransTotalValue |
| `pkg/execution/order_manager.go` | SendCancelOrderByID: CROSS 保护；新增 SendCancelOrderByIDForce；SendNewOrder: 同价反向撤单 |
| `pkg/execution/squareoff.go` | CheckSquareoff 签名改为指针参数；checkStopLoss 阈值翻倍 |
| `pkg/execution/execution_test.go` | 更新测试适配新签名；新增阈值翻倍验证 |
| `pkg/strategy/pairwise_callbacks.go` | CheckSquareoff 调用传递 ThresholdSet 字段指针 |
| `pkg/strategy/pairwise_send_order.go` | cancelCrossOrders 使用 SendCancelOrderByIDForce |

## 验证

- 171 个测试全部通过
- 8 个包编译通过
- Linux/amd64 交叉编译验证通过

## 剩余已知差距（优先级降序）

| 差距 | 优先级 | C++ 行号 | 说明 |
|------|--------|----------|------|
| GetBidPrice/GetAskPrice 基类 CROSS/IMPROVE | P1 | 1225-1440 | 单腿价格改善/穿越逻辑（PairwiseArb 已有自己的实现，部分缓解） |
| SendBidOrder/SendAskOrder 数量调整 | P1 | 1311-1485 | 持仓感知的下单量调整（PairwiseArb 通过 SendBidOrder2 使用显式数量，部分缓解） |
| CANCELREQ_PAUSE 冷却 | P2 | 1764-1770 | 撤单拒绝后的冷却机制 |
| fillOnCxlReject 安全机制 | P2 | 1874-1880 | 撤单拒绝但已成交的安全处理 |
| USE_PRICE_LIMIT | P2 | 2227-2277 | 价格范围安全检查 |
| HandleTimeLimitSquareoff | P2 | 2442-2498 | 渐进式时间平仓 |

---

**最后更新**: 2026-02-13 23:50
