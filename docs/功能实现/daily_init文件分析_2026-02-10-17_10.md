# daily_init 文件分析

**文档日期**: 2026-02-10
**版本**: v1.0
**C++ 参考**: `tbsrc/Strategies/PairwiseArbStrategy.cpp:18-144, 624-686`

---

## 概述

`daily_init` 文件用于在策略启动时恢复状态，在策略停止时保存状态。每个策略实例有独立的文件。

## 文件格式

### 文件路径

```
../data/daily_init.{strategy_id}
```

例如：
- `daily_init.92201` - 策略 92201 的初始化文件
- `daily_init.92101` - 策略 92101 的初始化文件

### 文件结构

**格式**: 空格分隔的文本文件，第一行为表头，第二行为数据

```
StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2
92201 0 -24.441424 ag_F_2_SFE ag_F_4_SFE -2 2
```

### 字段说明

| 字段 | 类型 | 说明 | C++ 变量 |
|------|------|------|----------|
| `StrategyID` | int32 | 策略 ID | `m_strategyID` |
| `2day` | int | 今日 Leg1 新开净仓（通常为 0，已合并到 ytd1） | - |
| `avgPx` | float64 | 价差均值（原始值，不含 tValue 调整） | `avgSpreadRatio_ori` |
| `m_origbaseName1` | string | Leg1 品种名称（如 ag_F_2_SFE） | `m_firstStrat->m_instru->m_origbaseName` |
| `m_origbaseName2` | string | Leg2 品种名称（如 ag_F_4_SFE） | `m_secondStrat->m_instru->m_origbaseName` |
| `ytd1` | int | Leg1 昨仓（被动成交净仓） | `m_firstStrat->m_netpos_pass` |
| `ytd2` | int | Leg2 主动成交净仓 | `m_secondStrat->m_netpos_agg` |

### 示例数据分析

```
92201 0 -24.441424 ag_F_2_SFE ag_F_4_SFE -2 2
```

| 字段 | 值 | 含义 |
|------|-----|------|
| StrategyID | 92201 | 策略编号 |
| 2day | 0 | 今日新开仓为 0 |
| avgPx | -24.441424 | 价差均值为 -24.44（Leg1 - Leg2 的历史均值） |
| m_origbaseName1 | ag_F_2_SFE | 白银近月合约 |
| m_origbaseName2 | ag_F_4_SFE | 白银远月合约 |
| ytd1 | -2 | Leg1 昨仓 -2 手（空头） |
| ytd2 | 2 | Leg2 主动仓 +2 手（多头，对冲 Leg1） |

---

## C++ 实现分析

### 加载逻辑 (LoadMatrix2)

```cpp
// PairwiseArbStrategy.cpp:18-62
auto mx_daily_init2 = LoadMatrix2(std::string("../data/daily_init.") + std::to_string(m_strategyID));

// 验证策略 ID 存在
if (mx_daily_init2.find(m_strategyID) == mx_daily_init2.end()) {
    TBLOG << "daily_init ERROR! Missing m_strategyID " << m_strategyID << endl;
    exit(-1);  // 找不到配置则退出
}

auto &row = mx_daily_init2.at(m_strategyID);

// 恢复价差均值
avgSpreadRatio_ori = std::stod(row["avgPx"]);
avgSpreadRatio = avgSpreadRatio_ori;

// 恢复 Leg1 持仓
int netpos_ytd1 = std::stoi(row["ytd1"]);     // 昨仓
int netpos_2day1 = std::stoi(row["2day"]);    // 今仓（通常为 0）
m_firstStrat->m_netpos_pass_ytd = netpos_ytd1;
m_firstStrat->m_netpos = netpos_ytd1 + netpos_2day1;
m_firstStrat->m_netpos_pass = netpos_ytd1 + netpos_2day1;

// 恢复 Leg2 持仓
int netpos_agg2 = std::stoi(row["ytd2"]);
m_secondStrat->m_netpos = netpos_agg2;
m_secondStrat->m_netpos_agg = netpos_agg2;
```

### 保存逻辑 (SaveMatrix2)

```cpp
// PairwiseArbStrategy.cpp:653-686
void PairwiseArbStrategy::SaveMatrix2(std::string filepath) {
    while (true) {
        auto fp = fopen(filepath.c_str(), "aw+");
        if (0 == flock(fileno(fp), LOCK_EX)) {  // 获取文件锁
            std::ofstream out(filepath, ios::out);
            if (out.is_open()) {
                out.setf(ios::fixed);
                // 写入表头
                const string Head = "StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2 ";
                out << Head << std::endl;
                // 写入数据
                out << m_strategyID << " "
                    << "0 "                                          // 2day 固定为 0
                    << avgSpreadRatio_ori << " "                     // 保存原始均值
                    << m_firstStrat->m_instru->m_origbaseName << " " // Leg1 品种
                    << m_secondStrat->m_instru->m_origbaseName << " "// Leg2 品种
                    << m_firstStrat->m_netpos_pass << " "            // Leg1 持仓
                    << m_secondStrat->m_netpos_agg << endl;          // Leg2 持仓
                out.close();
            }
            flock(fileno(fp), LOCK_UN);  // 释放文件锁
            break;
        } else {
            sleep(1);  // 获取锁失败，等待重试
        }
        fclose(fp);
    }
}
```

### 调用时机

| 时机 | 方法 | 说明 |
|------|------|------|
| 策略启动 | 构造函数 | 调用 `LoadMatrix2()` 恢复状态 |
| 策略停止 | `HandleSquareoff()` 末尾 | 调用 `SaveMatrix2()` 保存状态 |

---

## 数据流向

```
┌─────────────────────────────────────────────────────────────────┐
│                    程序启动                                      │
│                       │                                         │
│                       ▼                                         │
│    ┌─────────────────────────────────────┐                     │
│    │  LoadMatrix2("daily_init.92201")    │                     │
│    │  读取文件，解析各字段                 │                     │
│    └─────────────────────────────────────┘                     │
│                       │                                         │
│                       ▼                                         │
│    ┌─────────────────────────────────────┐                     │
│    │  恢复状态:                           │                     │
│    │  - avgSpreadRatio_ori = -24.44      │                     │
│    │  - firstStrat.netpos_pass_ytd = -2  │                     │
│    │  - firstStrat.netpos_pass = -2      │                     │
│    │  - secondStrat.netpos_agg = 2       │                     │
│    └─────────────────────────────────────┘                     │
│                       │                                         │
│                       ▼                                         │
│              【策略运行中...】                                    │
│                       │                                         │
│                       ▼                                         │
│    ┌─────────────────────────────────────┐                     │
│    │  程序停止 / HandleSquareoff()        │                     │
│    └─────────────────────────────────────┘                     │
│                       │                                         │
│                       ▼                                         │
│    ┌─────────────────────────────────────┐                     │
│    │  SaveMatrix2("daily_init.92201")    │                     │
│    │  - 使用 flock 获取文件锁             │                     │
│    │  - 写入当前状态                      │                     │
│    │  - 释放文件锁                        │                     │
│    └─────────────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Go 实现方案

### 文件路径

```
data/daily_init.{strategy_id}
```

### 数据结构

```go
// DailyInitData 每日初始化数据
// C++: daily_init 文件格式
type DailyInitData struct {
    StrategyID     int32   `json:"strategy_id"`      // 策略 ID
    TwoDay         int32   `json:"two_day"`          // 今日新开仓（通常为 0）
    AvgPx          float64 `json:"avg_px"`           // 价差均值
    OrigBaseName1  string  `json:"orig_base_name_1"` // Leg1 品种名
    OrigBaseName2  string  `json:"orig_base_name_2"` // Leg2 品种名
    Ytd1           int32   `json:"ytd1"`             // Leg1 昨仓
    Ytd2           int32   `json:"ytd2"`             // Leg2 主动仓
}
```

### 加载方法

```go
// LoadDailyInit 加载每日初始化数据
// C++: PairwiseArbStrategy::LoadMatrix2()
func LoadDailyInit(strategyID int32) (*DailyInitData, error) {
    filepath := fmt.Sprintf("data/daily_init.%d", strategyID)

    file, err := os.Open(filepath)
    if err != nil {
        return nil, fmt.Errorf("open daily_init failed: %w", err)
    }
    defer file.Close()

    scanner := bufio.NewScanner(file)

    // 跳过表头
    scanner.Scan()

    // 读取数据行
    if scanner.Scan() {
        line := scanner.Text()
        fields := strings.Fields(line)
        if len(fields) < 7 {
            return nil, fmt.Errorf("invalid daily_init format")
        }

        data := &DailyInitData{
            StrategyID:    int32(parseInt(fields[0])),
            TwoDay:        int32(parseInt(fields[1])),
            AvgPx:         parseFloat(fields[2]),
            OrigBaseName1: fields[3],
            OrigBaseName2: fields[4],
            Ytd1:          int32(parseInt(fields[5])),
            Ytd2:          int32(parseInt(fields[6])),
        }
        return data, nil
    }

    return nil, fmt.Errorf("no data in daily_init file")
}
```

### 保存方法

```go
// SaveDailyInit 保存每日初始化数据
// C++: PairwiseArbStrategy::SaveMatrix2()
func SaveDailyInit(data *DailyInitData) error {
    filepath := fmt.Sprintf("data/daily_init.%d", data.StrategyID)

    // 使用文件锁（类似 C++ flock）
    file, err := os.OpenFile(filepath, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, 0644)
    if err != nil {
        return fmt.Errorf("open daily_init failed: %w", err)
    }
    defer file.Close()

    // 获取文件锁
    if err := syscall.Flock(int(file.Fd()), syscall.LOCK_EX); err != nil {
        return fmt.Errorf("flock failed: %w", err)
    }
    defer syscall.Flock(int(file.Fd()), syscall.LOCK_UN)

    // 写入表头
    header := "StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2 \n"
    file.WriteString(header)

    // 写入数据
    line := fmt.Sprintf("%d %d %f %s %s %d %d\n",
        data.StrategyID,
        data.TwoDay,
        data.AvgPx,
        data.OrigBaseName1,
        data.OrigBaseName2,
        data.Ytd1,
        data.Ytd2,
    )
    file.WriteString(line)

    return nil
}
```

---

## 与现有 Go 代码的关系

### 现有实现

Go 代码中已有 `PositionSnapshot` 机制：
- `SavePositionSnapshot()` - 保存持仓快照
- `LoadPositionSnapshot()` - 加载持仓快照
- 文件路径: `data/positions/{strategy_id}_snapshot.json`

### 差异对比

| 功能 | C++ daily_init | Go PositionSnapshot |
|------|----------------|---------------------|
| 价差均值 | ✅ avgPx | ❌ 无 |
| 品种名称 | ✅ origBaseName | ❌ 无 |
| Leg1 持仓 | ✅ ytd1, 2day | ✅ SymbolsPos |
| Leg2 持仓 | ✅ ytd2 | ✅ SymbolsPos |
| 昨仓区分 | ✅ ytd1 vs 2day | ✅ SymbolsYesterdayPos |
| 文件格式 | 空格分隔文本 | JSON |

### 实施方案：双重保存机制

**已实现**：同时使用 C++ 格式和 Go JSON 格式

1. **daily_init 文件（C++ 兼容格式）**
   - 文件路径: `data/daily_init.{strategy_id}`
   - 函数: `LoadMatrix2()`, `SaveMatrix2()`
   - 用途: 与 C++ 系统互操作，保存 avgSpreadRatio_ori

2. **PositionSnapshot（JSON 格式）**
   - 文件路径: `data/positions/{strategy_id}_snapshot.json`
   - 函数: `LoadPositionSnapshot()`, `SavePositionSnapshot()`
   - 用途: Go 特有，便于调试和查看

---

## 已实现功能

### Go 代码实现（2026-02-10）

**文件**: `golang/pkg/strategy/daily_init.go`

函数和变量名与 C++ 保持一致：

| C++ 函数/变量 | Go 实现 | 说明 |
|--------------|---------|------|
| `LoadMatrix2()` | `LoadMatrix2()` | 加载 daily_init 文件 |
| `SaveMatrix2()` | `SaveMatrix2()` | 保存 daily_init 文件 |
| `MxDailyInit2` | `MxDailyInit2` | 数据映射类型 |
| `DailyInitRow` | `DailyInitRow` | 数据行结构 |
| `GetDailyInitPath()` | `GetDailyInitPath()` | 获取文件路径 |

### 集成位置

**PairwiseArbStrategy.Initialize()**:
```go
// 加载 daily_init 文件
dailyInitPath := GetDailyInitPath(pas.ExecutionStrategy.StrategyID)
mx_daily_init2, err := LoadMatrix2(dailyInitPath)
if err == nil {
    row := mx_daily_init2[strategyID]
    pas.avgSpreadRatio_ori = row.AvgPx
    pas.spreadAnalyzer.SetSpreadMean(pas.avgSpreadRatio_ori)
    pas.firstStrat.NetPosPassYtd = row.Ytd1
    pas.firstStrat.NetPosPass = row.Ytd1 + row.TwoDay
    pas.secondStrat.NetPosAgg = row.Ytd2
}
```

**PairwiseArbStrategy.Stop()**:
```go
// 保存 daily_init 文件
dailyInitPath := GetDailyInitPath(pas.ExecutionStrategy.StrategyID)
SaveMatrix2(
    dailyInitPath,
    pas.ExecutionStrategy.StrategyID,
    pas.avgSpreadRatio_ori,
    pas.firstStrat.Instru.Symbol,
    pas.secondStrat.Instru.Symbol,
    pas.firstStrat.NetPosPass,
    pas.secondStrat.NetPosAgg,
)
```

---

## 注意事项

1. **文件锁**: ✅ 已实现 `syscall.Flock()` 防止多进程并发写入
2. **原子性**: 建议保留历史版本，便于回滚
3. **验证**: 加载时检查 StrategyID 是否存在
4. **兼容性**: 同时支持 daily_init（C++格式）和 PositionSnapshot（JSON格式）

---

## 参考资料

- C++ 加载: `tbsrc/Strategies/PairwiseArbStrategy.cpp:112-144`
- C++ 保存: `tbsrc/Strategies/PairwiseArbStrategy.cpp:653-686`
- Go 实现: `golang/pkg/strategy/daily_init.go`
- 示例数据: `/Users/user/PWorks/RD/TradeBot_China/data/daily_init.*`

---

**最后更新**: 2026-02-10 17:30
