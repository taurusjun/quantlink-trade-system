# Phase 7：风控安全检查

**文档日期**: 2026-02-13
**版本**: v1.0
**相关模块**: tbsrc-golang/pkg/execution, tbsrc-golang/pkg/strategy

---

## 概述

Phase 7 补全 C++ ExecutionStrategy 中的关键风控安全检查，确保策略在异常情况下能够自我保护。

## 修正内容

### 1. CheckSquareoff 增强（关键修复）

**问题**: 原有 `CheckSquareoff` 仅支持时间触发（`EndTimeEpoch`/`EndTimeAggEpoch`），缺少 C++ 中的最大亏损、UPNL 止损、回撤止损、订单数限制、成交量限制检查。

**修复方案**: 扩展 `CheckSquareoff` 签名，增加 `maxLoss`、`upnlLoss`、`stopLoss` 参数：
- **Phase 1**: 激进平仓时间（`EndTimeAggEpoch`）→ `AggFlat = true`
- **Phase 4**: 止损冷却恢复（15 分钟后自动恢复交易）
- **Phase 2**: 标准退出条件（时间/最大亏损/订单数/成交量）
- **Phase 3**: UPNL_LOSS / STOP_LOSS 逐腿检查

**C++ 参考**: `ExecutionStrategy.cpp:2150-2186, 2279-2339`

### 2. CheckRejectLimit 新增

**问题**: 缺少拒绝次数超限检查（C++ 中 200 次拒绝后停止交易）。

**修复方案**: 新增 `CheckRejectLimit()` 方法，阈值 200 次。在 `PairwiseArbStrategy.ORSCallBack` 中每次 ORS 回调后检查。

**C++ 参考**: `ExecutionStrategy.cpp:432-481`

### 3. HandleRMSReject 新增

**问题**: 缺少 RMS 拒绝后的处理逻辑（C++ 中触发激进平仓并减半订单量）。

**修复方案**: 新增 `HandleRMSReject(inst)` 方法：
- 设置 `AggFlat = true`
- 将 `RmsQty` 减半
- 如果减半后 ≤ 0，重置为合约 LotSize

**C++ 参考**: `ExecutionStrategy.cpp:1069-1080`

### 4. 止损自动恢复

**问题**: 缺少止损后的自动恢复机制（C++ 中止损 15 分钟后自动恢复交易）。

**修复方案**: 在 `CheckSquareoff` 中增加 Phase 4 逻辑：
- 记录 `StopLossTS`（止损触发时间戳）
- 当前时间距触发超过 900 秒（15 分钟），清除所有退出标志恢复交易

**C++ 参考**: `ExecutionStrategy.cpp:2313-2320`

### 5. MDCallBack 集成

**修改**: `PairwiseArbStrategy.MDCallBack` 中新增：
- 每次行情更新时对两腿调用 `CheckSquareoff`
- 当任一腿触发 `OnExit` 时，执行策略级 `handleSquareoffLocked`

### 6. ORSCallBack 集成

**修改**: `PairwiseArbStrategy.ORSCallBack` 中新增：
- RMS_REJECT 时调用对应腿的 `HandleRMSReject`
- 每次回调后检查 `CheckRejectLimit`，超限则平仓

## 修改文件

| 文件 | 修改内容 |
|------|---------|
| `pkg/execution/state.go` | 新增 `StopLossTS uint64` 字段，Reset 中归零 |
| `pkg/execution/squareoff.go` | 重写 `CheckSquareoff`（新签名），新增 `checkStopLoss`、`CheckRejectLimit`、`HandleRMSReject` |
| `pkg/strategy/pairwise_callbacks.go` | MDCallBack 集成 CheckSquareoff，ORSCallBack 集成 RMS/Reject 检查 |
| `pkg/execution/execution_test.go` | 更新已有测试签名，新增 7 个风控测试 |

## 新增/更新测试

| 测试 | 覆盖内容 |
|------|---------|
| `TestCheckSquareoff_Time` | 更新签名（已有测试） |
| `TestCheckSquareoff_AggFlat` | 更新签名（已有测试） |
| `TestCheckSquareoff_MaxLoss` | 最大亏损触发退出 |
| `TestCheckSquareoff_MaxOrders` | 订单数超限触发退出 |
| `TestCheckSquareoff_UPNLLoss` | 未实现亏损止损 |
| `TestCheckSquareoff_StopLoss` | 回撤止损 |
| `TestCheckSquareoff_AutoResume` | 15 分钟冷却后自动恢复 |
| `TestCheckRejectLimit` | 拒绝次数阈值 |
| `TestHandleRMSReject` | RMS 拒绝处理（减半 + 重置） |

## 验证

- 171 个测试全部通过（+7）
- 8 个包编译通过
- Linux/amd64 交叉编译验证通过

---

**最后更新**: 2026-02-13 23:30
