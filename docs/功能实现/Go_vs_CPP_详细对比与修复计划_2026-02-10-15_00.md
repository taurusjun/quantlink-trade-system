# Go vs C++ 详细对比与修复计划

**文档日期**: 2026-02-10
**版本**: v1.0
**相关模块**: strategy, risk, portfolio

---

## 概述

本文档详细对比 Go 代码 (`/Users/user/PWorks/RD/quantlink-trade-system/golang/pkg/strategy/`) 与 C++ 原代码 (`/Users/user/PWorks/RD/tbsrc/`) 的变量和方法，识别差异并提供修复计划。

---

## 1. 架构对比

### 1.1 类继承结构

**C++ 原代码**:
```
ExecutionStrategy (基类)
    ├── 所有持仓、订单、PNL 字段
    ├── 订单管理方法
    └── 风控方法

ExtraStrategy (派生类)
    ├── 继承 ExecutionStrategy 所有字段
    ├── 支持多 Instrument 操作
    └── 扩展订单方法 (SendBidOrder2, SendAskOrder2)

PairwiseArbStrategy (派生类)
    ├── m_firstStrat : ExtraStrategy*  // 第一条腿
    ├── m_secondStrat : ExtraStrategy* // 第二条腿
    └── 价差计算、追单逻辑
```

**Go 新代码**:
```
Strategy (接口)
    └── 定义所有策略必须实现的方法

BaseStrategy (结构体)
    ├── 基础字段 (ID, Type, Config)
    ├── 持仓字段 (EstimatedPosition)
    ├── PNL 字段
    └── 控制状态 (ControlState)

ExtraStrategy (结构体) - 单独定义
    ├── 持仓字段 (NetPos, NetPosPass, NetPosAgg)
    ├── 订单映射 (OrdMap, BidMap, AskMap)
    └── 订单统计

PairwiseArbStrategy (结构体)
    ├── *BaseStrategy (嵌入)
    ├── firstStrat, secondStrat *ExtraStrategy
    └── 价差计算逻辑
```

### 1.2 架构差异总结

| 方面 | C++ | Go | 状态 |
|------|-----|-----|------|
| 继承模型 | 类继承 | 接口 + 组合 | ⚠️ 架构差异 |
| 基类访问 | 直接访问 | GetBaseStrategy() | ✅ 已实现 |
| 持仓字段位置 | ExecutionStrategy | BaseStrategy + ExtraStrategy | ⚠️ 分散 |
| 订单映射 | ExecutionStrategy | ExtraStrategy | ✅ 正确 |

---

## 2. 变量对比

### 2.1 持仓字段 (Position Fields)

**C++ ExecutionStrategy.h:111-114**:
```cpp
int32_t m_netpos;           // 总净仓
int32_t m_netpos_pass;      // 被动成交净仓
int32_t m_netpos_pass_ytd;  // 昨仓
int32_t m_netpos_agg;       // 主动成交净仓
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_netpos | BaseStrategy.EstimatedPosition | NetQty | ✅ 存在 |
| m_netpos_pass | ExtraStrategy | NetPosPass | ✅ 存在 |
| m_netpos_pass_ytd | ExtraStrategy | NetPosPassYtd | ✅ 存在 |
| m_netpos_agg | ExtraStrategy | NetPosAgg | ✅ 存在 |
| - | BaseStrategy.EstimatedPosition | BuyQty | ✅ 扩展 |
| - | BaseStrategy.EstimatedPosition | SellQty | ✅ 扩展 |

**问题**: 持仓字段分散在 BaseStrategy 和 ExtraStrategy 两处，需要明确使用场景。

### 2.2 订单统计字段 (Order Statistics)

**C++ ExecutionStrategy.h:123-137**:
```cpp
int32_t m_buyOpenOrders;    // 买入未成交订单数
int32_t m_sellOpenOrders;   // 卖出未成交订单数
int32_t m_improveCount;     // 改价次数
int32_t m_crossCount;       // 主动吃单次数
int32_t m_tradeCount;       // 成交次数
int32_t m_rejectCount;      // 拒单次数
int32_t m_orderCount;       // 下单次数
int32_t m_cancelCount;      // 撤单次数
int32_t m_confirmCount;     // 确认次数
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_buyOpenOrders | ExtraStrategy | BuyOpenOrders | ✅ 存在 |
| m_sellOpenOrders | ExtraStrategy | SellOpenOrders | ✅ 存在 |
| m_improveCount | ExtraStrategy | ImproveCount | ✅ 存在 |
| m_crossCount | ExtraStrategy | CrossCount | ✅ 存在 |
| m_tradeCount | ExtraStrategy | TradeCount | ✅ 存在 |
| m_rejectCount | ExtraStrategy | RejectCount | ✅ 存在 |
| m_orderCount | ExtraStrategy | OrderCount | ✅ 存在 |
| m_cancelCount | ExtraStrategy | CancelCount | ✅ 存在 |
| m_confirmCount | ExtraStrategy | ConfirmCount | ✅ 存在 |
| m_cancelconfirmCount | ExtraStrategy | CancelConfirmCount | ✅ 存在 |
| m_priceCount | ExtraStrategy | PriceCount | ✅ 存在 |
| m_deltaCount | ExtraStrategy | DeltaCount | ✅ 存在 |
| m_lossCount | ExtraStrategy | LossCount | ✅ 存在 |
| m_qtyCount | ExtraStrategy | QtyCount | ✅ 存在 |

### 2.3 成交量统计字段 (Volume Statistics)

**C++ ExecutionStrategy.h:139-153**:
```cpp
double m_buyQty;            // 当前买入量
double m_sellQty;           // 当前卖出量
double m_buyTotalQty;       // 总买入量
double m_sellTotalQty;      // 总卖出量
double m_buyOpenQty;        // 买入未成交量
double m_sellOpenQty;       // 卖出未成交量
double m_buyTotalValue;     // 买入总金额
double m_sellTotalValue;    // 卖出总金额
double m_buyAvgPrice;       // 买入均价
double m_sellAvgPrice;      // 卖出均价
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_buyQty | ExtraStrategy | BuyQty | ✅ 存在 |
| m_sellQty | ExtraStrategy | SellQty | ✅ 存在 |
| m_buyTotalQty | ExtraStrategy | BuyTotalQty | ✅ 存在 |
| m_sellTotalQty | ExtraStrategy | SellTotalQty | ✅ 存在 |
| m_buyOpenQty | ExtraStrategy | BuyOpenQty | ✅ 存在 |
| m_sellOpenQty | ExtraStrategy | SellOpenQty | ✅ 存在 |
| m_buyTotalValue | ExtraStrategy | BuyTotalValue | ✅ 存在 |
| m_sellTotalValue | ExtraStrategy | SellTotalValue | ✅ 存在 |
| m_buyAvgPrice | ExtraStrategy | BuyAvgPrice | ✅ 存在 |
| m_sellAvgPrice | ExtraStrategy | SellAvgPrice | ✅ 存在 |
| m_buyExchTx | ExtraStrategy | BuyExchTx | ✅ 存在 |
| m_sellExchTx | ExtraStrategy | SellExchTx | ✅ 存在 |
| m_buyValue | ExtraStrategy | BuyValue | ✅ 存在 |
| m_sellValue | ExtraStrategy | SellValue | ✅ 存在 |

### 2.4 PNL 字段 (Profit & Loss)

**C++ ExecutionStrategy.h:160-165**:
```cpp
double m_realisedPNL;       // 已实现盈亏
double m_unrealisedPNL;     // 未实现盈亏
double m_netPNL;            // 净盈亏
double m_grossPNL;          // 毛盈亏
double m_maxPNL;            // 最大盈亏
double m_drawdown;          // 回撤
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_realisedPNL | ExtraStrategy | RealisedPNL | ✅ 存在 |
| m_unrealisedPNL | ExtraStrategy | UnrealisedPNL | ✅ 存在 |
| m_netPNL | ExtraStrategy | NetPNL | ✅ 存在 |
| m_grossPNL | ExtraStrategy | GrossPNL | ✅ 存在 |
| m_maxPNL | ExtraStrategy | MaxPNL | ✅ 存在 |
| m_drawdown | ExtraStrategy | Drawdown | ✅ 存在 |

**BaseStrategy.PNL 字段**:

| Go 字段 | 状态 | 说明 |
|---------|------|------|
| RealizedPnL | ✅ | 与 C++ 对应 |
| UnrealizedPnL | ✅ | 与 C++ 对应 |
| TotalPnL | ✅ | 新增 |
| TradingFees | ✅ | 新增 |
| NetPnL | ✅ | 与 C++ 对应 |
| MaxDrawdown | ✅ | 与 C++ 对应 |

### 2.5 控制状态字段 (Control State)

**C++ ExecutionStrategy.h (布尔状态)**:
```cpp
bool m_onExit;              // 退出模式
bool m_onCancel;            // 撤单模式
bool m_onFlat;              // 平仓模式
bool m_aggFlat;             // 主动平仓
bool m_Active;              // 策略激活
bool m_onStopLoss;          // 止损触发
bool m_onMaxPx;             // 最大价格触发
bool m_onNewsFlat;          // 新闻平仓
bool m_onTimeSqOff;         // 时间平仓
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_onExit | ExtraStrategy | OnExit | ✅ 存在 |
| m_onCancel | ExtraStrategy | OnCancel | ✅ 存在 |
| m_onFlat | ExtraStrategy | OnFlat | ✅ 存在 |
| m_aggFlat | ExtraStrategy | AggFlat | ✅ 存在 |
| m_Active | ExtraStrategy | Active | ✅ 存在 |
| m_onStopLoss | ExtraStrategy | OnStopLoss | ✅ 存在 |
| m_onMaxPx | ExtraStrategy | OnMaxPx | ✅ 存在 |
| m_onNewsFlat | ExtraStrategy | OnNewsFlat | ✅ 存在 |
| m_onTimeSqOff | ExtraStrategy | OnTimeSqOff | ✅ 存在 |
| m_sendMail | ExtraStrategy | SendMail | ✅ 存在 |
| callSquareOff | ExtraStrategy | CallSquareOff | ✅ 存在 |

### 2.6 追单控制字段 (Aggressive Order Control)

**C++ ExecutionStrategy.h:289-294**:
```cpp
double buyAggCount;         // 买入主动单计数
double sellAggCount;        // 卖出主动单计数
double buyAggOrder;         // 买入主动单数量
double sellAggOrder;        // 卖出主动单数量
uint64_t last_agg_time;     // 上次主动单时间
TransactionType last_agg_side; // 上次主动单方向
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| buyAggCount | ExtraStrategy | BuyAggCount | ✅ 存在 |
| sellAggCount | ExtraStrategy | SellAggCount | ✅ 存在 |
| buyAggOrder | ExtraStrategy | BuyAggOrder | ✅ 存在 |
| sellAggOrder | ExtraStrategy | SellAggOrder | ✅ 存在 |
| last_agg_time | ExtraStrategy | LastAggTime | ✅ 存在 |
| last_agg_side | ExtraStrategy | LastAggSide | ✅ 存在 |

### 2.7 阈值字段 (Threshold Fields)

**C++ ExecutionStrategy.h**:
```cpp
double m_tholdBidPlace;     // 买入开仓阈值
double m_tholdBidRemove;    // 买入撤单阈值
double m_tholdAskPlace;     // 卖出开仓阈值
double m_tholdAskRemove;    // 卖出撤单阈值
int32_t m_tholdMaxPos;      // 最大持仓阈值
int32_t m_tholdBeginPos;    // 起始持仓阈值
int32_t m_tholdSize;        // 单笔大小阈值
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_tholdBidPlace | ExtraStrategy | TholdBidPlace | ✅ 存在 |
| m_tholdBidRemove | ExtraStrategy | TholdBidRemove | ✅ 存在 |
| m_tholdAskPlace | ExtraStrategy | TholdAskPlace | ✅ 存在 |
| m_tholdAskRemove | ExtraStrategy | TholdAskRemove | ✅ 存在 |
| m_tholdMaxPos | ExtraStrategy | TholdMaxPos | ✅ 存在 |
| m_tholdBeginPos | ExtraStrategy | TholdBeginPos | ✅ 存在 |
| m_tholdInc | ExtraStrategy | TholdInc | ✅ 存在 |
| m_tholdSize | ExtraStrategy | TholdSize | ✅ 存在 |
| m_tholdBidSize | ExtraStrategy | TholdBidSize | ✅ 存在 |
| m_tholdBidMaxPos | ExtraStrategy | TholdBidMaxPos | ✅ 存在 |
| m_tholdAskSize | ExtraStrategy | TholdAskSize | ✅ 存在 |
| m_tholdAskMaxPos | ExtraStrategy | TholdAskMaxPos | ✅ 存在 |

### 2.8 订单映射 (Order Maps)

**C++ ExecutionStrategy.h:257-264**:
```cpp
OrderMap m_ordMap;          // 订单ID → OrderStats*
OrderMap m_sweepordMap;     // 扫单订单映射
PriceMap m_bidMap;          // 买价 → OrderStats*
PriceMap m_askMap;          // 卖价 → OrderStats*
PriceMap m_bidMapCache;     // 买价缓存
PriceMap m_askMapCache;     // 卖价缓存
```

**Go 对比**:

| C++ 字段 | Go 位置 | Go 字段名 | 状态 |
|----------|---------|-----------|------|
| m_ordMap | ExtraStrategy | OrdMap | ✅ 存在 |
| m_sweepordMap | ExtraStrategy | SweepOrdMap | ✅ 存在 |
| m_bidMap | ExtraStrategy | BidMap | ✅ 存在 |
| m_askMap | ExtraStrategy | AskMap | ✅ 存在 |
| m_bidMapCache | ExtraStrategy | BidMapCache | ✅ 存在 |
| m_askMapCache | ExtraStrategy | AskMapCache | ✅ 存在 |

---

## 3. ThresholdSet 对比

### 3.1 核心阈值参数

**C++ TradeBotUtils.h:237-420**:

| C++ 参数 | Go ThresholdSet 字段 | 状态 |
|----------|---------------------|------|
| BEGIN_PLACE | BeginPlace | ✅ 存在 |
| BEGIN_REMOVE | BeginRemove | ✅ 存在 |
| LONG_PLACE | LongPlace | ✅ 存在 |
| LONG_REMOVE | LongRemove | ✅ 存在 |
| SHORT_PLACE | ShortPlace | ✅ 存在 |
| SHORT_REMOVE | ShortRemove | ✅ 存在 |
| LONG_INC | LongInc | ✅ 存在 |
| SIZE | Size | ✅ 存在 |
| BEGIN_SIZE | BeginSize | ✅ 存在 |
| MAX_SIZE | MaxSize | ✅ 存在 |
| SUPPORTING_ORDERS | SupportingOrders | ✅ 存在 |
| MAX_QUOTE_LEVEL | MaxQuoteLevel | ✅ 存在 |
| MAX_OS_ORDER | MaxOSOrder | ✅ 存在 |
| CROSS | Cross | ✅ 存在 |
| CLOSE_CROSS | CloseCross | ✅ 存在 |
| IMPROVE | Improve | ✅ 存在 |
| CLOSE_IMPROVE | CloseImprove | ✅ 存在 |
| AGG_COOL_OFF | AggCoolOff | ✅ 存在 |
| STOP_LOSS | StopLoss | ✅ 存在 |
| MAX_LOSS | MaxLoss | ✅ 存在 |
| UPNL_LOSS | UPnlLoss | ✅ 存在 |
| SLOP | Slop | ✅ 存在 |
| PAUSE | Pause | ✅ 存在 |

### 3.2 缺失的阈值参数

| C++ 参数 | 用途 | 优先级 |
|----------|------|--------|
| BID_SIZE | 买单大小覆盖 | 低 |
| ASK_SIZE | 卖单大小覆盖 | 低 |
| BID_MAX_SIZE | 买单最大持仓 | 中 |
| ASK_MAX_SIZE | 卖单最大持仓 | 中 |
| SWEEP_PLACE | 扫单开仓阈值 | 低 |
| SWEEP_CLOSE | 扫单平仓阈值 | 低 |
| MAX_ORDERS | 最大订单数 | 高 |
| TAILING_ORDERS | 追单数量 | 中 |
| MAX_CROSS | 最大主动单数 | 中 |
| MAX_IMPROVE | 最大改价次数 | 中 |
| DELTA_HEDGE | Delta 对冲阈值 | 低 |
| VWAP_RATIO | VWAP 比率 | 低 |
| HEDGE_RATIO | 对冲比率 | 中 |
| AHEAD_PERCENT | 队列位置百分比 | 低 |

---

## 4. OrderStats 对比

**C++ ExecutionStrategyStructs.h:44-68**:

| C++ 字段 | Go OrderStats 字段 | 状态 |
|----------|-------------------|------|
| m_active | Active | ✅ 存在 |
| m_new | New | ✅ 存在 |
| m_modifywait | ModifyWait | ✅ 存在 |
| m_cancel | Cancel | ✅ 存在 |
| m_modify | Modify | ✅ 存在 |
| m_lastTS | LastTS | ✅ 存在 |
| m_orderID | OrderID | ✅ 存在 |
| m_oldQty | OldQty | ✅ 存在 |
| m_newQty | NewQty | ✅ 存在 |
| m_Qty | Qty | ✅ 存在 |
| m_openQty | OpenQty | ✅ 存在 |
| m_cxlQty | CxlQty | ✅ 存在 |
| m_doneQty | DoneQty | ✅ 存在 |
| m_quantAhead | QuantAhead | ✅ 存在 |
| m_quantBehind | QuantBehind | ✅ 存在 |
| m_price | Price | ✅ 存在 |
| m_newprice | NewPrice | ✅ 存在 |
| m_oldprice | OldPrice | ✅ 存在 |
| m_typeOfOrder | TypeOfOrder | ✅ 存在 |
| m_ordType | OrdType | ✅ 存在 |
| m_status | Status | ✅ 存在 |
| m_side | Side | ✅ 存在 |

**结论**: OrderStats 完全对齐 ✅

---

## 5. 方法对比

### 5.1 ExecutionStrategy 核心方法

| C++ 方法 | Go 实现位置 | 状态 |
|----------|------------|------|
| `SendOrder()` | - | ❌ 纯虚函数，由子类实现 |
| `SendBidOrder()` | ExtraStrategy.SendBidOrder2 | ✅ 存在 |
| `SendAskOrder()` | ExtraStrategy.SendAskOrder2 | ✅ 存在 |
| `SendCancelOrder()` | ExtraStrategy.SendCancelOrder | ✅ 存在 |
| `SendNewOrder()` | - | ⚠️ 通过 SendBidOrder2/SendAskOrder2 实现 |
| `SendModifyOrder()` | ExtraStrategy.SendModifyOrder | ✅ 存在 |
| `SendSweepOrder()` | ExtraStrategy.SendSweepOrder | ✅ 存在 |
| `ProcessTrade()` | ExtraStrategy.ProcessTrade | ✅ 存在 |
| `ProcessNewConfirm()` | ExtraStrategy.ProcessNewConfirm | ✅ 存在 |
| `ProcessCancelConfirm()` | ExtraStrategy.ProcessCancelConfirm | ✅ 存在 |
| `ProcessNewReject()` | ExtraStrategy.ProcessNewReject | ✅ 存在 |
| `ProcessModifyConfirm()` | ExtraStrategy.ProcessModifyConfirm | ✅ 存在 |
| `ProcessModifyReject()` | ExtraStrategy.ProcessModifyReject | ✅ 存在 |
| `ProcessCancelReject()` | ExtraStrategy.ProcessCancelReject | ✅ 存在 |
| `ProcessSelfTrade()` | ExtraStrategy.ProcessSelfTrade | ✅ 存在 |
| `CalculatePNL()` | ExtraStrategy.CalculatePNL | ✅ 存在 |
| `SetThresholds()` | ExtraStrategy.SetThresholds | ✅ 存在 |
| `SetLinearThresholds()` | ExtraStrategy.SetLinearThresholds | ✅ 存在 |
| `HandleSquareoff()` | ExtraStrategy.HandleSquareoff | ✅ 存在 |
| `HandleTimeLimitSquareoff()` | ExtraStrategy.HandleTimeLimitSquareoff | ✅ 存在 |
| `CheckSquareoff()` | ExtraStrategy.CheckSquareoff | ✅ 存在 |
| `Reset()` | ExtraStrategy.Reset | ✅ 存在 |
| `HandleOrderUpdate()` | ExtraStrategy.HandleOrderUpdate | ✅ 存在 |
| `GetBidPrice()` | ExtraStrategy.GetBidPrice | ✅ 存在 |
| `GetAskPrice()` | ExtraStrategy.GetAskPrice | ✅ 存在 |

### 5.2 ExtraStrategy 扩展方法

| C++ 方法 | Go 实现 | 状态 |
|----------|---------|------|
| `SendBidOrder2()` | ExtraStrategy.SendBidOrder2 | ✅ 存在 |
| `SendAskOrder2()` | ExtraStrategy.SendAskOrder2 | ✅ 存在 |
| `MDCallBack()` | Strategy.OnMarketData | ✅ 存在 |
| `HandleSquareON()` | - | ❌ 缺失 |
| `HandleSquareoff()` | ExtraStrategy.HandleSquareoff | ✅ 存在 |

### 5.3 PairwiseArbStrategy 方法

| C++ 方法 | Go 实现 | 状态 |
|----------|---------|------|
| `MDCallBack()` | OnMarketData | ✅ 存在 |
| `ORSCallBack()` | OnOrderUpdate | ✅ 存在 |
| `SendOrder()` | sendPassiveOrder | ✅ 存在 |
| `SendAggressiveOrder()` | sendAggressiveOrder | ✅ 存在 |
| `SetThresholds()` | setDynamicThresholds | ✅ 存在 |
| `HandleAggOrder()` | handleAggOrder | ⚠️ 部分实现 |
| `CalcPendingNetposAgg()` | calculatePendingNetpos | ✅ 存在 |
| `GetBidPrice_first()` | - | ❌ 缺失（价格优化） |
| `GetAskPrice_first()` | - | ❌ 缺失（价格优化） |
| `HandleSquareoff()` | handleSquareoff | ✅ 存在 |

---

## 6. 关键功能差异

### 6.1 价格优化 (Invisible Book)

**C++ 实现**: `GetBidPrice_first()` / `GetAskPrice_first()`
- 检测价格层级间隙
- 如果队列前方数量 > lotSize，改进一个 tick
- 避免被其他做市商发现

**Go 状态**: ⚠️ 基础方法 GetBidPrice/GetAskPrice 存在，但 Invisible Book 优化逻辑未实现

### 6.2 订单改价 (Modify Order)

**C++ 实现**: `SendModifyOrder()` + `ProcessModifyConfirm/Reject`
- 支持在途订单改价
- 处理改价确认/拒绝

**Go 状态**: ✅ 完全实现
- SendModifyOrder() 已实现
- ProcessModifyConfirm() 已实现
- ProcessModifyReject() 已实现

### 6.3 扫单逻辑 (Sweep Order)

**C++ 实现**: `m_sweepordMap` + `SendSweepOrder()`
- 独立的扫单订单映射
- 市价扫单逻辑

**Go 状态**: ✅ 已实现
- SweepOrdMap 字段存在
- SendSweepOrder() 方法已实现

### 6.4 队列位置计算 (Queue Position)

**C++ 实现**: `SetQuantAhead()` + `m_quantAhead/m_quantBehind`
- 计算订单在队列中的位置
- 用于决定是否改价

**Go 状态**: ⚠️ OrderStats 中 QuantAhead/QuantBehind 字段存在，但计算逻辑未实现

### 6.5 监控上报 (Monitor Report)

**C++ 实现**: `SendMonitorStrat*()` 系列方法
- 上报策略状态
- 上报 PNL
- 上报持仓
- 上报撤单状态

**Go 状态**: ⚠️ 未实现（当前使用日志输出替代，如需对接 C++ 监控系统可添加）

### 6.6 撤单拒绝处理 (Cancel Reject)

**C++ 实现**: `ProcessCancelReject()`
- 处理撤单被拒绝的情况
- 更新 LastCancelRejectTime, LastCancelRejectOrderID

**Go 状态**: ✅ 已实现

### 6.7 自成交处理 (Self Trade)

**C++ 实现**: `ProcessSelfTrade()`
- 处理自成交检测

**Go 状态**: ✅ 已实现

---

## 7. 修复计划

### 7.1 当前状态总结

经过详细对比，ExtraStrategy 的实现已经**非常完整**，绝大部分 C++ 字段和方法都已实现：

**已完成 ✅**:
- 所有持仓字段 (NetPos, NetPosPass, NetPosPassYtd, NetPosAgg)
- 所有订单统计字段 (ImproveCount, CrossCount, ConfirmCount 等 14 个)
- 所有成交量字段 (BuyOpenQty, SellOpenQty, BuyTotalValue, SellTotalValue 等)
- 所有 PNL 字段 (GrossPNL, MaxPNL, Drawdown)
- 所有控制状态字段 (OnStopLoss, OnMaxPx, OnNewsFlat, OnTimeSqOff 等)
- 所有阈值字段 (TholdMaxPos, TholdBeginPos, TholdSize 等)
- 所有订单映射 (OrdMap, SweepOrdMap, BidMapCache, AskMapCache)
- 所有核心方法 (ProcessTrade, ProcessModifyConfirm/Reject, ProcessCancelReject 等)

### 7.2 已完成项目 (P1) ✅

| 序号 | 问题 | 修复方案 | 状态 |
|------|------|----------|------|
| 1 | 价格优化逻辑未完全实现 | GetBidPrice_first/GetAskPrice_first 已增加 QuantAhead 检查 | ✅ 已完成 |
| 2 | 队列位置计算 SetQuantAhead 未实现 | 在 ExtraStrategy 中实现 SetQuantAhead, InitQuantAhead | ✅ 已完成 |
| 3 | HandleSquareON 逻辑错误 | 修复为正确的平仓恢复逻辑（重置 OnFlat/OnExit/OnCancel） | ✅ 已完成 |
| 4 | 监控上报方法未实现 | 使用日志替代（可选，按需实现） | ⏸️ 低优先级 |

**已实现的方法**:
- `ExtraStrategy.SetQuantAhead(updateType, price, newQuant, oldQuant, side)` - 队列位置跟踪
- `ExtraStrategy.InitQuantAhead(orderID, totalQtyAtPrice, estimatedPosition)` - 初始化队列位置
- `ExtraStrategy.GetQuantAhead(orderID) / GetQuantBehind(orderID)` - 获取队列位置
- `PairwiseArbStrategy.GetBidPrice_first/GetAskPrice_first` - 增加 QuantAhead 检查

**测试文件**: `golang/pkg/strategy/extra_strategy_test.go` (11 个测试全部通过)

### 7.3 低优先级 (P2) - 可选增强

| 序号 | 问题 | 修复方案 | 工作量 |
|------|------|----------|--------|
| 5 | ThresholdSet 部分参数缺失 | 按需添加 BID_SIZE, MAX_ORDERS 等 | 2h |
| 6 | 统计队列未实现 | 添加 StatTradeQtyQ, StatPriceQ 等 | 4h |
| 7 | Delta/Vega 相关字段未实现 | 期权策略时添加 | 4h |

### 7.4 实施进度

**Phase 1: 价格优化 ✅ 已完成**
- ✅ GetBidPrice_first/GetAskPrice_first 已增加 QuantAhead 检查
- ✅ 在订单前方排队量大于 LotSize 时提升一个 tick

**Phase 2: 队列位置计算 ✅ 已完成**
- ✅ 实现 SetQuantAhead 方法 (支持 Trade/Add/Delete/Modify 四种更新类型)
- ✅ 根据行情深度计算订单在队列中的位置
- ✅ 添加 InitQuantAhead, GetQuantAhead, GetQuantBehind 辅助方法

**Phase 3: 开仓恢复 ✅ 已完成**
- ✅ 修复 HandleSquareON 方法（原逻辑错误，现已正确重置 OnFlat/OnExit/OnCancel）
- ✅ 平仓完成后正确恢复开仓能力

**Phase 4: 可选增强 (按需)**
- ⏸️ 监控上报（如需要与 C++ 监控系统对接）
- ⏸️ 更多阈值参数（如需要）

---

## 8. 验证方案

### 8.1 单元测试

```bash
# 测试 ExtraStrategy 字段完整性
go test -v ./pkg/strategy/... -run "TestExtraStrategy"

# 测试 OrderStats
go test -v ./pkg/strategy/... -run "TestOrderStats"

# 测试 ThresholdSet
go test -v ./pkg/strategy/... -run "TestThresholdSet"
```

### 8.2 端到端测试

```bash
# 模拟环境测试
./scripts/test/e2e/test_simulator_e2e.sh

# 验证订单统计
grep "TradeCount\|RejectCount\|OrderCount" log/trader.test.log
```

### 8.3 对比测试

创建相同的市场条件，对比 C++ 和 Go 的：
- 持仓变化
- PNL 计算
- 订单生成数量
- 阈值计算结果

---

## 9. 附录

### 9.1 C++ 原代码位置速查

| 功能 | 文件 | 行号 |
|------|------|------|
| ExecutionStrategy 字段 | tbsrc/Strategies/include/ExecutionStrategy.h | 1-350 |
| ExtraStrategy 定义 | tbsrc/Strategies/include/ExtraStrategy.h | 1-100 |
| OrderStats 结构 | tbsrc/Strategies/include/ExecutionStrategyStructs.h | 44-68 |
| ThresholdSet 结构 | tbsrc/main/include/TradeBotUtils.h | 237-420 |
| PairwiseArbStrategy | tbsrc/Strategies/PairwiseArbStrategy.cpp | 1-800 |

### 9.2 Go 代码位置速查

| 功能 | 文件 |
|------|------|
| Strategy 接口 | golang/pkg/strategy/strategy.go |
| BaseStrategy | golang/pkg/strategy/strategy.go |
| ExtraStrategy | golang/pkg/strategy/extra_strategy.go |
| OrderStats | golang/pkg/strategy/order_stats.go |
| ThresholdSet | golang/pkg/strategy/threshold_set.go |
| PairwiseArbStrategy | golang/pkg/strategy/pairwise_arb_strategy.go |

---

## 10. 总结

### 10.1 整体完成度

| 模块 | 完成度 | 说明 |
|------|--------|------|
| ExtraStrategy 字段 | **95%** | 几乎所有 C++ 字段都已实现 |
| ExtraStrategy 方法 | **95%** | 核心方法全部实现，SetQuantAhead/InitQuantAhead 已完成 |
| OrderStats | **100%** | 完全对齐 C++ |
| ThresholdSet | **85%** | 核心参数已实现，部分高级参数待添加 |
| PairwiseArbStrategy | **95%** | 主流程完整，价格优化已实现，HandleSquareON 已修复 |

### 10.2 架构差异处理

Go 代码采用组合而非继承，通过以下方式保持与 C++ 的一致性：
1. `Strategy` 接口定义统一的方法签名
2. `BaseStrategy` 嵌入提供基础功能
3. `ExtraStrategy` 作为独立结构体管理单腿状态
4. `GetBaseStrategy()` 方法提供基类访问

### 10.3 待完善项目优先级

**P0 (必须)**: 无 - 核心功能已完整

**P1 (建议)**: ✅ 全部完成
1. ✅ 价格优化逻辑 (Invisible Book) - 已实现 QuantAhead 检查
2. ✅ 队列位置计算 - 已实现 SetQuantAhead
3. ✅ HandleSquareON 修复 - 已修复平仓恢复逻辑

**P2 (可选)**:
1. 监控上报 - 如需与 C++ 系统对接
2. 更多阈值参数 - 按需添加

### 10.4 下一步行动

1. ✅ P1 项目全部完成
2. ✅ 单元测试全部通过 (11/11)
3. 运行端到端测试验证完整实现
4. 持续对比 C++ 原代码，确保逻辑一致

### 10.5 已完成的修复 (2026-02-10)

**文件变更**:
- `golang/pkg/strategy/extra_strategy.go`:
  - 添加 `SetQuantAhead()` - 队列位置跟踪
  - 添加 `InitQuantAhead()` - 初始化队列位置
  - 添加 `GetQuantAhead()` / `GetQuantBehind()` - 获取队列位置
  - 添加 `MarketUpdateType` 枚举 (Trade/Add/Delete/Modify)

- `golang/pkg/strategy/pairwise_arb_strategy.go`:
  - 修复 `HandleSquareON()` - 原逻辑错误设置 OnFlat=true，现正确重置为 false
  - 增强 `GetBidPrice_first()` / `GetAskPrice_first()` - 添加 QuantAhead 检查

- `golang/pkg/strategy/extra_strategy_test.go`:
  - 新建测试文件，包含 11 个测试用例
  - 测试覆盖: Creation, ProcessTrade, SetQuantAhead, InitQuantAhead, HandleSquareoff 等

---

**最后更新**: 2026-02-10 16:30
