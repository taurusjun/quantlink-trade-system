# Phase 5：C++ 对照修正与完善

**文档日期**: 2026-02-13
**版本**: v1.0
**相关模块**: tbsrc-golang/pkg/strategy, tbsrc-golang/pkg/execution

---

## 概述

Phase 5 对 Phase 3-4 实现的代码进行 C++ 逐行对照审查，修正与 C++ 原代码的偏差，补充缺失功能。

## 修正内容

### 1. SetThresholds 修正（关键修复）

**问题**: Go 通用 `ExecutionState.SetThresholds()` 使用 `Netpos`（总持仓）进行离散跳变阈值调整，但 C++ `PairwiseArbStrategy::SetThresholds()` 使用 `m_netpos_pass`（被动持仓）进行线性插值。

**修正**: 新增 `pairwise_thresholds.go`，实现 PairwiseArb 专用的 `setThresholds()` 方法：
- 使用 `NetposPass`（被动持仓）而非 `Netpos`
- 线性插值而非离散跳变
- 正确设置独立的 `BidSize/AskSize/BidMaxSize/AskMaxSize`
- `sendInLots` 模式：`TholdMaxPos = max(BID_MAX_SIZE, ASK_MAX_SIZE)`
- 非 `sendInLots` 模式：`TholdMaxPos = MAX_SIZE * lotSize`

**C++ 参考**: `PairwiseArbStrategy.cpp:902-947`

### 2. SendOrder 修正

**修正内容**:
- Leg1 报价使用 `SendAskOrder2`/`SendBidOrder2`（独立 bid/ask 大小）替代 `SendAskOrder`/`SendBidOrder`
- 挂单数量限制检查改为 `SUPPORTING_ORDERS`（C++ 原始逻辑）替代 `MAX_OS_ORDER`
- 增加 `sellOpenQty + netposPass >= tholdAskMaxPos` 复合条件检查
- 持仓超限时撤销所有同方向挂单（C++ 原始逻辑）
- `hedgeLeg2()` 增加 100ms 冷却时间和 `last_agg_side` 检查

**C++ 参考**: `PairwiseArbStrategy.cpp:146-385`

### 3. GetBidPrice2/GetAskPrice2（第二条腿价格改善）

**新增**: `pairwise_price.go` 中增加 `GetBidPrice2()` 和 `GetAskPrice2()` 方法：
- `GetBidPrice2`: 第二条腿 bid 价格改善，用 `leg1.bidPx[0]` 计算卖价差
- `GetAskPrice2`: 第二条腿 ask 价格改善，用 `leg1.askPx[0]` 计算买价差

**C++ 参考**: `PairwiseArbStrategy.cpp:842-883`

### 4. HandleSquareoff 保存 daily_init

**修正**: `HandleSquareoff()` 在平仓退出后自动保存 daily_init 状态：
- `AvgSpreadOri`: 当前 EWA 价差
- `NetposYtd1`: 昨仓
- `Netpos2day1`: 今仓增量
- `NetposAgg2`: 主动持仓

**新增字段**: `PairwiseArbStrategy.DailyInitPath` — 由 `main.go` 设置

### 5. 测试新增

| 测试文件 | 测试数 | 覆盖内容 |
|---------|-------|---------|
| `pairwise_thresholds_test.go` | 6 | 平仓/多头/空头线性插值、sendInLots、默认值、NetposPass vs Netpos |
| `pairwise_price_test.go` (扩展) | 5 | GetBidPrice2/GetAskPrice2 各场景 |

## 验证

- 157 个测试全部通过
- 8 个包编译通过
- Linux/amd64 交叉编译验证通过

---

**最后更新**: 2026-02-13 21:55
