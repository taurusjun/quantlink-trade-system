# æŒä»“æ•°æ®æ¥æºåˆ†ææŠ¥å‘Š

**æ—¶é—´**: 2026-01-30 16:00
**é—®é¢˜**: "è®¢å•æ˜¯ç©ºçš„ï¼Œä½†æ˜¯æœ‰æŒä»“" - è¿™äº›æŒä»“ä»å“ªé‡Œæ¥ï¼Ÿ
**ç»“è®º**: ä»æŒä»“æŒä¹…åŒ–æ–‡ä»¶ (`data/positions/*.json`) æ¢å¤

---

## ğŸ“Š ç°è±¡è§‚å¯Ÿ

### Dashboard æ˜¾ç¤ºçš„æŒä»“

ä» Dashboard å¯ä»¥çœ‹åˆ°ï¼š
- au2604 (Leg1): 4 lots LONG
- au2606 (Leg2): 4 lots SHORT

### API è¿”å›çš„æŒä»“

```bash
$ curl http://localhost:9201/api/v1/strategy/status | jq '.data.legs'
[
  {
    "symbol": "ag2603",
    "price": 7435.998,
    "position": -20,
    "side": "short"
  },
  {
    "symbol": "ag2605",
    "price": 7437.547,
    "position": 20,
    "side": "long"
  }
]
```

###æ³¨æ„åˆ°çš„å…³é”®ç‚¹

1. **å½“å‰æ²¡æœ‰è®¢å•**: `orderMap` ä¸ºç©º
2. **ä½†æœ‰æŒä»“æ•°æ®**: legs æ˜¾ç¤ºæœ‰æŒä»“
3. **estimated_position ä¸º null**: ç­–ç•¥ä¼°ç®—æŒä»“æ˜¯ç©ºçš„

---

## ğŸ” æŒä»“æ•°æ®æ¥æºè¿½è¸ª

### 1. æŒä»“æŒä¹…åŒ–æ–‡ä»¶

**ä½ç½®**: `data/positions/`

```bash
$ ls -lh data/positions/
-rw-r--r--  287B  live_ag_spread.json
-rw-r--r--  287B  live_au_spread.json
-rw-r--r--  284B  test_92201.json
-rw-r--r--  284B  test_92202.json
-rw-r--r--  284B  test_92203.json
```

**æ–‡ä»¶å†…å®¹** (`test_92202.json`):
```json
{
  "strategy_id": "test_92202",
  "timestamp": "2026-01-30T15:14:41.606901+08:00",
  "symbols_position": {
    "au2604": 4,
    "au2606": -4
  },
  "total_long_qty": 0,
  "total_short_qty": 0,
  "total_net_qty": 0,
  "avg_long_price": 0,
  "avg_short_price": 0,
  "realized_pnl": 0
}
```

**å…³é”®æ•°æ®**:
- `symbols_position`: æ¯ä¸ªå“ç§çš„æŒä»“
  - au2604: +4 (long)
  - au2606: -4 (short)

### 2. æŒä»“æ¢å¤æœºåˆ¶

**ä»£ç ä½ç½®**: `golang/pkg/strategy/pairwise_arb_strategy.go`

**å¯åŠ¨æ—¶åŠ è½½**:
```go
// åœ¨ NewPairwiseArbStrategy() ä¸­
if snapshot, err := LoadPositionSnapshot(pas.ID); err == nil && snapshot != nil {
    log.Printf("[PairwiseArbStrategy:%s] Restoring position from snapshot (saved at %s)",
        pas.ID, snapshot.Timestamp.Format("2006-01-02 15:04:05"))

    // æ¢å¤legæŒä»“
    if qty, exists := snapshot.SymbolsPos[pas.symbol1]; exists {
        pas.leg1Position = qty
        log.Printf("[PairwiseArbStrategy:%s] Restored leg1 position: %s = %d",
            pas.ID, pas.symbol1, qty)
    }
    if qty, exists := snapshot.SymbolsPos[pas.symbol2]; exists {
        pas.leg2Position = qty
        log.Printf("[PairwiseArbStrategy:%s] Restored leg2 position: %s = %d",
            pas.ID, pas.symbol2, qty)
    }

    // æ¢å¤EstimatedPosition
    pas.EstimatedPosition.LongQty = snapshot.TotalLongQty
    pas.EstimatedPosition.ShortQty = snapshot.TotalShortQty
    pas.EstimatedPosition.NetQty = snapshot.TotalNetQty
    pas.EstimatedPosition.AvgLongPrice = snapshot.AvgLongPrice
    pas.EstimatedPosition.AvgShortPrice = snapshot.AvgShortPrice
}
```

### 3. æŒä»“ä¿å­˜æœºåˆ¶

**ä¿å­˜æ—¶æœº**:
```go
// åœ¨è®¢å•æˆäº¤å
func (pas *PairwiseArbStrategy) OnOrderUpdate(update *orspb.OrderUpdate) {
    // ... æ›´æ–°æŒä»“ ...

    // ä¿å­˜å¿«ç…§
    if err := SaveStrategyPosition(pas); err != nil {
        log.Printf("[PairwiseArbStrategy:%s] Failed to save position: %v", pas.ID, err)
    }
}
```

**ä¿å­˜å‡½æ•°**: `golang/pkg/strategy/position_persistence.go`
```go
func SaveStrategyPosition(strategy Strategy) error {
    pos := strategy.GetEstimatedPosition()

    snapshot := PositionSnapshot{
        StrategyID:    strategy.GetID(),
        Timestamp:     time.Now(),
        TotalLongQty:  pos.LongQty,
        TotalShortQty: pos.ShortQty,
        TotalNetQty:   pos.NetQty,
        AvgLongPrice:  pos.AvgLongPrice,
        AvgShortPrice: pos.AvgShortPrice,
        RealizedPnL:   strategy.GetPNL().RealizedPnL,
        SymbolsPos:    make(map[string]int64),
    }

    // å¦‚æœç­–ç•¥å®ç°äº†PositionProvideræ¥å£ï¼Œè·å–æŒ‰å“ç§çš„æŒä»“
    if provider, ok := strategy.(PositionProvider); ok {
        snapshot.SymbolsPos = provider.GetPositionsBySymbol()
    }

    return SavePositionSnapshot(snapshot)
}
```

---

## ğŸ¯ ä¸‰ç§æŒä»“æ•°æ®

### 1. ç­–ç•¥ä¼°ç®—æŒä»“ (EstimatedPosition)

**æ¥æº**: ä»è®¢å•æˆäº¤å›æŠ¥è®¡ç®—
**ä½ç½®**: `BaseStrategy.EstimatedPosition`
**æ›´æ–°æ—¶æœº**: è®¢å•æˆäº¤æ—¶

**å‰ææ¡ä»¶**: **å¿…é¡»æœ‰è®¢å•æˆäº¤**

```go
// è®¢å•æˆäº¤å›æŠ¥
OnOrderUpdate(update) {
    if update.Status == FILLED {
        if update.Side == BUY {
            EstimatedPosition.LongQty += update.FilledQty
        }
    }
}
```

**ç‰¹ç‚¹**:
- âœ… å®æ—¶æ›´æ–°
- âŒ å¯èƒ½ä¸å‡†ç¡®ï¼ˆéƒ¨åˆ†æˆäº¤ã€æ‹’å•ã€é‡å¯ï¼‰
- âŒ ç­–ç•¥é‡å¯åæ¸…é›¶ï¼ˆé™¤éä»æ–‡ä»¶æ¢å¤ï¼‰

### 2. å“ç§æŒä»“ (leg1Position, leg2Position)

**æ¥æº**:
1. ä»è®¢å•æˆäº¤å›æŠ¥è®¡ç®—ï¼ˆæ­£å¸¸è¿è¡Œæ—¶ï¼‰
2. ä»æŒä»“å¿«ç…§æ–‡ä»¶æ¢å¤ï¼ˆå¯åŠ¨æ—¶ï¼‰

**ä½ç½®**: `PairwiseArbStrategy.leg1Position`, `leg2Position`
**æ˜¾ç¤ºä½ç½®**: API response çš„ `legs` å­—æ®µ

**ç‰¹ç‚¹**:
- âœ… å…·ä½“åˆ°æ¯ä¸ªå“ç§
- âœ… å¯åŠ¨æ—¶ä»æ–‡ä»¶æ¢å¤
- âœ… ç”¨äºDashboardæ˜¾ç¤º

### 3. çœŸå®æŒä»“ (Real CTP Position)

**æ¥æº**: CTP æŸœå°
**æŸ¥è¯¢æ–¹å¼**: `QueryPositions()` API
**ç‰¹ç‚¹**:
- âœ… å”¯ä¸€çœŸç›¸æ¥æº
- âŒ æŸ¥è¯¢æœ‰å»¶è¿Ÿ
- âŒ ä¸èƒ½é¢‘ç¹æŸ¥è¯¢

---

## ğŸ”„ å®Œæ•´çš„æŒä»“æ•°æ®æµ

### æ­£å¸¸äº¤æ˜“æµç¨‹

```
1. ç­–ç•¥ç”Ÿæˆä¿¡å·
    â†“
2. å‘é€è®¢å•
    â†“
3. è®¢å•æˆäº¤å›æŠ¥
    â†“
4. æ›´æ–° EstimatedPosition
    â†“
5. æ›´æ–° leg1Position, leg2Position
    â†“
6. ä¿å­˜åˆ° data/positions/<strategy_id>.json
```

### ç­–ç•¥é‡å¯æµç¨‹

```
1. Trader å¯åŠ¨
    â†“
2. åˆ›å»ºç­–ç•¥å®ä¾‹ (NewPairwiseArbStrategy)
    â†“
3. åŠ è½½æŒä»“å¿«ç…§æ–‡ä»¶ (LoadPositionSnapshot)
    â†“
4. æ¢å¤ leg1Position, leg2Position
    â†“
5. æ¢å¤ EstimatedPosition
    â†“
6. Dashboard æ˜¾ç¤ºæ¢å¤çš„æŒä»“
```

---

## ğŸ“ å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜1: estimated_position ä¸º null

**API è¿”å›**:
```json
{
  "estimated_position": null,
  "legs": [...]
}
```

**åŸå› **:
1. `BaseStrategy.EstimatedPosition` å¯èƒ½æ²¡æœ‰æ­£ç¡®æ¢å¤
2. æˆ–è€…æ¢å¤äº†ä½† API åºåˆ—åŒ–æ—¶æœ‰é—®é¢˜

**æ£€æŸ¥ç‚¹**:
```go
// æ£€æŸ¥ç­–ç•¥æ˜¯å¦æ¢å¤äº†EstimatedPosition
pas.EstimatedPosition.LongQty = snapshot.TotalLongQty
pas.EstimatedPosition.ShortQty = snapshot.TotalShortQty
pas.EstimatedPosition.NetQty = snapshot.TotalNetQty
```

### é—®é¢˜2: legs æœ‰æ•°æ®ä½† estimated_position ä¸ºç©º

**è§‚å¯Ÿ**:
- `legs` å­—æ®µæœ‰æŒä»“æ•°æ®ï¼ˆä» leg1Position, leg2Position æ¥ï¼‰
- `estimated_position` ä¸º nullï¼ˆBaseStrategy.EstimatedPosition ä¸ºç©ºï¼‰

**å¯èƒ½åŸå› **:
1. `leg1Position/leg2Position` ä»æ–‡ä»¶æ¢å¤äº†
2. ä½† `EstimatedPosition` æ²¡æœ‰æ­£ç¡®æ¢å¤
3. æˆ–è€… `EstimatedPosition` æ¢å¤äº†ä½†æ•°æ®å…¨æ˜¯0

**éªŒè¯æ–¹æ³•**:
```bash
# æ£€æŸ¥æ—¥å¿—
grep "Restored.*position" log/trader.log
grep "EstimatedPosition" log/trader.log
```

---

## âœ… æŒä»“æ•°æ®æ¥æºæ€»ç»“

### Dashboard æ˜¾ç¤ºçš„æŒä»“æ•°æ®æ¥æº

**æ¥æº**: `legs` å­—æ®µ
- ag2603: -20 (short) â† `pas.leg1Position`
- ag2605: +20 (long) â† `pas.leg2Position`

**è¿™äº›æ•°æ®ä»å“ªé‡Œæ¥**:
1. **ç­–ç•¥åˆšå¯åŠ¨**: ä» `data/positions/<strategy_id>.json` æ¢å¤
2. **æ­£å¸¸è¿è¡Œæ—¶**: ä»è®¢å•æˆäº¤å›æŠ¥è®¡ç®—

### ä¸ºä»€ä¹ˆ"è®¢å•æ˜¯ç©ºçš„ä½†æœ‰æŒä»“"ï¼Ÿ

**ç­”æ¡ˆ**: å› ä¸ºç­–ç•¥é‡å¯æ—¶ï¼Œä»æŒä»“æŒä¹…åŒ–æ–‡ä»¶æ¢å¤äº†ä¹‹å‰çš„æŒä»“çŠ¶æ€ã€‚

**è¯æ®**:
1. `data/positions/test_92202.json` æ–‡ä»¶å­˜åœ¨
2. æ–‡ä»¶ä¸­è®°å½•äº† au2604: +4, au2606: -4
3. ç­–ç•¥å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªæ–‡ä»¶
4. æ¢å¤ `leg1Position` å’Œ `leg2Position`

**è¿™è¯´æ˜**:
- âœ… è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œä¸æ˜¯bug
- âœ… æŒä»“æŒä¹…åŒ–æœºåˆ¶æ­£å¸¸å·¥ä½œ
- âš ï¸ ä½†éœ€è¦æ³¨æ„ï¼šè¿™æ˜¯**å†å²æŒä»“**ï¼Œä¸æ˜¯å½“å‰è®¢å•ç”Ÿæˆçš„

---

## âš ï¸ é‡è¦è­¦å‘Š

### æŒä»“ä¼°ç®—çš„å±€é™æ€§

1. **ä»æ–‡ä»¶æ¢å¤çš„æŒä»“å¯èƒ½ä¸å‡†ç¡®**
   - æ–‡ä»¶ä¿å­˜çš„æ˜¯ç­–ç•¥ä¸Šæ¬¡è¿è¡Œçš„çŠ¶æ€
   - ä¸ä»£è¡¨CTPçœŸå®æŒä»“
   - å¯èƒ½å› ä¸ºæ‰‹åŠ¨æ“ä½œã€å¼‚å¸¸é€€å‡ºç­‰åŸå› ä¸ä¸€è‡´

2. **æ²¡æœ‰è®¢å•ä¸ä»£è¡¨æ²¡æœ‰æŒä»“**
   - `orderMap` ä¸ºç©ºåªè¯´æ˜å½“å‰æ²¡æœ‰å¾…å¤„ç†è®¢å•
   - ä¸ä»£è¡¨æ²¡æœ‰å†å²æŒä»“
   - å†å²æŒä»“ä»æŒä¹…åŒ–æ–‡ä»¶æ¢å¤

3. **éœ€è¦ä¸çœŸå®CTPæŒä»“åŒæ­¥**
   - å¯åŠ¨æ—¶åº”è¯¥æŸ¥è¯¢CTPçœŸå®æŒä»“
   - ä¸æŒä¹…åŒ–æ–‡ä»¶å¯¹æ¯”
   - å¦‚æœä¸ä¸€è‡´ï¼Œä½¿ç”¨CTPæŒä»“è¦†ç›–

---

## ğŸ¯ å»ºè®®æ”¹è¿›

### 1. å¯åŠ¨æ—¶æŸ¥è¯¢çœŸå®æŒä»“

```go
func (t *Trader) Start() error {
    // 1. æŸ¥è¯¢CTPçœŸå®æŒä»“
    ctpPositions := t.QueryCTPPositions()

    // 2. åŠ è½½æŒä¹…åŒ–æ–‡ä»¶
    snapshot := LoadPositionSnapshot(strategyID)

    // 3. å¯¹æ¯”å¹¶åŒæ­¥
    if !PositionsMatch(ctpPositions, snapshot) {
        log.Warn("Position mismatch! Using CTP as source of truth")
        // ä½¿ç”¨CTPæŒä»“åˆå§‹åŒ–ç­–ç•¥
        strategy.InitializePositions(ctpPositions)
    } else {
        // æŒä¹…åŒ–æ–‡ä»¶å‡†ç¡®ï¼Œä½¿ç”¨å®ƒ
        strategy.RestoreFromSnapshot(snapshot)
    }

    // 4. å¯åŠ¨ç­–ç•¥
    t.Strategy.Start()
}
```

### 2. å®šæœŸæ ¡éªŒæŒä»“

```go
// æ¯5åˆ†é’Ÿæ‰§è¡Œ
func (t *Trader) SyncPositions() {
    ctpPositions := t.QueryCTPPositions()
    estimatedPositions := t.Strategy.GetEstimatedPosition()

    for symbol := range ctpPositions {
        ctpQty := ctpPositions[symbol]
        estQty := estimatedPositions[symbol]

        if ctpQty != estQty {
            log.Warnf("Position mismatch for %s: CTP=%d, Estimated=%d",
                symbol, ctpQty, estQty)
            // å¼ºåˆ¶åŒæ­¥
            t.Strategy.ForceSync(symbol, ctpQty)
        }
    }
}
```

### 3. Dashboard æ˜¾ç¤ºæŒä»“æ¥æº

åœ¨ Dashboard ä¸Šæ˜ç¡®æ ‡æ³¨æŒä»“æ•°æ®çš„æ¥æºï¼š

```
æŒä»“ä¿¡æ¯ï¼ˆä»æ–‡ä»¶æ¢å¤ï¼‰âš ï¸
- au2604: +4 lots
- au2606: -4 lots
- ä¸Šæ¬¡æ›´æ–°: 2026-01-30 15:14

[ğŸ”„ æŸ¥è¯¢CTPçœŸå®æŒä»“] æŒ‰é’®
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“– æŒä»“æ¦‚å¿µæ¾„æ¸…: `docs/å®ç›˜/æŒä»“æ¦‚å¿µæ¾„æ¸…_2026-01-30-11_25.md`
- ğŸ“– Positioné‡å‘½å: `docs/åŠŸèƒ½å®ç°/Positioné‡å‘½åä¸ºEstimatedPosition_2026-01-30-15_45.md`
- ğŸ“– æŒä»“ç®¡ç†Phase2-5: `docs/å®ç›˜/Phase2-5_å®Œæ•´æŒä»“ç®¡ç†åŠŸèƒ½å®æ–½æŠ¥å‘Š_2026-01-30-11_35.md`

---

## ğŸ‰ ç»“è®º

### é—®é¢˜å›ç­”ï¼š"è®¢å•æ˜¯ç©ºçš„ï¼Œä½†æ˜¯æœ‰æŒä»“" - ä¸ºä»€ä¹ˆï¼Ÿ

**ç­”æ¡ˆ**: æŒä»“æ•°æ®ä»æŒä¹…åŒ–æ–‡ä»¶ (`data/positions/*.json`) æ¢å¤ï¼Œä¸æ˜¯ä»å½“å‰è®¢å•ç”Ÿæˆçš„ã€‚

### æŒä»“æ•°æ®çš„ä¸‰ä¸ªå±‚æ¬¡

1. **EstimatedPosition**: ç­–ç•¥ä¼°ç®—æŒä»“ï¼ˆä»è®¢å•å›æŠ¥è®¡ç®—ï¼‰
2. **leg1Position/leg2Position**: å…·ä½“å“ç§æŒä»“ï¼ˆå¯ä»æ–‡ä»¶æ¢å¤ï¼‰
3. **Real CTP Position**: çœŸå®æŒä»“ï¼ˆéœ€è¦æŸ¥è¯¢CTPï¼‰

### Dashboard æ˜¾ç¤ºçš„æ˜¯ä»€ä¹ˆï¼Ÿ

- **legs å­—æ®µ**: ä» `leg1Position/leg2Position` æ¥
- **æ•°æ®æ¥æº**: ç­–ç•¥å¯åŠ¨æ—¶ä» `data/positions/<strategy_id>.json` æ¢å¤
- **å‡†ç¡®æ€§**: å¯èƒ½ä¸CTPçœŸå®æŒä»“ä¸ä¸€è‡´ï¼Œéœ€è¦æ ¡éªŒ

### æ‚¨çš„è§‚å¯Ÿæ˜¯æ­£ç¡®çš„

âœ… **ç­–ç•¥ä¼°ç®—æŒä»“ç¡®å®éœ€è¦è®¢å•æˆäº¤æ‰èƒ½æ›´æ–°**
âœ… **æ²¡æœ‰è®¢å•ä½†æœ‰æŒä»“æ•°æ®ï¼Œè¯´æ˜æ˜¯ä»æŒä¹…åŒ–æ–‡ä»¶æ¢å¤çš„**
âœ… **è¿™äº›æŒä»“å¯èƒ½ä¸æ˜¯çœŸå®CTPæŒä»“ï¼Œéœ€è¦æŸ¥è¯¢éªŒè¯**

---

**å®Œæˆæ—¶é—´**: 2026-01-30 16:00
**é—®é¢˜åˆ†æ**: âœ… å®Œæˆ
**æŒä»“æ¥æº**: âœ… å·²è¿½è¸ª
**æ”¹è¿›å»ºè®®**: âœ… å·²æä¾›
