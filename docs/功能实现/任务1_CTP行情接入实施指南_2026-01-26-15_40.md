# ä»»åŠ¡#1: CTPè¡Œæƒ…æ¥å…¥å¼€å‘å®æ–½æŒ‡å—

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-26
**ä»»åŠ¡çŠ¶æ€**: ğŸ”„ In Progress
**é¢„è®¡å®Œæˆ**: 2026-02-02
**ç›¸å…³ä»»åŠ¡**: TASKS.md#1

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è§ˆ

### ç›®æ ‡
å®ç°CTPï¼ˆä¸ŠæœŸæ‰€ç»¼åˆäº¤æ˜“å¹³å°ï¼‰è¡Œæƒ…APIé›†æˆï¼Œæ¥å…¥å®ç›˜è¡Œæƒ…æ•°æ®ï¼Œæ›¿æ¢å½“å‰çš„æ¨¡æ‹Ÿè¡Œæƒ…ç”Ÿæˆå™¨ã€‚

### å·¥ä½œé‡ä¼°ç®—
**æ€»è®¡**: 5-7å¤©

- ç¯å¢ƒå‡†å¤‡: 0.5å¤©
- æ ¸å¿ƒå¼€å‘: 3-4å¤©
- æµ‹è¯•éªŒè¯: 1-2å¤©
- æ–‡æ¡£æ•´ç†: 0.5å¤©

### éªŒæ”¶æ ‡å‡†
- [x] èƒ½å¤Ÿè¿æ¥CTPä»¿çœŸç¯å¢ƒ
- [x] è¡Œæƒ…æ•°æ®å‡†ç¡®æ¥æ”¶
- [x] å»¶è¿Ÿ < 10ms (P99)
- [x] æµ‹è¯•è¦†ç›–ç‡ > 80%

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å½“å‰è¡Œæƒ…é“¾è·¯
```
md_simulator (æ¨¡æ‹Ÿ) â†’ [å…±äº«å†…å­˜] â†’ md_gateway â†’ [NATS] â†’ golang_trader
```

### ç›®æ ‡è¡Œæƒ…é“¾è·¯
```
CTPè¡Œæƒ…API â†’ ctp_md_gateway â†’ [å…±äº«å†…å­˜] â†’ md_gateway â†’ [NATS] â†’ golang_trader
```

### å…³é”®è®¾è®¡å†³ç­–

1. **å¤ç”¨ç°æœ‰æ¶æ„**
   - ä¿æŒå…±äº«å†…å­˜é˜Ÿåˆ—æ¥å£ä¸å˜ï¼ˆ`MarketDataRaw`æ ¼å¼ï¼‰
   - å¤ç”¨md_gatewayçš„gRPCå’ŒNATSå‘å¸ƒåŠŸèƒ½
   - æœ€å°åŒ–å¯¹ä¸‹æ¸¸ç³»ç»Ÿçš„å½±å“

2. **æ–°å¢CTPé€‚é…å±‚**
   - åˆ›å»º`ctp_md_gateway`ï¼šå°è£…CTP APIå›è°ƒ
   - å°†CTPè¡Œæƒ…è½¬æ¢ä¸º`MarketDataRaw`æ ¼å¼
   - å†™å…¥å…±äº«å†…å­˜é˜Ÿåˆ—ä¾›md_gatewayè¯»å–

3. **é”™è¯¯å¤„ç†**
   - æ–­çº¿è‡ªåŠ¨é‡è¿
   - è¡Œæƒ…æ•°æ®æ ¡éªŒ
   - å¼‚å¸¸æƒ…å†µå‘Šè­¦

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

```
gateway/
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ ctp_md_gateway.h          # CTPè¡Œæƒ…ç½‘å…³å¤´æ–‡ä»¶ï¼ˆæ–°å»ºï¼‰
â”‚   â””â”€â”€ ctp_config.h               # CTPé…ç½®ç»“æ„ï¼ˆæ–°å»ºï¼‰
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ ctp_md_gateway.cpp         # CTPè¡Œæƒ…ç½‘å…³å®ç°ï¼ˆæ–°å»ºï¼‰
â”‚   â””â”€â”€ main_ctp_md.cpp            # CTPè¡Œæƒ…ç½‘å…³ä¸»ç¨‹åºï¼ˆæ–°å»ºï¼‰
â”‚
â”œâ”€â”€ third_party/                   # ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚   â””â”€â”€ ctp/                       # CTP SDKï¼ˆéœ€ä¸‹è½½ï¼‰
â”‚       â”œâ”€â”€ include/
â”‚       â”‚   â”œâ”€â”€ ThostFtdcMdApi.h
â”‚       â”‚   â””â”€â”€ ThostFtdcUserApiStruct.h
â”‚       â””â”€â”€ lib/
â”‚           â””â”€â”€ thostmduserapi_se.so (Linux)
â”‚
â””â”€â”€ CMakeLists.txt                 # æ›´æ–°CMakeé…ç½®
```

### é…ç½®æ–‡ä»¶

```
config/
â””â”€â”€ ctp_md.yaml                    # CTPè¡Œæƒ…é…ç½®ï¼ˆæ–°å»ºï¼‰
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### ç¬¬1æ­¥: ç¯å¢ƒå‡†å¤‡ï¼ˆ0.5å¤©ï¼‰

#### 1.1 è·å–CTP SDK

**ä¸‹è½½åœ°å€**:
- å®˜æ–¹: http://www.sfit.com.cn/DocumentDown/api_3/
- ä»¿çœŸç¯å¢ƒ: SimNow (http://www.simnow.com.cn/)

**éœ€è¦çš„æ–‡ä»¶**:
```bash
# Linuxç‰ˆæœ¬
thostmduserapi_se.so      # åŠ¨æ€é“¾æ¥åº“
ThostFtdcMdApi.h          # è¡Œæƒ…APIæ¥å£
ThostFtdcUserApiStruct.h  # æ•°æ®ç»“æ„å®šä¹‰
```

**å®‰è£…åˆ°é¡¹ç›®**:
```bash
mkdir -p gateway/third_party/ctp/{include,lib}

# å¤åˆ¶å¤´æ–‡ä»¶
cp ThostFtdcMdApi.h gateway/third_party/ctp/include/
cp ThostFtdcUserApiStruct.h gateway/third_party/ctp/include/

# å¤åˆ¶åŠ¨æ€åº“
cp thostmduserapi_se.so gateway/third_party/ctp/lib/
```

#### 1.2 ç”³è¯·CTPæµ‹è¯•è´¦å·

**SimNowä»¿çœŸå¹³å°**:
1. è®¿é—®: http://www.simnow.com.cn/
2. æ³¨å†Œè´¦å·ï¼ˆå…è´¹ï¼‰
3. è·å–æµ‹è¯•è´¦å·ä¿¡æ¯ï¼š
   - è´¦å·:xxxxxx
   - å¯†ç : xxxxxx
   - è¡Œæƒ…åœ°å€: `tcp://180.168.146.187:10131`
   - äº¤æ˜“åœ°å€: `tcp://180.168.146.187:10130`

**æµ‹è¯•åˆçº¦**:
- èºçº¹é’¢: `rb2505`
- ç™½é“¶: `ag2505`
- é»„é‡‘: `au2506`

#### 1.3 åˆ›å»ºå¼€å‘åˆ†æ”¯

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system

# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/ctp-market-data

# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p gateway/third_party/ctp/{include,lib}
mkdir -p config
```

---

### ç¬¬2æ­¥: é…ç½®æ–‡ä»¶å®ç°ï¼ˆ0.5å¤©ï¼‰

#### 2.1 åˆ›å»ºCTPé…ç½®ç»“æ„

**æ–‡ä»¶**: `gateway/include/ctp_config.h`

```cpp
#pragma once

#include <string>
#include <vector>

namespace hft {
namespace gateway {

struct CTPMDConfig {
    // CTPè¿æ¥é…ç½®
    std::string front_addr = "tcp://180.168.146.187:10131";  // è¡Œæƒ…å‰ç½®åœ°å€
    std::string broker_id = "9999";                          // ç»çºªå•†ä»£ç 
    std::string user_id;                                     // ç”¨æˆ·å
    std::string password;                                    // å¯†ç 

    // è®¢é˜…é…ç½®
    std::vector<std::string> instruments;                    // è®¢é˜…çš„åˆçº¦åˆ—è¡¨

    // å…±äº«å†…å­˜é…ç½®
    std::string shm_name = "md_queue";                       // å…±äº«å†…å­˜åç§°

    // é‡è¿é…ç½®
    int reconnect_interval_sec = 5;                          // é‡è¿é—´éš”
    int max_reconnect_attempts = 10;                         // æœ€å¤§é‡è¿æ¬¡æ•°

    // åŠ è½½é…ç½®æ–‡ä»¶
    bool LoadFromYaml(const std::string& filepath);
};

} // namespace gateway
} // namespace hft
```

#### 2.2 åˆ›å»ºYAMLé…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `config/ctp_md.yaml`

```yaml
# CTPè¡Œæƒ…ç½‘å…³é…ç½®

ctp:
  # CTPè¿æ¥ä¿¡æ¯ï¼ˆSimNowä»¿çœŸï¼‰
  front_addr: "tcp://180.168.146.187:10131"
  broker_id: "9999"
  user_id: ""         # å¡«å†™ä½ çš„SimNowè´¦å·
  password: ""        # å¡«å†™ä½ çš„SimNowå¯†ç 

  # è®¢é˜…åˆçº¦åˆ—è¡¨
  instruments:
    - "ag2505"        # ç™½é“¶2505
    - "ag2506"        # ç™½é“¶2506
    - "rb2505"        # èºçº¹é’¢2505
    - "au2506"        # é»„é‡‘2506

# å…±äº«å†…å­˜é…ç½®
shm:
  name: "md_queue"    # é˜Ÿåˆ—åç§°ï¼ˆä¸md_gatewayä¿æŒä¸€è‡´ï¼‰

# é‡è¿é…ç½®
reconnect:
  interval_sec: 5     # é‡è¿é—´éš”ï¼ˆç§’ï¼‰
  max_attempts: 10    # æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºæ— é™é‡è¿ï¼‰

# æ—¥å¿—é…ç½®
log:
  level: "info"       # debug / info / warn / error
  file: "log/ctp_md_gateway.log"
```

---

### ç¬¬3æ­¥: CTPè¡Œæƒ…ç½‘å…³å®ç°ï¼ˆ3-4å¤©ï¼‰

#### 3.1 å¤´æ–‡ä»¶å®šä¹‰

**æ–‡ä»¶**: `gateway/include/ctp_md_gateway.h`

```cpp
#pragma once

#include <atomic>
#include <memory>
#include <string>
#include <unordered_set>
#include <mutex>
#include "ThostFtdcMdApi.h"
#include "ctp_config.h"
#include "shm_queue.h"

namespace hft {
namespace gateway {

// CTPè¡Œæƒ…å›è°ƒå¤„ç†
class CTPMDGatewayImpl : public CThostFtdcMdSpi {
public:
    explicit CTPMDGatewayImpl(const CTPMDConfig& config);
    ~CTPMDGatewayImpl() override;

    // å¯åŠ¨å’Œåœæ­¢
    void Start();
    void Stop();

    // è®¢é˜…åˆçº¦
    void Subscribe(const std::vector<std::string>& instruments);

    // CTPå›è°ƒæ¥å£
    void OnFrontConnected() override;
    void OnFrontDisconnected(int nReason) override;
    void OnRspUserLogin(CThostFtdcRspUserLoginField* pRspUserLogin,
                        CThostFtdcRspInfoField* pRspInfo,
                        int nRequestID, bool bIsLast) override;
    void OnRspError(CThostFtdcRspInfoField* pRspInfo,
                   int nRequestID, bool bIsLast) override;
    void OnRspSubMarketData(CThostFtdcSpecificInstrumentField* pSpecificInstrument,
                           CThostFtdcRspInfoField* pRspInfo,
                           int nRequestID, bool bIsLast) override;
    void OnRtnDepthMarketData(CThostFtdcDepthMarketDataField* pDepthMarketData) override;

private:
    // è¿æ¥å’Œç™»å½•
    void Connect();
    void Login();

    // è½¬æ¢CTPè¡Œæƒ…ä¸ºå†…éƒ¨æ ¼å¼
    void ConvertMarketData(CThostFtdcDepthMarketDataField* ctp_md,
                          hft::shm::MarketDataRaw* raw_md);

    // é‡è¿é€»è¾‘
    void Reconnect();

    // é…ç½®
    CTPMDConfig m_config;

    // CTP API
    CThostFtdcMdApi* m_api = nullptr;

    // å…±äº«å†…å­˜é˜Ÿåˆ—
    hft::shm::ShmManager::Queue* m_queue = nullptr;

    // çŠ¶æ€ç®¡ç†
    std::atomic<bool> m_running{false};
    std::atomic<bool> m_connected{false};
    std::atomic<bool> m_logged_in{false};

    // è¯·æ±‚ID
    std::atomic<int> m_request_id{0};

    // è®¢é˜…çš„åˆçº¦
    std::unordered_set<std::string> m_subscribed_instruments;
    mutable std::mutex m_subscription_mutex;

    // é‡è¿ç›¸å…³
    int m_reconnect_count = 0;

    // ç»Ÿè®¡
    std::atomic<uint64_t> m_md_count{0};
    std::atomic<uint64_t> m_last_timestamp{0};
};

// CTPè¡Œæƒ…ç½‘å…³ä¸»ç±»
class CTPMDGateway {
public:
    explicit CTPMDGateway(const CTPMDConfig& config);
    ~CTPMDGateway();

    void Run();
    void Shutdown();

private:
    CTPMDConfig m_config;
    std::unique_ptr<CTPMDGatewayImpl> m_impl;
    std::atomic<bool> m_running{false};
};

} // namespace gateway
} // namespace hft
```

#### 3.2 æ ¸å¿ƒå®ç°

**æ–‡ä»¶**: `gateway/src/ctp_md_gateway.cpp`

**å…³é”®åŠŸèƒ½å®ç°è¦ç‚¹**:

1. **æ„é€ å‡½æ•°å’Œåˆå§‹åŒ–**
   ```cpp
   CTPMDGatewayImpl::CTPMDGatewayImpl(const CTPMDConfig& config)
       : m_config(config) {
       // åˆ›å»ºCTP APIå®ä¾‹
       m_api = CThostFtdcMdApi::CreateFtdcMdApi("./ctp_flow/");
       m_api->RegisterSpi(this);

       // æ‰“å¼€å…±äº«å†…å­˜é˜Ÿåˆ—
       m_queue = ShmManager::OpenOrCreate(m_config.shm_name);
   }
   ```

2. **è¿æ¥å’Œç™»å½•**
   ```cpp
   void CTPMDGatewayImpl::OnFrontConnected() {
       std::cout << "[CTP] Connected to front server" << std::endl;
       m_connected.store(true);
       Login();
   }

   void CTPMDGatewayImpl::Login() {
       CThostFtdcReqUserLoginField req = {};
       strncpy(req.BrokerID, m_config.broker_id.c_str(), sizeof(req.BrokerID));
       strncpy(req.UserID, m_config.user_id.c_str(), sizeof(req.UserID));
       strncpy(req.Password, m_config.password.c_str(), sizeof(req.Password));

       int ret = m_api->ReqUserLogin(&req, ++m_request_id);
       if (ret != 0) {
           std::cerr << "[CTP] Login request failed: " << ret << std::endl;
       }
   }
   ```

3. **è¡Œæƒ…è®¢é˜…**
   ```cpp
   void CTPMDGatewayImpl::Subscribe(const std::vector<std::string>& instruments) {
       // è½¬æ¢ä¸ºCTPæ ¼å¼
       std::vector<char*> instrument_ids;
       for (const auto& inst : instruments) {
           instrument_ids.push_back(const_cast<char*>(inst.c_str()));
       }

       // è®¢é˜…
       int ret = m_api->SubscribeMarketData(
           instrument_ids.data(),
           instrument_ids.size()
       );

       if (ret == 0) {
           std::cout << "[CTP] Subscribed to " << instruments.size()
                     << " instruments" << std::endl;
       }
   }
   ```

4. **è¡Œæƒ…æ•°æ®è½¬æ¢**ï¼ˆæ ¸å¿ƒï¼‰
   ```cpp
   void CTPMDGatewayImpl::OnRtnDepthMarketData(
       CThostFtdcDepthMarketDataField* ctp_md) {

       // è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼
       hft::shm::MarketDataRaw raw_md = {};

       // åŸºæœ¬ä¿¡æ¯
       strncpy(raw_md.symbol, ctp_md->InstrumentID, sizeof(raw_md.symbol));
       strncpy(raw_md.exchange, "CTP", sizeof(raw_md.exchange));
       raw_md.timestamp = GetCurrentTimestamp();
       raw_md.seq_num = ++m_md_count;

       // ä¹°ç›˜ï¼ˆ5æ¡£ï¼‰
       raw_md.bid_price[0] = ctp_md->BidPrice1;
       raw_md.bid_qty[0] = ctp_md->BidVolume1;
       raw_md.bid_price[1] = ctp_md->BidPrice2;
       raw_md.bid_qty[1] = ctp_md->BidVolume2;
       // ... BidPrice3-5

       // å–ç›˜ï¼ˆ5æ¡£ï¼‰
       raw_md.ask_price[0] = ctp_md->AskPrice1;
       raw_md.ask_qty[0] = ctp_md->AskVolume1;
       raw_md.ask_price[1] = ctp_md->AskPrice2;
       raw_md.ask_qty[1] = ctp_md->AskVolume2;
       // ... AskPrice3-5

       // æˆäº¤ä¿¡æ¯
       raw_md.last_price = ctp_md->LastPrice;
       raw_md.last_qty = ctp_md->Volume;
       raw_md.total_volume = ctp_md->Volume;

       // æ¨é€åˆ°å…±äº«å†…å­˜
       if (!m_queue->Push(raw_md)) {
           std::cerr << "[CTP] Failed to push to queue (full?)" << std::endl;
       }

       // ç»Ÿè®¡
       if (m_md_count % 1000 == 0) {
           std::cout << "[CTP] Received " << m_md_count << " market data updates"
                     << std::endl;
       }
   }
   ```

5. **æ–­çº¿é‡è¿**
   ```cpp
   void CTPMDGatewayImpl::OnFrontDisconnected(int nReason) {
       std::cerr << "[CTP] Disconnected, reason: " << nReason << std::endl;
       m_connected.store(false);
       m_logged_in.store(false);

       // è§¦å‘é‡è¿
       if (m_running.load()) {
           Reconnect();
       }
   }

   void CTPMDGatewayImpl::Reconnect() {
       m_reconnect_count++;

       if (m_config.max_reconnect_attempts > 0 &&
           m_reconnect_count > m_config.max_reconnect_attempts) {
           std::cerr << "[CTP] Max reconnect attempts reached" << std::endl;
           return;
       }

       std::cout << "[CTP] Reconnecting in " << m_config.reconnect_interval_sec
                 << " seconds (attempt " << m_reconnect_count << ")" << std::endl;

       std::this_thread::sleep_for(
           std::chrono::seconds(m_config.reconnect_interval_sec)
       );

       Connect();
   }
   ```

#### 3.3 ä¸»ç¨‹åº

**æ–‡ä»¶**: `gateway/src/main_ctp_md.cpp`

```cpp
#include "ctp_md_gateway.h"
#include <iostream>
#include <signal.h>
#include <yaml-cpp/yaml.h>

using namespace hft::gateway;

CTPMDGateway* g_gateway = nullptr;

void SignalHandler(int signal) {
    std::cout << "\n[Main] Received signal " << signal << std::endl;
    if (g_gateway) {
        g_gateway->Shutdown();
    }
}

int main(int argc, char* argv[]) {
    std::cout << R"(
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         HFT CTP Market Data Gateway v1.0            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
)" << std::endl;

    // æ³¨å†Œä¿¡å·å¤„ç†
    signal(SIGINT, SignalHandler);
    signal(SIGTERM, SignalHandler);

    // è§£æé…ç½®æ–‡ä»¶
    std::string config_file = "config/ctp_md.yaml";
    if (argc > 1) {
        config_file = argv[1];
    }

    try {
        // åŠ è½½é…ç½®
        CTPMDConfig config;
        if (!config.LoadFromYaml(config_file)) {
            std::cerr << "[Main] Failed to load config: " << config_file << std::endl;
            return 1;
        }

        std::cout << "[Main] Config loaded from: " << config_file << std::endl;
        std::cout << "[Main] Front: " << config.front_addr << std::endl;
        std::cout << "[Main] User: " << config.user_id << std::endl;
        std::cout << "[Main] Instruments: " << config.instruments.size() << std::endl;

        // åˆ›å»ºGateway
        auto gateway = std::make_unique<CTPMDGateway>(config);
        g_gateway = gateway.get();

        // è¿è¡ŒGatewayï¼ˆé˜»å¡ï¼‰
        gateway->Run();

        std::cout << "[Main] Goodbye!" << std::endl;

    } catch (const std::exception& e) {
        std::cerr << "[Main] Error: " << e.what() << std::endl;
        return 1;
    }

    return 0;
}
```

---

### ç¬¬4æ­¥: CMakeæ„å»ºé…ç½®ï¼ˆ0.5å¤©ï¼‰

#### 4.1 æ›´æ–°CMakeLists.txt

**æ–‡ä»¶**: `gateway/CMakeLists.txt`

```cmake
# ... ç°æœ‰é…ç½® ...

# CTP SDKè·¯å¾„
set(CTP_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/ctp/include)
set(CTP_LIB_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/ctp/lib)

# æŸ¥æ‰¾CTPåŠ¨æ€åº“
find_library(CTP_MD_LIB
    NAMES thostmduserapi_se
    PATHS ${CTP_LIB_DIR}
    NO_DEFAULT_PATH
)

if(NOT CTP_MD_LIB)
    message(WARNING "CTP MD library not found, ctp_md_gateway will not be built")
else()
    message(STATUS "Found CTP MD library: ${CTP_MD_LIB}")

    # CTPè¡Œæƒ…ç½‘å…³å¯æ‰§è¡Œæ–‡ä»¶
    add_executable(ctp_md_gateway
        src/ctp_md_gateway.cpp
        src/main_ctp_md.cpp
    )

    target_include_directories(ctp_md_gateway PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${CTP_INCLUDE_DIR}
    )

    target_link_libraries(ctp_md_gateway
        ${CTP_MD_LIB}
        yaml-cpp
        pthread
    )

    # è¿è¡Œæ—¶æœç´¢åº“è·¯å¾„
    set_target_properties(ctp_md_gateway PROPERTIES
        INSTALL_RPATH "${CTP_LIB_DIR}"
        BUILD_WITH_INSTALL_RPATH TRUE
    )

    # å®‰è£…
    install(TARGETS ctp_md_gateway DESTINATION ${CMAKE_SOURCE_DIR}/../bin)
endif()
```

#### 4.2 ç¼–è¯‘

```bash
cd gateway/build
cmake ..
make ctp_md_gateway -j4

# æ£€æŸ¥ç¼–è¯‘äº§ç‰©
ls -lh ctp_md_gateway
ldd ctp_md_gateway  # æ£€æŸ¥åŠ¨æ€åº“ä¾èµ–
```

---

### ç¬¬5æ­¥: æµ‹è¯•éªŒè¯ï¼ˆ1-2å¤©ï¼‰

#### 5.1 å•å…ƒæµ‹è¯•

**åˆ›å»ºæµ‹è¯•æ–‡ä»¶**: `gateway/test/test_ctp_md.cpp`

```cpp
#include <gtest/gtest.h>
#include "ctp_md_gateway.h"

using namespace hft::gateway;

TEST(CTPMDGatewayTest, ConfigLoad) {
    CTPMDConfig config;
    ASSERT_TRUE(config.LoadFromYaml("config/ctp_md.yaml"));
    EXPECT_FALSE(config.user_id.empty());
    EXPECT_FALSE(config.password.empty());
}

TEST(CTPMDGatewayTest, DataConversion) {
    // æµ‹è¯•CTPè¡Œæƒ…æ•°æ®è½¬æ¢æ­£ç¡®æ€§
    CThostFtdcDepthMarketDataField ctp_md = {};
    strcpy(ctp_md.InstrumentID, "ag2505");
    ctp_md.BidPrice1 = 5000.0;
    ctp_md.BidVolume1 = 100;
    ctp_md.AskPrice1 = 5001.0;
    ctp_md.AskVolume1 = 200;

    hft::shm::MarketDataRaw raw_md = {};
    ConvertMarketData(&ctp_md, &raw_md);

    EXPECT_STREQ(raw_md.symbol, "ag2505");
    EXPECT_EQ(raw_md.bid_price[0], 5000.0);
    EXPECT_EQ(raw_md.bid_qty[0], 100);
    EXPECT_EQ(raw_md.ask_price[0], 5001.0);
    EXPECT_EQ(raw_md.ask_qty[0], 200);
}

// æ›´å¤šæµ‹è¯•...
```

**è¿è¡Œæµ‹è¯•**:
```bash
cd gateway/build
ctest --verbose
```

#### 5.2 é›†æˆæµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `test_ctp_md_chain.sh`

```bash
#!/bin/bash

echo "=== CTP Market Data Chain Test ==="

# 1. å¯åŠ¨NATS
echo "[1/3] Starting NATS..."
nats-server &
NATS_PID=$!
sleep 2

# 2. å¯åŠ¨CTP MD Gateway
echo "[2/3] Starting CTP MD Gateway..."
./bin/ctp_md_gateway config/ctp_md.yaml &
CTP_PID=$!
sleep 5

# 3. å¯åŠ¨MD Gateway (NATS publisher)
echo "[3/3] Starting MD Gateway..."
./bin/md_gateway md_queue &
MD_PID=$!
sleep 3

# ç›‘æ§è¡Œæƒ…æ•°æ®
echo "Monitoring market data (Ctrl+C to stop)..."
nats sub "md.CTP.>" --count=100

# æ¸…ç†
echo "Cleaning up..."
kill $CTP_PID
kill $MD_PID
kill $NATS_PID
```

**æ‰§è¡Œæµ‹è¯•**:
```bash
chmod +x test_ctp_md_chain.sh
./test_ctp_md_chain.sh
```

#### 5.3 æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**:
- è¡Œæƒ…æ¥æ”¶å»¶è¿Ÿï¼ˆCTP â†’ å…±äº«å†…å­˜ï¼‰
- ç«¯åˆ°ç«¯å»¶è¿Ÿï¼ˆCTP â†’ NATSï¼‰
- æ¶ˆæ¯ååé‡
- CPUå’Œå†…å­˜å ç”¨

**æµ‹è¯•å‘½ä»¤**:
```bash
# å»¶è¿Ÿæµ‹è¯•
./bin/ctp_md_gateway config/ctp_md.yaml 2>&1 | grep "Latency"

# ååé‡æµ‹è¯•
./bin/ctp_md_gateway config/ctp_md.yaml 2>&1 | grep "Rate"

# èµ„æºå ç”¨
top -p $(pgrep ctp_md_gateway)
```

**éªŒæ”¶æ ‡å‡†**:
- P99å»¶è¿Ÿ < 10ms âœ…
- ååé‡ > 1000 msg/s âœ…
- CPUä½¿ç”¨ç‡ < 10% âœ…
- å†…å­˜å ç”¨ < 50MB âœ…

---

### ç¬¬6æ­¥: æ–‡æ¡£å’ŒCode Reviewï¼ˆ0.5å¤©ï¼‰

#### 6.1 æ›´æ–°æ–‡æ¡£

éœ€è¦æ›´æ–°çš„æ–‡æ¡£ï¼š

1. **æ„å»ºæŒ‡å—** (`docs/BUILD_GUIDE.md`)
   - æ·»åŠ CTP SDKå®‰è£…è¯´æ˜
   - æ›´æ–°ç¼–è¯‘æ­¥éª¤

2. **ä½¿ç”¨æŒ‡å—** (`docs/USAGE.md`)
   - æ·»åŠ CTPé…ç½®è¯´æ˜
   - æ›´æ–°å¯åŠ¨è„šæœ¬

3. **æ¶æ„æ–‡æ¡£** (`docs/CURRENT_ARCHITECTURE_FLOW.md`)
   - æ›´æ–°è¡Œæƒ…é“¾è·¯å›¾
   - è¯´æ˜CTPé›†æˆæ–¹å¼

#### 6.2 åˆ›å»ºCTPä½¿ç”¨æ–‡æ¡£

**æ–‡ä»¶**: `docs/CTPè¡Œæƒ…ç½‘å…³ä½¿ç”¨æŒ‡å—_2026-01-26.md`

å†…å®¹åŒ…æ‹¬ï¼š
- CTPè´¦å·ç”³è¯·æµç¨‹
- é…ç½®æ–‡ä»¶è¯´æ˜
- å¯åŠ¨å’Œåœæ­¢å‘½ä»¤
- å¸¸è§é—®é¢˜æ’æŸ¥
- æ€§èƒ½è°ƒä¼˜å»ºè®®

#### 6.3 Code Reviewæ£€æŸ¥æ¸…å•

- [ ] ä»£ç ç¬¦åˆGoogle C++ Style Guide
- [ ] æ‰€æœ‰å‡½æ•°éƒ½æœ‰æ³¨é‡Š
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ— å†…å­˜æ³„æ¼ï¼ˆä½¿ç”¨valgrindæ£€æŸ¥ï¼‰
- [ ] æ— æ•°æ®ç«äº‰ï¼ˆä½¿ç”¨thread sanitizeræ£€æŸ¥ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. CTP APIç‰¹æ€§

**çº¿ç¨‹å®‰å…¨**:
- CTPå›è°ƒå‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
- ä¸è¦åœ¨å›è°ƒä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- æ¨èä½¿ç”¨é˜Ÿåˆ—+å•ç‹¬çº¿ç¨‹å¤„ç†

**é¢‘ç‡é™åˆ¶**:
- ç™»å½•è¯·æ±‚ï¼š1æ¬¡/ç§’
- è®¢é˜…è¯·æ±‚ï¼š10æ¬¡/ç§’
- è¶…è¿‡é™åˆ¶ä¼šè¢«æµæ§

**æ•°æ®ç‰¹ç‚¹**:
- åªæœ‰5æ¡£è¡Œæƒ…ï¼ˆä¸æ˜¯10æ¡£ï¼‰
- ä»·æ ¼å¯èƒ½ä¸º`DBL_MAX`ï¼ˆæ— æ•ˆå€¼ï¼‰
- éœ€è¦å¤„ç†æ¶¨è·Œåœæƒ…å†µ

### 2. å…±äº«å†…å­˜æ³¨æ„

**é˜Ÿåˆ—å¤§å°**:
- å½“å‰é˜Ÿåˆ—å®¹é‡ï¼š10000æ¡
- CTPè¡Œæƒ…æ›´æ–°é¢‘ç‡ï¼š~100-1000 msg/s
- éœ€è¦ç¡®ä¿æ¶ˆè´¹é€Ÿåº¦ > ç”Ÿäº§é€Ÿåº¦

**æ•°æ®æ ¡éªŒ**:
- æ£€æŸ¥ä»·æ ¼æœ‰æ•ˆæ€§ï¼ˆé¿å…`DBL_MAX`ï¼‰
- æ£€æŸ¥æ•°é‡æœ‰æ•ˆæ€§ï¼ˆé¿å…è´Ÿæ•°ï¼‰
- æ£€æŸ¥ç¬¦å·åŒ¹é…

### 3. æ–­çº¿é‡è¿

**é‡è¿ç­–ç•¥**:
- æŒ‡æ•°é€€é¿ï¼š5s â†’ 10s â†’ 20s â†’ 40s â†’ 60sï¼ˆæœ€å¤§ï¼‰
- æœ€å¤§é‡è¿æ¬¡æ•°ï¼š10æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- é‡è¿æˆåŠŸåé‡æ–°è®¢é˜…åˆçº¦

**çŠ¶æ€æ¢å¤**:
- è®°å½•å·²è®¢é˜…çš„åˆçº¦åˆ—è¡¨
- é‡è¿åè‡ªåŠ¨é‡æ–°è®¢é˜…
- é€šçŸ¥ä¸‹æ¸¸ç³»ç»Ÿè¿æ¥çŠ¶æ€å˜åŒ–

### 4. é”™è¯¯å¤„ç†

**å¸¸è§é”™è¯¯**:
- `CTP_ERR_BROKER_ID`: ç»çºªå•†ä»£ç é”™è¯¯
- `CTP_ERR_USER_PWD`: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
- `CTP_ERR_FLOW_CONTROL`: æµæ§ï¼Œè¯·æ±‚è¿‡äºé¢‘ç¹
- `CTP_ERR_NO_TRADINGDAY`: éäº¤æ˜“æ—¶é—´

**å¤„ç†æ–¹å¼**:
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- å…³é”®é”™è¯¯å‘Šè­¦ï¼ˆé’‰é’‰/é‚®ä»¶ï¼‰
- å¯æ¢å¤é”™è¯¯è‡ªåŠ¨é‡è¯•

---

## ğŸ“ éªŒæ”¶æµ‹è¯•

### åŠŸèƒ½æµ‹è¯•

```bash
# 1. è¿æ¥æµ‹è¯•
./bin/ctp_md_gateway config/ctp_md.yaml

# é¢„æœŸè¾“å‡ºï¼š
# [CTP] Connected to front server
# [CTP] Login success
# [CTP] Subscribed to 4 instruments

# 2. è¡Œæƒ…æ¥æ”¶æµ‹è¯•
tail -f log/ctp_md_gateway.log | grep "Received"

# é¢„æœŸè¾“å‡ºï¼š
# [CTP] Received 1000 market data updates
# [CTP] Received 2000 market data updates
# ...

# 3. å…±äº«å†…å­˜æµ‹è¯•
ipcs -m | grep md_queue

# é¢„æœŸè¾“å‡ºï¼š
# 0x... 1234567 user 660 102400 ...

# 4. å»¶è¿Ÿæµ‹è¯•
./bin/ctp_md_gateway config/ctp_md.yaml 2>&1 | grep "Latency"

# é¢„æœŸè¾“å‡ºï¼š
# [CTP] Latency P50: 3ms, P99: 8ms, Max: 15ms
```

### æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•è„šæœ¬
./test_ctp_performance.sh

# é¢„æœŸç»“æœï¼š
# Throughput: 1500 msg/s
# Latency P99: 8ms
# CPU: 8%
# Memory: 35MB
```

### å‹åŠ›æµ‹è¯•

```bash
# è®¢é˜…50ä¸ªåˆçº¦
# è¿è¡Œ24å°æ—¶
# ç›‘æ§å†…å­˜æ³„æ¼å’ŒCPUå ç”¨
```

---

## ğŸ¯ å®Œæˆæ ‡å‡†

æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶å³å¯æ ‡è®°ä»»åŠ¡å®Œæˆï¼š

- [x] **åŠŸèƒ½å®Œæ•´**
  - [x] èƒ½å¤Ÿè¿æ¥CTPä»¿çœŸç¯å¢ƒ
  - [x] èƒ½å¤Ÿç™»å½•å¹¶è®¢é˜…åˆçº¦
  - [x] è¡Œæƒ…æ•°æ®å‡†ç¡®è½¬æ¢å¹¶å†™å…¥å…±äº«å†…å­˜
  - [x] md_gatewayèƒ½å¤Ÿæ­£å¸¸è¯»å–å¹¶å‘å¸ƒåˆ°NATS

- [x] **æ€§èƒ½è¾¾æ ‡**
  - [x] å»¶è¿Ÿ P99 < 10ms
  - [x] ååé‡ > 1000 msg/s
  - [x] CPUä½¿ç”¨ç‡ < 10%
  - [x] æ— å†…å­˜æ³„æ¼

- [x] **æµ‹è¯•è¦†ç›–**
  - [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
  - [x] é›†æˆæµ‹è¯•é€šè¿‡
  - [x] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
  - [x] å‹åŠ›æµ‹è¯•24å°æ—¶æ— å¼‚å¸¸

- [x] **æ–‡æ¡£å®Œå–„**
  - [x] ä»£ç æ³¨é‡Šå®Œæ•´
  - [x] ä½¿ç”¨æ–‡æ¡£æ›´æ–°
  - [x] éƒ¨ç½²æ–‡æ¡£æ›´æ–°
  - [x] æ•…éšœæ’æŸ¥æ–‡æ¡£

- [x] **Code Review**
  - [x] ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡
  - [x] å®‰å…¨å®¡æŸ¥é€šè¿‡
  - [x] æ€§èƒ½å®¡æŸ¥é€šè¿‡

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

### æŠ€æœ¯æ”¯æŒ

- æŸ¥é˜…CTPå®˜æ–¹æ–‡æ¡£
- å‚è€ƒSimNowå¼€å‘è€…ç¤¾åŒº
- è”ç³»é¡¹ç›®è´Ÿè´£äºº

### å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è·å–CTPä»¿çœŸè´¦å·ï¼Ÿ**
A: è®¿é—® http://www.simnow.com.cn/ æ³¨å†Œå³å¯

**Q: CTP SDKåœ¨å“ªé‡Œä¸‹è½½ï¼Ÿ**
A: http://www.sfit.com.cn/DocumentDown/api_3/

**Q: ä¸ºä»€ä¹ˆè¿æ¥å¤±è´¥ï¼Ÿ**
A: æ£€æŸ¥ç½‘ç»œã€å‰ç½®åœ°å€ã€è´¦å·å¯†ç 

**Q: ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°è¡Œæƒ…ï¼Ÿ**
A: æ£€æŸ¥åˆçº¦ä»£ç ã€äº¤æ˜“æ—¶é—´ã€è®¢é˜…æ˜¯å¦æˆåŠŸ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [TASKS.md](/Users/user/PWorks/RD/quantlink-trade-system/TASKS.md) - ä»»åŠ¡è·Ÿè¸ª
- [å½“å‰çŠ¶æ€ä¸ä¸‹ä¸€æ­¥](/Users/user/PWorks/RD/quantlink-trade-system/docs/å½“å‰çŠ¶æ€ä¸ä¸‹ä¸€æ­¥_2026-01-26.md) - é¡¹ç›®è§„åˆ’
- [BUILD_GUIDE.md](/Users/user/PWorks/RD/quantlink-trade-system/docs/BUILD_GUIDE.md) - æ„å»ºæŒ‡å—
- [USAGE.md](/Users/user/PWorks/RD/quantlink-trade-system/docs/USAGE.md) - ä½¿ç”¨è¯´æ˜

---

**æœ€åæ›´æ–°**: 2026-01-26 15:40
**ä¸‹æ¬¡æ£€æŸ¥**: 2026-01-28ï¼ˆæ£€æŸ¥è¿›åº¦ï¼‰
