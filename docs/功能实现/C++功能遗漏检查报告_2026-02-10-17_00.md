# C++ 功能遗漏检查报告

**文档日期**: 2026-02-10
**版本**: v1.0
**检查范围**: PairwiseArbStrategy, ExecutionStrategy

---

## 概述

本文档记录 Go 代码与 C++ 原代码的功能对比检查结果，列出遗漏的功能及优先级。

## 已实现功能

| 功能 | C++ 位置 | Go 位置 | 状态 |
|------|----------|---------|------|
| TVar 共享内存 | tvar.h | pkg/shm/tvar.go | ✅ 已实现 |
| TCache 共享内存 | tvar.h | pkg/shm/tcache.go | ✅ 已实现 |
| 动态阈值 SetThresholds | ExecutionStrategy.cpp | pairwise_arb_strategy.go | ✅ 已实现 |
| 追单逻辑 | PairwiseArbStrategy.cpp | pairwise_arb_strategy.go | ✅ 已实现 |
| 订单回调处理 | ExecutionStrategy.cpp | execution_strategy.go | ✅ 已实现 |
| 持仓管理 | ExecutionStrategy.cpp | execution_strategy.go | ✅ 已实现 |
| ExtraStrategy 架构 | ExtraStrategy.h | extra_strategy.go | ✅ 已实现 |
| daily_init 文件读写 | PairwiseArbStrategy.cpp:18-144 | daily_init.go | ✅ 已实现 |

---

## 遗漏功能列表

### 高优先级

#### 1. ~~daily_init 文件读写~~ ✅ 已实现

| 项目 | 内容 |
|------|------|
| **功能名称** | daily_init 每日初始化数据持久化 |
| **C++ 代码位置** | `tbsrc/Strategies/PairwiseArbStrategy.cpp:18-144, 624-686` |
| **功能说明** | 从文件加载/保存每日初始化数据，包括昨仓、价差均值等 |
| **关键方法** | `LoadMatrix2()`, `SaveMatrix2()` |
| **数据内容** | avgPx（价差均值）、ytd1/ytd2（昨仓）、2day（今仓）等 |
| **Go 实现** | `golang/pkg/strategy/daily_init.go` |
| **实现日期** | 2026-02-10 |

**Go 实现要点**:
- `LoadMatrix2()` - 在 `Initialize()` 中调用，恢复 avgSpreadRatio_ori 和持仓
- `SaveMatrix2()` - 在 `Stop()` 中调用，保存当前状态
- 函数和变量名与 C++ 保持一致（`MxDailyInit2`, `DailyInitRow` 等）
- 使用 `syscall.Flock()` 实现文件锁

---

#### 2. memlog 监控数据上报

| 项目 | 内容 |
|------|------|
| **功能名称** | memlog 监控数据上报 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:116-264` |
| **功能说明** | 通过共享内存向监控系统上报策略状态、持仓、PNL 等 |
| **关键方法** | `SendMonitorStratPos()`, `SendMonitorStratDetail()`, `SendMonitorStratPNL()`, `SendMonitorStratStatus()`, `SendMonitorStratCancelSts()` |
| **Go 现状** | 仅有日志输出，无共享内存上报 |
| **影响** | 生产环境无法实时监控策略状态 |

**C++ 代码片段**:
```cpp
// ExecutionStrategy.cpp:116
mlog = new tbadmin::memlog(shmkeymonitor, shmsizemonitor, 0666);

// ExecutionStrategy.cpp:133-160
void ExecutionStrategy::SendMonitorStratPos(...) {
    tbadmin::SlotData S;
    S.type = tbadmin::MemLogType::POSITION;
    // ... 填充数据 ...
    mlog->enqueue(S);
}
```

---

#### 3. 定时状态上报

| 项目 | 内容 |
|------|------|
| **功能名称** | 定时状态上报 (gap-based) |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:437-451` |
| **功能说明** | 使用时间间隔控制上报频率：每60秒上报持仓，每120秒上报状态 |
| **关键字段** | `m_lastPosTS`, `m_lastStsTS`, `m_lastDetailTS` |
| **Go 现状** | 有时间戳字段但无定时上报逻辑 |
| **影响** | 监控系统无法收到定期更新 |

---

### 中优先级

#### 4. SendAlert 邮件告警

| 项目 | 内容 |
|------|------|
| **功能名称** | SendAlert 邮件/告警通知 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:1156-1173` |
| **功能说明** | 触发限制（拒绝、最大亏损、订单限制）时发送告警 |
| **Go 现状** | 仅日志输出 |
| **建议** | 可用 webhook 替代邮件实现 |

**C++ 代码片段**:
```cpp
void ExecutionStrategy::SendAlert(const char *msg, const char *reason) {
    TBLOG << "ALERT! Limit got hit." << msg << " Reason: " << reason << endl;
    if (mlog) {
        SendMonitorStratDetail(..., true);  // isalert=true
    }
}
```

---

#### 5. 统计队列 (StatTradeQtyQ)

| 项目 | 内容 |
|------|------|
| **功能名称** | 统计队列和成交量统计 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:398-420` |
| **功能说明** | 维护成交量、价格变动统计队列，用于计算 SET_HIGH 标志 |
| **关键队列** | `StatTradeQtyQ`, `StatPriceQ`, `StatTimeQ` |
| **Go 现状** | 有字段定义但无实现 |
| **影响** | 影响动态阈值计算 |

**C++ 代码片段**:
```cpp
void ExecutionStrategy::GetInstrumentStats() {
    StatTrTimeQ.push_back(Watch::GetUniqueInstance()->GetCurrentTime());
    // ...
    if (volume_ewa > m_thold->STAT_TRADE_THRESH)
        SET_HIGH = 0;
    else
        SET_HIGH = 1;
}
```

---

#### 6. 高级阈值模式

| 项目 | 内容 |
|------|------|
| **功能名称** | SET_HIGH, USE_NOTIONAL 等高级阈值模式 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:500-593` |
| **功能说明** | 多种阈值计算模式：SET_HIGH=1 使用更高阈值，USE_NOTIONAL 使用名义金额 |
| **Go 现状** | 有基本动态阈值，缺少高级模式 |
| **影响** | 影响策略表现 |

---

#### 7. 队列位置统计 (SetQuantAhead)

| 项目 | 内容 |
|------|------|
| **功能名称** | SetQuantAhead 队列位置追踪 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:691-757` |
| **功能说明** | 追踪订单在队列中的位置（前面和后面的挂单量） |
| **Go 现状** | 有方法但使用场景可能不完整 |
| **影响** | 影响订单管理决策 |

---

#### 8. 自成交处理 (ProcessSelfTrade)

| 项目 | 内容 |
|------|------|
| **功能名称** | ProcessSelfTrade 自成交处理 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:835-948` |
| **功能说明** | 发生自成交时重建订单簿 |
| **Go 现状** | 有简化版方法 |
| **影响** | 特殊情况处理 |

---

### 低优先级

#### 9. NewsHandler 新闻事件处理

| 项目 | 内容 |
|------|------|
| **功能名称** | NewsHandler 新闻事件平仓 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:374-375, 2304-2336` |
| **功能说明** | 特定新闻事件发生时触发平仓 |
| **适用范围** | 仅 CME IR 和 BOVESPA DOL 品种 |
| **Go 现状** | 未实现 |

---

#### 10. AuctionCallBack 拍卖处理

| 项目 | 内容 |
|------|------|
| **功能名称** | AuctionCallBack 拍卖事件处理 |
| **C++ 代码位置** | `tbsrc/Strategies/ExecutionStrategy.cpp:759-771` |
| **功能说明** | 品种进入拍卖状态时自动平仓 |
| **适用范围** | 仅 BOVESPA 交易所 |
| **Go 现状** | 未实现 |

---

## 优先级汇总

| 优先级 | 功能 | 影响 |
|--------|------|------|
| ~~**高**~~ | ~~daily_init 文件读写~~ | ✅ 已实现 |
| **高** | memlog 监控上报 | 生产环境实时监控 |
| **高** | 定时状态上报 | 监控系统配合 |
| **中** | SendAlert 告警 | 运维告警需求 |
| **中** | 统计队列 | 动态阈值计算 |
| **中** | 高级阈值模式 | 策略表现 |
| **中** | 队列位置统计 | 订单管理 |
| **中** | 自成交处理 | 特殊情况 |
| **低** | NewsHandler | 特定品种 |
| **低** | AuctionCallBack | 特定交易所 |

---

## 建议实施顺序

### 第一阶段（高优先级）
1. ✅ TVar/TCache 共享内存 - **已完成**
2. ✅ daily_init 文件读写 - **已完成** (2026-02-10)
3. ⏳ memlog 监控上报 - 待实现
4. ⏳ 定时状态上报 - 待实现

### 第二阶段（中优先级）
5. 统计队列和 SET_HIGH 逻辑
6. SendAlert 告警机制（可用 webhook）
7. 完善自成交处理

### 第三阶段（低优先级）
8. NewsHandler 新闻事件
9. AuctionCallBack 拍卖处理
10. 高级阈值模式

---

## 参考文档

- C++ 原代码: `/Users/user/PWorks/RD/tbsrc/Strategies/`
- Go 代码: `/Users/user/PWorks/RD/quantlink-trade-system/golang/pkg/strategy/`

---

**最后更新**: 2026-02-10 17:00
