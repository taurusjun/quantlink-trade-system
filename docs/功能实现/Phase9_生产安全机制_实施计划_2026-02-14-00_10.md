# Phase 9：生产安全机制

**文档日期**: 2026-02-14
**版本**: v1.0
**相关模块**: tbsrc-golang/pkg/execution, tbsrc-golang/pkg/strategy

---

## 概述

Phase 9 实现三个生产环境关键安全机制：撤单冷却防护、撤单拒绝成交合成、渐进式时间平仓。这些机制防止撤单风暴、持仓漂移和尾盘强平风险。

## 修正内容

### 1. CANCELREQ_PAUSE 撤单冷却

**问题**: 撤单被拒绝后系统立即在下一个 tick 重新发送撤单，形成撤单-拒绝-撤单循环，可能触发交易所撤单频率限制（SHFE/CFFEX 有严格的撤单率限制）。

**修复方案**:
- `OrderManager` 新增三个跟踪字段：`LastCancelRejectSet`、`LastCancelRejectOrderID`、`LastCancelRejectTime`
- `OrderManager` 新增 `CancelReqPause` 配置（纳秒，从 `ThresholdSet.CancelReqPause` 加载）
- `sendCancelOrderInternal` 在发送撤单前检查：如果同一 orderID 在冷却期内被拒绝过，阻止重发
- `processCancelReject` 记录拒绝信息用于冷却判断

**C++ 参考**: `ExecutionStrategy.cpp:1764-1770, 1870-1872`

### 2. fillOnCxlReject 撤单拒绝成交合成

**问题**: 当撤单请求到达交易所时订单已成交，交易所返回撤单拒绝（Quantity=0）。如果不处理此场景，策略的持仓跟踪会与实际成交偏离——策略认为订单仍然活跃，实际已成交。

**修复方案**:
- `OrderManager` 新增 `FillOnCxlReject` 配置标志
- `processCancelReject` 签名扩展，增加 `inst *instrument.Instrument` 参数
- 检测 `resp.Quantity == 0 && FillOnCxlReject`，合成成交事件调用 `processTrade`
- 合成事件使用订单的原始价格和数量

**C++ 参考**: `ExecutionStrategy.cpp:1874-1880`

### 3. HandleTimeLimitSquareoff 渐进式时间平仓

**问题**: 系统缺少基于时间的渐进平仓，无法在交易时段结束前安全减仓。中国期货市场不平仓可能导致结算强平。

**修复方案**:
- `ExecutionState` 新增 `SqrOffTimeEpoch` 字段（渐进平仓触发时间）
- `CheckSquareoff` 新增 Phase 1.5：检查 `SqrOffTimeEpoch`，触发 `OnTimeSqOff`
- `LegManager` 新增 `HandleTimeLimitSquareoff(sqrOffAgg int)` 方法：
  - 使用 `TholdBeginPos` 限制每笔平仓量（渐进退出，减少市场冲击）
  - `sqrOffAgg != 0` 时穿越 BBO（激进定价），否则被动挂单
  - 先撤销不匹配的挂单，再发送平仓单
  - 不设置 `OnExit`（策略继续运行，逐步减仓）
- `PairwiseArbStrategy.MDCallBack` 在 OnExit 检查和 SendOrder 之间调用

**C++ 参考**: `ExecutionStrategy.cpp:2442-2506`

## 修改文件

| 文件 | 修改内容 |
|------|---------|
| `pkg/execution/order_manager.go` | OrderManager 新增冷却跟踪字段和 FillOnCxlReject 标志；sendCancelOrderInternal 增加冷却检查 |
| `pkg/execution/ors_callback.go` | processCancelReject 增加 inst 参数、冷却记录、Quantity=0 成交合成 |
| `pkg/execution/state.go` | ExecutionState 新增 SqrOffTimeEpoch 字段 |
| `pkg/execution/squareoff.go` | CheckSquareoff 新增 Phase 1.5 时间平仓触发 |
| `pkg/execution/leg_manager.go` | 新增 HandleTimeLimitSquareoff 渐进式平仓方法 |
| `pkg/execution/execution_test.go` | 新增 10 个测试 |
| `pkg/strategy/pairwise_callbacks.go` | MDCallBack 集成 HandleTimeLimitSquareoff 调用 |

## 验证

- 181 个测试全部通过（新增 10 个）
- 8 个包编译通过
- Linux/amd64 交叉编译验证通过

## 新增测试

| 测试名 | 验证内容 |
|--------|---------|
| TestCancelReqPause_Cooldown | 冷却期内阻止重发撤单 |
| TestCancelReqPause_DifferentOrderID | 冷却只对同一 orderID 生效 |
| TestFillOnCxlReject | Quantity=0 时合成成交、持仓更新 |
| TestFillOnCxlReject_Disabled | FillOnCxlReject=false 时不合成 |
| TestFillOnCxlReject_NonZeroQty | Quantity 非 0 时不触发 |
| TestCheckSquareoff_TimeLimitTrigger | SqrOffTimeEpoch 触发 OnTimeSqOff |
| TestHandleTimeLimitSquareoff_GradualExit | TholdBeginPos 限制平仓量 |
| TestHandleTimeLimitSquareoff_Aggressive | SQROFF_AGG 穿越定价 |
| TestHandleTimeLimitSquareoff_Short | 空头渐进平仓 |
| TestHandleTimeLimitSquareoff_Flat | 已平仓不下单 |

## 剩余已知差距（优先级降序）

| 差距 | 优先级 | C++ 行号 | 说明 |
|------|--------|----------|------|
| GetBidPrice/GetAskPrice 基类 CROSS/IMPROVE | P1 | 1225-1440 | 单腿价格改善/穿越逻辑（PairwiseArb 已有自己的实现，部分缓解） |
| SendBidOrder/SendAskOrder 数量调整 | P1 | 1311-1485 | 持仓感知的下单量调整（PairwiseArb 通过 SendBidOrder2 使用显式数量，部分缓解） |
| USE_PRICE_LIMIT | P2 | 2227-2277 | 价格范围安全检查（滚动均价 + 边界检查） |

---

**最后更新**: 2026-02-14 00:10
