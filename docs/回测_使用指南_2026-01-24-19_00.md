# 回测_使用指南

**文档日期**: 2026-01-24
**版本**: v1.0

---

## 一、快速开始

### 1.1 准备数据

#### 方法 1: 生成模拟数据（用于测试）

```bash
# 编译数据生成工具
cd scripts/backtest
go build -o ../../bin/generate_mock_data generate_mock_data.go

# 生成1个月的模拟数据
cd ../..
./bin/generate_mock_data \
    --start-date 2026-01-01 \
    --end-date 2026-01-31 \
    --symbols ag2502,ag2504 \
    --ticks 10000 \
    --output ./data/market_data
```

#### 方法 2: 从实盘录制（真实数据）

```bash
# 运行 md_gateway 时开启录制功能
./bin/md_gateway --record --output ./data/market_data/$(date +%Y%m%d)/
```

### 1.2 编译回测工具

```bash
cd golang
go build -o ../bin/backtest cmd/backtest/main.go
cd ..
```

### 1.3 运行第一次回测

```bash
# 启动 NATS（如果未运行）
nats-server &

# 运行回测
./bin/backtest -config config/backtest.yaml

# 或使用脚本
./scripts/backtest/run_backtest.sh config/backtest.yaml
```

---

## 二、配置说明

### 2.1 配置文件结构

配置文件: `config/backtest.yaml`

```yaml
backtest:
  name: "my_backtest"        # 回测名称
  mode: "backtest"           # 固定为 backtest

  # 时间范围
  start_date: "2026-01-01"   # 开始日期 (YYYY-MM-DD)
  end_date: "2026-01-31"     # 结束日期 (YYYY-MM-DD)
  start_time: "09:00:00"     # 每日开始时间
  end_time: "15:00:00"       # 每日结束时间

  # 数据源
  data:
    source_type: "csv"       # 数据类型: csv
    data_path: "./data/market_data"  # 数据路径
    symbols:                 # 交易品种
      - "ag2502"
      - "ag2504"

  # 回放设置
  replay:
    mode: "fast"             # realtime | fast | instant
    speed: 10.0              # 回放速度倍数（仅 fast 模式）

  # 初始资金
  initial:
    capital: 1000000.0

  # 订单模拟
  order_simulation:
    fill_delay_ms: 10        # 成交延迟（毫秒）
    slippage_bps: 1          # 滑点（基点）
    commission_rate: 0.0003  # 手续费率

  # 输出设置
  output:
    result_dir: "./backtest_results"
    save_trades: true        # 保存交易明细
    save_daily_pnl: true     # 保存每日 PNL
    generate_report: true    # 生成报告
    report_format: "markdown"  # markdown | json

# 策略配置（使用与实盘相同的配置）
strategy:
  type: "pairwise_arb"
  symbols:
    - "ag2502"
    - "ag2504"
  parameters:
    entry_zscore: 2.0
    exit_zscore: 0.5
    lookback_window: 20
    max_position_size: 10

# NATS 配置
engine:
  nats_addr: "nats://localhost:4222"
```

### 2.2 关键参数说明

#### 回放模式 (replay.mode)

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| `realtime` | 按实际时间间隔回放（1x 速度） | 测试订单延迟、验证实盘行为 |
| `fast` | 加速回放（10x-100x 速度） | 日常回测、参数优化 |
| `instant` | 极速回放（无延迟） | 大规模批量回测 |

#### 订单模拟参数

- **fill_delay_ms**: 模拟订单从发送到成交的延迟
  - 建议: 5-20ms（取决于实盘环境）

- **slippage_bps**: 滑点（1 bps = 0.01%）
  - 建议: 0.5-2 bps（流动性好的品种）

- **commission_rate**: 手续费率
  - 期货: 通常 0.02%-0.05%
  - 股票: 通常 0.02%-0.03%

---

## 三、使用场景

### 3.1 单次回测

```bash
# 基本用法
./bin/backtest -config config/backtest.yaml

# 覆盖日期
./bin/backtest -config config/backtest.yaml \
    -start-date 2026-01-15 \
    -end-date 2026-01-15

# 指定输出目录
./bin/backtest -config config/backtest.yaml \
    -output ./results/test_20260124
```

### 3.2 批量回测（多日期）

#### 方法 1: 使用日期列表文件

```bash
# 创建日期列表
cat > dates.txt <<EOF
2026-01-01
2026-01-02
2026-01-03
2026-01-05
2026-01-08
EOF

# 运行批量回测
./scripts/backtest/run_batch_backtest.py \
    -c config/backtest.yaml \
    -d dates.txt \
    -o ./results/batch_202601
```

#### 方法 2: 使用日期范围

```bash
./scripts/backtest/run_batch_backtest.py \
    -c config/backtest.yaml \
    --start 2026-01-01 \
    --end 2026-01-31 \
    -o ./results/batch_202601
```

#### 方法 3: 使用命令行直接指定

```bash
./bin/backtest -config config/backtest.yaml \
    -dates 2026-01-01,2026-01-02,2026-01-03
```

### 3.3 参数优化（手动）

```bash
# 测试不同的 entry_zscore
for zscore in 1.0 1.5 2.0 2.5 3.0; do
    # 修改配置
    sed "s/entry_zscore:.*/entry_zscore: $zscore/" config/backtest.yaml > config/backtest_temp.yaml

    # 运行回测
    ./bin/backtest -config config/backtest_temp.yaml \
        -output ./results/zscore_$zscore
done

# 清理
rm config/backtest_temp.yaml
```

---

## 四、结果分析

### 4.1 输出文件

回测完成后，会在输出目录生成以下文件：

```
backtest_results/
├── backtest_report_20260124_190000.md      # Markdown 报告
├── backtest_result_20260124_190000.json    # JSON 结果（完整数据）
├── trades_20260124_190000.csv              # 交易明细
└── daily_pnl_20260124_190000.csv           # 每日 PNL
```

### 4.2 报告解读

#### Markdown 报告示例

```markdown
# 回测报告

**策略**: pairwise_arb
**日期**: 2026-01-01 至 2026-01-31
**初始资金**: 1000000.00
**最终资金**: 1058320.00

## 绩效摘要

| 指标 | 数值 |
|------|------|
| **总收益** | 58320.00 |
| **总收益率** | 5.83% |
| **Sharpe Ratio** | 2.34 (优秀) |
| **Sortino Ratio** | 3.12 (优秀) |
| **最大回撤** | -2.30% (优秀) |
| **胜率** | 67.80% |
```

#### 关键指标说明

| 指标 | 说明 | 优秀标准 |
|------|------|---------|
| **Sharpe Ratio** | 风险调整后收益 | > 2.0 |
| **Sortino Ratio** | 下行风险调整收益 | > 2.0 |
| **Max Drawdown** | 最大回撤 | < 5% |
| **Win Rate** | 胜率 | > 60% |
| **Profit Factor** | 盈利因子 | > 2.0 |

### 4.3 使用 JSON 结果

```python
import json

# 加载结果
with open('backtest_result_20260124_190000.json') as f:
    result = json.load(f)

# 打印关键指标
print(f"Total PNL: {result['TotalPNL']}")
print(f"Sharpe Ratio: {result['SharpeRatio']}")
print(f"Win Rate: {result['WinRate']*100:.1f}%")

# 分析每日 PNL
for daily in result['DailyPNL']:
    print(f"{daily['Date']}: {daily['PNL']:.2f}")
```

---

## 五、常见问题

### 5.1 数据相关

**Q: 数据文件格式有什么要求？**

A: CSV 格式，最少需要 9 列：

```csv
timestamp_ns,symbol,exchange,last_price,last_volume,bid_price1,bid_volume1,ask_price1,ask_volume1
```

**Q: 时间戳格式是什么？**

A: 纳秒时间戳（19 位数字），例如：`1737705600000000000`

**Q: 如何生成测试数据？**

A: 使用 `generate_mock_data` 工具：

```bash
./bin/generate_mock_data --start-date 2026-01-01 --end-date 2026-01-10 --symbols ag2502,ag2504
```

### 5.2 性能相关

**Q: 回测速度慢怎么办？**

A:
1. 使用 `instant` 回放模式
2. 减少数据量（缩短日期范围）
3. 使用更快的存储（SSD）

**Q: 内存占用高怎么办？**

A:
1. 分批回测（不要一次加载太多天）
2. 减少每日 tick 数量

### 5.3 结果相关

**Q: 为什么没有生成订单？**

A: 检查：
1. 策略阈值是否过高（降低 entry_zscore）
2. 数据是否有效（查看日志）
3. NATS 是否运行

**Q: 回测结果与实盘差异大？**

A: 检查：
1. 滑点和手续费设置是否合理
2. 成交延迟是否符合实际
3. 数据质量是否与实盘一致

---

## 六、最佳实践

### 6.1 数据准备

1. **使用真实数据**: 尽量使用实盘录制的数据，而非模拟数据
2. **数据完整性**: 确保数据无缺失、无错误
3. **数据分辨率**: Tick 级数据最佳，至少需要 1 秒级

### 6.2 参数设置

1. **保守的滑点**: 宁愿高估滑点，避免过度优化
2. **真实的手续费**: 包括交易所费用、平台费用等
3. **合理的延迟**: 根据实盘环境设置成交延迟

### 6.3 结果验证

1. **样本外测试**: 用训练期外的数据验证
2. **Walk-forward**: 滚动回测验证稳定性
3. **对比实盘**: 小仓位实盘验证后再放大

### 6.4 风险控制

1. **回撤限制**: MaxDrawdown < 10%
2. **夏普比率**: Sharpe > 1.5
3. **胜率平衡**: 不要过度追求高胜率

---

## 七、进阶使用

### 7.1 自定义策略回测

如果需要回测自定义策略，修改 `trader.go` 以支持回测模式：

```go
// 在 trader.go 中添加
if config.Mode == "backtest" {
    // 使用回测专用的组件
    t.orderRouter = backtest.NewBacktestOrderRouter(...)
} else {
    // 使用实盘组件
    t.orderRouter = ors.NewORSClient(...)
}
```

### 7.2 参数优化框架（未来）

计划支持自动参数优化：

```bash
# 网格搜索
./bin/backtest -config config/backtest.yaml \
    --optimize \
    --param entry_zscore:1.0,1.5,2.0,2.5,3.0 \
    --param exit_zscore:0.2,0.5,0.7,1.0
```

### 7.3 分布式回测（未来）

计划支持多机器并行回测：

```bash
# 主节点
./bin/backtest-master --workers 4

# 工作节点
./bin/backtest-worker --master http://master:8080
```

---

## 八、附录

### 8.1 完整示例

```bash
# 1. 生成测试数据
./bin/generate_mock_data \
    --start-date 2026-01-01 \
    --end-date 2026-01-05 \
    --symbols ag2502,ag2504 \
    --ticks 5000

# 2. 启动 NATS
nats-server &

# 3. 运行单日回测
./bin/backtest -config config/backtest.yaml \
    -start-date 2026-01-01 \
    -end-date 2026-01-01

# 4. 运行批量回测
./scripts/backtest/run_batch_backtest.py \
    -c config/backtest.yaml \
    --start 2026-01-01 \
    --end 2026-01-05 \
    -o ./results/batch_test

# 5. 查看结果
cat ./results/batch_test/backtest_report_*.md
```

### 8.2 目录结构

```
quantlink-trade-system/
├── bin/
│   ├── backtest                    # 回测可执行文件
│   └── generate_mock_data          # 数据生成工具
├── config/
│   └── backtest.yaml               # 回测配置
├── data/
│   └── market_data/                # 历史数据
│       ├── 20260101/
│       │   ├── ag2502.csv
│       │   └── ag2504.csv
│       └── 20260102/
│           └── ...
├── golang/
│   ├── cmd/backtest/               # 回测命令行工具
│   └── pkg/backtest/               # 回测核心库
├── scripts/backtest/               # 回测脚本
│   ├── run_backtest.sh
│   ├── run_batch_backtest.py
│   └── generate_mock_data.go
└── backtest_results/               # 回测结果输出
    ├── backtest_report_*.md
    ├── backtest_result_*.json
    ├── trades_*.csv
    └── daily_pnl_*.csv
```

---

**文档更新时间**: 2026-01-24 19:00
**维护者**: QuantLink Team

如有问题，请参考：
- 系统架构: `docs/CURRENT_ARCHITECTURE_FLOW.md`
- 回测实施方案: `docs/系统_回测系统实施方案_2026-01-24-18_30.md`
