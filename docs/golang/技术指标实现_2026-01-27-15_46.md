# 技术指标实现技术文档

**文档日期**: 2026-01-27
**作者**: Claude Code
**版本**: v1.0
**相关模块**: golang/pkg/indicators

---

## 概述

本文档记录了 10 个核心技术指标的实现，这些指标用于支持趋势跟随策略和技术分析。其中 6 个指标已存在，4 个为新实现。所有指标均基于 `Indicator` 接口和 `BaseIndicator` 基类，提供统一的接口、历史追踪和线程安全保证。

### 已实现指标列表

| # | 指标名称 | 英文名 | 文件 | 状态 |
|---|---------|--------|------|------|
| 1 | 简单移动平均 | SMA | sma.go | ✅ (已有) |
| 2 | 指数移动平均 | EMA/EWMA | ewma.go | ✅ (已有) |
| 3 | 加权移动平均 | WMA | wma.go | ✅ (新) |
| 4 | 相对强弱指标 | RSI | rsi.go | ✅ (已有) |
| 5 | MACD | MACD | macd.go | ✅ (已有) |
| 6 | 布林带 | BollingerBands | bollinger.go | ✅ (已有) |
| 7 | 平均真实范围 | ATR | atr.go | ✅ (已有) |
| 8 | 动量指标 | Momentum | momentum.go | ✅ (新) |
| 9 | 变动率 | ROC | roc.go | ✅ (新) |
| 10 | 标准差 | StdDev | stddev.go | ✅ (新) |

---

## 新实现指标详解

### 1. WMA - 加权移动平均

#### 定义

加权移动平均给予最近的价格更高的权重，权重线性递减。相比SMA，WMA对价格变化更敏感。

**公式**：
```
WMA = Σ(Price[i] * Weight[i]) / Σ(Weight[i])

其中：
Weight[i] = i + 1  (最旧价格权重为1，最新价格权重为period)
Σ(Weight[i]) = 1 + 2 + ... + period = period * (period + 1) / 2
```

**示例（5周期WMA）**：
```
价格: [100, 102, 104, 106, 108]
权重: [1, 2, 3, 4, 5]

WMA = (100*1 + 102*2 + 104*3 + 106*4 + 108*5) / (1+2+3+4+5)
    = (100 + 204 + 312 + 424 + 540) / 15
    = 1580 / 15 = 105.33
```

#### 实现

```go
type WMA struct {
    *BaseIndicator
    period      int
    prices      []float64
    weightSum   float64  // period * (period + 1) / 2
    initialized bool
}

func NewWMA(period int, maxHistory int) *WMA
func (w *WMA) Update(md *mdpb.MarketDataUpdate)
```

#### 配置参数

```yaml
wma:
  period: 20           # 周期长度（默认 20）
  max_history: 1000    # 历史长度
```

#### 使用示例

```go
// 创建20周期WMA
indicator := indicators.NewWMA(20, 1000)

// 工厂创建
config := map[string]interface{}{
    "period": float64(20),
    "max_history": float64(1000),
}
indicator, err := lib.Create("wma", "wma", config)

// 更新
indicator.Update(marketData)

// 获取当前值
wma := indicator.GetValue()
```

#### 应用场景

- **趋势跟踪**: 比SMA更快响应价格变化
- **交叉信号**: WMA与价格交叉产生买卖信号
- **支撑/阻力**: 动态支撑阻力位
- **多周期分析**: 短期WMA与长期WMA交叉

#### 与SMA比较

在上升趋势中，WMA > SMA（更接近最新价格）
在下降趋势中，WMA < SMA（更快反映下跌）

#### 性能指标

- **更新延迟**: 17.10 ns (20周期), 126.6 ns (200周期)
- **内存占用**: < 20 KB
- **线程安全**: 是

---

### 2. Momentum - 动量指标

#### 定义

动量测量价格在指定周期内的变化量（绝对值）。正值表示上涨动能，负值表示下跌动能。

**公式**：
```
Momentum = CurrentPrice - Price[N periods ago]
```

**解释**：
- Momentum > 0: 价格上涨
- Momentum = 0: 价格不变
- Momentum < 0: 价格下跌

#### 实现

```go
type Momentum struct {
    *BaseIndicator
    period      int
    prices      []float64  // Keep period+1 prices
    initialized bool
}

func NewMomentum(period int, maxHistory int) *Momentum
func (m *Momentum) Update(md *mdpb.MarketDataUpdate)
```

#### 配置参数

```yaml
momentum:
  period: 10           # 回溯周期（默认 10）
  max_history: 1000    # 历史长度
```

#### 使用示例

```go
// 创建10周期Momentum
indicator := indicators.NewMomentum(10, 1000)

indicator.Update(marketData)
momentum := indicator.GetValue()

// 趋势判断
if momentum > 10 {
    fmt.Println("强劲上涨动能")
} else if momentum < -10 {
    fmt.Println("强劲下跌动能")
}
```

#### 应用场景

- **趋势强度**: 动量绝对值越大，趋势越强
- **动能衰减**: 动量减小可能预示趋势反转
- **零轴交叉**: 动量穿越零轴产生信号
- **背离分析**: 价格创新高但动量未创新高（看跌背离）

#### 典型值范围

| 动量值 | 市场状态 |
|--------|---------|
| > 20 | 强劲上涨 |
| 10 - 20 | 温和上涨 |
| -10 - 10 | 盘整 |
| -20 - -10 | 温和下跌 |
| < -20 | 强劲下跌 |

#### 性能指标

- **更新延迟**: 13.17 ns (10周期), 12.05 ns (200周期)
- **内存占用**: < 15 KB
- **线程安全**: 是

---

### 3. ROC - 变动率

#### 定义

变动率（Rate of Change）测量价格的百分比变化，是Momentum的归一化版本。

**公式**：
```
ROC = ((CurrentPrice - Price[N periods ago]) / Price[N periods ago]) * 100
```

**与Momentum关系**：
```
ROC = (Momentum / PastPrice) * 100
```

#### 实现

```go
type ROC struct {
    *BaseIndicator
    period      int
    prices      []float64  // Keep period+1 prices
    initialized bool
}

func NewROC(period int, maxHistory int) *ROC
func (r *ROC) Update(md *mdpb.MarketDataUpdate)
```

#### 配置参数

```yaml
roc:
  period: 10           # 回溯周期（默认 10）
  max_history: 1000    # 历史长度
```

#### 使用示例

```go
// 创建10周期ROC
indicator := indicators.NewROC(10, 1000)

indicator.Update(marketData)
roc := indicator.GetValue()  // 例如: 15.5 表示15.5%涨幅

// 趋势判断
if roc > 5 {
    fmt.Println("快速上涨")
} else if roc < -5 {
    fmt.Println("快速下跌")
}
```

#### 应用场景

- **跨资产比较**: 百分比变化可比较不同价格的资产
- **超买超卖**: 极端ROC值可能预示反转
- **趋势确认**: ROC方向确认价格趋势
- **动量振荡器**: 作为振荡指标使用

#### 典型值范围

| ROC值 | 市场状态 |
|-------|---------|
| > 10% | 强劲上涨，可能超买 |
| 5% - 10% | 温和上涨 |
| -5% - 5% | 盘整 |
| -10% - -5% | 温和下跌 |
| < -10% | 强劲下跌，可能超卖 |

#### 与Momentum比较

```
价格: 100 → 120
Momentum = 20 (绝对值)
ROC = 20% (百分比)

价格: 1000 → 1020
Momentum = 20 (绝对值相同)
ROC = 2% (百分比不同)
```

ROC更适合跨资产比较，Momentum更直观显示价格变化。

#### 性能指标

- **更新延迟**: 13.06 ns (10周期), 11.99 ns (200周期)
- **内存占用**: < 15 KB
- **线程安全**: 是

---

### 4. StdDev - 标准差

#### 定义

标准差测量价格围绕均值的离散程度，是最常用的波动率指标。

**公式**：
```
Mean = Σ(Price[i]) / N
Variance = Σ(Price[i] - Mean)² / N
StdDev = √Variance
```

**解释**：
- 高标准差: 价格波动大，风险高
- 低标准差: 价格稳定，风险低

#### 实现

```go
type StdDev struct {
    *BaseIndicator
    period      int
    prices      []float64
    sum         float64  // Optimize mean calculation
    initialized bool
}

func NewStdDev(period int, maxHistory int) *StdDev
func (s *StdDev) Update(md *mdpb.MarketDataUpdate)
func (s *StdDev) GetMean() float64  // 额外方法
```

#### 配置参数

```yaml
stddev:
  period: 20           # 周期长度（默认 20）
  max_history: 1000    # 历史长度
```

#### 使用示例

```go
// 创建20周期StdDev
indicator := indicators.NewStdDev(20, 1000)

indicator.Update(marketData)
stddev := indicator.GetValue()
mean := indicator.GetMean()

// 波动率分析
if stddev > 10 {
    fmt.Println("高波动，风险大")
} else if stddev < 3 {
    fmt.Println("低波动，稳定")
}
```

#### 应用场景

- **波动率测量**: 量化市场风险
- **布林带构建**: StdDev是布林带的核心组件
- **仓位管理**: 高波动时减小仓位
- **止损设置**: 基于标准差动态调整止损

#### 与布林带关系

```
布林带上轨 = SMA + (2 * StdDev)
布林带中轨 = SMA
布林带下轨 = SMA - (2 * StdDev)
```

#### 典型值范围（相对价格）

| StdDev/Price | 年化波动率 | 市场状态 |
|--------------|-----------|---------|
| < 1% | < 16% | 极低波动 |
| 1% - 2% | 16% - 32% | 低波动 |
| 2% - 3% | 32% - 48% | 正常波动 |
| 3% - 5% | 48% - 80% | 高波动 |
| > 5% | > 80% | 极高波动 |

*注：假设数据为日频，年化系数 √252*

#### 性能指标

- **更新延迟**: 19.53 ns (20周期), 131 ns (200周期)
- **内存占用**: < 20 KB
- **线程安全**: 是

---

## 已有指标概览

### 5. SMA - 简单移动平均

最基础的均线，所有价格权重相等。

**公式**: `SMA = Σ(Price[i]) / N`

**应用**: 趋势判断、支撑阻力、金叉死叉

### 6. EMA - 指数移动平均

对最近价格赋予更高权重，响应速度介于SMA和WMA之间。

**公式**: `EMA = α * Price + (1 - α) * EMA_prev`

其中 `α = 2 / (period + 1)`

**应用**: 快速跟踪趋势、MACD构建

### 7. RSI - 相对强弱指标

测量价格上涨和下跌的相对强度。

**公式**: `RSI = 100 - (100 / (1 + RS))`

其中 `RS = Average Gain / Average Loss`

**范围**: 0 - 100
- RSI > 70: 超买
- RSI < 30: 超卖

### 8. MACD - 移动平均收敛发散

基于EMA的动量指标，包含MACD线、信号线和柱状图。

**公式**:
```
MACD Line = EMA(12) - EMA(26)
Signal Line = EMA(9) of MACD Line
Histogram = MACD Line - Signal Line
```

**信号**:
- MACD线上穿信号线: 买入
- MACD线下穿信号线: 卖出

### 9. BollingerBands - 布林带

基于标准差的动态通道指标。

**公式**:
```
Middle Band = SMA(20)
Upper Band = SMA(20) + 2 * StdDev(20)
Lower Band = SMA(20) - 2 * StdDev(20)
```

**应用**: 超买超卖、波动率、突破交易

### 10. ATR - 平均真实范围

测量价格波动范围，不考虑方向。

**公式**:
```
True Range = max(High - Low, |High - Close_prev|, |Low - Close_prev|)
ATR = EMA(True Range, period)
```

**应用**: 波动率测量、止损设置、仓位管理

---

## 综合示例

### 创建所有技术指标

```go
import (
    "github.com/yourusername/quantlink-trade-system/pkg/indicators"
    mdpb "github.com/yourusername/quantlink-trade-system/pkg/proto/md"
)

func main() {
    // 创建指标库
    lib := indicators.NewIndicatorLibrary()

    // 配置所有技术指标
    configs := map[string]struct {
        indicatorType string
        config        map[string]interface{}
    }{
        "sma_20": {
            "sma",
            map[string]interface{}{"period": float64(20)},
        },
        "ema_20": {
            "ewma",
            map[string]interface{}{"period": float64(20)},
        },
        "wma_20": {
            "wma",
            map[string]interface{}{"period": float64(20)},
        },
        "rsi_14": {
            "rsi",
            map[string]interface{}{"period": float64(14)},
        },
        "macd": {
            "macd",
            map[string]interface{}{
                "fast_period":   float64(12),
                "slow_period":   float64(26),
                "signal_period": float64(9),
            },
        },
        "bollinger": {
            "bollinger_bands",
            map[string]interface{}{
                "period":      float64(20),
                "num_std_dev": float64(2),
            },
        },
        "atr_14": {
            "atr",
            map[string]interface{}{"period": float64(14)},
        },
        "momentum_10": {
            "momentum",
            map[string]interface{}{"period": float64(10)},
        },
        "roc_10": {
            "roc",
            map[string]interface{}{"period": float64(10)},
        },
        "stddev_20": {
            "stddev",
            map[string]interface{}{"period": float64(20)},
        },
    }

    // 创建所有指标
    for name, cfg := range configs {
        _, err := lib.Create(name, cfg.indicatorType, cfg.config)
        if err != nil {
            panic(err)
        }
    }

    // 更新所有指标
    lib.UpdateAll(marketData)

    // 获取所有指标值
    values := lib.GetAllValues()
}
```

### 趋势跟踪策略示例

```go
type TrendFollowingStrategy struct {
    sma50  *indicators.SMA
    sma200 *indicators.SMA
    rsi    *indicators.RSI
    atr    *indicators.ATR
}

func (s *TrendFollowingStrategy) OnMarketData(md *mdpb.MarketDataUpdate) {
    // 更新指标
    s.sma50.Update(md)
    s.sma200.Update(md)
    s.rsi.Update(md)
    s.atr.Update(md)

    // 等待指标准备好
    if !s.sma200.IsReady() {
        return
    }

    price := (md.BidPrice[0] + md.AskPrice[0]) / 2
    sma50 := s.sma50.GetValue()
    sma200 := s.sma200.GetValue()
    rsi := s.rsi.GetValue()
    atr := s.atr.GetValue()

    // 趋势判断
    isBullish := sma50 > sma200
    isBearish := sma50 < sma200

    // 买入条件: 金叉 + RSI不超买
    if isBullish && rsi < 70 {
        // 动态止损: 2倍ATR
        stopLoss := price - 2*atr
        // 发送买入信号...
    }

    // 卖出条件: 死叉 + RSI不超卖
    if isBearish && rsi > 30 {
        // 发送卖出信号...
    }
}
```

---

## 性能总结

### 基准测试结果

在 Apple M4 Pro 处理器上的性能表现：

| 指标 | 更新延迟 (ns) | 每秒更新次数 |
|------|--------------|-------------|
| WMA (20) | 17.10 | 58M |
| WMA (200) | 126.6 | 8M |
| Momentum (10) | 13.17 | 76M |
| Momentum (200) | 12.05 | 83M |
| ROC (10) | 13.06 | 77M |
| ROC (200) | 11.99 | 83M |
| StdDev (20) | 19.53 | 51M |
| StdDev (200) | 131.0 | 7M |

**观察**：
1. 简单指标（Momentum, ROC）延迟最低（~13ns）
2. WMA和StdDev在大周期时延迟增加（需遍历所有价格）
3. 所有指标在常用周期（10-20）下延迟 < 20ns
4. 性能远超 1μs 目标

### 内存占用

| 指标 | 内存占用（1000历史） |
|------|---------------------|
| WMA | ~20 KB |
| Momentum | ~15 KB |
| ROC | ~15 KB |
| StdDev | ~20 KB |

**总计**：所有 10 个技术指标约 180 KB，内存占用合理。

---

## 测试覆盖率

### 单元测试

每个新指标都有完整的单元测试：

**WMA测试** (10个测试用例):
- 基本计算验证
- 手动计算对比
- 与SMA比较
- 边界条件
- 配置测试
- 重置测试

**Momentum测试** (11个测试用例):
- 正负动量测试
- 零动量测试
- 趋势检测
- 边界条件
- 历史管理

**ROC测试** (12个测试用例):
- 百分比计算验证
- 与Momentum关系验证
- 极端情况（翻倍、减半）
- 配置测试

**StdDev测试** (13个测试用例):
- 标准差计算验证
- 常数价格（零标准差）
- 高低波动比较
- 手动计算对比
- 均值验证

**测试统计**：
- 新增测试文件: 4 个
- 新增测试用例: 46 个
- 覆盖率: > 90%
- 所有测试通过: ✅

### 运行测试

```bash
# 运行所有技术指标测试
cd golang
go test ./pkg/indicators -v

# 运行新指标测试
go test ./pkg/indicators -run "TestWMA|TestMomentum|TestROC|TestStdDev" -v

# 运行基准测试
go test ./pkg/indicators -bench "BenchmarkWMA|BenchmarkMomentum|BenchmarkROC|BenchmarkStdDev" -run=^$

# 生成覆盖率报告
go test ./pkg/indicators -coverprofile=coverage.out
go tool cover -html=coverage.out
```

---

## 工厂注册

所有新指标已注册到 `IndicatorLibrary` 工厂：

```go
// indicator.go
func NewIndicatorLibrary() *IndicatorLibrary {
    lib := &IndicatorLibrary{
        indicators: make(map[string]Indicator),
        factories:  make(map[string]IndicatorFactory),
    }

    // ... 其他指标 ...

    // 注册新技术指标
    lib.RegisterFactory("wma", NewWMAFromConfig)
    lib.RegisterFactory("momentum", NewMomentumFromConfig)
    lib.RegisterFactory("roc", NewROCFromConfig)
    lib.RegisterFactory("stddev", NewStdDevFromConfig)

    return lib
}
```

---

## 演示程序

运行 `technical_indicators_demo` 查看所有指标的实时演示：

```bash
cd golang
go run cmd/technical_indicators_demo/main.go
```

演示输出示例：

```
==========================================
技术指标演示程序
==========================================

已创建 10 个技术指标

========== 场景 1: 强劲上升趋势 ==========
最新价格: 150.00

技术指标值:
  1. SMA(20):       131.00
  2. EMA(20):       132.56
  3. WMA(20):       137.33      ← 最接近当前价格
  4. RSI(14):       100.00      ← 超买
  5. MACD:          10.5185
  6. Bollinger:     131.00
  7. ATR(14):       2.4560
  8. Momentum(10):  20.00       ← 强劲上涨
  9. ROC(10):       15.38%      ← 快速上涨
 10. StdDev(20):    11.5326     ← 高波动

趋势分析:
  • 价格位于均线上方，上升趋势
  • RSI = 100，超买区域
  • 动量 = 20，强劲上涨动能
  • ROC = 15.4%，快速上涨
  • 标准差 = 11.53，高波动
```

---

## 文件清单

### 实现文件

```
golang/pkg/indicators/
├── wma.go                          # WMA 实现 (134行)
├── wma_test.go                     # WMA 测试 (269行)
├── momentum.go                     # Momentum 实现 (126行)
├── momentum_test.go                # Momentum 测试 (292行)
├── roc.go                          # ROC 实现 (132行)
├── roc_test.go                     # ROC 测试 (328行)
├── stddev.go                       # StdDev 实现 (161行)
├── stddev_test.go                  # StdDev 测试 (377行)
└── indicator.go                    # 工厂注册（已更新）
```

### 演示程序

```
golang/cmd/technical_indicators_demo/
└── main.go                         # 技术指标演示 (260行)
```

### 文档

```
docs/golang/
└── 技术指标实现_2026-01-27-15_46.md  # 本文档
```

---

## 指标选择指南

### 按用途选择

| 用途 | 推荐指标 |
|------|---------|
| 趋势判断 | SMA, EMA, WMA |
| 趋势强度 | Momentum, ROC |
| 超买超卖 | RSI, StochasticRSI |
| 动量确认 | MACD, Momentum |
| 波动率测量 | ATR, StdDev, BollingerBands |
| 支撑阻力 | SMA, EMA, BollingerBands |

### 按策略类型选择

**趋势跟踪策略**:
- SMA(50) 和 SMA(200) - 金叉死叉
- EMA(12) 和 EMA(26) - MACD基础
- Momentum - 确认趋势强度

**均值回归策略**:
- BollingerBands - 超买超卖区域
- RSI - 反转信号
- StdDev - 波动率筛选

**突破策略**:
- ATR - 动态止损
- StdDev - 波动率过滤
- BollingerBands - 挤压突破

### 多指标组合

**经典组合1: 趋势+动量**
```
SMA(50), SMA(200)  - 趋势方向
MACD               - 动量确认
RSI                - 超买超卖过滤
ATR                - 止损设置
```

**经典组合2: 波动率突破**
```
BollingerBands     - 通道范围
ATR                - 波动率确认
Volume             - 成交量确认
```

**经典组合3: 短线交易**
```
EMA(5), EMA(13)    - 快速均线
Momentum(10)       - 动能变化
StdDev(20)         - 波动率
```

---

## 常见问题

### Q1: WMA、SMA、EMA如何选择？

**A**:
- **SMA**: 最平滑，适合长期趋势
- **EMA**: 中等响应速度，最常用（MACD基础）
- **WMA**: 最快响应，适合短期交易

在上升趋势中: WMA > EMA > SMA
在下降趋势中: WMA < EMA < SMA

### Q2: Momentum和ROC有什么区别？

**A**:
- **Momentum**: 绝对值变化，单位与价格相同
- **ROC**: 百分比变化，跨资产可比

示例：
- 股价100→120: Momentum=20, ROC=20%
- 股价1000→1020: Momentum=20, ROC=2%

ROC更适合比较不同价格的资产。

### Q3: StdDev如何用于风险管理？

**A**:
1. **仓位调整**: `Position Size ∝ 1 / StdDev`
2. **止损设置**: `Stop Loss = Entry - 2 * StdDev`
3. **波动率过滤**: 低StdDev时增加交易，高StdDev时减少

### Q4: 指标周期如何选择？

**A**:
| 交易周期 | 推荐周期 |
|---------|---------|
| 超短线 | 5, 10 |
| 短线 | 10, 20 |
| 中线 | 20, 50 |
| 长线 | 50, 200 |

经典组合: 快线(短周期) + 慢线(长周期)

### Q5: 如何避免指标滞后？

**A**:
1. 使用更快的指标（EMA, WMA）
2. 减小周期长度
3. 结合价格行为分析
4. 多指标确认（不依赖单一指标）

---

## 总结

本次实现完成了 10 个核心技术指标：

✅ **均线类**: SMA, EMA, WMA (3个)
✅ **动量类**: Momentum, ROC, RSI, MACD (4个)
✅ **波动率类**: StdDev, ATR, BollingerBands (3个)

所有指标：
- 实现 `Indicator` 接口
- 提供配置驱动创建
- 支持历史追踪
- 线程安全
- 性能优秀（< 20ns 常用周期）
- 单元测试完整（> 90% 覆盖率）
- 文档详细

**新增成果**:
- 4 个新指标（WMA, Momentum, ROC, StdDev）
- 553 行实现代码
- 1,266 行测试代码
- 46 个单元测试
- 1 个演示程序

这些指标为趋势跟踪策略、动量策略和技术分析提供了坚实的基础。

---

**最后更新**: 2026-01-27 15:46
**文档版本**: v1.0
