# Macå¼€å‘ç¯å¢ƒé…ç½® - Dockeræ–¹æ¡ˆ

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-26
**é€‚ç”¨åœºæ™¯**: Macå¼€å‘CTP Linuxåº”ç”¨
**é—®é¢˜**: CTPåªæä¾›Linuxç‰ˆæœ¬ï¼ŒMacæ— æ³•ç›´æ¥ä½¿ç”¨

---

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

åœ¨Macä¸Šä½¿ç”¨Dockerè¿è¡ŒLinuxå®¹å™¨ï¼Œåœ¨å®¹å™¨å†…è¿›è¡ŒCTPå¼€å‘å’Œæµ‹è¯•ã€‚

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨å…¼å®¹CTP Linuxåº“
- âœ… ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´
- âœ… å¯ä»¥åœ¨Macä¸Šç¼–è¾‘ä»£ç ï¼Œå®¹å™¨å†…ç¼–è¯‘è¿è¡Œ
- âœ… ä¸éœ€è¦è™šæ‹Ÿæœºï¼Œèµ„æºå ç”¨å°

---

## ğŸ“¦ å‰ç½®æ¡ä»¶

### 1. å®‰è£…Docker Desktop

**ä¸‹è½½åœ°å€**: https://www.docker.com/products/docker-desktop/

```bash
# æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
docker --version
# åº”è¾“å‡º: Docker version 24.x.x

docker-compose --version
# åº”è¾“å‡º: Docker Compose version v2.x.x
```

### 2. å·²ä¸‹è½½CTP API

```bash
ls ~/Downloads/v6.7.11_20250714_traderapi/
# ç¡®è®¤æ–‡ä»¶å·²ä¸‹è½½
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: å®‰è£…CTP APIåˆ°é¡¹ç›®

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system

# åˆ›å»ºç›®å½•
mkdir -p gateway/third_party/ctp/include
mkdir -p gateway/third_party/ctp/lib

# è®¾ç½®CTPè·¯å¾„ï¼ˆç®€åŒ–å‘½ä»¤ï¼‰
CTP_DIR=~/Downloads/v6.7.11_20250714_traderapi/v6.7.11_20250617_api_traderapi_linux64/v6.7.11_20250617_api/v6.7.11_20250617_api_traderapi_se_linux64

# å¤åˆ¶å¤´æ–‡ä»¶
cp $CTP_DIR/ThostFtdc*.h gateway/third_party/ctp/include/

# å¤åˆ¶åŠ¨æ€åº“
cp $CTP_DIR/thostmduserapi_se.so gateway/third_party/ctp/lib/
cp $CTP_DIR/thosttraderapi_se.so gateway/third_party/ctp/lib/

# å¤åˆ¶é”™è¯¯å®šä¹‰æ–‡ä»¶
cp $CTP_DIR/error.xml gateway/third_party/ctp/lib/
cp $CTP_DIR/error.dtd gateway/third_party/ctp/lib/

# éªŒè¯å®‰è£…
ls -lh gateway/third_party/ctp/include/
ls -lh gateway/third_party/ctp/lib/
```

### æ­¥éª¤2: æ„å»ºDockerå¼€å‘ç¯å¢ƒ

```bash
# æ„å»ºé•œåƒï¼ˆé¦–æ¬¡éœ€è¦å‡ åˆ†é’Ÿï¼‰
docker-compose -f docker-compose.dev.yml build

# å¯åŠ¨å®¹å™¨
docker-compose -f docker-compose.dev.yml up -d ctp-dev

# è¿›å…¥å®¹å™¨
docker exec -it quantlink-ctp-dev bash
```

### æ­¥éª¤3: åœ¨å®¹å™¨å†…ç¼–è¯‘

```bash
# ç°åœ¨ä½ åœ¨Linuxå®¹å™¨å†…äº†

# ç¼–è¯‘gateway
cd /workspace/gateway
mkdir -p build && cd build
cmake ..
make -j4

# æ£€æŸ¥ç¼–è¯‘äº§ç‰©
ls -lh md_gateway
ldd md_gateway  # æ£€æŸ¥ä¾èµ–åº“

# ç¼–è¯‘Golangéƒ¨åˆ†
cd /workspace/golang
go build -o ../bin/trader cmd/trader/main.go
```

### æ­¥éª¤4: è¿è¡Œæµ‹è¯•

```bash
# åœ¨å®¹å™¨å†…å¯åŠ¨NATS
nats-server &

# è¿è¡Œå®Œæ•´é“¾è·¯æµ‹è¯•
cd /workspace
./test_full_chain.sh
```

---

## ğŸ’» å¼€å‘å·¥ä½œæµ

### æ—¥å¸¸å¼€å‘æµç¨‹

```bash
# 1. åœ¨Macä¸Šç¼–è¾‘ä»£ç 
# ä½¿ç”¨VS Code/Cursor/ä»»ä½•ç¼–è¾‘å™¨ç¼–è¾‘é¡¹ç›®æ–‡ä»¶
# æ–‡ä»¶ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å®¹å™¨å†…ï¼ˆé€šè¿‡volumeæŒ‚è½½ï¼‰

# 2. åœ¨å®¹å™¨å†…ç¼–è¯‘å’Œæµ‹è¯•
docker exec -it quantlink-ctp-dev bash

cd /workspace/gateway/build
make -j4

# 3. è¿è¡Œå’Œè°ƒè¯•
./bin/md_gateway

# 4. æŸ¥çœ‹æ—¥å¿—
tail -f /workspace/log/*.log
```

### å®¹å™¨ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨å®¹å™¨
docker-compose -f docker-compose.dev.yml up -d

# åœæ­¢å®¹å™¨
docker-compose -f docker-compose.dev.yml stop

# åˆ é™¤å®¹å™¨
docker-compose -f docker-compose.dev.yml down

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps

# è¿›å…¥å®¹å™¨
docker exec -it quantlink-ctp-dev bash

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs quantlink-ctp-dev
```

---

## ğŸ”§ CTPå¼€å‘ç‰¹å®šé…ç½®

### åœ¨å®¹å™¨å†…éªŒè¯CTPåº“

```bash
# è¿›å…¥å®¹å™¨
docker exec -it quantlink-ctp-dev bash

# æ£€æŸ¥CTPåº“
cd /workspace/gateway/third_party/ctp/lib

# æŸ¥çœ‹åŠ¨æ€åº“ä¿¡æ¯
file thostmduserapi_se.so
# åº”è¾“å‡º: ELF 64-bit LSB shared object, x86-64

# æ£€æŸ¥ä¾èµ–
ldd thostmduserapi_se.so
# åº”è¯¥æ˜¾ç¤ºæ‰€æœ‰ä¾èµ–éƒ½æ‰¾åˆ°äº†

# è®¾ç½®åº“è·¯å¾„ï¼ˆå·²åœ¨docker-composeä¸­é…ç½®ï¼‰
echo $LD_LIBRARY_PATH
# åº”åŒ…å«: /workspace/gateway/third_party/ctp/lib
```

### åˆ›å»ºCTPæµ‹è¯•ç¨‹åº

åœ¨å®¹å™¨å†…åˆ›å»ºä¸€ä¸ªç®€å•çš„CTPè¿æ¥æµ‹è¯•ï¼š

```bash
# åœ¨å®¹å™¨å†…
cd /workspace/gateway
cat > test_ctp_connection.cpp << 'EOF'
#include "ThostFtdcMdApi.h"
#include <iostream>
#include <thread>
#include <chrono>

class TestSpi : public CThostFtdcMdSpi {
public:
    void OnFrontConnected() override {
        std::cout << "âœ… CTP Connected!" << std::endl;
    }

    void OnFrontDisconnected(int nReason) override {
        std::cout << "âŒ CTP Disconnected: " << nReason << std::endl;
    }
};

int main() {
    std::cout << "Testing CTP API..." << std::endl;

    CThostFtdcMdApi* api = CThostFtdcMdApi::CreateFtdcMdApi("./flow/");
    TestSpi spi;
    api->RegisterSpi(&spi);
    api->RegisterFront(const_cast<char*>("tcp://180.168.146.187:10211"));
    api->Init();

    std::cout << "Waiting for connection..." << std::endl;
    std::this_thread::sleep_for(std::chrono::seconds(5));

    api->Release();
    return 0;
}
EOF

# ç¼–è¯‘æµ‹è¯•ç¨‹åº
g++ -o test_ctp test_ctp_connection.cpp \
    -I/workspace/gateway/third_party/ctp/include \
    -L/workspace/gateway/third_party/ctp/lib \
    -lthostmduserapi_se \
    -lpthread \
    -std=c++11

# è¿è¡Œæµ‹è¯•
./test_ctp
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### ä½¿ç”¨GDBè°ƒè¯•

```bash
# åœ¨å®¹å™¨å†…
cd /workspace/gateway/build

# ä½¿ç”¨GDBå¯åŠ¨
gdb ./md_gateway

# GDBå‘½ä»¤
(gdb) break main
(gdb) run
(gdb) next
(gdb) print variable_name
(gdb) continue
```

### ä½¿ç”¨Valgrindæ£€æŸ¥å†…å­˜

```bash
# æ£€æŸ¥å†…å­˜æ³„æ¼
valgrind --leak-check=full ./md_gateway
```

### æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨

```bash
# è¿½è¸ªç³»ç»Ÿè°ƒç”¨
strace -f ./md_gateway

# è¿½è¸ªç‰¹å®šç³»ç»Ÿè°ƒç”¨
strace -e trace=open,read,write ./md_gateway
```

---

## ğŸ“ æ–‡ä»¶åŒæ­¥è¯´æ˜

### Mac â†” å®¹å™¨æ–‡ä»¶åŒæ­¥

```
Macæ–‡ä»¶ç³»ç»Ÿ                      Dockerå®¹å™¨
/Users/user/PWorks/RD/          /workspace/
quantlink-trade-system/
â”œâ”€â”€ gateway/              â†â†’    â”œâ”€â”€ gateway/
â”œâ”€â”€ golang/               â†â†’    â”œâ”€â”€ golang/
â”œâ”€â”€ config/               â†â†’    â”œâ”€â”€ config/
â””â”€â”€ bin/                  â†â†’    â””â”€â”€ bin/
```

**å®æ—¶åŒæ­¥**:
- åœ¨Macä¸Šä¿®æ”¹æ–‡ä»¶ â†’ å®¹å™¨å†…ç«‹å³ç”Ÿæ•ˆ
- åœ¨å®¹å™¨å†…ç¼–è¯‘ â†’ äºŒè¿›åˆ¶æ–‡ä»¶åœ¨Macä¹Ÿå¯è§

---

## âš™ï¸ é«˜çº§é…ç½®

### é…ç½®VS Codeè¿œç¨‹å¼€å‘

å®‰è£…VS Codeæ’ä»¶: **Remote - Containers**

```json
// .devcontainer/devcontainer.json
{
  "name": "QuantLink CTP Dev",
  "dockerComposeFile": "../docker-compose.dev.yml",
  "service": "ctp-dev",
  "workspaceFolder": "/workspace",
  "extensions": [
    "ms-vscode.cpptools",
    "ms-vscode.cmake-tools",
    "golang.go"
  ]
}
```

### æ€§èƒ½ä¼˜åŒ–

```yaml
# docker-compose.dev.yml æ€§èƒ½ä¼˜åŒ–
services:
  ctp-dev:
    # ... å…¶ä»–é…ç½®
    volumes:
      - .:/workspace:cached  # ä½¿ç”¨cachedæ¨¡å¼æå‡æ€§èƒ½
    shm_size: '2gb'  # å¢åŠ å…±äº«å†…å­˜
    ulimits:
      memlock: -1
      stack: 67108864
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: Dockerå¯åŠ¨å¤±è´¥

**é—®é¢˜**: `Cannot connect to Docker daemon`

**è§£å†³**:
```bash
# ç¡®ä¿Docker Desktopæ­£åœ¨è¿è¡Œ
open -a Docker

# ç­‰å¾…Dockerå¯åŠ¨å®Œæˆï¼ˆèœå•æ å›¾æ ‡ä¸å†æ—‹è½¬ï¼‰
```

### Q2: å®¹å™¨å†…æ— æ³•è®¿é—®ç½‘ç»œ

**é—®é¢˜**: `Could not resolve host`

**è§£å†³**:
```bash
# æ£€æŸ¥Dockerç½‘ç»œ
docker network ls

# é‡å¯Docker Desktop
```

### Q3: æ–‡ä»¶æƒé™é—®é¢˜

**é—®é¢˜**: å®¹å™¨å†…åˆ›å»ºçš„æ–‡ä»¶åœ¨Macä¸Šæ— æƒé™

**è§£å†³**:
```bash
# åœ¨å®¹å™¨å†…ä»¥Macç”¨æˆ·èº«ä»½è¿è¡Œ
docker exec -u $(id -u):$(id -g) -it quantlink-ctp-dev bash
```

### Q4: CTPåº“æ‰¾ä¸åˆ°

**é—®é¢˜**: `error while loading shared libraries: libthostmduserapi_se.so`

**è§£å†³**:
```bash
# åœ¨å®¹å™¨å†…è®¾ç½®åº“è·¯å¾„
export LD_LIBRARY_PATH=/workspace/gateway/third_party/ctp/lib:$LD_LIBRARY_PATH

# æˆ–æ°¸ä¹…æ·»åŠ åˆ° ~/.bashrc
echo 'export LD_LIBRARY_PATH=/workspace/gateway/third_party/ctp/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | ç¼–è¯‘é€Ÿåº¦ | è¿è¡Œæ€§èƒ½ | èµ„æºå ç”¨ | ä¾¿åˆ©æ€§ |
|------|----------|----------|----------|--------|
| Docker | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… |
| è™šæ‹Ÿæœº | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜†â˜† |
| è¿œç¨‹Linux | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®ŒæˆDockerç¯å¢ƒé…ç½®åï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… **ç»§ç»­ä»»åŠ¡#1å¼€å‘**: åœ¨å®¹å™¨å†…ç¼–å†™CTPè¡Œæƒ…ç½‘å…³ä»£ç 
2. âœ… **è¿è¡Œæµ‹è¯•**: æµ‹è¯•CTPè¿æ¥å’Œæ•°æ®æ¥æ”¶
3. âœ… **è°ƒè¯•**: ä½¿ç”¨GDBç­‰å·¥å…·è°ƒè¯•

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ä»»åŠ¡#1å®æ–½æŒ‡å—](/Users/user/PWorks/RD/quantlink-trade-system/docs/ä»»åŠ¡1_CTPè¡Œæƒ…æ¥å…¥å®æ–½æŒ‡å—_2026-01-26-15_40.md)
- [Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [CTP APIæ–‡æ¡£](http://www.sfit.com.cn/)

---

**æœ€åæ›´æ–°**: 2026-01-26 16:00
