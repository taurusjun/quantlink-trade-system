# ç³»ç»Ÿ_å›æµ‹ç³»ç»Ÿå®æ–½æ–¹æ¡ˆ

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-24
**ç‰ˆæœ¬**: v1.0
**é¢„è®¡å·¥ä½œé‡**: 10-15 å¤©
**ä¼˜å…ˆçº§**: P0

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 ç›®æ ‡

ä¸º quantlink-trade-system æ·»åŠ å®Œæ•´çš„å›æµ‹ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- âœ… å†å²æ•°æ®å›æ”¾
- âœ… ç­–ç•¥éªŒè¯
- âœ… ç»©æ•ˆç»Ÿè®¡åˆ†æï¼ˆSharpeã€Sortinoã€Drawdown ç­‰ï¼‰
- âœ… æ‰¹é‡å›æµ‹ï¼ˆå¤šæ—¥æœŸã€å¤šå‚æ•°ï¼‰
- âœ… å›æµ‹æŠ¥å‘Šç”Ÿæˆ

### 1.2 è®¾è®¡åŸåˆ™

1. **çº¯æ–°ç³»ç»Ÿå®ç°** - ä¸ä¾èµ–æ—§ç³»ç»Ÿä»£ç ï¼Œä½¿ç”¨ Golang + C++
2. **æ¶æ„ä¸€è‡´æ€§** - å¤ç”¨ç°æœ‰ç»„ä»¶ï¼ˆNATSã€gRPCã€Protobufï¼‰
3. **æœ€å°ä¾µå…¥** - Golang ç­–ç•¥ä»£ç æ— éœ€ä¿®æ”¹
4. **é«˜æ€§èƒ½** - æ”¯æŒå¿«é€Ÿå›æ”¾ï¼ˆ10x-100x å®æ—¶é€Ÿåº¦ï¼‰

### 1.3 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å›æµ‹ç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  å†å²æ•°æ®æ–‡ä»¶ (CSV/Parquet)                                      â”‚
â”‚       â†“                                                          â”‚
â”‚  [æ–°å¢] HistoricalDataReader (Golang)                           â”‚
â”‚       â†“                                                          â”‚
â”‚  [å¤ç”¨] NATS                                                     â”‚
â”‚       â†“                                                          â”‚
â”‚  [å¤ç”¨] Golang Trader (ç­–ç•¥å¼•æ“) â† æ— éœ€ä¿®æ”¹                      â”‚
â”‚       â†“                                                          â”‚
â”‚  [æ–°å¢] BacktestStatistics (Golang)                             â”‚
â”‚       â†“                                                          â”‚
â”‚  å›æµ‹æŠ¥å‘Š (JSON/Markdown)                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯¹æ¯”å®ç›˜æ¶æ„**:

| ç»„ä»¶ | å®ç›˜æ¨¡å¼ | å›æµ‹æ¨¡å¼ |
|------|----------|----------|
| æ•°æ®æº | md_simulator â†’ md_gateway | HistoricalDataReader |
| æ¶ˆæ¯æ€»çº¿ | NATS | NATS (ç›¸åŒ) |
| ç­–ç•¥å¼•æ“ | Golang Trader | Golang Trader (ç›¸åŒ) |
| è®¢å•è·¯ç”± | ors_gateway â†’ counter_gateway | BacktestOrderRouter |
| ç»Ÿè®¡åˆ†æ | æ—  | BacktestStatistics |

---

## äºŒã€æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 2.1 HistoricalDataReader (å†å²æ•°æ®è¯»å–å™¨)

**ä½ç½®**: `golang/pkg/backtest/datareader.go`

**èŒè´£**:
1. è¯»å–å†å²è¡Œæƒ…æ•°æ®æ–‡ä»¶
2. æŒ‰æ—¶é—´æˆ³é¡ºåºå›æ”¾è¡Œæƒ…
3. å‘å¸ƒåˆ° NATSï¼ˆä¸å®ç›˜æ ¼å¼ä¸€è‡´ï¼‰
4. æ§åˆ¶å›æ”¾é€Ÿåº¦

**æ ¸å¿ƒæ¥å£**:
```go
type HistoricalDataReader struct {
    config      *BacktestConfig
    natsConn    *nats.Conn
    dataFiles   []string
    playSpeed   float64  // å›æ”¾é€Ÿåº¦å€æ•°ï¼ˆ1.0=å®æ—¶ï¼Œ0=æé€Ÿï¼‰
    currentTime time.Time
}

// ä¸»è¦æ–¹æ³•
func NewHistoricalDataReader(config *BacktestConfig) (*HistoricalDataReader, error)
func (r *HistoricalDataReader) LoadData(startDate, endDate string) error
func (r *HistoricalDataReader) Start() error
func (r *HistoricalDataReader) Replay() error
func (r *HistoricalDataReader) Stop() error
```

**æ•°æ®æ–‡ä»¶æ ¼å¼**: CSV (ç®€å•æ˜“ç”¨)

```csv
timestamp_ns,symbol,exchange,last_price,last_volume,bid_price1,bid_volume1,ask_price1,ask_volume1,bid_price2,bid_volume2,ask_price2,ask_volume2
1737705600000000000,ag2502,SHFE,5123.0,10,5122.5,100,5123.5,150,5122.0,200,5124.0,180
1737705600100000000,ag2502,SHFE,5123.5,5,5123.0,120,5124.0,130,5122.5,210,5124.5,160
```

**æ”¯æŒçš„æ•°æ®æº**:
- Phase 1: CSV æ–‡ä»¶
- Phase 2 (å¯é€‰): Parquet (æ›´é«˜å‹ç¼©æ¯”)
- Phase 3 (å¯é€‰): ClickHouse/TimescaleDB (å¤§è§„æ¨¡æ•°æ®)

**å›æ”¾æ¨¡å¼**:
```go
const (
    ReplayModeRealtime  = iota  // å®æ—¶å›æ”¾ï¼ˆ1x é€Ÿåº¦ï¼‰
    ReplayModeFast               // å¿«é€Ÿå›æ”¾ï¼ˆ10x-100x é€Ÿåº¦ï¼‰
    ReplayModeInstant            // æé€Ÿå›æ”¾ï¼ˆæ— å»¶è¿Ÿï¼Œç›´æ¥æ¨é€æ‰€æœ‰æ•°æ®ï¼‰
)
```

---

### 2.2 BacktestOrderRouter (å›æµ‹è®¢å•è·¯ç”±å™¨)

**ä½ç½®**: `golang/pkg/backtest/order_router.go`

**èŒè´£**:
1. æ¥æ”¶ç­–ç•¥çš„è®¢å•è¯·æ±‚ï¼ˆgRPCï¼‰
2. æ¨¡æ‹Ÿè®¢å•æ’®åˆ
3. ç”Ÿæˆæˆäº¤å›æŠ¥
4. è®°å½•è®¢å•å†å²

**æ’®åˆé€»è¾‘**:
```go
type SimpleMatchEngine struct {
    currentMarketData map[string]*mdpb.MarketDataUpdate
    openOrders        map[string]*Order
    fillDelay         time.Duration  // æ¨¡æ‹Ÿæˆäº¤å»¶è¿Ÿï¼ˆé»˜è®¤ 10msï¼‰
}

// æ’®åˆè§„åˆ™ï¼ˆç®€åŒ–ç‰ˆï¼‰
func (e *SimpleMatchEngine) TryMatch(order *Order) *Fill {
    md := e.currentMarketData[order.Symbol]

    switch order.Side {
    case Buy:
        if order.Price >= md.AskPrice1 {
            // ä¹°å•ä»·æ ¼ >= å–ä¸€ä»·ï¼Œç«‹å³æˆäº¤
            return &Fill{
                Price:  md.AskPrice1,
                Volume: min(order.Volume, md.AskVolume1),
                Time:   md.Timestamp + fillDelay,
            }
        }
    case Sell:
        if order.Price <= md.BidPrice1 {
            // å–å•ä»·æ ¼ <= ä¹°ä¸€ä»·ï¼Œç«‹å³æˆäº¤
            return &Fill{
                Price:  md.BidPrice1,
                Volume: min(order.Volume, md.BidVolume1),
                Time:   md.Timestamp + fillDelay,
            }
        }
    }

    // æ— æ³•æˆäº¤ï¼ŒæŒ‚å•
    return nil
}
```

**é«˜çº§åŠŸèƒ½ (å¯é€‰)**:
- è®¢å•ç°¿æ·±åº¦æ¨¡æ‹Ÿ
- Passive è®¢å•æ’é˜Ÿä½ç½®
- éƒ¨åˆ†æˆäº¤
- æ‹’å•æ¨¡æ‹Ÿï¼ˆè¶…è¿‡ä»·æ ¼é™åˆ¶ï¼‰

---

### 2.3 BacktestStatistics (å›æµ‹ç»Ÿè®¡æ¨¡å—)

**ä½ç½®**: `golang/pkg/backtest/statistics.go`

**èŒè´£**:
1. æ”¶é›†å›æµ‹è¿‡ç¨‹ä¸­çš„äº¤æ˜“æ•°æ®
2. è®¡ç®—ç»©æ•ˆæŒ‡æ ‡
3. ç”Ÿæˆå›æµ‹æŠ¥å‘Š

**æ ¸å¿ƒæ•°æ®ç»“æ„**:
```go
type BacktestResult struct {
    // åŸºæœ¬ä¿¡æ¯
    StartTime     time.Time
    EndTime       time.Time
    InitialCash   float64
    FinalCash     float64

    // äº¤æ˜“è®°å½•
    Trades        []*Trade
    DailyPNL      []DailyPNL

    // ç»©æ•ˆæŒ‡æ ‡
    TotalPNL      float64
    TotalReturn   float64
    SharpeRatio   float64
    SortinoRatio  float64
    MaxDrawdown   float64
    MaxDrawdownDuration time.Duration
    WinRate       float64
    ProfitFactor  float64

    // äº¤æ˜“ç»Ÿè®¡
    TotalTrades   int
    WinTrades     int
    LossTrades    int
    AvgWin        float64
    AvgLoss       float64
    AvgTradeSize  float64
}

type DailyPNL struct {
    Date        string
    PNL         float64
    Return      float64
    MaxPNL      float64
    MinPNL      float64
    TradeCount  int
}
```

**è®¡ç®—æŒ‡æ ‡**:

1. **Sharpe Ratio (å¤æ™®æ¯”ç‡)**:
```go
func (r *BacktestResult) CalculateSharpe(riskFreeRate float64) float64 {
    if len(r.DailyPNL) == 0 {
        return 0
    }

    returns := make([]float64, len(r.DailyPNL))
    for i, daily := range r.DailyPNL {
        returns[i] = daily.Return
    }

    meanReturn := stat.Mean(returns, nil)
    stdDev := stat.StdDev(returns, nil)

    if stdDev == 0 {
        return 0
    }

    // å¹´åŒ–
    sharpe := (meanReturn - riskFreeRate) / stdDev * math.Sqrt(252)
    return sharpe
}
```

2. **Sortino Ratio (ç´¢æè¯ºæ¯”ç‡)**:
```go
func (r *BacktestResult) CalculateSortino(targetReturn float64) float64 {
    downsideReturns := []float64{}
    allReturns := []float64{}

    for _, daily := range r.DailyPNL {
        allReturns = append(allReturns, daily.Return)
        if daily.Return < targetReturn {
            downsideReturns = append(downsideReturns, daily.Return-targetReturn)
        }
    }

    meanReturn := stat.Mean(allReturns, nil)
    downsideStdDev := stat.StdDev(downsideReturns, nil)

    if downsideStdDev == 0 {
        return 0
    }

    sortino := (meanReturn - targetReturn) / downsideStdDev * math.Sqrt(252)
    return sortino
}
```

3. **Max Drawdown (æœ€å¤§å›æ’¤)**:
```go
func (r *BacktestResult) CalculateMaxDrawdown() (float64, time.Duration) {
    if len(r.DailyPNL) == 0 {
        return 0, 0
    }

    var maxDrawdown float64
    var maxDrawdownDuration time.Duration
    var peak float64
    var peakTime time.Time

    cumPNL := 0.0
    for _, daily := range r.DailyPNL {
        cumPNL += daily.PNL

        if cumPNL > peak {
            peak = cumPNL
            peakTime, _ = time.Parse("2006-01-02", daily.Date)
        }

        drawdown := (peak - cumPNL) / peak
        if drawdown > maxDrawdown {
            maxDrawdown = drawdown
            currentTime, _ := time.Parse("2006-01-02", daily.Date)
            maxDrawdownDuration = currentTime.Sub(peakTime)
        }
    }

    return maxDrawdown, maxDrawdownDuration
}
```

4. **Win Rate (èƒœç‡)**:
```go
func (r *BacktestResult) CalculateWinRate() float64 {
    if r.TotalTrades == 0 {
        return 0
    }
    return float64(r.WinTrades) / float64(r.TotalTrades)
}
```

5. **Profit Factor (ç›ˆåˆ©å› å­)**:
```go
func (r *BacktestResult) CalculateProfitFactor() float64 {
    var totalWin, totalLoss float64

    for _, trade := range r.Trades {
        if trade.PNL > 0 {
            totalWin += trade.PNL
        } else {
            totalLoss += -trade.PNL
        }
    }

    if totalLoss == 0 {
        return 0
    }

    return totalWin / totalLoss
}
```

---

### 2.4 BacktestRunner (å›æµ‹æ‰§è¡Œå™¨)

**ä½ç½®**: `golang/pkg/backtest/runner.go`

**èŒè´£**:
1. åè°ƒå„ç»„ä»¶
2. æ‰§è¡Œå•æ¬¡å›æµ‹
3. æ‰¹é‡å›æµ‹ï¼ˆå¤šæ—¥æœŸï¼‰
4. å‚æ•°ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

**æ ¸å¿ƒæµç¨‹**:
```go
type BacktestRunner struct {
    config        *BacktestConfig
    dataReader    *HistoricalDataReader
    orderRouter   *BacktestOrderRouter
    statistics    *BacktestStatistics
    trader        *trader.Trader
    natsConn      *nats.Conn
}

func (r *BacktestRunner) Run() (*BacktestResult, error) {
    // 1. åˆå§‹åŒ–ç»„ä»¶
    log.Println("[Backtest] Initializing components...")
    if err := r.initialize(); err != nil {
        return nil, err
    }

    // 2. åŠ è½½å†å²æ•°æ®
    log.Println("[Backtest] Loading historical data...")
    if err := r.dataReader.LoadData(r.config.StartDate, r.config.EndDate); err != nil {
        return nil, err
    }

    // 3. å¯åŠ¨ç­–ç•¥å¼•æ“
    log.Println("[Backtest] Starting strategy engine...")
    if err := r.trader.Start(); err != nil {
        return nil, err
    }

    // 4. å¼€å§‹æ•°æ®å›æ”¾
    log.Println("[Backtest] Starting data replay...")
    if err := r.dataReader.Replay(); err != nil {
        return nil, err
    }

    // 5. ç­‰å¾…å›æµ‹å®Œæˆ
    log.Println("[Backtest] Waiting for completion...")
    r.waitForCompletion()

    // 6. åœæ­¢ç­–ç•¥å¼•æ“
    log.Println("[Backtest] Stopping strategy engine...")
    r.trader.Stop()

    // 7. ç”Ÿæˆç»Ÿè®¡ç»“æœ
    log.Println("[Backtest] Generating statistics...")
    result := r.statistics.GenerateReport()

    // 8. æ¸…ç†èµ„æº
    r.cleanup()

    log.Println("[Backtest] Backtest completed!")
    return result, nil
}
```

**æ‰¹é‡å›æµ‹**:
```go
func (r *BacktestRunner) RunBatch(dates []string) ([]*BacktestResult, error) {
    results := make([]*BacktestResult, 0, len(dates))

    for _, date := range dates {
        log.Printf("[Backtest] Running backtest for %s", date)

        r.config.StartDate = date
        r.config.EndDate = date

        result, err := r.Run()
        if err != nil {
            log.Printf("[Backtest] Failed for %s: %v", date, err)
            continue
        }

        results = append(results, result)
    }

    // æ±‡æ€»ç»Ÿè®¡
    summary := r.aggregateResults(results)
    return results, nil
}
```

---

### 2.5 ReportGenerator (æŠ¥å‘Šç”Ÿæˆå™¨)

**ä½ç½®**: `golang/pkg/backtest/report.go`

**èŒè´£**:
1. ç”Ÿæˆ Markdown æŠ¥å‘Š
2. ç”Ÿæˆ JSON ç»“æœï¼ˆä¾›å…¶ä»–å·¥å…·ä½¿ç”¨ï¼‰
3. å¯é€‰ï¼šç”Ÿæˆå›¾è¡¨ï¼ˆequity curve, drawdown chartï¼‰

**æŠ¥å‘Šæ ¼å¼**:
```markdown
# å›æµ‹æŠ¥å‘Š

**ç­–ç•¥**: PairwiseArbitrage
**æ—¥æœŸ**: 2026-01-01 è‡³ 2026-01-31
**åˆå§‹èµ„é‡‘**: 1,000,000
**æœ€ç»ˆèµ„é‡‘**: 1,058,320

---

## ç»©æ•ˆæ‘˜è¦

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æ€»æ”¶ç›Š** | 58,320 |
| **æ€»æ”¶ç›Šç‡** | 5.83% |
| **å¹´åŒ–æ”¶ç›Šç‡** | 94.5% |
| **Sharpe Ratio** | 2.34 |
| **Sortino Ratio** | 3.12 |
| **æœ€å¤§å›æ’¤** | -2.3% |
| **æœ€å¤§å›æ’¤æŒç»­æœŸ** | 3 å¤© |
| **èƒœç‡** | 67.8% |
| **ç›ˆåˆ©å› å­** | 2.15 |

---

## äº¤æ˜“ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æ€»äº¤æ˜“æ¬¡æ•°** | 158 |
| **ç›ˆåˆ©äº¤æ˜“** | 107 |
| **äºæŸäº¤æ˜“** | 51 |
| **å¹³å‡ç›ˆåˆ©** | 1,234 |
| **å¹³å‡äºæŸ** | -567 |
| **æœ€å¤§å•ç¬”ç›ˆåˆ©** | 5,678 |
| **æœ€å¤§å•ç¬”äºæŸ** | -2,345 |

---

## æ¯æ—¥PNL

| æ—¥æœŸ | PNL | ç´¯è®¡PNL | æ”¶ç›Šç‡ | äº¤æ˜“æ¬¡æ•° |
|------|-----|---------|--------|---------|
| 2026-01-01 | 2,345 | 2,345 | 0.23% | 8 |
| 2026-01-02 | 1,890 | 4,235 | 0.19% | 7 |
| ... | ... | ... | ... | ... |

---

## é£é™©åˆ†æ

- **æœ€å¤§å›æ’¤å‡ºç°æ—¶é—´**: 2026-01-15
- **å›æ’¤æ¢å¤æ—¶é—´**: 3 å¤©
- **å¤æ™®æ¯”ç‡**: 2.34ï¼ˆä¼˜ç§€ï¼‰
- **ç´¢æè¯ºæ¯”ç‡**: 3.12ï¼ˆä¼˜ç§€ï¼‰
- **æ—¥å‡æ³¢åŠ¨ç‡**: 1.2%

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-24 18:30:00
```

---

## ä¸‰ã€é…ç½®æ–‡ä»¶è®¾è®¡

### 3.1 å›æµ‹é…ç½®

**æ–‡ä»¶**: `config/backtest.yaml`

```yaml
backtest:
  # åŸºæœ¬é…ç½®
  name: "pairwise_arb_backtest"
  mode: "backtest"  # æ ‡è¯†å›æµ‹æ¨¡å¼

  # æ—¶é—´èŒƒå›´
  start_date: "2026-01-01"
  end_date: "2026-01-31"
  start_time: "09:00:00"
  end_time: "15:00:00"

  # æ•°æ®æº
  data:
    source_type: "csv"  # csv, parquet, database
    data_path: "./data/market_data"
    symbols:
      - "ag2502"
      - "ag2504"

  # å›æ”¾è®¾ç½®
  replay:
    mode: "fast"  # realtime, fast, instant
    speed: 10.0   # å›æ”¾é€Ÿåº¦å€æ•°ï¼ˆä»… fast æ¨¡å¼æœ‰æ•ˆï¼‰

  # åˆå§‹èµ„é‡‘
  initial_capital: 1000000.0

  # è®¢å•æ¨¡æ‹Ÿ
  order_simulation:
    fill_delay_ms: 10        # æˆäº¤å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    slippage_bps: 1          # æ»‘ç‚¹ï¼ˆåŸºç‚¹ï¼‰
    commission_rate: 0.0003  # æ‰‹ç»­è´¹ç‡

  # è¾“å‡ºè®¾ç½®
  output:
    result_dir: "./backtest_results"
    save_trades: true
    save_daily_pnl: true
    generate_report: true
    report_format: "markdown"  # markdown, json, html

# å¤ç”¨ç­–ç•¥é…ç½®ï¼ˆä» trader.yamlï¼‰
strategy:
  type: "pairwise_arb"
  symbols:
    - "ag2502"
    - "ag2504"
  parameters:
    entry_zscore: 2.0
    exit_zscore: 0.5
    lookback_window: 20
    max_position_size: 10

# NATS é…ç½®ï¼ˆå›æµ‹ä¹Ÿéœ€è¦ï¼‰
engine:
  nats_addr: "nats://localhost:4222"
```

---

## å››ã€å®æ–½è®¡åˆ’

### 4.1 å¼€å‘é˜¶æ®µ

#### Week 1: åŸºç¡€ç»„ä»¶ (3-4 å¤©)

**Day 1-2: HistoricalDataReader**
- [ ] CSV æ•°æ®è¯»å–
- [ ] Protobuf è½¬æ¢
- [ ] NATS å‘å¸ƒ
- [ ] å•å…ƒæµ‹è¯•

**Day 3-4: BacktestOrderRouter**
- [ ] è®¢å•æ¥æ”¶ï¼ˆgRPC Serverï¼‰
- [ ] ç®€å•æ’®åˆå¼•æ“
- [ ] æˆäº¤å›æŠ¥ç”Ÿæˆ
- [ ] å•å…ƒæµ‹è¯•

#### Week 2: ç»Ÿè®¡ä¸é›†æˆ (3-4 å¤©)

**Day 5-6: BacktestStatistics**
- [ ] äº¤æ˜“è®°å½•æ”¶é›†
- [ ] ç»©æ•ˆæŒ‡æ ‡è®¡ç®—
- [ ] æŠ¥å‘Šç”Ÿæˆ
- [ ] å•å…ƒæµ‹è¯•

**Day 7-8: BacktestRunner**
- [ ] ç»„ä»¶é›†æˆ
- [ ] é…ç½®æ–‡ä»¶è§£æ
- [ ] å›æµ‹ä¸»æµç¨‹
- [ ] é›†æˆæµ‹è¯•

#### Week 3: è„šæœ¬ä¸ä¼˜åŒ– (2-3 å¤©)

**Day 9-10: æ‰¹é‡å›æµ‹è„šæœ¬**
- [ ] Python/Bash è„šæœ¬
- [ ] å¤šæ—¥æœŸæ‰¹é‡è¿è¡Œ
- [ ] ç»“æœæ±‡æ€»

**Day 11: æ€§èƒ½ä¼˜åŒ–**
- [ ] æ•°æ®åŠ è½½ä¼˜åŒ–
- [ ] å†…å­˜ä¼˜åŒ–
- [ ] å¹¶å‘å¤„ç†

#### Week 4: æµ‹è¯•ä¸æ–‡æ¡£ (2-3 å¤©)

**Day 12-13: å®Œæ•´æµ‹è¯•**
- [ ] ç«¯åˆ°ç«¯å›æµ‹æµ‹è¯•
- [ ] ä¸é¢„æœŸç»“æœå¯¹æ¯”
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•

**Day 14: æ–‡æ¡£ç¼–å†™**
- [ ] ä½¿ç”¨æ–‡æ¡£
- [ ] API æ–‡æ¡£
- [ ] ç¤ºä¾‹ä»£ç 

---

### 4.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ç‚¹ | éªŒæ”¶æ ‡å‡† |
|--------|--------|---------|
| **M1: æ•°æ®å›æ”¾** | Day 2 | CSV æ•°æ®å¯é€šè¿‡ NATS å›æ”¾ |
| **M2: è®¢å•æ¨¡æ‹Ÿ** | Day 4 | è®¢å•å¯è¢«æ’®åˆå¹¶ç”Ÿæˆæˆäº¤ |
| **M3: ç»Ÿè®¡åˆ†æ** | Day 6 | å¯è®¡ç®— Sharpe/Sortino/Drawdown |
| **M4: ç«¯åˆ°ç«¯** | Day 8 | å®Œæ•´å›æµ‹æµç¨‹å¯è¿è¡Œ |
| **M5: æ‰¹é‡å›æµ‹** | Day 10 | å¯æ‰¹é‡è¿è¡Œå¤šæ—¥æœŸå›æµ‹ |
| **M6: ç”Ÿäº§å°±ç»ª** | Day 14 | æ–‡æ¡£å®Œå–„ï¼Œé€šè¿‡æ‰€æœ‰æµ‹è¯• |

---

## äº”ã€ç›®å½•ç»“æ„

```
quantlink-trade-system/
â”œâ”€â”€ golang/
â”‚   â”œâ”€â”€ pkg/
â”‚   â”‚   â”œâ”€â”€ backtest/              # æ–°å¢ï¼šå›æµ‹æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ config.go          # é…ç½®ç»“æ„
â”‚   â”‚   â”‚   â”œâ”€â”€ datareader.go      # å†å²æ•°æ®è¯»å–å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ order_router.go    # è®¢å•è·¯ç”±å’Œæ’®åˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ statistics.go      # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ report.go          # æŠ¥å‘Šç”Ÿæˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ runner.go          # å›æµ‹æ‰§è¡Œå™¨
â”‚   â”‚   â”‚   â””â”€â”€ types.go           # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ trader/
â”‚   â”‚       â””â”€â”€ trader.go          # éœ€è¦å°æ”¹ï¼šæ”¯æŒå›æµ‹æ¨¡å¼
â”‚   â””â”€â”€ cmd/
â”‚       â””â”€â”€ backtest/              # æ–°å¢ï¼šå›æµ‹å‘½ä»¤è¡Œå·¥å…·
â”‚           â””â”€â”€ main.go
â”œâ”€â”€ config/
â”‚   â””â”€â”€ backtest.yaml              # æ–°å¢ï¼šå›æµ‹é…ç½®
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ backtest/                  # æ–°å¢ï¼šå›æµ‹è„šæœ¬
â”‚       â”œâ”€â”€ run_backtest.sh
â”‚       â”œâ”€â”€ run_batch_backtest.py
â”‚       â””â”€â”€ compare_results.py
â”œâ”€â”€ data/                          # æ–°å¢ï¼šå†å²æ•°æ®ç›®å½•
â”‚   â””â”€â”€ market_data/
â”‚       â”œâ”€â”€ 20260101/
â”‚       â”‚   â”œâ”€â”€ ag2502.csv
â”‚       â”‚   â””â”€â”€ ag2504.csv
â”‚       â””â”€â”€ 20260102/
â”‚           â””â”€â”€ ...
â””â”€â”€ backtest_results/              # æ–°å¢ï¼šå›æµ‹ç»“æœç›®å½•
    â””â”€â”€ 20260124_183000/
        â”œâ”€â”€ result.json
        â”œâ”€â”€ report.md
        â””â”€â”€ trades.csv
```

---

## å…­ã€ä¿®æ”¹ç°æœ‰ä»£ç 

### 6.1 Trader æ”¯æŒå›æµ‹æ¨¡å¼

**æ–‡ä»¶**: `golang/pkg/trader/trader.go`

éœ€è¦å°å¹…ä¿®æ”¹ä»¥æ”¯æŒå›æµ‹æ¨¡å¼ï¼š

```go
type Trader struct {
    config        *config.TraderConfig
    mode          string  // æ–°å¢: "live" æˆ– "backtest"
    // ...
}

func (t *Trader) Start() error {
    // æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„åˆå§‹åŒ–é€»è¾‘
    if t.mode == "backtest" {
        // å›æµ‹æ¨¡å¼ï¼šä¸å¯åŠ¨ HTTP API
        // å›æµ‹æ¨¡å¼ï¼šè®¢å•è·¯ç”±åˆ° BacktestOrderRouter
        return t.startBacktestMode()
    } else {
        // å®ç›˜æ¨¡å¼ï¼šåŸæœ‰é€»è¾‘
        return t.startLiveMode()
    }
}
```

**æ”¹åŠ¨é‡**: çº¦ 50-100 è¡Œï¼Œé£é™©ä½

---

## ä¸ƒã€æ•°æ®å‡†å¤‡

### 7.1 å†å²æ•°æ®æ ¼å¼

**CSV æ ¼å¼** (ç®€å•ï¼Œæ¨èç”¨äº MVP):

```csv
timestamp_ns,symbol,exchange,last_price,last_volume,bid_price1,bid_volume1,ask_price1,ask_volume1
1737705600000000000,ag2502,SHFE,5123.0,10,5122.5,100,5123.5,150
1737705600100000000,ag2502,SHFE,5123.5,5,5123.0,120,5124.0,130
```

### 7.2 æ•°æ®é‡‡é›†

**æ–¹æ³• 1: ä»æ—§ç³»ç»Ÿè½¬æ¢**
```bash
# å¦‚æœæ—§ç³»ç»Ÿæœ‰å†å²æ•°æ® dump æ–‡ä»¶
python scripts/convert_old_data_to_csv.py \
    --input /data/old_dumps/20260101/ \
    --output ./data/market_data/20260101/
```

**æ–¹æ³• 2: ä»å®ç›˜å½•åˆ¶**
```bash
# è¿è¡Œ md_gateway æ—¶å¼€å¯æ•°æ®å½•åˆ¶
./bin/md_gateway --record --output ./data/market_data/$(date +%Y%m%d)/
```

**æ–¹æ³• 3: æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆï¼ˆç”¨äºæµ‹è¯•ï¼‰**
```bash
# ç”Ÿæˆæ¨¡æ‹Ÿå†å²æ•°æ®
go run scripts/generate_mock_data.go \
    --start-date 2026-01-01 \
    --end-date 2026-01-31 \
    --symbols ag2502,ag2504 \
    --output ./data/market_data/
```

---

## å…«ã€ä½¿ç”¨ç¤ºä¾‹

### 8.1 å•æ¬¡å›æµ‹

```bash
# ç¼–è¯‘å›æµ‹å·¥å…·
cd golang
go build -o ../bin/backtest cmd/backtest/main.go

# è¿è¡Œå›æµ‹
../bin/backtest \
    -config ../config/backtest.yaml \
    -start-date 2026-01-15 \
    -end-date 2026-01-15

# æŸ¥çœ‹ç»“æœ
cat ../backtest_results/latest/report.md
```

### 8.2 æ‰¹é‡å›æµ‹

```bash
# æ–¹å¼ 1: ä½¿ç”¨è„šæœ¬
./scripts/backtest/run_batch_backtest.py \
    -config config/backtest.yaml \
    -dates dates.txt \
    -output backtest_results/batch_20260124/

# æ–¹å¼ 2: ç›´æ¥å‘½ä»¤è¡Œ
for date in $(cat dates.txt); do
    ./bin/backtest \
        -config config/backtest.yaml \
        -start-date $date \
        -end-date $date \
        -output backtest_results/$date/
done
```

### 8.3 å‚æ•°ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰

```bash
# ç½‘æ ¼æœç´¢æœ€ä¼˜å‚æ•°
./scripts/backtest/optimize_parameters.py \
    -config config/backtest.yaml \
    -param entry_zscore:1.0,1.5,2.0,2.5,3.0 \
    -param exit_zscore:0.2,0.3,0.5,0.7 \
    -dates dates.txt \
    -output backtest_results/optimization/
```

---

## ä¹ã€éªŒè¯æ–¹æ¡ˆ

### 9.1 å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯•å„æ¨¡å—
cd golang
go test ./pkg/backtest/...

# æµ‹è¯•è¦†ç›–ç‡
go test -cover ./pkg/backtest/...
```

### 9.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯ 1: ç®€å•å›æµ‹**
```go
func TestSimpleBacktest(t *testing.T) {
    // 1. å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆ1å¤©ï¼Œ100æ¡tickï¼‰
    testData := generateMockData(100)

    // 2. è¿è¡Œå›æµ‹
    runner := backtest.NewRunner(testConfig)
    result, err := runner.Run()

    // 3. éªŒè¯ç»“æœ
    assert.NoError(t, err)
    assert.True(t, result.TotalTrades > 0)
    assert.True(t, result.SharpeRatio > 0)
}
```

**æµ‹è¯•åœºæ™¯ 2: æç«¯æƒ…å†µ**
- ç©ºæ•°æ®
- å•æ¡æ•°æ®
- å¤§é‡æ•°æ®ï¼ˆ100ä¸‡æ¡ï¼‰
- ç­–ç•¥æ— ä¿¡å·
- å…¨éƒ¨æˆäº¤
- å…¨éƒ¨æ‹’å•

### 9.3 æ€§èƒ½åŸºå‡†

```bash
# å›æ”¾é€Ÿåº¦æµ‹è¯•
go test -bench=BenchmarkDataReplay ./pkg/backtest/

# é¢„æœŸç›®æ ‡:
# - 10ä¸‡æ¡tickæ•°æ®: < 10 ç§’
# - 100ä¸‡æ¡tickæ•°æ®: < 2 åˆ†é’Ÿ
# - å†…å­˜å ç”¨: < 500MB
```

---

## åã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **æ•°æ®æ ¼å¼ä¸ç»Ÿä¸€** | æ— æ³•è¯»å– | ä¸­ | å®šä¹‰ä¸¥æ ¼çš„ CSV schema |
| **å†…å­˜ä¸è¶³** | å´©æºƒ | ä½ | æµå¼è¯»å–ï¼Œåˆ†æ‰¹å¤„ç† |
| **æ’®åˆé€»è¾‘ä¸å‡†ç¡®** | ç»“æœå¤±çœŸ | ä¸­ | ä»ç®€å•å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ– |
| **å›æ”¾é€Ÿåº¦æ…¢** | æ•ˆç‡ä½ | ä½ | ä½¿ç”¨ goroutine å¹¶å‘ |
| **ç­–ç•¥è¡Œä¸ºå·®å¼‚** | ç»“æœä¸å¯ä¿¡ | ä½ | ç¡®ä¿ç­–ç•¥ä»£ç æ— çŠ¶æ€ |

---

## åä¸€ã€åç»­å¢å¼ºï¼ˆå¯é€‰ï¼‰

### Phase 3 åŠŸèƒ½

1. **é«˜çº§æ’®åˆå¼•æ“**
   - è®¢å•ç°¿æ·±åº¦æ¨¡æ‹Ÿ
   - Passive è®¢å•æ’é˜Ÿ
   - éƒ¨åˆ†æˆäº¤

2. **å¤šç­–ç•¥å¹¶è¡Œå›æµ‹**
   - åŒæ—¶è¿è¡Œå¤šä¸ªç­–ç•¥
   - ç­–ç•¥å¯¹æ¯”åˆ†æ

3. **å‚æ•°ä¼˜åŒ–æ¡†æ¶**
   - Grid Search
   - Genetic Algorithm
   - Bayesian Optimization

4. **å›¾è¡¨å¯è§†åŒ–**
   - Equity Curve
   - Drawdown Chart
   - PNL Distribution

5. **åˆ†å¸ƒå¼å›æµ‹**
   - å¤šæœºå™¨å¹¶è¡Œ
   - å¤§è§„æ¨¡å‚æ•°æ‰«æ

---

## åäºŒã€æ€»ç»“

### ä¼˜å…ˆçº§

**P0 (å¿…é¡»å®ç°)**:
- âœ… HistoricalDataReader
- âœ… BacktestOrderRouter
- âœ… BacktestStatistics
- âœ… BacktestRunner
- âœ… å•æ¬¡å›æµ‹

**P1 (å»ºè®®å®ç°)**:
- âš ï¸ æ‰¹é‡å›æµ‹è„šæœ¬
- âš ï¸ æŠ¥å‘Šç”Ÿæˆå™¨
- âš ï¸ æ•°æ®æ ¼å¼è½¬æ¢å·¥å…·

**P2 (æœªæ¥å¢å¼º)**:
- ğŸ”µ é«˜çº§æ’®åˆå¼•æ“
- ğŸ”µ å‚æ•°ä¼˜åŒ–
- ğŸ”µ å¯è§†åŒ–

### å·¥ä½œé‡

- **å¼€å‘**: 10-12 å¤©
- **æµ‹è¯•**: 2-3 å¤©
- **æ–‡æ¡£**: 1 å¤©
- **æ€»è®¡**: **13-16 å¤©** (çº¦ 3 å‘¨)

### ä¸‹ä¸€æ­¥

1. âœ… **ç¡®è®¤æ–¹æ¡ˆ** - å·²å®Œæˆ
2. ğŸ”² **æ•°æ®å‡†å¤‡** - å‡†å¤‡è‡³å°‘ 1 ä¸ªæœˆçš„å†å²æ•°æ®ï¼ˆCSV æ ¼å¼ï¼‰
3. ğŸ”² **å¼€å‘ DataReader** - ä»æœ€æ ¸å¿ƒç»„ä»¶å¼€å§‹
4. ğŸ”² **å¼€å‘ OrderRouter** - ç®€å•æ’®åˆå³å¯
5. ğŸ”² **å¼€å‘ Statistics** - æ ¸å¿ƒæŒ‡æ ‡è®¡ç®—
6. ğŸ”² **é›†æˆæµ‹è¯•** - ç«¯åˆ°ç«¯éªŒè¯
7. ğŸ”² **æ–‡æ¡£ä¸äº¤ä»˜** - ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2026-01-24 18:30
**å®¡æ ¸çŠ¶æ€**: å¾…ç¡®è®¤
**é¢„è®¡å¼€å§‹æ—¶é—´**: 2026-01-25

---

*æœ¬æ–¹æ¡ˆåŸºäº quantlink-trade-system å½“å‰æ¶æ„è®¾è®¡ï¼Œéµå¾ªæœ€å°ä¾µå…¥åŸåˆ™ï¼Œç¡®ä¿å¿«é€Ÿäº¤ä»˜ã€‚*
