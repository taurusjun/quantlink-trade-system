# 核心变量生命周期对比报告

**文档日期**: 2026-02-12  
**版本**: v1.0  
**参考文档**: `CODE_CONSISTENCY_CHECKLIST.md`

---

## 概述

本文档对 PairwiseArbStrategy 的三个核心功能进行完整的变量生命周期追踪对比：

1. **价差均值计算** (avgSpreadRatio_ori) - 影响所有信号生成
2. **持仓变量** (NetPosPass/NetPosAgg) - 影响动态阈值和风控
3. **追单逻辑** (SendAggressiveOrder) - 对冲机制的核心

---

## 1. 价差均值变量 (avgSpreadRatio_ori)

### 1.1 变量定义

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **变量名** | `avgSpreadRatio_ori`, `avgSpreadRatio` | `avgSpreadRatio_ori`, `spreadMean` | ✅ |
| **定义位置** | `PairwiseArbStrategy.h` | `pairwise_arb_strategy.go:127` | ✅ |
| **类型** | `double` | `float64` | ✅ |

### 1.2 初始化

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **来源** | `daily_init` 文件的 `avgPx` 字段 | `daily_init` 文件的 `avgPx` 字段 | ✅ 一致 |
| **默认值** | 0 | 0 | ✅ 一致 |
| **代码位置** | `PairwiseArbStrategy.cpp:31-32` | `pairwise_arb_strategy.go:565-566` | ✅ |

**C++ 初始化代码**:
```cpp
// PairwiseArbStrategy.cpp:31-32
avgSpreadRatio_ori = std::stod(row["avgPx"]);
avgSpreadRatio = avgSpreadRatio_ori;
```

**Go 初始化代码**:
```go
// pairwise_arb_strategy.go:565-566
pas.avgSpreadRatio_ori = row.AvgPx
pas.spreadAnalyzer.SetSpreadMean(pas.avgSpreadRatio_ori)
```

### 1.3 更新逻辑

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **更新公式** | EMA: `(1-ALPHA) * ori + ALPHA * curr` | EMA: `(1-alpha) * ori + alpha * curr` | ✅ **已修复** |
| **触发条件** | 收到 Leg1 行情且价差变化时 | 收到 Leg1 行情时 | ✅ 一致 |
| **代码位置** | `PairwiseArbStrategy.cpp:521-523` | `pairwise_arb_strategy.go:686-693` | ✅ |

**C++ EMA 更新代码**:
```cpp
// PairwiseArbStrategy.cpp:521-523
if (currSpreadRatio != currSpreadRatio_prev) {
    avgSpreadRatio_ori = (1 - m_firstStrat->m_thold->ALPHA) * avgSpreadRatio_ori 
                       + m_firstStrat->m_thold->ALPHA * currSpreadRatio;
}
```

**Go EMA 更新代码**:
```go
// pairwise_arb_strategy.go:686-693
// === EMA 更新 avgSpreadRatio_ori（C++: PairwiseArbStrategy.cpp:519-522）===
if pas.tholdFirst.Alpha > 0 {
    alpha := pas.tholdFirst.Alpha
    pas.avgSpreadRatio_ori = (1-alpha)*pas.avgSpreadRatio_ori + alpha*currentSpread
}
```

### 1.4 使用位置

| 用途 | C++ | Go | 状态 |
|------|-----|-----|------|
| **信号判断** | `ShortSpread > avgSpreadRatio + tholdAskPlace` | `zscore >= entryZScoreAsk` | ✅ 语义一致 |
| **撤单判断** | `LongSpread > avgSpreadRatio - tholdBidRemove` | `longSpread > avgSpreadRatio - exitZScoreBid` | ✅ 一致 |
| **价差偏离保护** | `abs(curr - avg) > tickSize * AVG_SPREAD_AWAY` | `abs(curr - avg) > tickSize * AvgSpreadAway` | ✅ 一致 |

### 1.5 保存

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **保存位置** | `daily_init` 的 `avgPx` 字段 | `daily_init` 的 `avgPx` 字段 | ✅ |
| **保存值** | `avgSpreadRatio` (= avgSpreadRatio_ori) | `avgSpreadRatio_ori` | ✅ **已修复** |
| **代码位置** | `PairwiseArbStrategy.cpp:666` | `pairwise_arb_strategy.go:2493` | ✅ |

**C++ 保存代码**:
```cpp
// PairwiseArbStrategy.cpp:666
row["avgPx"] = std::to_string(avgSpreadRatio);
```

**Go 保存代码**:
```go
// pairwise_arb_strategy.go:2493
pas.avgSpreadRatio_ori,  // C++: avgSpreadRatio (保存 EMA 均值)
```

### 1.6 配置参数

| 参数 | C++ | Go | 配置字段 | 状态 |
|------|-----|-----|---------|------|
| **ALPHA** | `m_thold->ALPHA` | `tholdFirst.Alpha` | `alpha` | ✅ 已添加 |
| **默认值** | 通常 0.01-0.1 | 0.1 | - | ✅ |

---

## 2. 持仓变量 (NetPosPass / NetPosAgg)

### 2.1 Leg1 被动持仓 (m_netpos_pass / NetPosPass)

#### 定义与初始化

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **变量名** | `m_firstStrat->m_netpos_pass` | `firstStrat.NetPosPass` | ✅ |
| **定义位置** | `ExecutionStrategy.h:112` | `execution_strategy.go:93` | ✅ |
| **初始化公式** | `netpos_ytd1 + netpos_2day1` | `netpos_ytd1 + netpos_2day1` | ✅ 一致 |
| **初始化代码** | `PairwiseArbETFStrategy.cpp:23` | `pairwise_arb_strategy.go:579` | ✅ |

**C++ 初始化代码**:
```cpp
// PairwiseArbETFStrategy.cpp:21-23
m_firstStrat->m_netpos_pass_ytd = netpos_ytd1;
m_firstStrat->m_netpos_pass = netpos_ytd1 + netpos_2day1;
```

**Go 初始化代码**:
```go
// pairwise_arb_strategy.go:577-579
pas.firstStrat.NetPosPassYtd = netpos_ytd1
pas.firstStrat.NetPosPass = netpos_ytd1 + netpos_2day1
```

#### 更新逻辑

| 触发条件 | C++ | Go | 状态 |
|---------|-----|-----|------|
| **被动买单成交** | `m_netpos_pass += Quantity` | `NetPosPass += Quantity` | ✅ |
| **被动卖单成交** | `m_netpos_pass -= Quantity` | `NetPosPass -= Quantity` | ✅ |
| **代码位置** | `ExecutionStrategy.cpp:2052` | `execution_strategy.go:509-511` | ✅ |

#### 使用位置

| 用途 | C++ 代码位置 | Go 代码位置 | 状态 |
|------|-------------|-------------|------|
| **动态阈值计算** | `SetThresholds()` | `setDynamicThresholds()` | ✅ |
| **敞口计算 (dr)** | `m_netpos_pass / HEDGE_SIZE_RATIO + netpos_agg` | `NetPosPass / hedgeRatio + NetPosAgg` | ✅ |
| **仓位限制检查** | `m_netpos_pass < m_tholdMaxPos` | `NetPosPass < maxPositionSize` | ✅ |

#### 保存

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **保存字段 (ytd)** | `m_netpos_pass_ytd` | `firstStrat.NetPosPassYtd` | ✅ |
| **保存字段 (2day)** | `m_netpos_pass - m_netpos_pass_ytd` | `NetPosPass - NetPosPassYtd` | ✅ |
| **代码位置** | `PairwiseArbETFStrategy.cpp:439-440` | `pairwise_arb_strategy.go:2547-2548` | ✅ |

---

### 2.2 Leg2 主动持仓 (m_netpos_agg / NetPosAgg)

#### 定义与初始化

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **变量名** | `m_secondStrat->m_netpos_agg` | `secondStrat.NetPosAgg` | ✅ |
| **定义位置** | `ExecutionStrategy.h:113` | `execution_strategy.go:95` | ✅ |
| **初始化来源** | `daily_init` 的 `ytd2` 字段 | `daily_init` 的 `ytd2` 字段 | ✅ 一致 |
| **初始化代码** | `PairwiseArbETFStrategy.cpp:25` | `pairwise_arb_strategy.go:589` | ✅ |

**C++ 初始化代码**:
```cpp
// PairwiseArbETFStrategy.cpp:25
m_secondStrat->m_netpos_agg = netpos_agg2;
```

**Go 初始化代码**:
```go
// pairwise_arb_strategy.go:589
pas.secondStrat.NetPosAgg = netpos_agg2
```

#### 更新逻辑

| 触发条件 | C++ | Go | 状态 |
|---------|-----|-----|------|
| **主动买单成交** | `m_netpos_agg += Quantity` | `NetPosAgg += Quantity` | ✅ |
| **主动卖单成交** | `m_netpos_agg -= Quantity` | `NetPosAgg -= Quantity` | ✅ |
| **代码位置** | `ExecutionStrategy.cpp:2052` | `execution_strategy.go:503-505` | ✅ |

#### 使用位置

| 用途 | C++ | Go | 状态 |
|------|-----|-----|------|
| **敞口计算** | `netpos_pass / RATIO + m_netpos_agg` | 同左 | ✅ |
| **追单触发** | `dr > HEDGE_THRES` | `exposure > hedgeThreshold` | ✅ |

---

### 2.3 Leg1 昨仓 (m_netpos_pass_ytd / NetPosPassYtd)

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **初始化** | `daily_init` 的 `ytd1` | `daily_init` 的 `ytd1` | ✅ |
| **更新** | 卖出平仓时递减 | 卖出平仓时递减 | ✅ |
| **用途** | 区分昨仓/今仓，限制卖出量 | 同左 | ✅ |

**C++ 昨仓更新代码**:
```cpp
// PairwiseArbETFStrategy.cpp:337
strat->m_netpos_pass_ytd -= response->Quantity;
```

**Go 昨仓更新代码**:
```go
// pairwise_arb_strategy.go:2072
pas.leg1YtdPosition = int64(pas.firstStrat.NetPosPassYtd)
```

---

## 3. 追单逻辑 (SendAggressiveOrder)

### 3.1 核心变量

| 变量 | C++ | Go | 用途 | 状态 |
|------|-----|-----|------|------|
| `sellAggOrder` | `m_secondStrat->sellAggOrder` | `secondStrat.SellAggOrder` | 卖出追单计数 | ✅ |
| `buyAggOrder` | `m_secondStrat->buyAggOrder` | `secondStrat.BuyAggOrder` | 买入追单计数 | ✅ |
| `last_agg_time` | `m_secondStrat->last_agg_time` | `lastAggTime` | 上次追单时间 | ✅ |
| `last_agg_side` | `m_secondStrat->last_agg_side` | `lastAggSide` | 上次追单方向 | ✅ |
| `agg_repeat` | 局部变量 | `aggRepeat` | 追单重试次数 | ✅ |

### 3.2 触发条件对比

| 条件 | C++ | Go | 状态 |
|------|-----|-----|------|
| **敞口阈值** | `dr > HEDGE_THRES` | `exposure > hedgeThreshold` | ✅ 一致 |
| **追单数量限制** | `sellAggOrder <= SUPPORTING_ORDERS` | `sellAggOrder <= supportingOrders` | ✅ 一致 |
| **时间间隔** | `now - last_agg_time > 100ms` | `now - lastAggTime > interval` | ✅ 一致 |
| **方向切换** | `last_agg_side != SELL` | `lastAggSide != targetSide` | ✅ 一致 |

**C++ 触发条件代码**:
```cpp
// PairwiseArbETFStrategy.cpp:491-495
if (dr > m_secondStrat->m_thold->HEDGE_THRES && 
    m_secondStrat->sellAggOrder <= m_secondStrat->m_thold->SUPPORTING_ORDERS) {
    if (m_secondStrat->last_agg_side != SELL || 
        now_ts / 1000000 - m_secondStrat->last_agg_time > 100) {
        // 发送追单
    }
}
```

**Go 触发条件代码**:
```go
// pairwise_arb_strategy.go:1707-1728
if targetSide == OrderSideSell && sellAggOrder > supportingOrders {
    return // 超过追单限制
}
if time.Since(pas.lastAggTime) < pas.aggressiveInterval {
    return // 时间间隔不足
}
```

### 3.3 价格计算

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **基础价格** | 对手价 (bid[0] 或 ask[0]) | 对手价 | ✅ 一致 |
| **滑点调整** | `agg_repeat` 跳 | `aggRepeat * tickSize` | ✅ 一致 |
| **滑点公式** | `price - agg_repeat * tickSize` (卖) | 同左 | ✅ |

**C++ 价格计算**:
```cpp
// PairwiseArbETFStrategy.cpp:501-502
auto agg_repeat = std::floor((now_ts / 1000000 - m_secondStrat->last_agg_time) / 10) + 1;
// 价格调整使用 agg_repeat
```

**Go 价格计算**:
```go
// pairwise_arb_strategy.go:1768-1770
if pas.aggRepeat <= 3 {
    priceAdjust = float64(pas.aggRepeat) * tickSize
}
```

### 3.4 计数器更新

| 事件 | C++ | Go | 状态 |
|------|-----|-----|------|
| **发送追单** | `sellAggOrder++` / `buyAggOrder++` | 同左 | ✅ |
| **追单成交/撤单** | `sellAggOrder--` / `buyAggOrder--` | 同左 | ✅ **已修复** |
| **Leg1 成交** | 不变 | `aggRepeat = 1` | ✅ |

**C++ 计数器递减代码**:
```cpp
// PairwiseArbETFStrategy.cpp:345
order->m_side == BUY ? strat->buyAggOrder-- : strat->sellAggOrder--;
```

**Go 计数器递减代码**:
```go
// pairwise_arb_strategy.go:1974-1983
if order.Side == OrderSideBuy {
    pas.secondStrat.BuyAggOrder--
} else {
    pas.secondStrat.SellAggOrder--
}
```

### 3.5 敞口计算公式

| 项目 | C++ | Go | 状态 |
|------|-----|-----|------|
| **公式** | `netpos_pass / HEDGE_SIZE_RATIO + netpos_agg + pending` | `leg1Pos / hedgeRatio + leg2Pos + pendingQty` | ✅ 一致 |

**C++ 敞口计算**:
```cpp
// PairwiseArbETFStrategy.cpp:114
auto dr = m_firstStrat->m_netpos_pass / m_firstStrat->m_thold->HEDGE_SIZE_RATIO 
        + m_secondStrat->m_netpos_agg + pending_netpos_agg2;
```

**Go 敞口计算**:
```go
// pairwise_arb_strategy.go:1661-1669
leg1Pos := pas.leg1Position
leg2Pos := pas.leg2Position
hedgeRatio := pas.tholdFirst.HedgeSizeRatio
exposure := int64(math.Round(float64(leg1Pos)/hedgeRatio)) + leg2Pos + pendingNetpos
```

---

## 4. 一致性总结

### 4.1 价差均值 (avgSpreadRatio_ori)

| 检查项 | 状态 | 备注 |
|--------|------|------|
| 初始化来源 | ✅ | daily_init avgPx |
| EMA 更新公式 | ✅ | 已添加 ALPHA 参数 |
| 保存值 | ✅ | 保存 EMA 均值 |
| tValue 调整 | ✅ | avgSpreadRatio = ori + tValue |

### 4.2 持仓变量

| 检查项 | 状态 | 备注 |
|--------|------|------|
| NetPosPass 初始化 | ✅ | ytd1 + 2day1 |
| NetPosPass 成交更新 | ✅ | 买+ 卖- |
| NetPosAgg 初始化 | ✅ | ytd2 |
| NetPosAgg 成交更新 | ✅ | 买+ 卖- |
| 动态阈值使用 | ✅ | 使用 NetPosPass |
| 敞口计算使用 | ✅ | 两者都参与 |

### 4.3 追单逻辑

| 检查项 | 状态 | 备注 |
|--------|------|------|
| 触发条件 | ✅ | dr > HEDGE_THRES |
| 数量限制 | ✅ | <= SUPPORTING_ORDERS |
| 时间间隔 | ✅ | 100ms |
| 价格计算 | ✅ | 对手价 + 滑点 |
| 计数器递增 | ✅ | 发送时 ++ |
| 计数器递减 | ✅ | 成交/撤单时 -- (已修复) |

---

## 5. 已修复问题汇总

| # | 问题 | 修复日期 | 影响范围 |
|---|------|---------|---------|
| 1 | avgSpreadRatio 使用 SMA 而非 EMA | 2026-02-10 | 信号生成 |
| 2 | ALPHA 参数缺失 | 2026-02-10 | EMA 计算 |
| 3 | avgPx 保存时使用 SMA 均值 | 2026-02-10 | 状态持久化 |
| 4 | setDynamicThresholds 使用 leg1Position | 2026-02-10 | 动态阈值 |
| 5 | 追单计数递减缺失 (HandleAggOrder) | 2026-02-11 | 追单限制 |
| 6 | maxPositionSize 只从 Parameters 读取 | 2026-02-12 | 动态阈值 |

---

## 6. 测试覆盖

### 6.1 价差均值测试

```bash
go test -v -run "TestSpreadAnalyzer" ./pkg/strategy/spread/
```

### 6.2 持仓变量测试

```bash
go test -v -run "TestDailyInit" ./pkg/strategy/
```

### 6.3 追单逻辑测试

```bash
go test -v -run "TestPairwiseArbStrategy_AggressiveOrder" ./pkg/strategy/
```

### 6.4 端到端测试

```bash
go test -v -run "TestDynamicThreshold_E2E" ./pkg/strategy/
```

---

**文档维护者**: Claude  
**最后更新**: 2026-02-12
