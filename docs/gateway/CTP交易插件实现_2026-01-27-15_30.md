# CTP交易插件实现

**文档日期**: 2026-01-27
**作者**: Claude Code
**版本**: v1.0
**相关模块**: Gateway, CTP Plugin

---

## 概述

本文档描述CTP交易插件的实现，该插件实现了`ITDPlugin`接口，提供完整的期货交易功能，包括订单管理、账户查询、持仓查询等。

### 核心文件

1. **接口定义**:
   - `gateway/include/plugin/td_plugin_interface.h` (371行) - 统一交易插件接口

2. **配置管理**:
   - `gateway/plugins/ctp/include/ctp_td_config.h` (68行) - 配置结构定义
   - `gateway/plugins/ctp/src/ctp_td_config.cpp` (175行) - 配置加载实现

3. **插件实现**:
   - `gateway/plugins/ctp/include/ctp_td_plugin.h` (213行) - 插件类定义
   - `gateway/plugins/ctp/src/ctp_td_plugin.cpp` (1120行) - 插件核心实现

4. **主程序**:
   - `gateway/plugins/ctp/src/main_ctp_td.cpp` (176行) - 测试程序入口

5. **编译配置**:
   - `gateway/plugins/ctp/CMakeLists.txt` - 增加TD插件编译配置

6. **配置文件**:
   - `config/ctp/ctp_td.yaml` - 主配置文件
   - `config/ctp/ctp_td.secret.yaml` - 敏感信息配置

---

## 架构设计

### 1. ITDPlugin统一接口

```cpp
class ITDPlugin {
public:
    // 生命周期管理
    virtual bool Initialize(const std::string& config_file) = 0;
    virtual bool Login() = 0;
    virtual void Logout() = 0;
    virtual bool IsLoggedIn() const = 0;
    virtual bool IsConnected() const = 0;

    // 交易功能
    virtual std::string SendOrder(const OrderRequest& request) = 0;
    virtual bool CancelOrder(const std::string& order_id) = 0;

    // 查询功能
    virtual bool QueryAccount(AccountInfo& account_info) = 0;
    virtual bool QueryPositions(std::vector<PositionInfo>& positions) = 0;
    virtual bool QueryOrders(std::vector<OrderInfo>& orders) = 0;
    virtual bool QueryTrades(std::vector<TradeInfo>& trades) = 0;

    // 回调注册
    virtual void RegisterOrderCallback(OrderCallback callback) = 0;
    virtual void RegisterTradeCallback(TradeCallback callback) = 0;
    virtual void RegisterErrorCallback(ErrorCallback callback) = 0;
};
```

### 2. 数据结构

**订单请求** (`OrderRequest`):
```cpp
struct OrderRequest {
    char symbol[32];            // 合约代码
    char exchange[16];          // 交易所代码
    OrderDirection direction;   // 买卖方向（BUY/SELL）
    OffsetFlag offset;          // 开平标志（OPEN/CLOSE/CLOSE_TODAY/CLOSE_YESTERDAY）
    PriceType price_type;       // 价格类型（LIMIT/MARKET/BEST）
    double price;               // 价格
    uint32_t volume;            // 数量
    char client_order_id[64];   // 客户端订单ID
};
```

**订单信息** (`OrderInfo`):
```cpp
struct OrderInfo {
    char order_id[64];          // 系统订单ID（格式：FrontID-SessionID-OrderRef）
    char client_order_id[64];   // 客户端订单ID
    char symbol[32];            // 合约代码
    OrderDirection direction;   // 买卖方向
    OffsetFlag offset;          // 开平标志
    OrderStatus status;         // 订单状态
    uint32_t volume;            // 总数量
    uint32_t traded_volume;     // 已成交数量
    double price;               // 价格
    int64_t insert_time;        // 报单时间（纳秒）
    int64_t update_time;        // 更新时间（纳秒）
};
```

**订单状态** (`OrderStatus`):
- `UNKNOWN` - 未知
- `SUBMITTING` - 提交中
- `SUBMITTED` - 已提交
- `ACCEPTED` - 已接受
- `PARTIAL_FILLED` - 部分成交
- `FILLED` - 全部成交
- `CANCELING` - 撤单中
- `CANCELED` - 已撤单
- `REJECTED` - 已拒绝
- `ERROR` - 错误

---

## 核心功能实现

### 1. 初始化和登录流程

```cpp
bool CTPTDPlugin::Initialize(const std::string& config_file) {
    // 1. 加载配置
    m_config.LoadFromYaml(config_file);
    m_config.Validate();

    // 2. 创建CTP API实例
    m_api = CThostFtdcTraderApi::CreateFtdcTraderApi("./ctp_flow/");
    m_api->RegisterSpi(this);
    m_api->RegisterFront(m_config.front_addr);

    // 3. 订阅主题
    m_api->SubscribePrivateTopic(THOST_TERT_QUICK);
    m_api->SubscribePublicTopic(THOST_TERT_QUICK);
}

bool CTPTDPlugin::Login() {
    m_api->Init();  // 触发连接
    // 等待登录完成...
}
```

**登录流程**:
```
OnFrontConnected()
  → Authenticate() [可选]
    → OnRspAuthenticate()
      → DoLogin()
        → OnRspUserLogin()
          → ConfirmSettlement()
            → OnRspSettlementInfoConfirm()
              → [登录完成，可以交易]
```

### 2. 订单发送

```cpp
std::string CTPTDPlugin::SendOrder(const OrderRequest& request) {
    // 1. 检查状态
    if (!m_settlement_confirmed.load()) return "";

    // 2. 生成OrderRef
    std::string order_ref = GenerateOrderRef();

    // 3. 构建CTP订单请求
    CThostFtdcInputOrderField req = {};
    strncpy(req.InstrumentID, request.symbol, sizeof(req.InstrumentID) - 1);
    req.Direction = (request.direction == OrderDirection::BUY) ?
        THOST_FTDC_D_Buy : THOST_FTDC_D_Sell;
    req.LimitPrice = request.price;
    req.VolumeTotalOriginal = request.volume;
    // ... 设置其他字段

    // 4. 发送订单
    m_api->ReqOrderInsert(&req, ++m_request_id);

    // 5. 构建订单ID: FrontID-SessionID-OrderRef
    std::ostringstream oss;
    oss << m_front_id << "-" << m_session_id << "-" << order_ref;
    return oss.str();
}
```

**订单ID格式**: `FrontID-SessionID-OrderRef`
例如: `1-1234567-000000000001`

### 3. 订单撤单

```cpp
bool CTPTDPlugin::CancelOrder(const std::string& order_id) {
    // 1. 解析订单ID
    std::vector<std::string> parts = split(order_id, '-');

    // 2. 构建撤单请求
    CThostFtdcInputOrderActionField req = {};
    req.FrontID = std::stoi(parts[0]);
    req.SessionID = std::stoi(parts[1]);
    strncpy(req.OrderRef, parts[2].c_str(), sizeof(req.OrderRef) - 1);
    req.ActionFlag = THOST_FTDC_AF_Delete;

    // 3. 发送撤单请求
    m_api->ReqOrderAction(&req, ++m_request_id);
}
```

### 4. 查询功能

使用条件变量实现同步查询（CTP API本身是异步的）:

```cpp
bool CTPTDPlugin::QueryAccount(AccountInfo& account_info) {
    std::lock_guard<std::mutex> lock(m_query_mutex);
    m_query_finished = false;

    // 发送查询请求
    CThostFtdcQryTradingAccountField req = {};
    m_api->ReqQryTradingAccount(&req, ++m_request_id);

    // 等待查询完成（超时5秒）
    std::unique_lock<std::mutex> ulock(m_query_mutex);
    m_query_cv.wait_for(ulock, std::chrono::seconds(5),
        [this] { return m_query_finished; });

    account_info = m_cached_account;
    return true;
}

void CTPTDPlugin::OnRspQryTradingAccount(...) {
    if (pTradingAccount) {
        ConvertAccount(pTradingAccount, m_cached_account);
    }
    if (bIsLast) {
        m_query_finished = true;
        m_query_cv.notify_one();
    }
}
```

### 5. 订单和成交回调

```cpp
void CTPTDPlugin::OnRtnOrder(CThostFtdcOrderField* pOrder) {
    // 1. 转换CTP订单 → OrderInfo
    OrderInfo order_info;
    ConvertOrder(pOrder, order_info);

    // 2. 保存到缓存
    SaveOrder(order_info.order_id, order_info);

    // 3. 触发回调
    if (m_order_callback) {
        m_order_callback(order_info);
    }
}

void CTPTDPlugin::OnRtnTrade(CThostFtdcTradeField* pTrade) {
    // 1. 转换CTP成交 → TradeInfo
    TradeInfo trade_info;
    ConvertTrade(pTrade, trade_info);

    // 2. 更新统计
    m_trade_count.fetch_add(1);

    // 3. 触发回调
    if (m_trade_callback) {
        m_trade_callback(trade_info);
    }
}
```

---

## 配置管理

### 主配置文件 (`ctp_td.yaml`)

```yaml
ctp:
  front_addr: "tcp://180.168.146.187:10130"  # 交易前置地址
  broker_id: "9999"                           # 经纪商代码
  user_id: ""                                 # 从secret文件加载
  password: ""                                # 从secret文件加载
  investor_id: ""                             # 投资者ID
  product_info: "QuantlinkTrader"             # 产品信息

reconnect:
  interval_sec: 5                             # 重连间隔
  max_attempts: -1                            # 最大重连次数

log:
  level: "info"                               # 日志级别
  file: "log/ctp_td.log"                      # 日志文件
  console: true                               # 控制台输出

query:
  interval_ms: 1000                           # 查询间隔（毫秒）
```

### 密码配置文件 (`ctp_td.secret.yaml`)

```yaml
credentials:
  user_id: "your_simnow_userid"
  password: "your_simnow_password"
  investor_id: "your_simnow_userid"
```

**配置加载顺序**:
1. 加载主配置文件 `ctp_td.yaml`
2. 自动查找同目录下的 `ctp_td.secret.yaml`
3. 用secret文件的凭证覆盖主配置中的对应字段
4. 验证必填字段

---

## 编译和测试

### 编译

```bash
cd gateway
mkdir -p build && cd build
cmake ..
make ctp_td_plugin -j4
```

生成可执行文件: `gateway/build/plugins/ctp/ctp_td_plugin`

### 运行测试

```bash
# 1. 配置账户信息
vim config/ctp/ctp_td.secret.yaml

# 2. 运行插件
./gateway/build/plugins/ctp/ctp_td_plugin config/ctp/ctp_td.yaml
```

**预期输出**:
```
========================================
CTP Trading Plugin Test Program
========================================

[Main] Initializing plugin with config: config/ctp/ctp_td.yaml
[CTPTDPlugin] Loading configuration...
========================================
CTP Trading Configuration
========================================
Front Address: tcp://180.168.146.187:10130
Broker ID: 9999
User ID: ******
...
[Main] ✅ Plugin initialized successfully

[Main] Logging in...
[CTPTDPlugin] Connecting to CTP server...
[CTPTDPlugin] ✅ Connected to server
[CTPTDPlugin] ✅ Login successful
[CTPTDPlugin] ✅ Settlement confirmed, ready to trade
[Main] ✅ Logged in successfully

[Main] Querying account info...
========================================
Account Information
========================================
Account ID: ******
Balance: 1000000.00
Available: 1000000.00
...
```

---

## 线程安全设计

### 1. 原子变量

```cpp
std::atomic<bool> m_connected{false};
std::atomic<bool> m_authenticated{false};
std::atomic<bool> m_logged_in{false};
std::atomic<int> m_request_id{0};
std::atomic<int> m_order_ref{0};
std::atomic<uint64_t> m_order_count{0};
std::atomic<double> m_available_fund{0.0};
```

### 2. 互斥锁保护

- **订单缓存**: `m_order_cache_mutex`
- **回调函数**: `m_callback_mutex`
- **查询同步**: `m_query_mutex`

### 3. 条件变量

用于同步查询操作:
```cpp
std::condition_variable m_query_cv;
bool m_query_finished = false;
```

---

## API限流处理

CTP对查询请求有频率限制（通常为1秒1次）:

1. **配置查询间隔**:
   ```yaml
   query:
     interval_ms: 1000  # 建议≥1000ms
   ```

2. **查询超时处理**:
   ```cpp
   m_query_cv.wait_for(ulock, std::chrono::seconds(5),
       [this] { return m_query_finished; });
   ```

3. **错误处理**:
   - 查询失败时记录错误日志
   - 返回false给调用方

---

## 常见问题

### 1. 登录失败

**原因**:
- 账户信息错误
- 网络连接问题
- 前置地址不可达
- 认证信息缺失（实盘环境）

**解决方法**:
```bash
# 检查配置
cat config/ctp/ctp_td.secret.yaml

# 测试网络连接
telnet 180.168.146.187 10130

# 查看日志
tail -f log/ctp_td.log
```

### 2. 结算单确认失败

**原因**:
- 每日首次登录需要确认结算单
- 结算时间内无法确认

**解决方法**:
- 插件已自动处理结算单确认
- 确认失败会重试
- 避免在结算时间登录（15:30-17:00, 20:30-21:00）

### 3. 订单被拒

**原因**:
- 合约代码错误
- 价格不在有效范围
- 资金不足
- 超过持仓限制
- 非交易时段

**解决方法**:
- 检查订单参数
- 查询账户可用资金
- 确认合约是否在交易时段
- 查看错误回调中的详细信息

### 4. 查询超时

**原因**:
- 查询请求过于频繁触发限流
- 网络延迟
- 服务器繁忙

**解决方法**:
```yaml
# 增加查询间隔
query:
  interval_ms: 2000  # 从1000增加到2000
```

---

## 与市场数据插件的对比

| 特性 | 市场数据插件 (MD) | 交易插件 (TD) |
|------|-----------------|--------------|
| **API** | CThostFtdcMdApi | CThostFtdcTraderApi |
| **接口** | IMDPlugin | ITDPlugin |
| **主要功能** | 订阅行情、接收Tick数据 | 发送订单、查询账户/持仓 |
| **回调** | OnRtnDepthMarketData | OnRtnOrder, OnRtnTrade |
| **认证** | 无需认证 | 需要认证（实盘） |
| **结算确认** | 不需要 | 需要 |
| **Flow文件** | ctp_md_flow/ | ctp_td_flow/ |
| **配置文件** | ctp_md.yaml | ctp_td.yaml |

---

## 下一步工作

1. ✅ 定义ITDPlugin接口
2. ✅ 实现CTP交易插件核心功能
3. ✅ 实现查询功能
4. ✅ 创建配置和编译系统
5. ⏸️ **测试验证CTP交易功能** (Task #19)
   - 编译测试
   - 登录测试
   - 发单测试（模拟盘）
   - 查询测试
   - 回调测试
6. ⏸️ **更新文档** (Task #20)
   - API文档
   - 使用示例
   - 故障排查指南

---

## 参考资料

- CTP API官方文档: http://www.sfit.com.cn/
- SimNow注册: https://www.simnow.com.cn/
- 通用接口: @gateway/include/plugin/td_plugin_interface.h
- 市场数据插件: @docs/gateway/CTP行情插件实现_2026-01-27.md

---

**最后更新**: 2026-01-27 15:30
