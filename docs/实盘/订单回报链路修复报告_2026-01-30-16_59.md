# è®¢å•å›æŠ¥é“¾è·¯ä¿®å¤æŠ¥å‘Š - P0 é—®é¢˜

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-30
**ä½œè€…**: Claude (bedrock-claude-4-5-sonnet)
**ç‰ˆæœ¬**: v1.0
**ç›¸å…³æ¨¡å—**: Counter Bridge, ORS Gateway, Golang Trader
**é—®é¢˜çº§åˆ«**: P0 (Critical)

---

## é—®é¢˜æ¦‚è¿°

### é—®é¢˜æè¿°

åœ¨å®ç›˜æµ‹è¯•ä¸­å‘ç° **estimated_position å§‹ç»ˆä¸º null**ï¼Œå¯¼è‡´ï¼š
- API æ¥å£ `/api/v1/strategy/status` è¿”å›ç©ºçš„æŒä»“ä¿¡æ¯
- Dashboard æ— æ³•æ˜¾ç¤ºç­–ç•¥æŒä»“
- é£æ§æ¨¡å—æ— æ³•æ­£ç¡®è®¡ç®—é£é™©æ•å£
- **ä¸¥é‡å½±å“ç³»ç»Ÿå¯ç”¨æ€§**

### ç”¨æˆ·åé¦ˆ

> "legs ä¸æ˜¯æ­£ç¡®çš„æŒä»“æ•°æ®!!!! estimated_position å§‹ç»ˆä¸º null æ˜¯ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤ï¼ŒåŠ å…¥åˆ° Tasks.md é‡Œä½œä¸º P0 é—®é¢˜è¦ä¿®å¤"

### å½±å“èŒƒå›´

- **åŠŸèƒ½å½±å“**: æŒä»“æŸ¥è¯¢ã€é£æ§è®¡ç®—ã€Dashboard å±•ç¤º
- **ä¸¥é‡ç¨‹åº¦**: P0 - ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- **å½±å“ç”¨æˆ·**: æ‰€æœ‰ä½¿ç”¨å®ç›˜æ¨¡å¼çš„äº¤æ˜“ç­–ç•¥

---

## é—®é¢˜åˆ†æ

### åˆæ­¥æ’æŸ¥

1. **Golang ç­–ç•¥ä»£ç æ£€æŸ¥** âœ… æ­£å¸¸
   - `UpdatePosition()` æ–¹æ³•é€»è¾‘æ­£ç¡®
   - `EstimatedPosition` ç»“æ„ä½“å®šä¹‰å®Œæ•´
   - è®¢å•å›è°ƒå‡½æ•° `OnOrderUpdate()` å®ç°æ­£ç¡®

2. **API æ¥å£æ£€æŸ¥** âœ… æ­£å¸¸
   - API ä»£ç æ­£ç¡®åºåˆ—åŒ– estimated_position
   - æ•°æ®ç»“æ„æ˜ å°„æ— è¯¯

3. **è®¢å•ç”Ÿæˆæ£€æŸ¥** âœ… æ­£å¸¸
   - ç­–ç•¥æ­£å¸¸ç”Ÿæˆè®¢å•ä¿¡å·
   - è®¢å•æˆåŠŸå‘é€åˆ° ORS Gateway
   - æ—¥å¿—æ˜¾ç¤ºï¼š"Order sent: test_simple, OrderID: ORD_xxx, Status: SUCCESS"

### å…³é”®å‘ç°

**OnOrderUpdate å›è°ƒä»æœªè¢«è§¦å‘ï¼**

æ·»åŠ  emoji è°ƒè¯•æ—¥å¿—åå‘ç°ï¼š
```go
log.Printf("[BaseStrategy:%s] ğŸš¨ OnOrderUpdate ENTRY")
log.Printf("[BaseStrategy:%s] ğŸ” UpdatePosition called")
```

è¿™äº›æ—¥å¿—å®Œå…¨ä¸å‡ºç°ï¼Œè¯´æ˜è®¢å•æ›´æ–°æ ¹æœ¬æ²¡æœ‰è¿”å›åˆ° Traderã€‚

### æ·±å…¥åˆ†æ

#### è®¢å•æµç¨‹è¿½è¸ª

1. âœ… **Trader â†’ ORS Gateway (gRPC)**
   ```
   [StrategyEngine] Order sent: ORD_1769763491369_000001, Status: SUCCESS
   ```

2. âœ… **ORS Gateway â†’ å…±äº«å†…å­˜**
   ```
   [ORSGateway] SendOrder: ORD_1769763491369_000001 symbol=ag2603 side=BUY
   ```

3. âœ… **Counter Bridge â†’ Simulator Plugin**
   ```
   [SimulatorPlugin] Order submitted: SIM_1769762876570521000_169
   [Bridge] âœ… Order FILLED: SIM_1769762876570521000_169 (1/1)
   ```

4. âŒ **ORS Gateway â†’ NATS å‘å¸ƒå¼‚å¸¸**
   ```
   [ORSGateway] Publishing order update: order.. status=3
   ```
   æ³¨æ„ï¼š`order..` æœ‰ä¸¤ä¸ªç‚¹ï¼åº”è¯¥æ˜¯ `order.test_simple.ORD_xxx`

5. âŒ **Trader è®¢é˜…æœªæ”¶åˆ°æ¶ˆæ¯**
   - Trader è®¢é˜…ä¸»é¢˜ï¼š`order.test_simple.>`
   - å®é™…å‘å¸ƒä¸»é¢˜ï¼š`order..`ï¼ˆæ— æ³•åŒ¹é…ï¼‰

### æ ¹æœ¬åŸå› 

#### åŸå›  1: Counter Bridge ç¼ºå°‘ strategy_id ä¼ é€’

**æ–‡ä»¶**: `gateway/src/counter_bridge.cpp`

**é—®é¢˜ä»£ç **:
```cpp
struct CachedOrderInfo {
    // std::string strategy_id;  // âŒ ç¼ºå¤±ï¼
    std::string client_order_id;
    std::string symbol;
    std::string exchange;
    uint8_t side;
};
```

**å½±å“**:
- è®¢å•å“åº”ä¸­ `strategy_id` å­—æ®µä¸ºç©º
- NATS å‘å¸ƒä¸»é¢˜å˜æˆ `order..` è€Œä¸æ˜¯ `order.test_simple.ORD_xxx`

#### åŸå›  2: Golang Trader ç¼ºå°‘ client_order_id ç”Ÿæˆ

**æ–‡ä»¶**: `golang/pkg/client/ors_client.go`

**é—®é¢˜ä»£ç **:
```go
func (c *ORSClient) SendOrder(ctx context.Context, req *orspb.OrderRequest) {
    // è®¾ç½®ç­–ç•¥ID
    if req.StrategyId == "" {
        req.StrategyId = c.strategyID
    }

    // âŒ ç¼ºå°‘ ClientOrderId ç”Ÿæˆï¼

    // è°ƒç”¨gRPCæ¥å£
    resp, err := c.client.SendOrder(ctx, req)
}
```

**å½±å“**:
- è®¢å•è¯·æ±‚ä¸­ `client_order_id` å­—æ®µä¸ºç©º
- Counter Bridge æ— æ³•æ­£ç¡®ç¼“å­˜è®¢å•ä¿¡æ¯
- å›æŠ¥æ—¶æ— æ³•åŒ¹é…åŸå§‹è®¢å•

#### åŸå›  3: æŒä»“ç›´æ¥ä¿®æ”¹ï¼ˆæ¬¡è¦é—®é¢˜ï¼‰

**æ–‡ä»¶**: `golang/pkg/strategy/pairwise_arb_strategy.go`

**é—®é¢˜ä»£ç **:
```go
// å…¥åœºä¿¡å·
if direction == "long" {
    pas.leg1Position += qty      // âŒ ç›´æ¥ä¿®æ”¹
    pas.leg2Position -= hedgeQty // âŒ ç›´æ¥ä¿®æ”¹
}

// å‡ºåœºä¿¡å·
pas.leg1Position = 0  // âŒ ç›´æ¥é‡ç½®
pas.leg2Position = 0  // âŒ ç›´æ¥é‡ç½®
```

**å½±å“**:
- æŒä»“æ•°æ®ä¸å‡†ç¡®ï¼ˆåŸºäºä¿¡å·è€Œéå®é™…æˆäº¤ï¼‰
- å³ä½¿è®¢å•æœªæˆäº¤ï¼ŒæŒä»“ä¹Ÿä¼šå˜åŒ–
- ä¸å®é™…åˆ¸å•†æŒä»“ä¸ä¸€è‡´

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: Counter Bridge æ·»åŠ  strategy_id æ”¯æŒ

**æ–‡ä»¶**: `gateway/src/counter_bridge.cpp`

**ä¿®æ”¹ 1.1 - æ›´æ–° CachedOrderInfo ç»“æ„ä½“**
```cpp
struct CachedOrderInfo {
    std::string strategy_id;      // âœ… æ–°å¢å­—æ®µ
    std::string client_order_id;
    std::string symbol;
    std::string exchange;
    uint8_t side;
};
```

**ä¿®æ”¹ 1.2 - ç¼“å­˜æ—¶ä¿å­˜ strategy_id**
```cpp
// Line 486-499
{
    std::lock_guard<std::mutex> lock(g_orders_mutex);
    CachedOrderInfo info;
    info.strategy_id = raw_req.strategy_id;      // âœ… æ–°å¢
    info.client_order_id = raw_req.client_order_id;
    info.symbol = raw_req.symbol;
    info.exchange = raw_req.exchange;
    info.side = raw_req.side;
    g_order_map[broker_order_id] = info;
}
```

**ä¿®æ”¹ 1.3 - å“åº”æ—¶å¤åˆ¶ strategy_id**
```cpp
// Line 114-120
std::strncpy(resp.strategy_id, cached_info.strategy_id.c_str(), sizeof(resp.strategy_id) - 1);  // âœ… æ–°å¢
std::strncpy(resp.order_id, cached_info.client_order_id.c_str(), sizeof(resp.order_id) - 1);
std::strncpy(resp.client_order_id, cached_info.client_order_id.c_str(), sizeof(resp.client_order_id) - 1);
std::strncpy(resp.symbol, cached_info.symbol.c_str(), sizeof(resp.symbol) - 1);
std::strncpy(resp.exchange, cached_info.exchange.c_str(), sizeof(resp.exchange) - 1);
resp.side = cached_info.side;
```

**ä¿®æ”¹ 1.4 - é™çº§å¤„ç†ä¸­è®¾ç½®é»˜è®¤å€¼**
```cpp
// Line 105-111
} else {
    // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä½¿ç”¨order_infoä¸­çš„ä¿¡æ¯ï¼ˆé™çº§å¤„ç†ï¼‰
    cached_info.strategy_id = "";  // âœ… æ–°å¢ï¼ˆè™½ç„¶ä¸ºç©ºï¼Œä½†é¿å…æœªåˆå§‹åŒ–ï¼‰
    cached_info.client_order_id = order_info.client_order_id;
    cached_info.symbol = order_info.symbol;
    cached_info.exchange = "SHFE";
    cached_info.side = 1;
}
```

### ä¿®å¤ 2: Golang Trader è‡ªåŠ¨ç”Ÿæˆ client_order_id

**æ–‡ä»¶**: `golang/pkg/client/ors_client.go`

**ä¿®æ”¹ 2.1 - æ·»åŠ  orderSeq å­—æ®µ**
```go
type ORSClient struct {
    // gRPCè¿æ¥
    conn   *grpc.ClientConn
    client orspb.ORSGatewayClient

    // NATSè¿æ¥ï¼ˆç”¨äºè®¢å•å›æŠ¥ï¼‰
    natsConn *nats.Conn
    natsSub  *nats.Subscription

    // Counter Bridgeåœ°å€ï¼ˆç”¨äºæŒä»“æŸ¥è¯¢ï¼‰
    counterBridgeAddr string

    // è®¢å•å›è°ƒ
    onOrderUpdate func(*orspb.OrderUpdate)

    // çŠ¶æ€
    mu         sync.RWMutex
    connected  bool
    strategyID string

    // ç»Ÿè®¡
    ordersSent     int64
    ordersAccepted int64
    ordersRejected int64
    orderSeq       int64 // âœ… æ–°å¢ï¼šè®¢å•åºåˆ—å·
}
```

**ä¿®æ”¹ 2.2 - SendOrder æ–¹æ³•ä¸­ç”Ÿæˆ ClientOrderId**
```go
// Line 130-150
func (c *ORSClient) SendOrder(ctx context.Context, req *orspb.OrderRequest) (*orspb.OrderResponse, error) {
    c.mu.RLock()
    if !c.connected {
        c.mu.RUnlock()
        return nil, fmt.Errorf("client not connected")
    }
    c.mu.RUnlock()

    // è®¾ç½®ç­–ç•¥ID
    if req.StrategyId == "" {
        req.StrategyId = c.strategyID
    }

    // âœ… ç”Ÿæˆå®¢æˆ·ç«¯è®¢å•IDï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
    if req.ClientOrderId == "" {
        req.ClientOrderId = fmt.Sprintf("ORD_%d_%06d",
            time.Now().UnixMilli(),
            atomic.AddInt64(&c.orderSeq, 1))
    }

    // è°ƒç”¨gRPCæ¥å£
    resp, err := c.client.SendOrder(ctx, req)
    // ...
}
```

**ä¿®æ”¹ 2.3 - æ·»åŠ  sync/atomic å¯¼å…¥**
```go
import (
    "context"
    "encoding/json"
    "fmt"
    "io"
    "log"
    "net/http"
    "sync"
    "sync/atomic"  // âœ… æ–°å¢
    "time"

    "github.com/nats-io/nats.go"
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
)
```

**ClientOrderId æ ¼å¼è¯´æ˜**:
- æ ¼å¼ï¼š`ORD_{æ¯«ç§’æ—¶é—´æˆ³}_{6ä½åºåˆ—å·}`
- ç¤ºä¾‹ï¼š`ORD_1769763491369_000001`
- ç‰¹ç‚¹ï¼š
  - å…¨å±€å”¯ä¸€ï¼ˆæ—¶é—´æˆ³ + åºåˆ—å·ï¼‰
  - å¯è¯»æ€§å¥½ï¼ˆåŒ…å«æ—¶é—´ä¿¡æ¯ï¼‰
  - æ˜“äºæ’åºå’ŒæŸ¥è¯¢

### ä¿®å¤ 3: ç§»é™¤æŒä»“ç›´æ¥ä¿®æ”¹é€»è¾‘

**æ–‡ä»¶**: `golang/pkg/strategy/pairwise_arb_strategy.go`

**ä¿®æ”¹ 3.1 - åˆ é™¤å…¥åœºä¿¡å·ä¸­çš„æŒä»“ä¿®æ”¹**
```go
// Line 356-367 (å·²åˆ é™¤)
// âŒ åˆ é™¤ä»¥ä¸‹ä»£ç ï¼š
// Track positions (simplified - in reality would track per symbol)
// if direction == "long" {
//     pas.leg1Position += qty
//     pas.leg2Position -= hedgeQty
// } else {
//     pas.leg1Position -= qty
//     pas.leg2Position += hedgeQty
// }

// âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜
// æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œç›´æ¥ä¿®æ”¹ leg1Position/leg2Position
// æŒä»“åº”è¯¥ä»è®¢å•æˆäº¤å›æŠ¥ä¸­è®¡ç®—ï¼ˆOnOrderUpdateï¼‰
```

**ä¿®æ”¹ 3.2 - åˆ é™¤å‡ºåœºä¿¡å·ä¸­çš„æŒä»“é‡ç½®**
```go
// Line 431-437 (å·²åˆ é™¤)
// âŒ åˆ é™¤ä»¥ä¸‹ä»£ç ï¼š
// Reset positions
// pas.leg1Position = 0
// pas.leg2Position = 0

// âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜
// æ³¨æ„ï¼šæŒä»“ä¼šåœ¨è®¢å•æˆäº¤åè‡ªåŠ¨æ›´æ–°
// æ— éœ€æ‰‹åŠ¨é‡ç½®
```

**æŒä»“æ›´æ–°æœºåˆ¶è¯´æ˜**:
- æŒä»“åªä» `OnOrderUpdate` å›è°ƒä¸­æ›´æ–°
- å½“è®¢å•çŠ¶æ€ä¸º `FILLED` æ—¶ï¼Œè°ƒç”¨ `UpdatePosition()`
- `UpdatePosition()` æ–¹æ³•ä¼šè‡ªåŠ¨è®¡ç®—ï¼š
  - LongQty / ShortQtyï¼ˆå¤šç©ºæ•°é‡ï¼‰
  - AvgLongPrice / AvgShortPriceï¼ˆå¹³å‡æˆæœ¬ï¼‰
  - NetQtyï¼ˆå‡€æŒä»“ï¼‰
  - RealizedPnL / UnrealizedPnLï¼ˆå·²å®ç°/æœªå®ç°ç›ˆäºï¼‰

---

## ç¼–è¯‘å’Œéƒ¨ç½²

### ç¼–è¯‘æ­¥éª¤

```bash
# 1. ç¼–è¯‘ Counter Bridge
cd gateway/build
make counter_bridge -j4

# 2. ç¼–è¯‘ Golang Trader
cd ../../golang
go build -o ../bin/trader cmd/trader/main.go

# 3. éªŒè¯ç¼–è¯‘äº§ç‰©
ls -lh ../gateway/build/counter_bridge
ls -lh bin/trader
```

### å¯åŠ¨ç³»ç»Ÿ

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/user/PWorks/RD/quantlink-trade-system

# 1. å¯åŠ¨ NATSï¼ˆå¦‚æœªè¿è¡Œï¼‰
nats-server &

# 2. å¯åŠ¨ Gateway ç»„ä»¶
./gateway/build/md_simulator > log/md_simulator.log 2>&1 &
./gateway/build/md_gateway > log/md_gateway.log 2>&1 &
./gateway/build/ors_gateway > log/ors_gateway.log 2>&1 &
./gateway/build/counter_bridge simulator:config/simulator/simulator.yaml > log/counter_bridge.log 2>&1 &

# 3. å¯åŠ¨ Trader
./bin/trader -config config/trader.simple.yaml > log/trader.simple.log 2>&1 &

# 4. ç­‰å¾…ç³»ç»Ÿå¯åŠ¨
sleep 5

echo "âœ“ ç³»ç»Ÿå¯åŠ¨å®Œæˆ"
```

---

## æµ‹è¯•éªŒè¯

### éªŒè¯æ­¥éª¤

#### 1. æ£€æŸ¥è®¢å•å‘é€

```bash
grep "Order sent" log/trader.simple.log | tail -5
```

**é¢„æœŸè¾“å‡º**:
```
2026/01/30 16:58:17 [StrategyEngine] Order sent: test_simple, OrderID: ORD_1769763497369_000161, Status: SUCCESS
2026/01/30 16:58:20 [StrategyEngine] Order sent: test_simple, OrderID: ORD_1769763500372_000162, Status: SUCCESS
```

#### 2. æ£€æŸ¥è®¢å•ç¼“å­˜ï¼ˆCounter Bridgeï¼‰

```bash
grep "ğŸ’¾ Cached" log/counter_bridge.log | head -5
```

**é¢„æœŸè¾“å‡º**:
```
[Processor] ğŸ’¾ Cached: broker_order_id=SIM_1769763491631508000_1 strategy_id=test_simple client_order_id=ORD_1769763491369_000001
[Processor] ğŸ’¾ Cached: broker_order_id=SIM_1769763491631694000_2 strategy_id=test_simple client_order_id=ORD_1769763491631_000002
```

**éªŒè¯ç‚¹**:
- âœ… `strategy_id=test_simple` (ä¸ä¸ºç©º)
- âœ… `client_order_id=ORD_xxx` (ä¸ä¸ºç©º)

#### 3. æ£€æŸ¥è®¢å•æ›´æ–°æ¥æ”¶ï¼ˆTraderï¼‰

```bash
grep "Received order update" log/trader.simple.log | head -5
```

**é¢„æœŸè¾“å‡º**:
```
2026/01/30 16:58:11 [StrategyEngine] Received order update: ORD_1769763491631_000002, Status: ACCEPTED
2026/01/30 16:58:11 [StrategyEngine] Received order update: ORD_1769763491369_000001, Status: ACCEPTED
2026/01/30 16:58:11 [StrategyEngine] Received order update: ORD_1769763491631_000002, Status: FILLED
```

**éªŒè¯ç‚¹**:
- âœ… OrderID åŒ¹é…å‘é€çš„è®¢å•
- âœ… Status ä» ACCEPTED â†’ FILLED

#### 4. æ£€æŸ¥æŒä»“æ›´æ–°

```bash
grep "âœ… EstimatedPosition UPDATED" log/trader.simple.log | tail -10
```

**é¢„æœŸè¾“å‡º**:
```
2026/01/30 16:58:11 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=0, Short=1, Net=-1, AvgLong=0.00, AvgShort=8037.00
2026/01/30 16:58:11 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=1, Short=1, Net=0, AvgLong=8034.00, AvgShort=8037.00
2026/01/30 16:58:14 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=2, Short=1, Net=1, AvgLong=8041.50, AvgShort=8037.00
2026/01/30 16:58:14 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=2, Short=2, Net=0, AvgLong=8041.50, AvgShort=8042.50
2026/01/30 16:58:17 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=3, Short=2, Net=1, AvgLong=8045.67, AvgShort=8042.50
2026/01/30 16:58:17 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=3, Short=3, Net=0, AvgLong=8045.67, AvgShort=8047.33
```

**éªŒè¯ç‚¹**:
- âœ… LongQty / ShortQty æ­£ç¡®ç´¯åŠ 
- âœ… AvgLongPrice / AvgShortPrice æ­£ç¡®è®¡ç®—
- âœ… NetQty æ­£ç¡®åæ˜ å¤šç©ºå¹³è¡¡

#### 5. æ£€æŸ¥ API è¿”å›ï¼ˆå¦‚æœå¯ç”¨äº† HTTP APIï¼‰

```bash
# æŸ¥è¯¢ç­–ç•¥çŠ¶æ€
curl -s http://localhost:9201/api/v1/strategy/status | jq '{
  estimated_position: .data.estimated_position,
  legs: .data.legs,
  orders_count: (.data.orders | length)
}'
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "estimated_position": {
    "Symbol": "ag2603",
    "Exchange": "SHFE",
    "LongQty": 3,
    "ShortQty": 3,
    "NetQty": 0,
    "AvgLongPrice": 8045.67,
    "AvgShortPrice": 8047.33,
    "RealizedPnL": 0,
    "UnrealizedPnL": -5.01,
    "LastUpdate": "2026-01-30T16:58:17+08:00"
  },
  "legs": [
    {
      "symbol": "ag2603",
      "price": 8045.67,
      "position": 0,
      "side": "flat"
    },
    {
      "symbol": "ag2605",
      "price": 8047.33,
      "position": 0,
      "side": "flat"
    }
  ],
  "orders_count": 163
}
```

**éªŒè¯ç‚¹**:
- âœ… `estimated_position` ä¸ä¸º null
- âœ… LongQty / ShortQty æœ‰æ­£ç¡®çš„å€¼
- âœ… AvgLongPrice / AvgShortPrice æœ‰æ­£ç¡®çš„å€¼
- âœ… LastUpdate æ—¶é—´æˆ³ä¸ºæœ€è¿‘æ—¶é—´

### æµ‹è¯•ç»“æœ

#### ä¿®å¤å‰ âŒ

```
[ORSGateway] Publishing order update: order.. status=3
                                            â†‘â†‘
                                      ä¸¤ä¸ªç‚¹ï¼šstrategy_id å’Œ order_id éƒ½ä¸ºç©º
```

- âŒ NATS ä¸»é¢˜é”™è¯¯
- âŒ Trader æ— æ³•æ¥æ”¶è®¢å•æ›´æ–°
- âŒ OnOrderUpdate ä»æœªè§¦å‘
- âŒ estimated_position å§‹ç»ˆä¸º null

#### ä¿®å¤å âœ…

```
[Processor] ğŸ’¾ Cached: broker_order_id=SIM_xxx strategy_id=test_simple client_order_id=ORD_1769763491369_000001
[ORSGateway] Publishing order update: order.test_simple.ORD_1769763491369_000001 status=5
[StrategyEngine] Received order update: ORD_1769763491369_000001, Status: FILLED
[BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=3, Short=3, Net=0
```

- âœ… strategy_id æ­£ç¡®ä¼ é€’
- âœ… client_order_id æ­£ç¡®ç”Ÿæˆ
- âœ… NATS ä¸»é¢˜æ ¼å¼æ­£ç¡®
- âœ… è®¢å•æ›´æ–°æ­£å¸¸æ¥æ”¶
- âœ… OnOrderUpdate æ­£å¸¸è§¦å‘
- âœ… estimated_position æ­£ç¡®æ›´æ–°

---

## æŠ€æœ¯ç»†èŠ‚

### NATS ä¸»é¢˜è®¾è®¡

#### å‘å¸ƒç«¯ï¼ˆORS Gatewayï¼‰

```cpp
void ORSGatewayImpl::PublishOrderUpdate(const OrderUpdate& update) {
    std::string subject = "order." + update.strategy_id() + "." + update.order_id();
    // ç¤ºä¾‹ï¼šorder.test_simple.ORD_1769763491369_000001

    PublishToNATS(subject, serialized_data);
}
```

#### è®¢é˜…ç«¯ï¼ˆGolang Traderï¼‰

```go
// è®¢é˜…ä¸»é¢˜ï¼šorder.{strategy_id}.>
subject := fmt.Sprintf("order.%s.>", c.strategyID)
// ç¤ºä¾‹ï¼šorder.test_simple.>

sub, err := c.natsConn.Subscribe(subject, func(msg *nats.Msg) {
    var update orspb.OrderUpdate
    proto.Unmarshal(msg.Data, &update)

    if c.onOrderUpdate != nil {
        c.onOrderUpdate(&update)
    }
})
```

**åŒ¹é…è§„åˆ™**:
- å‘å¸ƒï¼š`order.test_simple.ORD_1769763491369_000001`
- è®¢é˜…ï¼š`order.test_simple.>`
- ç»“æœï¼šâœ… åŒ¹é…æˆåŠŸ

### è®¢å• ID æ˜ å°„å…³ç³»

```
å®¢æˆ·ç«¯è®¢å•ID (client_order_id)
  â†“
  ç”± Trader ç”Ÿæˆ
  æ ¼å¼ï¼šORD_{timestamp_ms}_{seq}
  ç¤ºä¾‹ï¼šORD_1769763491369_000001
  â†“
  å‘é€åˆ° ORS Gateway (gRPC)
  â†“
  å†™å…¥å…±äº«å†…å­˜ (OrderRequestRaw)
  â†“
  Counter Bridge è¯»å–
  â†“
  å‘é€åˆ° Broker Plugin
  â†“
  Broker è¿”å› broker_order_id
  æ ¼å¼ï¼šSIM_{timestamp_ns}_{seq}
  ç¤ºä¾‹ï¼šSIM_1769763491631508000_1
  â†“
  Counter Bridge ç¼“å­˜æ˜ å°„ï¼š
    g_order_map[broker_order_id] = {
        strategy_id: "test_simple",
        client_order_id: "ORD_1769763491369_000001",
        ...
    }
  â†“
  æ”¶åˆ° Broker è®¢å•æ›´æ–°å›è°ƒ
  é€šè¿‡ broker_order_id æŸ¥æ‰¾ç¼“å­˜
  è·å–åŸå§‹çš„ strategy_id å’Œ client_order_id
  â†“
  æ„é€ è®¢å•å“åº” (OrderResponseRaw)
    order_id = client_order_id (ORD_xxx)
    strategy_id = "test_simple"
  â†“
  å†™å…¥å…±äº«å†…å­˜å“åº”é˜Ÿåˆ—
  â†“
  ORS Gateway è¯»å–
  è½¬æ¢ä¸º Protobuf (OrderUpdate)
  â†“
  å‘å¸ƒåˆ° NATS
  ä¸»é¢˜ï¼šorder.{strategy_id}.{order_id}
  â†“
  Trader è®¢é˜…æ¥æ”¶
  é€šè¿‡ order_id åŒ¹é…æœ¬åœ°è®¢å•
  â†“
  è§¦å‘ OnOrderUpdate å›è°ƒ
  â†“
  æ›´æ–° estimated_position
```

### å…±äº«å†…å­˜ç»“æ„

#### OrderRequestRaw (ORS Gateway â†’ Counter Bridge)

```cpp
struct OrderRequestRaw {
    char strategy_id[32];       // âœ… å¿…é¡»è®¾ç½®
    char symbol[16];
    char exchange[8];
    uint8_t side;
    double price;
    int64_t quantity;
    char client_order_id[32];   // âœ… å¿…é¡»è®¾ç½®
    // ...
};
```

#### OrderResponseRaw (Counter Bridge â†’ ORS Gateway)

```cpp
struct OrderResponseRaw {
    char strategy_id[32];       // âœ… å¿…é¡»è®¾ç½®ï¼ˆä»ç¼“å­˜è·å–ï¼‰
    char order_id[32];          // âœ… ä½¿ç”¨ client_order_id
    char client_order_id[32];   // âœ… ä»ç¼“å­˜è·å–
    char symbol[16];
    char exchange[8];
    uint8_t side;
    uint8_t status;
    // ...
};
```

---

## ç»éªŒæ€»ç»“

### é—®é¢˜æ’æŸ¥æ–¹æ³•

1. **è‡ªé¡¶å‘ä¸‹è¿½è¸ª**
   - ä»ç”¨æˆ·å¯è§çš„é—®é¢˜å¼€å§‹ï¼ˆestimated_position ä¸º nullï¼‰
   - é€å±‚å‘ä¸‹è¿½è¸ªï¼ˆAPI â†’ Strategy â†’ OrderUpdate â†’ NATS â†’ ...ï¼‰
   - ä½¿ç”¨æ—¥å¿—å®šä½é—®é¢˜å±‚çº§

2. **æ·»åŠ è°ƒè¯•æ—¥å¿—**
   - ä½¿ç”¨ emoji æ ‡è®°å…³é”®è·¯å¾„ï¼ˆğŸš¨ ğŸ” âœ… ğŸ’¾ï¼‰
   - åœ¨å…³é”®èŠ‚ç‚¹è¾“å‡ºçŠ¶æ€ä¿¡æ¯
   - éªŒè¯æ•°æ®æ˜¯å¦æŒ‰é¢„æœŸæµåŠ¨

3. **æ£€æŸ¥æ•°æ®å®Œæ•´æ€§**
   - éªŒè¯æ¯ä¸ªç¯èŠ‚çš„è¾“å…¥è¾“å‡º
   - æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦ä¸ºç©º
   - ç¡®è®¤æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

### è®¾è®¡æ•™è®­

1. **ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•çš„é‡è¦æ€§**
   - å•å…ƒæµ‹è¯•æ— æ³•å‘ç°æ­¤ç±»é—®é¢˜
   - éœ€è¦å®Œæ•´çš„é“¾è·¯æµ‹è¯•
   - åº”è¯¥æœ‰è‡ªåŠ¨åŒ–çš„ç«¯åˆ°ç«¯æµ‹è¯•

2. **æ—¥å¿—è®¾è®¡çš„é‡è¦æ€§**
   - å…³é”®è·¯å¾„å¿…é¡»æœ‰æ—¥å¿—
   - æ—¥å¿—åº”åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
   - ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼ä¾¿äºè¿½è¸ª

3. **å­—æ®µå¿…å¡«æ€§æ£€æŸ¥**
   - åº”è¯¥åœ¨å‘é€å‰éªŒè¯å¿…å¡«å­—æ®µ
   - ç©ºå­—æ®µåº”è¯¥æŠ¥é”™è€Œä¸æ˜¯é™é»˜å¤±è´¥
   - ä½¿ç”¨ç±»å‹ç³»ç»Ÿå¼ºåˆ¶éç©º

4. **æ–‡æ¡£åŒ–æ•°æ®æµ**
   - å¤æ‚ç³»ç»Ÿéœ€è¦æ¸…æ™°çš„æ•°æ®æµå›¾
   - æ¯ä¸ªç¯èŠ‚çš„èŒè´£è¦æ˜ç¡®
   - æ¥å£å¥‘çº¦è¦æ–‡æ¡£åŒ–

### æœ€ä½³å®è·µ

1. **è®¢å• ID è®¾è®¡**
   ```
   âœ… å¥½çš„è®¾è®¡ï¼š
   - åŒ…å«æ—¶é—´æˆ³ï¼ˆä¾¿äºæ’åºå’ŒæŸ¥è¯¢ï¼‰
   - åŒ…å«åºåˆ—å·ï¼ˆä¿è¯å”¯ä¸€æ€§ï¼‰
   - æ ¼å¼ç»Ÿä¸€ï¼ˆæ˜“äºè§£æï¼‰
   - ç¤ºä¾‹ï¼šORD_1769763491369_000001

   âŒ ä¸å¥½çš„è®¾è®¡ï¼š
   - UUIDï¼ˆæ— åºï¼Œä¸å¯è¯»ï¼‰
   - çº¯æ•°å­—ï¼ˆæ— ä¸Šä¸‹æ–‡ï¼‰
   - æ— æ ¼å¼ï¼ˆéš¾ä»¥è§£æï¼‰
   ```

2. **NATS ä¸»é¢˜è®¾è®¡**
   ```
   âœ… å¥½çš„è®¾è®¡ï¼š
   - å±‚çº§ç»“æ„æ¸…æ™°ï¼šorder.{strategy}.{order_id}
   - ä¾¿äºè®¢é˜…è¿‡æ»¤ï¼šorder.test_simple.>
   - æ˜“äºç†è§£å’Œè°ƒè¯•

   âŒ ä¸å¥½çš„è®¾è®¡ï¼š
   - æ‰å¹³ç»“æ„ï¼šorder_update_{id}
   - éš¾ä»¥è¿‡æ»¤è®¢é˜…
   - å¢åŠ ç³»ç»Ÿè´Ÿæ‹…
   ```

3. **çŠ¶æ€ä¼ é€’**
   ```
   âœ… å¥½çš„è®¾è®¡ï¼š
   - æ¯ä¸ªç¯èŠ‚ä¿å­˜å¿…è¦çš„ä¸Šä¸‹æ–‡
   - ä½¿ç”¨ç¼“å­˜è§£å†³å¼‚æ­¥é—®é¢˜
   - æ¸…æ™°çš„çŠ¶æ€æœº

   âŒ ä¸å¥½çš„è®¾è®¡ï¼š
   - å‡è®¾ä¸Šä¸‹æ–‡å§‹ç»ˆå¯ç”¨
   - ä¾èµ–å¤–éƒ¨æŸ¥è¯¢
   - çŠ¶æ€ä¸ä¸€è‡´
   ```

---

## ç›¸å…³æ–‡æ¡£

- ç³»ç»Ÿæ¶æ„ï¼š`@docs/æ ¸å¿ƒæ–‡æ¡£/CURRENT_ARCHITECTURE_FLOW.md`
- æ„å»ºæŒ‡å—ï¼š`@docs/æ ¸å¿ƒæ–‡æ¡£/BUILD_GUIDE.md`
- æŒä»“ç®¡ç†ï¼š`@docs/å®ç›˜/Phase2-5_å®Œæ•´æŒä»“ç®¡ç†åŠŸèƒ½å®æ–½æŠ¥å‘Š_2026-01-30-11_35.md`
- é…ç½®åŠ è½½ï¼š`@docs/å®ç›˜/å‚æ•°åŠ è½½ä¿®å¤æŠ¥å‘Š_2026-01-30-11_05.md`

---

## é™„å½•

### è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

#### Counter Bridge æ—¥å¿—
```
[Bridge] Looking up broker_order_id: SIM_1769763491631508000_1 (cache size: 0)
[Bridge] âš  NOT found in cache, using fallback
[Processor] ğŸ’¾ Cached: broker_order_id=SIM_1769763491631508000_1 strategy_id=test_simple client_order_id=ORD_1769763491369_000001
[Bridge] Looking up broker_order_id: SIM_1769763491631508000_1 (cache size: 1)
[Bridge] âœ“ Found in cache: strategy_id=test_simple client_order_id=ORD_1769763491369_000001
[Bridge] Response: strategy_id=test_simple order_id=ORD_1769763491369_000001 client_order_id=ORD_1769763491369_000001
```

#### ORS Gateway æ—¥å¿—
```
[ORSGateway] SendOrder: ORD_1769763491369_000001 symbol=ag2603 side=BUY price=8034 qty=1 latency=8333ns
[ORSGateway] Publishing order update: order.test_simple.ORD_1769763491369_000001 status=3
[ORSGateway] Publishing order update: order.test_simple.ORD_1769763491369_000001 status=5
```

#### Trader æ—¥å¿—
```
2026/01/30 16:58:11 [StrategyEngine] Order sent: test_simple, OrderID: ORD_1769763491369_000001, Status: SUCCESS
2026/01/30 16:58:11 [StrategyEngine] Received order update: ORD_1769763491369_000001, Status: ACCEPTED
2026/01/30 16:58:11 [PairwiseArb:test_simple] ğŸš¨ OnOrderUpdate ENTRY: OrderID=ORD_1769763491369_000001, Status=ACCEPTED, Symbol=ag2603, Side=BUY, FilledQty=0
2026/01/30 16:58:11 [BaseStrategy:test_simple] ğŸ” UpdatePosition called: OrderID=ORD_1769763491369_000001, Symbol=ag2603, Status=ACCEPTED, Side=BUY, FilledQty=0
2026/01/30 16:58:11 [StrategyEngine] Received order update: ORD_1769763491369_000001, Status: FILLED
2026/01/30 16:58:11 [PairwiseArb:test_simple] ğŸš¨ OnOrderUpdate ENTRY: OrderID=ORD_1769763491369_000001, Status=FILLED, Symbol=ag2603, Side=BUY, FilledQty=1
2026/01/30 16:58:11 [BaseStrategy:test_simple] ğŸ” UpdatePosition called: OrderID=ORD_1769763491369_000001, Symbol=ag2603, Status=FILLED, Side=BUY, FilledQty=1
2026/01/30 16:58:11 [BaseStrategy:test_simple] âœ… EstimatedPosition UPDATED: Long=1, Short=0, Net=1, AvgLong=8034.00, AvgShort=0.00
```

### å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è®¢å•å‘é€æµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Trader (Golang)
  â”‚
  â”‚ 1. ç”Ÿæˆäº¤æ˜“ä¿¡å·
  â”‚    TradingSignal â†’ OrderRequest
  â”‚
  â”œâ”€ 2. è®¾ç½® StrategyId (ors_client.go)
  â”‚    req.StrategyId = "test_simple"
  â”‚
  â”œâ”€ 3. ç”Ÿæˆ ClientOrderId (âœ… æ–°å¢)
  â”‚    req.ClientOrderId = "ORD_1769763491369_000001"
  â”‚
  â””â”€â†’ 4. gRPC è°ƒç”¨ SendOrder()
       â”‚
       â†“
ORS Gateway (C++)
  â”‚
  â”œâ”€ 5. æ¥æ”¶ gRPC è¯·æ±‚
  â”‚    OrderRequest (Protobuf)
  â”‚
  â”œâ”€ 6. è½¬æ¢ä¸ºå…±äº«å†…å­˜æ ¼å¼
  â”‚    ConvertToRaw()
  â”‚    OrderRequestRaw
  â”‚
  â””â”€â†’ 7. å†™å…¥å…±äº«å†…å­˜é˜Ÿåˆ—
       /hft_ors_request
       â”‚
       â†“
Counter Bridge (C++)
  â”‚
  â”œâ”€ 8. ä»å…±äº«å†…å­˜è¯»å–
  â”‚    OrderRequestRaw raw_req
  â”‚
  â”œâ”€ 9. ç¼“å­˜è®¢å•ä¿¡æ¯ (âœ… æ–°å¢ strategy_id)
  â”‚    g_order_map[broker_order_id] = {
  â”‚      strategy_id: raw_req.strategy_id,
  â”‚      client_order_id: raw_req.client_order_id,
  â”‚      ...
  â”‚    }
  â”‚
  â””â”€â†’ 10. å‘é€åˆ° Broker Plugin
        â”‚
        â†“
Simulator Plugin (C++)
  â”‚
  â”œâ”€ 11. å¤„ç†è®¢å•
  â”‚     ç«‹å³æˆäº¤æ¨¡å¼
  â”‚
  â””â”€â†’ 12. è§¦å‘è®¢å•å›è°ƒ
        OnBrokerOrderCallback(order_info)
        broker_order_id = "SIM_1769763491631508000_1"


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è®¢å•å›æŠ¥æµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Counter Bridge (C++)
  â”‚
  â”œâ”€ 13. æ¥æ”¶ Broker å›è°ƒ
  â”‚     OnBrokerOrderCallback(order_info)
  â”‚     order_info.order_id = "SIM_xxx" (broker_order_id)
  â”‚
  â”œâ”€ 14. æŸ¥æ‰¾è®¢å•ç¼“å­˜
  â”‚     auto it = g_order_map.find(order_info.order_id)
  â”‚     cached_info = it->second
  â”‚
  â”œâ”€ 15. æ„é€ è®¢å•å“åº” (âœ… ä¿®å¤)
  â”‚     OrderResponseRaw resp
  â”‚     resp.strategy_id = cached_info.strategy_id
  â”‚     resp.order_id = cached_info.client_order_id
  â”‚     resp.client_order_id = cached_info.client_order_id
  â”‚     resp.status = ACCEPTED / FILLED
  â”‚
  â””â”€â†’ 16. å†™å…¥å…±äº«å†…å­˜å“åº”é˜Ÿåˆ—
        /hft_ors_response
        â”‚
        â†“
ORS Gateway (C++)
  â”‚
  â”œâ”€ 17. ä»å…±äº«å†…å­˜è¯»å–
  â”‚     OrderResponseRaw raw_resp
  â”‚
  â”œâ”€ 18. è½¬æ¢ä¸º Protobuf
  â”‚     ConvertToProtobuf()
  â”‚     OrderUpdate proto_update
  â”‚
  â”œâ”€ 19. å‘å¸ƒåˆ° NATS (âœ… ä¿®å¤)
  â”‚     ä¸»é¢˜ï¼šorder.{strategy_id}.{order_id}
  â”‚     ç¤ºä¾‹ï¼šorder.test_simple.ORD_1769763491369_000001
  â”‚
  â””â”€â†’ natsConnection_Publish(subject, data)
        â”‚
        â†“
NATS Server
  â”‚
  â””â”€â†’ å¹¿æ’­æ¶ˆæ¯åˆ°è®¢é˜…è€…
        â”‚
        â†“
Trader (Golang)
  â”‚
  â”œâ”€ 20. NATS è®¢é˜…æ¥æ”¶
  â”‚     è®¢é˜…ä¸»é¢˜ï¼šorder.test_simple.>
  â”‚     åŒ¹é…æˆåŠŸ âœ…
  â”‚
  â”œâ”€ 21. ååºåˆ—åŒ– Protobuf
  â”‚     proto.Unmarshal(msg.Data, &update)
  â”‚
  â”œâ”€ 22. è§¦å‘è®¢å•å›è°ƒ
  â”‚     c.onOrderUpdate(&update)
  â”‚
  â”œâ”€ 23. ç­–ç•¥å¤„ç†å›è°ƒ
  â”‚     OnOrderUpdate(update)
  â”‚
  â”œâ”€ 24. æ›´æ–°æŒä»“ (å¦‚æœ FILLED)
  â”‚     UpdatePosition(update)
  â”‚
  â””â”€â†’ 25. æ›´æ–° EstimatedPosition âœ…
        LongQty, ShortQty, NetQty
        AvgLongPrice, AvgShortPrice
        LastUpdate = now()
```

---

**æœ€åæ›´æ–°**: 2026-01-30 16:59
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²
