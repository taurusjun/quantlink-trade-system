# CTP P&L è®¡ç®—ä¿®å¤æŠ¥å‘Š

**æ–‡æ¡£æ—¥æœŸ**: 2026-02-11
**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: v1.0
**ç›¸å…³æ¨¡å—**: CTP æ’ä»¶ã€Traderã€ç­–ç•¥å¼•æ“

---

## æ¦‚è¿°

ä¿®å¤äº† CTP æŒä»“æˆæœ¬ä»·è·å–é”™è¯¯å¯¼è‡´çš„ P&L è®¡ç®—å¼‚å¸¸é—®é¢˜ã€‚ä¿®å¤å‰ç³»ç»Ÿæ˜¾ç¤ºçº¦ 4000 ä¸‡äºæŸï¼Œä¿®å¤å P&L è®¡ç®—ä¸å®ç›˜å®Œå…¨ä¸€è‡´ã€‚

## é—®é¢˜æè¿°

### ç°è±¡

ç³»ç»Ÿå¯åŠ¨åï¼ŒP&L è®¡ç®—æ˜¾ç¤ºå¼‚å¸¸å¤§çš„äºæŸå€¼ï¼š

```
[PairwiseArb:test_92201] ğŸ“Š Leg1(ag2603) P&L: 20493135.00 (Pos=65, AvgCost=318.40, ...)
[PairwiseArb:test_92201] ğŸ“Š Leg2(ag2605) P&L: -60919430.00 (Pos=-195, AvgCost=106.84, ...)
[PairwiseArb:test_92201] ğŸ’° Total P&L: Unrealized=-40426295.00
```

å®é™…å®ç›˜ P&L åº”è¯¥åœ¨å‡ åä¸‡èŒƒå›´å†…ã€‚

### æ ¹å› åˆ†æ

é—®é¢˜åˆ†ä¸ºä¸¤å±‚ï¼š

#### 1. Go å±‚ï¼šåˆçº¦ä¹˜æ•°æœªè½¬æ¢

CTP è¿”å›çš„ `avg_price` å®é™…ä¸Šæ˜¯ï¼š
```
avg_price = å¼€ä»“æˆæœ¬ / æŒä»“æ•°é‡
         = (å¼€ä»“ä»·æ ¼ Ã— åˆçº¦ä¹˜æ•° Ã— æŒä»“æ•°é‡) / æŒä»“æ•°é‡
         = å¼€ä»“ä»·æ ¼ Ã— åˆçº¦ä¹˜æ•°
```

ä¾‹å¦‚ç™½é“¶åˆçº¦ï¼ˆä¹˜æ•°=15ï¼‰ï¼š
- å®é™…å¼€ä»“ä»·æ ¼ï¼š20862
- CTP è¿”å› avg_priceï¼š312930ï¼ˆ= 20862 Ã— 15ï¼‰

Go ä»£ç ç›´æ¥ä½¿ç”¨ CTP çš„ `avg_price` ä½œä¸ºæˆæœ¬ä»·ï¼Œæœªé™¤ä»¥åˆçº¦ä¹˜æ•°ã€‚

#### 2. C++ å±‚ï¼šä½¿ç”¨äº†é”™è¯¯çš„æˆæœ¬å­—æ®µ

CTP API æœ‰ä¸¤ä¸ªæˆæœ¬å­—æ®µï¼š
- `PositionCost`ï¼šæŒä»“æˆæœ¬ï¼ˆæ˜¨ä»“ä½¿ç”¨**æ˜¨æ—¥ç»“ç®—ä»·**è®¡ç®—ï¼‰
- `OpenCost`ï¼šå¼€ä»“æˆæœ¬ï¼ˆå§‹ç»ˆä½¿ç”¨**å®é™…å¼€ä»“ä»·æ ¼**è®¡ç®—ï¼‰

åŸä»£ç ä½¿ç”¨ `PositionCost`ï¼š
```cpp
pos_info.avg_price = ctp_pos->PositionCost / ctp_pos->Position;
```

å¯¹äºæ˜¨ä»“ï¼Œ`PositionCost` åŸºäºæ˜¨æ—¥ç»“ç®—ä»·è€Œéå¼€ä»“ä»·ï¼Œå¯¼è‡´æˆæœ¬ä»·ä¸å‡†ç¡®ã€‚

| åˆçº¦ | å®ç›˜å¼€ä»“å‡ä»· | PositionCost è½¬æ¢ | OpenCost è½¬æ¢ |
|------|-------------|------------------|---------------|
| ag2603 | 20862 | 20696 âŒ | 20862 âœ“ |
| ag2605 | 20835 | 20834.67 âœ“ | 20834.67 âœ“ |

ag2603 å…¨éƒ¨æ˜¯æ˜¨ä»“ï¼ˆY:65, T:0ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨ `PositionCost` ä¼šå¾—åˆ°é”™è¯¯çš„æˆæœ¬ä»·ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### C++ å±‚ä¿®å¤

**æ–‡ä»¶**: `gateway/plugins/ctp/src/ctp_td_plugin.cpp`

```cpp
// ä¿®å¤å‰
if (ctp_pos->Position > 0) {
    pos_info.avg_price = ctp_pos->PositionCost / ctp_pos->Position;
}

// ä¿®å¤å
// æ³¨æ„ï¼šä½¿ç”¨ OpenCostï¼ˆå¼€ä»“æˆæœ¬ï¼‰è€Œä¸æ˜¯ PositionCostï¼ˆæŒä»“æˆæœ¬ï¼‰
// CTP ä¸­ PositionCost å¯¹äºæ˜¨ä»“ä½¿ç”¨æ˜¨æ—¥ç»“ç®—ä»·ï¼Œè€Œéå®é™…å¼€ä»“ä»·æ ¼
// OpenCost å§‹ç»ˆæ˜¯å®é™…å¼€ä»“ä»·æ ¼ Ã— åˆçº¦ä¹˜æ•° Ã— æ•°é‡
// ä¸ C++ åŸä»£ç ä¸åŒï¼šC++ åªè®¡ç®—å½“å¤©ç›ˆäºï¼ŒGo éœ€è¦å®Œæ•´çš„æµ®åŠ¨ç›ˆäº
if (ctp_pos->Position > 0) {
    pos_info.avg_price = ctp_pos->OpenCost / ctp_pos->Position;
}
```

### Go å±‚ä¿®å¤

**æ–‡ä»¶**: `golang/pkg/trader/trader.go`

åœ¨ `initializeStrategyPositions()` å’Œ `initializeStrategiesWithCTPPositions()` ä¸¤ä¸ªå‡½æ•°ä¸­æ·»åŠ åˆçº¦ä¹˜æ•°è½¬æ¢ï¼š

```go
// CTP è¿”å›çš„ avg_price = PositionCost / Position
// PositionCost = å¼€ä»“ä»·æ ¼ * åˆçº¦ä¹˜æ•° * æŒä»“æ•°é‡
// æ‰€ä»¥ avg_price = å¼€ä»“ä»·æ ¼ * åˆçº¦ä¹˜æ•°
// éœ€è¦é™¤ä»¥åˆçº¦ä¹˜æ•°æ‰èƒ½å¾—åˆ°å®é™…çš„å¼€ä»“ä»·æ ¼
// æ³¨æ„ï¼šæ­¤è½¬æ¢æ˜¯ Go ä»£ç æ–°å¢çš„ï¼ŒC++ åŸä»£ç ä¸­æ˜¨ä»“æˆæœ¬ä¸º 0
avgCost := pos.AvgPrice
multiplier := strategy.GetContractMultiplier(pos.Symbol)
if multiplier > 1 && avgCost > 0 {
    avgCost = avgCost / multiplier
    log.Printf("[Trader] Converted avg_price for %s: raw=%.2f / multiplier=%.0f = %.2f",
        pos.Symbol, pos.AvgPrice, multiplier, avgCost)
}
```

## ä¸ C++ åŸä»£ç çš„å·®å¼‚

æ ¹æ®é¡¹ç›®è§„èŒƒï¼Œéœ€è¦è¯´æ˜ä¸ C++ åŸä»£ç çš„å·®å¼‚ï¼š

| ç‰¹æ€§ | C++ åŸä»£ç  | Go æ–°ä»£ç  |
|------|-----------|----------|
| æ˜¨ä»“æˆæœ¬ | ä¸º 0ï¼ˆä¸è®¡ç®—ï¼‰ | ä½¿ç”¨ CTP OpenCost |
| P&L è®¡ç®—èŒƒå›´ | ä»…å½“å¤©äº¤æ˜“ç›ˆäº | å®Œæ•´æµ®åŠ¨ç›ˆäº |
| æˆæœ¬ä»·æ¥æº | å½“å¤©æˆäº¤å‡ä»· | CTP å®é™…å¼€ä»“ä»· |

**è®¾è®¡è€ƒé‡**ï¼š
- C++ åŸä»£ç è®¾è®¡ä¸ºåªå…³æ³¨å½“å¤©äº¤æ˜“äº§ç”Ÿçš„ç›ˆäº
- Go ä»£ç éœ€è¦å®Œæ•´çš„æµ®åŠ¨ç›ˆäºç”¨äºé£æ§ç›‘æ§å’Œä»“ä½ç®¡ç†
- æ­¤å·®å¼‚å·²åœ¨ä»£ç æ³¨é‡Šä¸­è¯´æ˜

## éªŒè¯ç»“æœ

### ä¿®å¤å‰

| åˆçº¦ | ç³»ç»Ÿ AvgCost | å®ç›˜å¼€ä»“å‡ä»· | ç³»ç»Ÿ P&L |
|------|-------------|-------------|----------|
| ag2603 | 318.40 âŒ | 20862 | +20,493,135 âŒ |
| ag2605 | 106.84 âŒ | 20835 | -60,919,430 âŒ |
| **åˆè®¡** | | | **-40,426,295** âŒ |

### ä¿®å¤å

| åˆçº¦ | ç³»ç»Ÿ AvgCost | å®ç›˜å¼€ä»“å‡ä»· | ç³»ç»Ÿ P&L | å®ç›˜é€ç¬”æµ®ç›ˆ |
|------|-------------|-------------|----------|-------------|
| ag2603 | 20862.07 âœ“ | 20862 | +436,735 | +526,425 |
| ag2605 | 20834.67 âœ“ | 20835 | -264,225 | -489,450 |
| au2604 | 1130.69 âœ“ | 1130.69 | -23,840 | -45,560 |
| au2606 | 1134.03 âœ“ | 1134.03 | -11,970 | -23,520 |

æ³¨ï¼šP&L æ•°å€¼å› å®æ—¶ä»·æ ¼å˜åŒ–è€Œä¸åŒï¼Œä½† AvgCost å®Œå…¨åŒ¹é…ã€‚

### P&L è®¡ç®—éªŒè¯

ä»¥ ag2603 ä¸ºä¾‹ï¼š
```
P&L = (å½“å‰ä»·æ ¼ - æˆæœ¬ä»·) Ã— æŒä»“é‡ Ã— åˆçº¦ä¹˜æ•°
    = (21310 - 20862.07) Ã— 65 Ã— 15
    = 447.93 Ã— 65 Ã— 15
    = 436,732 âœ“
```

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `gateway/plugins/ctp/src/ctp_td_plugin.cpp` | ä½¿ç”¨ OpenCost æ›¿ä»£ PositionCost |
| `golang/pkg/trader/trader.go` | æ·»åŠ åˆçº¦ä¹˜æ•°è½¬æ¢é€»è¾‘ |
| `golang/pkg/strategy/position_persistence.go` | æ·»åŠ  PositionWithCost ç»“æ„å’Œæ¥å£ |
| `golang/pkg/strategy/pairwise_arb_strategy.go` | å®ç° InitializePositionsWithCost æ–¹æ³• |

## æµ‹è¯•è„šæœ¬

```bash
# å¯åŠ¨ CTP å®ç›˜æµ‹è¯•
./scripts/test/e2e/test_ctp_live_e2e.sh --run

# éªŒè¯ P&L è®¡ç®—
curl -s http://localhost:8080/positions | python3 -m json.tool
grep "ğŸ“Š.*P&L" log/trader.test.log | tail -10
```

## å‚è€ƒèµ„æ–™

- CTP API æ–‡æ¡£ï¼š`CThostFtdcInvestorPositionField` ç»“æ„è¯´æ˜
- C++ åŸä»£ç ï¼š`tbsrc/Strategies/ExecutionStrategy.cpp`
- é¡¹ç›®è§„èŒƒï¼š`@.claude/CLAUDE.md` - C++ ä»£ç è¿ç§»è§„åˆ™

---

**æœ€åæ›´æ–°**: 2026-02-11 22:30
