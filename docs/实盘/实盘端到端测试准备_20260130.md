# 实盘端到端测试准备与执行计划

**文档日期**: 2026年01月30日  
**测试类型**: ⚠️ **实盘测试** (连接SimNow/CTP真实交易环境)  
**测试时间**: 夜盘时间 (21:00-02:30)  
**测试品种**: 白银期货 ag2603/ag2605  

---

## ⚠️ 重要提醒

**本次为实盘测试，将连接到真实的CTP交易环境（SimNow或期货公司）**

- ✅ 使用真实CTP行情接口
- ✅ 使用真实CTP交易接口
- ✅ 真实订单报送（可能产生真实成交）
- ⚠️ 需要确认使用测试账户（SimNow）还是真实账户
- ⚠️ 需要设置合理的订单数量和风控参数

---

## 一、实盘测试架构

### 1.1 数据链路对比

**模拟测试**:
```
md_simulator(模拟) → md_gateway → NATS → trader
trader → ors_gateway → counter_gateway(SimulatedCounter) → 模拟成交
```

**实盘测试**:
```
CTP行情服务器 → ctp_md_gateway → md_gateway → NATS → trader
trader → ors_gateway → counter_bridge → CTP交易服务器 → 真实交易所
```

### 1.2 关键组件变化

| 组件 | 模拟测试 | 实盘测试 |
|------|---------|---------|
| 行情来源 | md_simulator | ctp_md_gateway (CTP) |
| 交易网关 | counter_gateway + SimulatedCounter | counter_bridge + CTP插件 |
| 成交延迟 | 固定50ms | 实际延迟（10-500ms） |
| 滑点 | 无 | 存在 |
| 拒单 | 固定2%概率 | 真实风控规则 |

### 1.3 完整链路流程

```
【行情链路 - 实盘】
CTP交易所(真实) → CTP行情前置(tcp://...) → ctp_md_gateway 
  → md_queue(SHM) → md_gateway → NATS(md.SHFE.ag2603) 
  → trader → PairwiseArbStrategy → 计算Z-Score

【订单链路 - 实盘】
PairwiseArbStrategy → trader.SendOrder() → gRPC(localhost:50052)
  → ors_gateway → ors_request(SHM) → counter_bridge 
  → CTP插件 → CTP交易前置 → 交易所

【回报链路 - 实盘】
交易所 → CTP交易前置 → CTP插件.OnRtnOrder() 
  → counter_bridge → ors_response(SHM) → ors_gateway 
  → NATS(order.updates.*) → trader → Strategy.OnOrderUpdate()
```

---

## 二、测试前准备

### 2.1 账户准备

**选项1: SimNow测试环境（推荐）**
- ✅ 7x24小时运行
- ✅ 无资金风险
- ✅ 真实CTP接口
- ⚠️ 需要注册账号: https://www.simnow.com.cn/

**选项2: 期货公司测试环境**
- ✅ 更接近实盘环境
- ⚠️ 可能受交易时段限制
- ⚠️ 需要与期货公司沟通

**选项3: 小资金实盘**
- ⚠️ 真实资金风险
- ⚠️ 需要完成所有测试验证后再使用
- ⚠️ 建议从1-2手开始

### 2.2 配置文件检查

**必需文件清单**:

```bash
# CTP行情配置
config/ctp_md.yaml              # 公开配置
config/ctp_md.secret.yaml       # 账号密码（需创建）

# CTP交易配置  
config/ctp/ctp_td.yaml          # 公开配置
config/ctp/ctp_td.secret.yaml   # 账号密码（需创建）

# 策略配置
config/trader.test.yaml         # 测试配置（已有）
```

**创建secret配置文件**:

```bash
# 1. 创建CTP行情secret配置
cat > config/ctp_md.secret.yaml << 'YAML'
ctp:
  user_id: "your_simnow_user_id"
  password: "your_simnow_password"
  investor_id: "your_simnow_user_id"
YAML

# 2. 创建CTP交易secret配置
cat > config/ctp/ctp_td.secret.yaml << 'YAML'
ctp:
  user_id: "your_simnow_user_id"
  password: "your_simnow_password"
  investor_id: "your_simnow_user_id"
YAML

# 3. 设置权限（防止泄露）
chmod 600 config/ctp_md.secret.yaml
chmod 600 config/ctp/ctp_td.secret.yaml
```

### 2.3 编译CTP插件

```bash
# 进入gateway目录
cd gateway/build

# 编译CTP行情网关
cmake -DENABLE_CTP=ON ..
make ctp_md_gateway

# 编译counter_bridge（包含CTP插件）
make counter_bridge

# 验证编译结果
ls -lh ctp_md_gateway counter_bridge
```

### 2.4 策略参数调整

**实盘测试建议参数**:

编辑 `config/trader.test.yaml`:

```yaml
strategies:
  - id: "test_92201"
    type: "pairwise_arb"
    enabled: true
    allocation: 0.5
    symbols:
      - "ag2603"
      - "ag2605"
    exchanges:
      - "SHFE"
    max_position_size: 10      # 限制最大持仓10手
    
    parameters:
      entry_zscore: 2.0        # 提高阈值（更保守）
      exit_zscore: 0.5         # 提高出场阈值
      order_size: 1.0          # 改为1手（降低风险）
      min_correlation: 0.7     # 提高相关系数要求
```

**关键参数对比**:

| 参数 | 模拟测试 | 实盘测试 | 说明 |
|------|---------|---------|------|
| entry_zscore | 0.5 | 2.0 | 提高入场阈值，减少交易频率 |
| order_size | 10手 | 1手 | 降低单笔风险 |
| min_correlation | 0.3 | 0.7 | 确保品种相关性 |
| max_position_size | 100手 | 10手 | 限制总持仓 |

---

## 三、测试执行步骤

### 3.1 启动测试环境

使用提供的脚本启动完整链路：

```bash
# 1. 确保NATS运行
nats-server &

# 2. 执行实盘测试脚本
./test_ctp_e2e_full.sh
```

脚本会依次启动：
1. CTP行情网关 (ctp_md_gateway)
2. 行情转发网关 (md_gateway)
3. 订单路由网关 (ors_gateway)
4. CTP交易桥接 (counter_bridge)
5. 策略引擎 (trader)

### 3.2 验证各组件状态

```bash
# 检查所有进程
ps aux | grep -E "ctp_md|md_gateway|ors_gateway|counter_bridge|trader" | grep -v grep

# 查看CTP行情网关日志
tail -f log/ctp_md_gateway.log

# 查看counter_bridge日志
tail -f log/counter_bridge.log

# 查看trader日志
tail -f log/trader.test.log
```

**检查要点**:

✅ CTP行情网关:
```
[CTPMDGateway] Connected to front server
[CTPMDGateway] Login successful
[CTPMDGateway] Subscribed: ag2603, ag2605
[CTPMDGateway] OnRtnDepthMarketData: ag2603 ...
```

✅ counter_bridge:
```
[Main] Loading broker: ctp
[Main] ✅ CTP plugin initialized and logged in
[Main] ✅ Counter bridge ready
```

✅ trader:
```
[StrategyEngine] Connected to NATS
[StrategyEngine] Subscribed to market data: ag2603
[StrategyEngine] Received market data: ag2603 (bid: ..., ask: ...)
```

### 3.3 激活策略（谨慎）

⚠️ **在激活前务必确认**:
- [ ] CTP登录成功
- [ ] 行情数据正常接收
- [ ] 订单大小设置为1手
- [ ] 入场阈值设置为2.0（保守）
- [ ] 最大持仓限制已设置

```bash
# 等待所有组件启动完成（至少5秒）
sleep 5

# 检查策略状态
curl http://localhost:9201/api/v1/strategy/status | jq .

# 激活策略
curl -X POST http://localhost:9201/api/v1/strategy/activate \
  -H "Content-Type: application/json" \
  -d '{"strategy_id": "test_92201"}'
```

### 3.4 监控测试运行

```bash
# 监控订单生成
tail -f log/trader.test.log | grep "Order sent"

# 监控订单回报
tail -f log/counter_bridge.log | grep "OnRtnOrder"

# 监控持仓更新
tail -f log/trader.test.log | grep "position updated"

# 查看实时统计
watch -n 1 'curl -s http://localhost:9201/api/v1/strategy/status | jq ".data.indicators"'
```

---

## 四、测试场景

### 4.1 场景1: 连接测试（10分钟）

**目标**: 验证CTP连接和行情接收

**步骤**:
1. 启动所有组件
2. 等待CTP登录成功
3. 观察行情数据接收
4. **不激活策略**
5. 验证数据流正常

**预期结果**:
- ✅ CTP登录成功
- ✅ 行情数据持续接收
- ✅ md_gateway转发正常
- ✅ trader接收行情正常

### 4.2 场景2: 单笔订单测试（20分钟）

**目标**: 验证订单完整流程

**配置**:
```yaml
parameters:
  entry_zscore: 0.5    # 临时降低阈值便于触发
  order_size: 1.0      # 1手
```

**步骤**:
1. 激活策略
2. 等待触发信号（z-score > 0.5）
3. 观察订单发送
4. 观察CTP回报
5. 验证持仓更新
6. 停用策略

**预期结果**:
- ✅ 订单发送成功
- ✅ CTP接受订单
- ✅ 订单成交（或部分成交）
- ✅ 持仓正确更新
- ✅ Dashboard实时显示

### 4.3 场景3: 持续运行测试（1小时）

**目标**: 验证系统稳定性

**配置**:
```yaml
parameters:
  entry_zscore: 2.0    # 保守阈值
  order_size: 1.0      # 1手
  max_position_size: 5 # 限制5手
```

**步骤**:
1. 激活策略
2. 持续运行1小时
3. 定期检查日志
4. 记录统计数据
5. 停用策略

**监控指标**:
- 订单数量
- 成交率
- 持仓情况
- 盈亏情况
- 错误日志

---

## 五、风险控制

### 5.1 实盘测试风险等级

| 风险项 | 等级 | 控制措施 |
|--------|------|----------|
| 资金风险 | 🔴 高 | 使用SimNow测试环境 |
| 滑点风险 | 🟡 中 | 1手起测，观察实际滑点 |
| 系统风险 | 🟡 中 | 完整日志，便于问题定位 |
| 网络风险 | 🟡 中 | 监控断线重连 |

### 5.2 紧急停止措施

**立即停止所有交易**:

```bash
# 方法1: 停用策略（推荐）
curl -X POST http://localhost:9201/api/v1/strategy/deactivate \
  -H "Content-Type: application/json" \
  -d '{"strategy_id": "test_92201"}'

# 方法2: 停止trader进程
pkill trader

# 方法3: 停止所有进程
pkill -f 'ctp_md_gateway|md_gateway|ors_gateway|counter_bridge|trader'

# 方法4: 使用停止脚本
./stop_ctp_e2e.sh
```

**平仓持仓**:

如果有未平仓位：
1. 登录CTP交易客户端
2. 手动平仓
3. 或使用CTP API发送平仓指令

### 5.3 异常处理

**常见问题**:

1. **CTP登录失败**
   - 检查账号密码
   - 检查网络连接
   - 确认front_addr正确

2. **订单被拒**
   - 检查资金是否充足
   - 检查持仓限额
   - 查看拒单原因

3. **行情断线**
   - CTP会自动重连
   - 观察重连日志
   - 必要时重启ctp_md_gateway

4. **策略异常**
   - 查看trader日志
   - 停用策略
   - 分析错误原因

---

## 六、测试记录模板

### 6.1 测试前检查表

```
[ ] SimNow账号已注册并测试
[ ] secret配置文件已创建
[ ] 策略参数已调整为保守值
[ ] NATS服务已启动
[ ] CTP插件已编译
[ ] 日志目录已创建
[ ] 停止脚本已准备
[ ] 了解紧急停止措施
```

### 6.2 测试执行记录

```
测试日期: ____年__月__日 __:__
测试场景: [ ] 连接测试 [ ] 单笔订单 [ ] 持续运行
测试环境: [ ] SimNow [ ] 期货公司测试 [ ] 小资金实盘

启动时间: __:__
停止时间: __:__
测试时长: ____分钟

CTP登录: [ ] 成功 [ ] 失败 原因:________
行情接收: [ ] 正常 [ ] 异常 原因:________
订单发送: [ ] 成功 [ ] 失败 数量:___笔
订单成交: [ ] 成功 [ ] 部分 [ ] 失败 成交:___笔
持仓管理: [ ] 正确 [ ] 错误 最终持仓:________

遇到的问题:
1. 
2. 
3. 

改进建议:
1. 
2. 
3. 
```

---

## 七、下一步计划

### 7.1 短期（本次测试）
1. ✅ 准备测试环境和配置
2. ⏭️ 执行连接测试（10分钟）
3. ⏭️ 执行单笔订单测试（20分钟）
4. ⏭️ 生成实盘测试报告

### 7.2 中期（1-2周）
1. 修复发现的问题
2. 多次重复测试验证
3. 测试不同市场状况
4. 完善错误处理

### 7.3 长期（1个月）
1. 增加测试品种
2. 测试异常场景（断线、拒单等）
3. 性能优化
4. 准备小资金实盘

---

**文档版本**: v1.0  
**创建时间**: 2026年01月30日 00:31  
**适用环境**: SimNow/CTP实盘测试

