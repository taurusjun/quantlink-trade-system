# 持仓概念澄清

**时间**: 2026-01-30 11:25
**问题**: 持仓的定义是什么？

---

## 📖 持仓的本质定义

### 正确的定义

**持仓（Position）** = **在交易所/柜台（CTP）实际持有的合约数量**

**特征**:
- ✅ 这是**唯一的真相来源（Source of Truth）**
- ✅ 由交易所/CTP柜台维护和结算
- ✅ 是最终盈亏计算、保证金占用、强平的依据
- ✅ 需要通过**查询接口**从CTP获取

**例子**:
```
CTP柜台记录：
  - ag2603: Long 4 lots, 开仓均价 29500
  - au2604: Short 2 lots, 开仓均价 1170.5

这才是"持仓"
```

---

## ❌ 我之前的误解

### 我错误地认为的"持仓"

**策略内部追踪的持仓状态**:
```go
// BaseStrategy.Position
type Position struct {
    LongQty  int64
    ShortQty int64
    NetQty   int64
    AvgLongPrice  float64
    AvgShortPrice float64
}
```

**这不是真正的持仓！**

这只是：
- **策略的持仓估算（Position Estimation）**
- **策略的内部记账（Internal Bookkeeping）**
- 从订单回报推算出来的
- 可能与真实持仓**不一致**

### 为什么会不一致？

| 场景 | 策略追踪 | 真实持仓 | 结果 |
|------|---------|---------|------|
| **正常成交** | +4 lots | +4 lots | ✅ 一致 |
| **部分成交** | +4 lots | +2 lots | ❌ 不一致 |
| **订单拒单** | +4 lots | 0 lots | ❌ 不一致 |
| **策略重启** | 0 lots | +4 lots | ❌ 不一致 |
| **手动平仓** | +4 lots | 0 lots | ❌ 不一致 |
| **回报丢失** | +2 lots | +4 lots | ❌ 不一致 |

---

## 🔍 正确的持仓管理架构

### 层次1: 真实持仓（Source of Truth）

**位置**: CTP柜台

**查询方式**:
```
Trader → Counter Bridge → CTP API → QueryPosition()
```

**返回数据**:
```cpp
struct PositionInfo {
    string symbol;           // 合约代码
    Direction direction;     // 多/空
    int64 volume;           // 持仓量
    double open_cost;       // 开仓成本
    double position_profit; // 持仓盈亏
    double margin;          // 占用保证金
    string trading_day;     // 交易日
}
```

**特点**:
- ✅ 这是唯一真相
- ✅ 用于最终结算
- ⚠️ 查询有延迟（网络+CTP响应）
- ⚠️ 不能频繁查询（API限流）

### 层次2: 策略持仓估算（Estimation）

**位置**: Strategy.Position

**更新方式**: 从订单回报计算
```go
// 订单成交回报
OnOrderUpdate(update) {
    if update.Status == FILLED {
        if update.Side == BUY {
            Position.LongQty += update.FilledQty
        }
    }
}
```

**特点**:
- ✅ 实时更新（毫秒级）
- ✅ 用于策略决策
- ❌ 可能不准确（见上表）
- ⚠️ 需要定期同步校验

### 层次3: 持仓同步与校验

**目的**: 确保策略估算 ≈ 真实持仓

**方法**:
```
定期（每5分钟）:
  1. 查询CTP真实持仓
  2. 对比策略估算持仓
  3. 如果不一致:
     - 记录告警日志
     - 策略持仓 = 真实持仓（强制同步）
     - 可选：停止策略交易
```

---

## 🎯 持仓管理的核心问题

### 问题：谁负责查询真实持仓？

**选项1**: Counter Bridge提供HTTP接口 ❌
- 职责混乱（主职责是订单转发）
- HTTP服务实现有问题（超时）
- **您的质疑是对的**

**选项2**: ORS Gateway提供gRPC接口 ✅
- 职责清晰（订单路由层）
- 可以转发查询请求到Counter Bridge
- gRPC接口更高效

**选项3**: Trader直接连接CTP ❌
- 需要额外的CTP连接
- 违背了Gateway架构

**推荐**: 选项2（ORS Gateway提供查询接口）

### 问题：持仓查询的频率？

**启动时** (必须):
- 查询真实持仓
- 传递给策略初始化
- 防止重启后持仓丢失

**运行时** (可选):
- 定期查询（每5分钟）
- 与策略估算对比
- 发现不一致时告警/同步

**不应该**:
- ❌ 每笔订单都查询（太慢）
- ❌ 实时查询用于策略决策（延迟高）

---

## 📊 正确的持仓使用场景

### 场景1: 策略决策（实时）

**使用**: 策略估算持仓
```go
// 策略内部
if pas.leg1Position > 0 {
    // 已有多头持仓，考虑平仓
    generateExitSignal()
}
```

**原因**: 需要实时性，策略估算足够

### 场景2: 风控检查（实时）

**使用**: 策略估算持仓
```go
// 风控
if totalPosition > maxPositionSize {
    rejectOrder("Position limit exceeded")
}
```

**原因**: 需要实时性，策略估算足够（略保守更安全）

### 场景3: 启动初始化（一次性）

**使用**: 查询真实持仓
```go
// Trader启动时
ctpPositions := queryCTPPositions()
for _, pos := range ctpPositions {
    strategy.InitializePosition(pos.Symbol, pos.Volume)
}
```

**原因**: 恢复真实状态，防止持仓丢失

### 场景4: 定期校验（5分钟）

**使用**: 查询真实持仓 vs 策略估算
```go
// 定期任务
ctpPos := queryCTPPositions()
strategyPos := getStrategyPosition()

if abs(ctpPos - strategyPos) > tolerance {
    log.Warn("Position mismatch!")
    strategy.SyncPosition(ctpPos)  // 强制同步
}
```

**原因**: 发现漂移，及时修正

### 场景5: 盈亏结算（日终）

**使用**: 查询真实持仓
```go
// 日终
ctpPositions := queryCTPPositions()
calculateDailyPnL(ctpPositions)
```

**原因**: 最终结算必须基于真实持仓

---

## 🔄 持仓数据流

### 正确的数据流

```
[真实持仓 - CTP柜台]
    ↓ 查询（启动时、定期）
[Trader持仓缓存]
    ↓ 初始化
[策略估算持仓]
    ↑ 更新（订单回报）
[订单成交回报]
```

### 关键点

1. **真实持仓是唯一真相** - 来自CTP
2. **策略估算持仓用于决策** - 实时但可能不准
3. **定期同步校验** - 防止漂移
4. **启动时必须查询** - 恢复历史持仓

---

## 📝 总结

### 持仓的定义

**持仓** = 在CTP柜台实际持有的合约数量

**不是**:
- ❌ 策略内部的Position字段
- ❌ 从订单回报推算的数量
- ❌ 待成交的订单数量

### 持仓的来源

**唯一真相来源**: CTP柜台
- 查询方式: QueryPositions() API
- 查询频率: 启动时 + 定期（5分钟）
- 查询接口: 应该由ORS Gateway提供（不是Counter Bridge）

### 策略持仓的本质

**策略.Position** = 持仓估算（Estimation）
- 从订单回报计算
- 用于实时决策
- 需要定期与真实持仓同步
- 可能不准确（部分成交、拒单、重启、手动操作）

---

## 🎯 回答您的问题

**Q: 持仓的定义是什么？**

**A**:
- **持仓** = 在CTP柜台实际持有的合约数量（唯一真相）
- **策略.Position** = 策略从订单回报推算的持仓估算（可能不准）
- 应该定期查询真实持仓，与策略估算对比同步

**Q: 在counter_bridge查询持仓合理吗？**

**A**:
- ❌ 让Counter Bridge提供HTTP查询接口不合理（职责混乱）
- ✅ 应该由ORS Gateway提供gRPC查询接口
- ✅ 或者Trader启动时查询后传递给策略

---

**澄清时间**: 2026-01-30 11:25
**结论**: 我之前混淆了"真实持仓"和"策略估算"

