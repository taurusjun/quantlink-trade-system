# 使用实盘配置启动系统

## 快速开始

### 1. 停止当前测试系统
```bash
# 停用所有策略
for id in test_92201 test_92202 test_92203; do
  curl -X POST http://localhost:9201/api/v1/strategies/$id/deactivate
done

# 停止trader
pkill trader

# 停止所有网关（可选，如需重启）
pkill ctp_md_gateway
pkill md_gateway
pkill ors_gateway
pkill counter_bridge
```

### 2. 编译最新代码
```bash
cd golang
go build -o ../bin/trader cmd/trader/main.go
cd ..
```

### 3. 使用实盘配置启动
```bash
# 启动网关（如果未运行）
./start_live_test.sh

# 或者手动启动trader
./bin/trader -config config/trader.live.yaml
```

### 4. 验证启动

**查看持仓查询日志**:
```bash
tail -f log/trader.live.log | grep -E "Position|持仓"
```

预期看到：
```
[Trader] Querying initial positions from broker...
[Trader] ✓ Loaded 3 positions from 1 exchanges
[Trader] Position Summary:
[Trader] SHFE Exchange:
[Trader]   - ag2603 long: 4 lots ...
```

**查看策略参数**:
```bash
tail -f log/trader.live.log | grep "Initialized"
```

预期看到：
```
[PairwiseArbStrategy:live_ag_spread] Initialized ag2603/ag2605, entry_z=2.50, exit_z=0.80, lookback=200, slippage=2 ticks
```

### 5. 激活策略
```bash
# 激活白银策略
curl -X POST http://localhost:9201/api/v1/strategies/live_ag_spread/activate

# 激活黄金策略
curl -X POST http://localhost:9201/api/v1/strategies/live_au_spread/activate
```

### 6. 监控运行

**实时订单**:
```bash
tail -f log/trader.live.log | grep "Order sent"
```

**策略统计**:
```bash
tail -f log/trader.live.log | grep "Stats:"
```

**价格验证**（确保tick size对齐）:
```bash
# 查看订单价格
tail -f log/trader.live.log | grep "Order sent" | tail -5

# 检查价格：
# 白银（ag）应该是整数：31120, 31121 ✅
# 黄金（au）应该是0.02的倍数：1191.84, 1191.86 ✅
```

---

## 重要参数说明

### 实盘配置 vs 测试配置

| 参数 | 测试配置 | 实盘配置 | 说明 |
|------|---------|---------|------|
| entry_zscore | 0.5 | 2.5 | 降低交易频率 |
| min_correlation | 0.0 | 0.7 | 要求高相关性 |
| order_size | 1 | 2 | 适度增加规模 |
| slippage_ticks | 0 | 2 | 提高成交率 |
| max_drawdown | 10k | 50k | 更合理的风控 |

### 新增参数

```yaml
# 滑点设置
parameters:
  slippage_ticks: 2           # 滑点(tick数)
  use_market_price: false     # false=限价单, true=对手价

# 品种规格
instruments:
  ag2603:
    tick_size: 1.0            # 白银tick size
  au2604:
    tick_size: 0.02           # 黄金tick size
```

---

## 验证清单

启动后检查：

- [ ] 持仓查询成功（日志显示"✓ Loaded N positions"）
- [ ] 策略参数正确（entry_zscore=2.50）
- [ ] Tick size已配置（slippage=2 ticks）
- [ ] 策略激活成功（active=true）
- [ ] 订单价格合理（在市价±1%内）
- [ ] 价格tick size对齐（白银整数，黄金0.02倍数）

---

## 风险提示

⚠️ **首次使用注意事项**：

1. **小规模测试**: 先用10-20%资金测试
2. **持仓核对**: 启动后立即核对持仓是否正确
3. **价格监控**: 观察前几笔订单价格是否合理
4. **止损设置**: 确认风控参数符合你的风险承受能力

---

## 问题排查

### 问题1: 持仓查询失败

**现象**: 日志显示 "Warning: Failed to query initial positions"

**原因**: CTP连接未就绪或counter_bridge未启动

**解决**:
```bash
# 检查counter_bridge
ps aux | grep counter_bridge

# 如果未运行，启动它
./gateway/build/counter_bridge ctp:config/ctp/ctp_td.yaml &
```

### 问题2: 订单仍被拒绝

**现象**: 日志显示 "REJECTED"

**检查**:
1. 价格是否是tick size的倍数？
2. 委托价格是否偏离市价太远？
3. 品种代码是否正确？

**查看拒单原因**:
```bash
grep "REJECTED" log/trader.live.log | tail -5
```

### 问题3: 策略不产生信号

**原因**: 实盘配置更保守（entry_zscore=2.5）

**正常情况**: 信号频率会大幅降低

**验证策略计算**:
```bash
tail -f log/trader.live.log | grep "Stats:"
```

看到类似输出即表示正常：
```
[PairwiseArb:live_ag_spread] Stats: zscore=1.25 (need ±2.50), corr=0.850 (need 0.700), ready=true, condMet=false
```

---

## 配置文件

- **实盘配置**: `config/trader.live.yaml`
- **测试配置**: `config/trader.test.yaml`
- **详细说明**: `docs/实盘问题修复报告_2026-01-30-10_50.md`

---

**创建时间**: 2026-01-30 10:50
**适用版本**: v1.0+
