# QuantLink Trade System 部署运行指南

**文档日期**: 2026-02-10
**版本**: v1.0

---

## 概述

本文档介绍如何部署和运行 QuantLink Trade System，包括：
- 编译构建
- 配置文件准备
- CTP 账号配置
- 启动和停止服务
- 常见问题排查

---

## 1. 编译构建

### 1.1 一键构建部署包

```bash
cd /Users/user/PWorks/RD/quantlink-trade-system

# 完整编译（C++ 网关 + Go 策略）
./scripts/build_deploy.sh

# 仅编译 Go 组件（快速）
./scripts/build_deploy.sh --go

# 仅编译 C++ 组件
./scripts/build_deploy.sh --cpp

# 清理后重新编译
./scripts/build_deploy.sh --clean
```

构建完成后，所有文件会打包到 `deploy/` 目录。

### 1.2 部署目录结构

```
deploy/
├── bin/                        # 可执行文件
│   ├── trader                  # Go 策略引擎
│   ├── md_gateway              # 行情网关
│   ├── md_simulator            # 行情模拟器（测试用）
│   ├── ors_gateway             # 订单路由网关
│   ├── counter_bridge          # 成交网关（支持 CTP/Simulator）
│   └── ctp_md_gateway          # CTP 行情网关
├── config/                     # 配置文件
│   ├── trader.yaml             # 生产配置
│   ├── trader.test.yaml        # 测试配置
│   └── ctp/                    # CTP 配置目录
│       ├── ctp_md.yaml         # CTP 行情配置模板
│       ├── ctp_td.yaml         # CTP 交易配置模板
│       ├── ctp_md.secret.yaml  # CTP 行情配置（含账号）
│       └── ctp_td.secret.yaml  # CTP 交易配置（含账号）
├── golang/web/                 # Web 资源
│   ├── dashboard.html          # 监控面板
│   └── control.html            # 控制面板
├── data/positions/             # 持仓快照目录
├── log/                        # 日志目录
└── scripts/                    # 启动脚本
    ├── start_ctp.sh            # 启动 CTP 实盘环境
    ├── start_simulator.sh      # 启动模拟环境
    └── stop_all.sh             # 停止所有服务
```

---

## 2. 配置文件准备

### 2.1 CTP 账号配置

#### 创建 CTP 行情配置

```bash
cd deploy/config/ctp

# 复制模板
cp ctp_md.yaml ctp_md.secret.yaml

# 编辑配置
vim ctp_md.secret.yaml
```

**ctp_md.secret.yaml 示例**:

```yaml
# CTP 行情配置
ctp:
  # SimNow 模拟环境
  front_addr: "tcp://180.168.146.187:10211"  # SimNow 行情前置
  broker_id: "9999"
  user_id: "你的资金账号"
  password: "你的密码"
  app_id: "simnow_client_test"
  auth_code: "0000000000000000"

  # 订阅合约
  instruments:
    - "ag2603"
    - "ag2605"
    - "au2604"
    - "au2606"

# 共享内存配置
shm:
  queue_name: "queue"
  queue_size: 10000
```

#### 创建 CTP 交易配置

```bash
cp ctp_td.yaml ctp_td.secret.yaml
vim ctp_td.secret.yaml
```

**ctp_td.secret.yaml 示例**:

```yaml
# CTP 交易配置
ctp:
  # SimNow 模拟环境
  front_addr: "tcp://180.168.146.187:10201"  # SimNow 交易前置
  broker_id: "9999"
  user_id: "你的资金账号"
  password: "你的密码"
  app_id: "simnow_client_test"
  auth_code: "0000000000000000"

# HTTP 服务（用于持仓查询）
http:
  port: 8080
```

### 2.2 策略配置

编辑 `config/trader.test.yaml`（测试）或 `config/trader.yaml`（生产）：

```yaml
# 系统配置
system:
  mode: "live"
  multi_strategy: true

# 策略配置
strategies:
  - id: "test_92201"
    type: "pairwise_arb"
    enabled: true
    symbols:
      - "ag2603"
      - "ag2605"
    parameters:
      entry_zscore: 0.5
      exit_zscore: 0.2
      # ... 其他参数

# 风控配置（重要！）
risk:
  max_drawdown: 100000000.0    # 设置大值相当于禁用
  stop_loss: 100000000.0
  max_loss: 100000000.0
  daily_loss_limit: 100000000.0
```

### 2.3 配置文件安全

**重要**: secret 文件包含敏感信息，确保：

1. 添加到 `.gitignore`：
```
config/ctp/*.secret.yaml
```

2. 设置文件权限：
```bash
chmod 600 config/ctp/*.secret.yaml
```

---

## 3. 启动服务

### 3.1 CTP 实盘环境

```bash
cd deploy

# 1. 启动 CTP 网关和交易服务
./scripts/start_ctp.sh

# 2. 启动策略（会提示确认）
./bin/trader -config config/trader.test.yaml

# 或后台运行
./bin/trader -config config/trader.test.yaml >> log/trader.log 2>&1 &
```

### 3.2 模拟测试环境

```bash
cd deploy

# 1. 启动模拟环境（使用模拟行情）
./scripts/start_simulator.sh

# 2. 启动策略
./bin/trader -config config/trader.test.yaml
```

### 3.3 访问监控面板

启动后访问：
- **Dashboard**: http://localhost:9201/dashboard
- **API Health**: http://localhost:9201/api/v1/health
- **策略状态**: http://localhost:9201/api/v1/strategy/status

### 3.4 停止服务

```bash
./scripts/stop_all.sh
```

---

## 4. 运行架构

### 4.1 CTP 实盘架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  CTP 行情服务器  │────▶│ ctp_md_gateway  │────▶│   md_gateway    │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                              [SHM]                      │ [NATS]
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  CTP 交易服务器  │◀───│ counter_bridge  │◀───│     trader      │
└─────────────────┘     └────────┬────────┘     └────────┬────────┘
                              [SHM]                      │ [gRPC]
                                │                        ▼
                                └───────────────▶│  ors_gateway   │
                                                 └─────────────────┘
```

### 4.2 进程说明

| 进程 | 端口 | 说明 |
|------|------|------|
| nats-server | 4222 | 消息队列 |
| ctp_md_gateway | - | CTP 行情接收 |
| md_gateway | - | 行情分发（共享内存→NATS）|
| ors_gateway | 50052 | 订单路由（gRPC）|
| counter_bridge | 8080 | 成交网关、持仓查询 |
| trader | 9201 | 策略引擎、HTTP API |

---

## 5. 日志查看

```bash
# 策略日志
tail -f log/trader.test.log

# CTP 行情日志
tail -f log/ctp_md_gateway.*.log

# 成交日志
tail -f log/counter_bridge.*.log

# 查看错误
grep -E "ERROR|FAIL|EMERGENCY" log/*.log
```

---

## 6. 常见问题

### 6.1 Dashboard 无法访问

**现象**: http://localhost:9201/dashboard 返回 404

**解决**:
```bash
# 确保 web 资源存在
ls -la golang/web/dashboard.html

# 如果不存在，从主项目复制
mkdir -p golang/web
cp /path/to/quantlink-trade-system/golang/web/*.html golang/web/
```

### 6.2 风控频繁触发

**现象**: 日志显示 `EMERGENCY STOP triggered`，`exceeds limit 0.00`

**原因**: 风控参数默认值为 0，会立即触发

**解决**: 在 `config/trader.test.yaml` 中设置大值：
```yaml
risk:
  max_drawdown: 100000000.0
  stop_loss: 100000000.0
  max_loss: 100000000.0
```

### 6.3 持仓不匹配

**现象**: 启动时报 `Position mismatch on startup`

**解决**:
```bash
# 删除旧的持仓快照，使用 CTP 查询的持仓
rm -f data/positions/*.json
```

### 6.4 CTP 连接失败

**检查**:
1. 确认 CTP 配置文件路径正确
2. 确认 SimNow 交易时段（周一至周五 9:00-15:00, 21:00-02:30）
3. 检查网络连接

```bash
# 查看 CTP 日志
tail -f log/ctp_md_gateway.*.log
tail -f log/counter_bridge.*.log
```

### 6.5 共享内存错误

**解决**:
```bash
# 清理共享内存
ipcs -m | grep $(whoami) | awk '{print $2}' | xargs -I{} ipcrm -m {}

# 重启服务
./scripts/stop_all.sh
./scripts/start_ctp.sh
```

---

## 7. 部署到服务器

```bash
# 打包 deploy 目录
cd /path/to/quantlink-trade-system
tar -czvf quantlink-deploy.tar.gz deploy/

# 传输到服务器
scp quantlink-deploy.tar.gz user@server:/opt/

# 在服务器上解压
ssh user@server
cd /opt
tar -xzvf quantlink-deploy.tar.gz
cd deploy

# 配置 CTP 账号
cp config/ctp/ctp_md.yaml config/ctp/ctp_md.secret.yaml
cp config/ctp/ctp_td.yaml config/ctp/ctp_td.secret.yaml
vim config/ctp/ctp_md.secret.yaml
vim config/ctp/ctp_td.secret.yaml

# 启动
./scripts/start_ctp.sh
./bin/trader -config config/trader.yaml
```

---

## 8. 相关脚本

| 脚本 | 说明 |
|------|------|
| `scripts/build_deploy.sh` | 编译并打包部署 |
| `scripts/start_ctp.sh` | 启动 CTP 实盘环境 |
| `scripts/start_simulator.sh` | 启动模拟环境 |
| `scripts/stop_all.sh` | 停止所有服务 |

---

**最后更新**: 2026-02-10
