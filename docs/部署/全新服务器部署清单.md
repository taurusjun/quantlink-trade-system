# 全新服务器部署 - 需要手动准备的文件清单

**文档日期**: 2026-02-12

---

## 概述

运行 `./scripts/build_deploy.sh` 会自动生成 `deploy/` 目录，包含可执行文件、脚本和配置模板。
但以下文件**不会自动生成**，需要根据实际情况手动创建或从现有环境复制。

---

## 1. CTP 账号配置文件 (必须)

这些文件包含 CTP 账号密码等敏感信息，**绝不能提交到 Git**。

| 文件路径 | 说明 | 创建方式 |
|---------|------|---------|
| `config/ctp/ctp_md.secret.yaml` | CTP 行情账号配置 | `cp config/ctp/ctp_md.yaml config/ctp/ctp_md.secret.yaml` 后编辑 |
| `config/ctp/ctp_td.secret.yaml` | CTP 交易账号配置 | `cp config/ctp/ctp_td.yaml config/ctp/ctp_td.secret.yaml` 后编辑 |

**配置示例** (`ctp_md.secret.yaml`):
```yaml
ctp:
  front_addr: "tcp://180.168.146.187:10211"  # SimNow 行情前置
  broker_id: "9999"
  user_id: "你的资金账号"
  password: "你的密码"
  app_id: "simnow_client_test"
  auth_code: "0000000000000000"
  instruments:
    - "ag2603"
    - "ag2605"
shm:
  queue_name: "queue"
  queue_size: 10000
```

---

## 2. 实盘数据目录 (必须)

策略运行需要的持仓和均值数据。

| 文件/目录 | 说明 | 创建方式 |
|----------|------|---------|
| `data/live/` | 实盘数据目录 | `mkdir -p data/live/positions` |
| `data/live/daily_init.<strategyID>` | 每日初始化文件 | 手动创建，见下方格式 |
| `data/simulation/` | 模拟盘数据目录 | `mkdir -p data/simulation/positions` |

**daily_init 文件格式**:
```
StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2 
<hash_id> 0 0.0 <leg1_symbol> <leg2_symbol> <leg1_pos> <leg2_pos>
```

**示例** (白银策略，已有持仓):
```
StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2 
184289369 0 0.0 ag2603 ag2605 65 -195
```

**策略 ID 计算方法**:
```go
// hash("live_ag") -> int32 = 184289369
// hash("live_au") -> int32 = 184289383
// hash("test_92201") -> int32 = 2014849549
```

---

## 3. 实盘策略配置文件 (必须)

根据实际持仓和交易需求定制的配置。

| 文件路径 | 说明 | 创建方式 |
|---------|------|---------|
| `config/trader.live.yaml` | 实盘主配置 | 从模板复制并修改策略参数 |
| `config/trader.live.day.yaml` | 日盘配置 | 根据交易时段定制 |
| `config/trader.live.night.yaml` | 夜盘配置 | 根据交易时段定制 |

**关键配置项**:
```yaml
system:
  mode: "live"
  data_dir: "data/live"  # 实盘数据目录

strategies:
  - id: "live_ag"
    enabled: true
    symbols: ["ag2603", "ag2605"]
    max_position_size: 200
    parameters:
      aggressive_enabled: false  # 谨慎起见，先禁用追单
```

---

## 4. Control 文件 (可选，传统模式)

如果使用 Control 文件模式启动策略，需要准备：

| 文件路径 | 说明 |
|---------|------|
| `controls/day/control.<symbols>.<strategyID>` | 日盘控制文件 |
| `controls/night/control.<symbols>.<strategyID>` | 夜盘控制文件 |

**注意**: 新版本推荐使用 YAML 配置文件模式，Control 文件模式为向后兼容。

---

## 5. Model 文件 (可选，热加载)

如果启用模型热加载功能：

| 文件路径 | 说明 |
|---------|------|
| `models/model.<symbols>.<strategyID>` | 策略参数文件 |

---

## 6. 模拟器配置 (仅模拟环境)

| 文件路径 | 说明 | 创建方式 |
|---------|------|---------|
| `config/simulator.yaml` | 模拟器配置 | 脚本自动生成或从模板复制 |

---

## 快速部署清单

### 全新服务器部署步骤

```bash
# 1. 运行构建脚本
./scripts/build_deploy.sh

# 2. 进入部署目录
cd deploy

# 3. 创建 CTP 配置（必须）
cp config/ctp/ctp_md.yaml config/ctp/ctp_md.secret.yaml
cp config/ctp/ctp_td.yaml config/ctp/ctp_td.secret.yaml
# 编辑填入账号密码
vim config/ctp/ctp_md.secret.yaml
vim config/ctp/ctp_td.secret.yaml

# 4. 创建数据目录（必须）
mkdir -p data/live/positions
mkdir -p data/simulation/positions

# 5. 创建 daily_init 文件（根据实际持仓）
# 空仓示例：
echo "StrategyID 2day avgPx m_origbaseName1 m_origbaseName2 ytd1 ytd2 
184289369 0 0.0 ag2603 ag2605 0 0" > data/live/daily_init.184289369

# 6. 检查/修改实盘配置
vim config/trader.live.yaml

# 7. 启动测试（模拟环境）
./scripts/start_simulator.sh
./bin/trader -config config/trader.test.yaml

# 8. 启动实盘（CTP 环境）
./scripts/start_ctp.sh
./bin/trader -config config/trader.live.yaml
```

---

## 文件清单总结

| 类别 | 文件 | 自动生成 | 需手动创建 |
|------|------|---------|-----------|
| **CTP 配置** | `config/ctp/ctp_md.secret.yaml` | ❌ | ✅ 必须 |
| **CTP 配置** | `config/ctp/ctp_td.secret.yaml` | ❌ | ✅ 必须 |
| **数据目录** | `data/live/` | ❌ | ✅ 必须 |
| **数据目录** | `data/live/daily_init.*` | ❌ | ✅ 必须 |
| **数据目录** | `data/simulation/` | ❌ | ✅ 必须 |
| **实盘配置** | `config/trader.live.yaml` | ✅ 模板 | ⚠️ 需修改 |
| **Control** | `controls/*/control.*` | ❌ | ⚠️ 可选 |
| **Model** | `models/model.*` | ❌ | ⚠️ 可选 |
| **可执行文件** | `bin/*` | ✅ | - |
| **启动脚本** | `scripts/*` | ✅ | - |
| **CTP 模板** | `config/ctp/*.yaml` | ✅ | - |

---

**注意事项**:
1. `.secret.yaml` 文件包含敏感信息，**绝不能提交到 Git**
2. `daily_init` 文件中的持仓数据必须与 CTP 实际持仓一致
3. 首次部署建议先用模拟环境测试，确认无误后再连接实盘
