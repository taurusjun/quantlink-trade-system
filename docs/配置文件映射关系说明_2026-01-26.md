# 配置文件映射关系说明

**文档日期**: 2026-01-26
**版本**: v1.0
**适用范围**: QuantlinkTrader 新旧系统配置兼容

---

## 目录

1. [配置文件概览](#一配置文件概览)
2. [新系统：YAML配置](#二新系统yaml配置)
3. [旧系统：Control + Model配置](#三旧系统control--model配置)
4. [YAML ↔ Control 映射关系](#四yaml--control-映射关系)
5. [YAML ↔ Model 映射关系](#五yaml--model-映射关系)
6. [完整配置示例对比](#六完整配置示例对比)
7. [配置转换逻辑](#七配置转换逻辑)
8. [Model热加载配置](#八model热加载配置)

---

## 一、配置文件概览

### 1.1 新系统配置方式

```
新系统 (YAML模式)
└── trader.yaml          # 单一配置文件，包含所有配置
    ├── system           # 系统配置
    ├── strategy         # 策略配置
    │   ├── parameters   # 策略参数（嵌入在YAML中）
    │   └── model_file   # 可选：外部model文件路径（用于热加载）
    ├── session          # 交易时段
    ├── risk             # 风险管理
    ├── engine           # 引擎配置
    ├── portfolio        # 组合管理
    ├── api              # API配置
    └── logging          # 日志配置
```

**特点**:
- ✅ 单文件配置，结构清晰
- ✅ 支持嵌入式参数配置
- ✅ 可选支持外部model文件热加载
- ✅ 现代化YAML格式

**启动方式**:
```bash
./bin/trader --config config/trader.yaml
```

### 1.2 旧系统配置方式（Legacy模式）

```
旧系统 (Legacy模式)
├── control.txt          # 控制文件（8字段单行）
│   ├── 符号1            # 交易品种1
│   ├── model路径        # Model文件路径
│   ├── 交易所          # 交易所
│   ├── 策略类型        # 策略类型代码
│   ├── 开始时间        # 交易开始时间
│   ├── 结束时间        # 交易结束时间
│   └── 符号2            # 交易品种2
└── model.par.txt        # 参数文件（KEY VALUE格式）
    ├── BEGIN_PLACE      # 入场参数
    ├── BEGIN_REMOVE     # 出场参数
    ├── SIZE             # 订单大小
    ├── MAX_SIZE         # 最大持仓
    ├── STOP_LOSS        # 止损
    └── ...              # 其他参数
```

**特点**:
- ⚠️ 双文件配置，需要同步维护
- ⚠️ 固定格式，不够灵活
- ✅ 旧系统用户熟悉
- ✅ 支持热加载（新系统兼容）

**启动方式**:
```bash
./bin/trader --Live --controlFile control.txt --strategyID 92201
```

---

## 二、新系统：YAML配置

### 2.1 YAML配置文件结构

```yaml
# trader.yaml 完整结构

# ═══════════════════════════════════════════════════════════
# System Configuration - 系统配置
# ═══════════════════════════════════════════════════════════
system:
  strategy_id: "92201"              # 策略ID（对应旧系统 --strategyID）
  mode: "live"                      # 运行模式（对应旧系统 --Live/--Backtest/--Simulation）

# ═══════════════════════════════════════════════════════════
# Strategy Configuration - 策略配置
# ═══════════════════════════════════════════════════════════
strategy:
  type: "pairwise_arb"              # 策略类型（对应control文件第5字段）
  symbols:                          # 交易品种（对应control文件第1、8字段）
    - "ag2502"
    - "ag2504"
  exchanges:                        # 交易所（对应control文件第3字段）
    - "SHFE"
  max_position_size: 50             # 最大持仓（对应model文件 MAX_SIZE）
  max_exposure: 1000000.0           # 最大风险敞口（对应model文件 MAX_EXPOSURE）

  # 策略参数（两种配置方式）
  # 方式1: 嵌入式参数（推荐）
  parameters:
    entry_zscore: 2.0               # 对应 model 文件 BEGIN_PLACE
    exit_zscore: 0.5                # 对应 model 文件 BEGIN_REMOVE
    order_size: 10                  # 对应 model 文件 SIZE
    lookback_period: 100            # 对应 model 文件 LOOKBACK_PERIOD

  # 方式2: 外部model文件（用于热加载）
  model_file: "./models/model.par.txt"    # Model文件路径（对应control文件第2字段）
  hot_reload:
    enabled: true                   # 启用热加载

# ═══════════════════════════════════════════════════════════
# Trading Session Configuration - 交易时段配置
# ═══════════════════════════════════════════════════════════
session:
  start_time: "09:00:00"            # 开始时间（对应control文件第6字段）
  end_time: "15:00:00"              # 结束时间（对应control文件第7字段）
  timezone: "Asia/Shanghai"         # 时区
  auto_start: false                 # 自动启动
  auto_stop: true                   # 自动停止
  auto_activate: false              # 自动激活（推荐false，手动激活更安全）

# ═══════════════════════════════════════════════════════════
# Risk Management Configuration - 风险管理配置
# ═══════════════════════════════════════════════════════════
risk:
  max_drawdown: 10000.0             # 最大回撤
  stop_loss: 50000.0                # 止损（对应model文件 STOP_LOSS）
  max_loss: 100000.0                # 最大亏损（对应model文件 MAX_LOSS）
  daily_loss_limit: 200000.0        # 每日亏损限制
  max_reject_count: 10              # 最大拒单次数
  check_interval_ms: 5000           # 风控检查间隔（毫秒）

# ═══════════════════════════════════════════════════════════
# Strategy Engine Configuration - 策略引擎配置
# ═══════════════════════════════════════════════════════════
engine:
  ors_gateway_addr: "localhost:50051"   # ORS网关地址
  nats_addr: "nats://localhost:4222"    # NATS地址
  order_queue_size: 100                 # 订单队列大小
  timer_interval: 5s                    # 定时器间隔
  max_concurrent_orders: 10             # 最大并发订单

# ═══════════════════════════════════════════════════════════
# Portfolio Management Configuration - 组合管理配置
# ═══════════════════════════════════════════════════════════
portfolio:
  total_capital: 1000000.0              # 总资金
  strategy_allocation:
    "92201": 0.5                        # 策略资金分配
  rebalance_interval_sec: 0             # 再平衡间隔
  min_allocation: 0.0                   # 最小分配
  max_allocation: 1.0                   # 最大分配
  enable_auto_rebalance: false          # 自动再平衡
  enable_correlation_calc: true         # 相关性计算

# ═══════════════════════════════════════════════════════════
# API Configuration - API配置
# ═══════════════════════════════════════════════════════════
api:
  enabled: true                         # 启用API
  port: 9201                            # API端口
  host: "localhost"                     # API地址

# ═══════════════════════════════════════════════════════════
# Logging Configuration - 日志配置
# ═══════════════════════════════════════════════════════════
logging:
  level: "info"                         # 日志级别
  file: "./log/trader.92201.log"        # 日志文件
  max_size_mb: 100                      # 最大文件大小
  max_backups: 10                       # 备份数量
  max_age_days: 30                      # 保留天数
  compress: true                        # 压缩
  console: true                         # 控制台输出
  json_format: false                    # JSON格式
```

---

## 三、旧系统：Control + Model配置

### 3.1 Control文件格式

**文件名**: `control.{symbol1}.{symbol2}.txt`
**格式**: 单行，8个字段，空格分隔

```
字段1      字段2                    字段3  字段4  字段5           字段6  字段7  字段8
ag_F_2_SFE ./models/model.xxx.par.txt SFE    4      TB_PAIR_STRAT   0900   1500   ag_F_4_SFE
```

**字段说明**:

| 字段位置 | 字段名称 | 说明 | 示例 | 对应YAML |
|---------|---------|------|------|---------|
| 1 | 符号1 | 第一个交易品种（内部格式） | `ag_F_2_SFE` | `strategy.symbols[0]` |
| 2 | Model路径 | Model参数文件路径 | `./models/model.xxx.par.txt` | `strategy.model_file` |
| 3 | 交易所 | 交易所代码 | `SFE` | `strategy.exchanges[0]` |
| 4 | 保留字段 | 通常为数字（4） | `4` | - |
| 5 | 策略类型 | 策略类型代码 | `TB_PAIR_STRAT` | `strategy.type` |
| 6 | 开始时间 | 交易开始时间（HHMM格式） | `0900` | `session.start_time` |
| 7 | 结束时间 | 交易结束时间（HHMM格式） | `1500` | `session.end_time` |
| 8 | 符号2 | 第二个交易品种（内部格式） | `ag_F_4_SFE` | `strategy.symbols[1]` |

**符号格式转换规则**:

```
内部格式: ag_F_2_SFE  →  标准格式: ag2502
          │   │ │  │              ││  ││
          │   │ │  └─ 交易所       ││  │└─ 月份 (02)
          │   │ └─ 月份 (2)        ││  └─ 年份简写 (25)
          │   └─ 期货标识 (F)      │└─ 品种代码 (ag)
          └─ 品种代码 (ag)         └─ 品种代码

转换公式: {品种}_F_{月份}_{交易所} → {品种}25{月份补零}
```

**策略类型映射**:

| 旧系统类型 | 新系统类型 | 说明 |
|-----------|-----------|------|
| `TB_PAIR_STRAT` | `pairwise_arb` | 配对套利策略 |
| `TB_HEDGE_STRAT` | `hedging` | 对冲策略 |
| `TB_PASSIVE_STRAT` | `passive` | 被动做市策略 |
| `TB_AGGRESSIVE_STRAT` | `aggressive` | 主动做市策略 |

### 3.2 Model文件格式

**文件名**: `model.{description}.par.txt`
**格式**: 多行，KEY VALUE格式

```
# model.xxx.par.txt

BEGIN_PLACE 2.0
BEGIN_REMOVE 0.5
SIZE 10
MAX_SIZE 50
STOP_LOSS 50000
MAX_LOSS 100000
MAX_EXPOSURE 500000
LOOKBACK_PERIOD 60

# 可选参数
LONG_PLACE 2.0
LONG_REMOVE 0.5
SHORT_PLACE 2.0
SHORT_REMOVE 0.5
HEDGE_RATIO 1.0
MIN_CORRELATION 0.7
USE_COINTEGRATION 0
SPREAD_TYPE 0
```

**参数说明**:

| Model参数 | 类型 | 说明 | 有效范围 | 对应YAML字段 |
|----------|------|------|---------|-------------|
| `BEGIN_PLACE` | float | 入场Z-Score阈值 | [0, 10] | `strategy.parameters.entry_zscore` |
| `BEGIN_REMOVE` | float | 出场Z-Score阈值 | [0, 10] | `strategy.parameters.exit_zscore` |
| `SIZE` | int | 单次订单数量 | [1, 1000] | `strategy.parameters.order_size` |
| `MAX_SIZE` | int | 最大持仓数量 | [1, 1000] | `strategy.max_position_size` |
| `STOP_LOSS` | float | 止损金额 | ≥ 0 | `risk.stop_loss` |
| `MAX_LOSS` | float | 最大亏损限制 | ≥ 0 | `risk.max_loss` |
| `MAX_EXPOSURE` | float | 最大风险敞口 | ≥ 0 | `strategy.max_exposure` |
| `LOOKBACK_PERIOD` | int | 回溯周期 | ≥ 1 | `strategy.parameters.lookback_period` |
| `LONG_PLACE` | float | 做多入场阈值 | [0, 10] | `strategy.parameters.long_entry_zscore` |
| `LONG_REMOVE` | float | 做多出场阈值 | [0, 10] | `strategy.parameters.long_exit_zscore` |
| `SHORT_PLACE` | float | 做空入场阈值 | [0, 10] | `strategy.parameters.short_entry_zscore` |
| `SHORT_REMOVE` | float | 做空出场阈值 | [0, 10] | `strategy.parameters.short_exit_zscore` |
| `HEDGE_RATIO` | float | 对冲比率 | > 0 | `strategy.parameters.hedge_ratio` |
| `MIN_CORRELATION` | float | 最小相关系数 | [0, 1] | `strategy.parameters.min_correlation` |
| `USE_COINTEGRATION` | int | 是否使用协整 | 0/1 | `strategy.parameters.use_cointegration` |
| `SPREAD_TYPE` | int | 价差类型 | 0/1/2 | `strategy.parameters.spread_type` |

**SPREAD_TYPE映射**:

| Model值 | 新系统值 | 说明 |
|--------|---------|------|
| `0` | `"difference"` | 价差（A-B） |
| `1` | `"ratio"` | 比率（A/B） |
| `2` | `"log"` | 对数（ln(A/B)） |

---

## 四、YAML ↔ Control 映射关系

### 4.1 完整映射表

| Control文件字段 | YAML字段路径 | 转换规则 | 示例 |
|----------------|-------------|---------|------|
| 字段1: 符号1 | `strategy.symbols[0]` | 内部格式 → 标准格式 | `ag_F_2_SFE` → `ag2502` |
| 字段2: Model路径 | `strategy.model_file` | 直接映射 | `./models/model.xxx.par.txt` |
| 字段3: 交易所 | `strategy.exchanges[0]` | 直接映射 | `SFE` → `SHFE` |
| 字段4: 保留 | - | 忽略 | `4` |
| 字段5: 策略类型 | `strategy.type` | 类型代码转换 | `TB_PAIR_STRAT` → `pairwise_arb` |
| 字段6: 开始时间 | `session.start_time` | HHMM → HH:MM:SS | `0900` → `09:00:00` |
| 字段7: 结束时间 | `session.end_time` | HHMM → HH:MM:SS | `1500` → `15:00:00` |
| 字段8: 符号2 | `strategy.symbols[1]` | 内部格式 → 标准格式 | `ag_F_4_SFE` → `ag2504` |

### 4.2 示例转换

**Control文件输入**:
```
ag_F_2_SFE ./models/model.test.par.txt SFE 4 TB_PAIR_STRAT 0900 1500 ag_F_4_SFE
```

**转换为YAML**:
```yaml
strategy:
  type: "pairwise_arb"              # TB_PAIR_STRAT → pairwise_arb
  symbols:
    - "ag2502"                      # ag_F_2_SFE → ag2502
    - "ag2504"                      # ag_F_4_SFE → ag2504
  exchanges:
    - "SHFE"                        # SFE (可能需要映射到标准名称)
  model_file: "./models/model.test.par.txt"

session:
  start_time: "09:00:00"            # 0900 → 09:00:00
  end_time: "15:00:00"              # 1500 → 15:00:00
  timezone: "Asia/Shanghai"         # 默认值
```

---

## 五、YAML ↔ Model 映射关系

### 5.1 策略参数映射表

| Model文件参数 | YAML参数路径 | 数据类型 | 示例转换 |
|--------------|-------------|---------|---------|
| `BEGIN_PLACE` | `strategy.parameters.entry_zscore` | float | `2.0` → `entry_zscore: 2.0` |
| `BEGIN_REMOVE` | `strategy.parameters.exit_zscore` | float | `0.5` → `exit_zscore: 0.5` |
| `SIZE` | `strategy.parameters.order_size` | int | `10` → `order_size: 10` |
| `MAX_SIZE` | `strategy.max_position_size` | int | `50` → `max_position_size: 50` |
| `MAX_EXPOSURE` | `strategy.max_exposure` | float | `1000000` → `max_exposure: 1000000.0` |
| `LOOKBACK_PERIOD` | `strategy.parameters.lookback_period` | int | `60` → `lookback_period: 60` |
| `HEDGE_RATIO` | `strategy.parameters.hedge_ratio` | float | `1.0` → `hedge_ratio: 1.0` |
| `MIN_CORRELATION` | `strategy.parameters.min_correlation` | float | `0.7` → `min_correlation: 0.7` |
| `USE_COINTEGRATION` | `strategy.parameters.use_cointegration` | bool | `1` → `use_cointegration: true` |
| `SPREAD_TYPE` | `strategy.parameters.spread_type` | string | `0` → `spread_type: "difference"` |
| `LONG_PLACE` | `strategy.parameters.long_entry_zscore` | float | `2.0` → `long_entry_zscore: 2.0` |
| `LONG_REMOVE` | `strategy.parameters.long_exit_zscore` | float | `0.5` → `long_exit_zscore: 0.5` |
| `SHORT_PLACE` | `strategy.parameters.short_entry_zscore` | float | `2.0` → `short_entry_zscore: 2.0` |
| `SHORT_REMOVE` | `strategy.parameters.short_exit_zscore` | float | `0.5` → `short_exit_zscore: 0.5` |

### 5.2 风控参数映射表

| Model文件参数 | YAML参数路径 | 数据类型 | 示例转换 |
|--------------|-------------|---------|---------|
| `STOP_LOSS` | `risk.stop_loss` | float | `50000` → `stop_loss: 50000.0` |
| `MAX_LOSS` | `risk.max_loss` | float | `100000` → `max_loss: 100000.0` |

### 5.3 示例转换

**Model文件输入**:
```
BEGIN_PLACE 2.0
BEGIN_REMOVE 0.5
SIZE 10
MAX_SIZE 50
STOP_LOSS 50000
MAX_LOSS 100000
MAX_EXPOSURE 500000
LOOKBACK_PERIOD 60
HEDGE_RATIO 1.0
MIN_CORRELATION 0.7
USE_COINTEGRATION 0
SPREAD_TYPE 0
```

**转换为YAML**:
```yaml
strategy:
  max_position_size: 50             # MAX_SIZE
  max_exposure: 500000.0            # MAX_EXPOSURE
  parameters:
    entry_zscore: 2.0               # BEGIN_PLACE
    exit_zscore: 0.5                # BEGIN_REMOVE
    order_size: 10                  # SIZE
    lookback_period: 60             # LOOKBACK_PERIOD
    hedge_ratio: 1.0                # HEDGE_RATIO
    min_correlation: 0.7            # MIN_CORRELATION
    use_cointegration: false        # USE_COINTEGRATION (0 → false)
    spread_type: "difference"       # SPREAD_TYPE (0 → "difference")

risk:
  stop_loss: 50000.0                # STOP_LOSS
  max_loss: 100000.0                # MAX_LOSS
```

---

## 六、完整配置示例对比

### 6.1 旧系统配置（Legacy模式）

**control.ag.txt**:
```
ag_F_2_SFE ./models/model.ag.par.txt SFE 4 TB_PAIR_STRAT 0900 1500 ag_F_4_SFE
```

**models/model.ag.par.txt**:
```
BEGIN_PLACE 2.0
BEGIN_REMOVE 0.5
SIZE 10
MAX_SIZE 50
STOP_LOSS 50000
MAX_LOSS 100000
MAX_EXPOSURE 500000
LOOKBACK_PERIOD 60
HEDGE_RATIO 1.0
MIN_CORRELATION 0.7
USE_COINTEGRATION 0
SPREAD_TYPE 0
```

**启动命令**:
```bash
./bin/trader --Live --controlFile control.ag.txt --strategyID 92201
```

### 6.2 新系统配置（YAML模式）

**config/trader.yaml**:
```yaml
system:
  strategy_id: "92201"
  mode: "live"

strategy:
  type: "pairwise_arb"
  symbols:
    - "ag2502"
    - "ag2504"
  exchanges:
    - "SHFE"
  max_position_size: 50
  max_exposure: 500000.0

  # 方式1: 嵌入式参数（推荐）
  parameters:
    entry_zscore: 2.0
    exit_zscore: 0.5
    order_size: 10
    lookback_period: 60
    hedge_ratio: 1.0
    min_correlation: 0.7
    use_cointegration: false
    spread_type: "difference"

session:
  start_time: "09:00:00"
  end_time: "15:00:00"
  timezone: "Asia/Shanghai"
  auto_start: false
  auto_stop: true
  auto_activate: false

risk:
  stop_loss: 50000.0
  max_loss: 100000.0
  daily_loss_limit: 200000.0
  max_reject_count: 10
  check_interval_ms: 5000

engine:
  ors_gateway_addr: "localhost:50051"
  nats_addr: "nats://localhost:4222"
  order_queue_size: 100
  timer_interval: 5s
  max_concurrent_orders: 10

portfolio:
  total_capital: 1000000.0
  strategy_allocation:
    "92201": 0.5
  rebalance_interval_sec: 0
  enable_auto_rebalance: false
  enable_correlation_calc: true

api:
  enabled: true
  port: 9201
  host: "localhost"

logging:
  level: "info"
  file: "./log/trader.92201.log"
  max_size_mb: 100
  max_backups: 10
  max_age_days: 30
  compress: true
  console: true
  json_format: false
```

**启动命令**:
```bash
./bin/trader --config config/trader.yaml
```

### 6.3 新系统配置（YAML + Model文件）

**config/trader.yaml** (启用热加载):
```yaml
system:
  strategy_id: "92201"
  mode: "live"

strategy:
  type: "pairwise_arb"
  symbols:
    - "ag2502"
    - "ag2504"
  exchanges:
    - "SHFE"
  max_position_size: 50              # 也可以从model文件读取
  max_exposure: 500000.0             # 也可以从model文件读取

  # 方式2: 外部model文件（用于热加载）
  model_file: "./models/model.ag.par.txt"
  hot_reload:
    enabled: true

session:
  start_time: "09:00:00"
  end_time: "15:00:00"
  timezone: "Asia/Shanghai"
  auto_start: false
  auto_stop: true
  auto_activate: false

risk:
  stop_loss: 50000.0                 # 也可以从model文件读取
  max_loss: 100000.0                 # 也可以从model文件读取
  # ... 其他配置
```

**models/model.ag.par.txt** (与旧系统相同):
```
BEGIN_PLACE 2.0
BEGIN_REMOVE 0.5
SIZE 10
# ... 其他参数
```

**启动命令**:
```bash
./bin/trader --config config/trader.yaml
```

**热加载命令**:
```bash
# 修改model文件后
curl -X POST http://localhost:9201/api/v1/model/reload
```

---

## 七、配置转换逻辑

### 7.1 Legacy模式自动转换流程

```
启动命令: ./bin/trader --Live --controlFile control.txt --strategyID 92201
                         │
                         ├─ 检测到 --controlFile 参数
                         │
                         v
                   进入 Legacy 兼容模式
                         │
                         ├─ 1. 解析 control 文件
                         │    ├─ 读取 8 个字段
                         │    ├─ 符号格式转换
                         │    ├─ 策略类型转换
                         │    └─ 时间格式转换
                         │
                         ├─ 2. 解析 model 文件
                         │    ├─ 读取 KEY VALUE 参数
                         │    ├─ 参数类型转换
                         │    └─ 参数验证
                         │
                         ├─ 3. 转换为 TraderConfig
                         │    ├─ system: 设置 strategy_id, mode
                         │    ├─ strategy: 设置 type, symbols, parameters
                         │    ├─ session: 设置 start_time, end_time
                         │    ├─ risk: 设置 stop_loss, max_loss
                         │    ├─ engine: 使用默认值
                         │    ├─ portfolio: 使用默认值
                         │    ├─ api: 自动计算端口 (9200 + ID后两位)
                         │    ├─ logging: 生成旧系统格式日志名
                         │    └─ hot_reload: 自动启用
                         │
                         ├─ 4. 应用命令行覆盖
                         │    ├─ --Live → mode: "live"
                         │    ├─ --strategyID → strategy_id
                         │    ├─ --logFile → logging.file
                         │    └─ 其他参数...
                         │
                         v
                   正常启动 trader（与YAML模式相同流程）
```

### 7.2 转换代码位置

**主要转换文件**:
- `golang/pkg/config/control_parser.go`: Control文件解析
- `golang/pkg/config/model_parser.go`: Model文件解析
- `golang/pkg/config/legacy_converter.go`: 配置转换逻辑
- `golang/cmd/trader/main.go`: 模式检测和启动

**核心函数**:
```go
// 解析control文件
func ParseControlFile(filePath string) (*ControlFile, error)

// 解析model文件
func (p *ModelFileParser) Parse() (map[string]interface{}, error)

// 转换model参数到策略参数
func ConvertModelToStrategyParams(modelParams map[string]interface{}) map[string]interface{}

// 转换整体配置
func ConvertLegacyToTraderConfig(
    controlFile *ControlFile,
    strategyID string,
    mode string,
    logFile string,
) (*TraderConfig, error)
```

---

## 八、Model热加载配置

### 8.1 新系统YAML模式启用热加载

```yaml
strategy:
  # 指定model文件路径
  model_file: "./models/model.par.txt"

  # 启用热加载
  hot_reload:
    enabled: true
```

**启动后**:
```bash
# 查看当前参数
curl http://localhost:9201/api/v1/model/status

# 修改model文件
vim ./models/model.par.txt

# 触发热加载
curl -X POST http://localhost:9201/api/v1/model/reload

# 验证更新
curl http://localhost:9201/api/v1/model/status
```

### 8.2 Legacy模式自动启用热加载

**启动命令**:
```bash
./bin/trader --Live --controlFile control.txt --strategyID 92201
```

**系统自动**:
1. 从control文件读取model路径（字段2）
2. 自动设置 `strategy.model_file`
3. 自动启用 `strategy.hot_reload.enabled: true`
4. 自动计算API端口（9200 + strategyID后两位）

**热加载使用**:
```bash
# 修改model文件
vim ./models/model.xxx.par.txt

# 触发热加载
curl -X POST http://localhost:9201/api/v1/model/reload
```

### 8.3 热加载API端点

| API端点 | 方法 | 说明 |
|--------|------|------|
| `/api/v1/model/status` | GET | 查看当前参数和状态 |
| `/api/v1/model/reload` | POST | 触发手动重载 |
| `/api/v1/model/history` | GET | 查看重载历史（最近10次） |

### 8.4 热加载参数优先级

当同时配置了YAML参数和model文件时：

1. **启动时**:
   - 如果YAML中有`parameters`，使用YAML参数
   - 如果配置了`model_file`，从model文件加载参数（覆盖YAML）

2. **运行时热加载**:
   - 只更新`strategy.parameters`中的参数
   - 不更新`strategy.max_position_size`、`strategy.max_exposure`等顶层字段
   - 不更新`risk.*`等其他模块配置

**推荐做法**:
- ✅ 使用YAML嵌入参数 + 禁用热加载（简单场景）
- ✅ 使用model文件 + 启用热加载（需要频繁调参）
- ⚠️ 避免同时使用YAML参数和model文件（容易混淆）

---

## 九、配置最佳实践

### 9.1 新系统推荐配置

**场景1: 稳定策略，不需要频繁调参**
```yaml
strategy:
  parameters:           # 嵌入式参数
    entry_zscore: 2.0
    exit_zscore: 0.5
    # ... 其他参数
  # 不配置 model_file
```

**场景2: 测试策略，需要频繁调参**
```yaml
strategy:
  model_file: "./models/model.test.par.txt"
  hot_reload:
    enabled: true
  # 不配置 parameters（从model文件读取）
```

### 9.2 Legacy模式迁移建议

**方案1: 继续使用Legacy模式（零修改）**
```bash
# 旧系统启动方式完全兼容
./bin/trader --Live --controlFile control.txt --strategyID 92201

# 自动支持热加载
curl -X POST http://localhost:9201/api/v1/model/reload
```

**方案2: 迁移到YAML模式（推荐）**
```bash
# 1. 转换配置（手动或自动）
# 将control.txt + model.par.txt → trader.yaml

# 2. 使用新系统启动
./bin/trader --config trader.yaml

# 3. 可选：保留model文件用于热加载
# 在YAML中配置 model_file 和 hot_reload
```

### 9.3 配置文件组织

```
config/
├── trader.yaml              # 生产配置（YAML模式）
├── trader.test.yaml         # 测试配置（YAML模式）
├── control.ag.txt           # Legacy control文件
└── models/
    ├── model.ag.par.txt     # Legacy model文件
    └── model.cu.par.txt     # Legacy model文件
```

---

## 十、常见问题

### Q1: YAML模式和Legacy模式可以同时使用吗？

**答**: 不可以。系统启动时只能选择一种模式：
- 如果提供 `--controlFile`，进入Legacy模式
- 如果提供 `--config`，进入YAML模式
- 不能同时提供两者

### Q2: Legacy模式能使用所有YAML配置吗？

**答**: Legacy模式会自动生成完整的TraderConfig，但部分高级功能使用默认值：
- ✅ 策略参数：完整支持（从model文件读取）
- ✅ 交易时段：完整支持（从control文件读取）
- ✅ 热加载：自动启用
- ⚠️ Portfolio配置：使用默认值
- ⚠️ Engine配置：使用默认值

### Q3: 如何知道当前使用的是哪种模式？

**答**: 查看启动日志：

**Legacy模式**:
```
[Main] ════════════════════════════════════════════════════════════
[Main] Running in LEGACY COMPATIBILITY MODE
[Main] Converting old system config to new format...
[Main] ════════════════════════════════════════════════════════════
```

**YAML模式**:
```
[Main] Loading configuration from: ./config/trader.yaml
[Main] ✓ Configuration loaded successfully
```

### Q4: Model文件的参数是否必须全部提供？

**答**: 只有部分参数是必须的：
- ✅ 必须参数: `BEGIN_PLACE`, `BEGIN_REMOVE`
- ⚠️ 推荐参数: `SIZE`, `MAX_SIZE`, `STOP_LOSS`, `MAX_LOSS`
- ⏸️ 可选参数: 其他参数有默认值

### Q5: 热加载会影响正在运行的订单吗？

**答**: 不会。热加载只更新参数，不影响：
- ✅ 已发送的订单（继续执行）
- ✅ 已建立的连接（NATS、gRPC）
- ✅ 当前持仓（Position）
- ⚠️ 新订单使用新参数

---

## 附录A: 快速参考

### A.1 启动方式对比

| 模式 | 启动命令 | 配置文件 |
|------|---------|---------|
| YAML模式 | `./bin/trader --config trader.yaml` | 单文件YAML |
| Legacy模式 | `./bin/trader --Live --controlFile control.txt --strategyID 92201` | control + model |

### A.2 参数名称对照表（简化版）

| Model参数 | YAML参数 | 说明 |
|----------|---------|------|
| `BEGIN_PLACE` | `entry_zscore` | 入场阈值 |
| `BEGIN_REMOVE` | `exit_zscore` | 出场阈值 |
| `SIZE` | `order_size` | 订单大小 |
| `MAX_SIZE` | `max_position_size` | 最大持仓 |
| `STOP_LOSS` | `stop_loss` | 止损 |
| `MAX_LOSS` | `max_loss` | 最大亏损 |

### A.3 API端口计算

**Legacy模式**: `端口 = 9200 + strategyID后两位`

示例:
- strategyID = **92201** → 端口 = **9201**
- strategyID = **92210** → 端口 = **9210**

**YAML模式**: 在`api.port`中配置

---

**文档版本**: v1.0
**最后更新**: 2026-01-26
**维护者**: Claude Code

*本文档详细说明了新旧系统的配置映射关系，供用户迁移和日常使用参考。*
