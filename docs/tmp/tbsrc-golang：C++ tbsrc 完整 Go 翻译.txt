tbsrc-golang：C++ tbsrc 完整 Go 翻译（独立项目，SHM 直连，取代 golang/）                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ Context                                                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ quantlink-trade-system/golang/ 中的策略代码与 C++ 原代码（tbsrc/）存在根本性架构偏离（Z-Score vs EWMA、双腿同时下单 vs 被动+主动、撤单未实现、对冲延迟等）。决定新建独立项目 tbsrc-golang，从 C++ 逐行翻译，不依赖任何现有 │
     │  Go 代码，最终删除 golang/ 目录。                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 核心原则：                                                                                                                                                                                                                 │
     │ - 方法名、字段名尽可能与 C++ 一致                                                                                                                                                                                          │
     │ - CommonClient 直接翻译为 Go，不发明新的 StrategyEngine 抽象                                                                                                                                                               │
     │ - 所有参数从配置读取，不自设默认值                                                                                                                                                                                         │
     │ - SHM 直连：Go trader 直接读写 POSIX 共享内存，与 C++ 网关用相同的 SPSC 队列通信，不经过 NATS/gRPC                                                                                                                         │
     │ - CentOS 兼容：POSIX SHM、纯 Go syscall（无 CGO）、支持 GOOS=linux GOARCH=amd64 交叉编译                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ 架构变化                                                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 原 golang/ 架构（5 进程）                                                                                                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │ md_simulator → [SHM] → md_gateway → [NATS] → golang_trader → [gRPC] → ors_gateway → [SHM] → counter_bridge                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ 新 tbsrc-golang 架构（与 C++ 一致：共享 MWMR 队列）                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │                                     ┌── go_trader(92201)                                                                                                                                                                   │
     │ md_simulator/ctp_md_gateway ──→     │                                                                                                                                                                                      │
     │   [MWMR: /hft_md_queue]     ──→    ├── go_trader(93201)    ──→ [MWMR: /hft_ors_request] ──→ counter_bridge                                                                                                                 │
     │                              ──→    │                       ←── [MWMR: /hft_ors_response] ←──  ├→ CTP                                                                                                                      │
     │                                     └── go_trader(41231)                                        └→ XTP                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ 与 C++ 完全一致：                                                                                                                                                                                                          │
     │ - 一组 MWMR 队列，所有 trader 共享（通过 atomic fetch_add 保证并发安全）                                                                                                                                                   │
     │ - 每个 trader 通过 ClientStore 获取唯一 clientId，OrderID = clientId * 1,000,000 + seq                                                                                                                                     │
     │ - 读回报时按 clientId 过滤，只处理自己的订单                                                                                                                                                                               │
     │ - counter_bridge 内部按 symbol/exchange 路由到对应 broker plugin                                                                                                                                                           │
     │ - 省去了 md_gateway 和 ors_gateway，Go trader 直接读写 SHM                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ 项目位置与结构                                                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ /Users/user/PWorks/RD/quantlink-trade-system/                                                                                                                                                                              │
     │ ├── gateway/                  # C++ 网关（不动）                                                                                                                                                                           │
     │ │   ├── include/shm_queue.h   # SHM 结构定义（Go 需严格对齐）                                                                                                                                                              │
     │ │   └── include/ors_gateway.h # OrderRequestRaw/ResponseRaw 定义                                                                                                                                                           │
     │ ├── golang/                   # 旧 Go 代码（最终删除）                                                                                                                                                                     │
     │ ├── tbsrc-golang/             # ★ 新项目                                                                                                                                                                                   │
     │ │   ├── go.mod                # module tbsrc-golang                                                                                                                                                                        │
     │ │   ├── cmd/                                                                                                                                                                                                               │
     │ │   │   ├── trader/                                                                                                                                                                                                        │
     │ │   │   │   └── main.go       # ← main.cpp 翻译                                                                                                                                                                            │
     │ │   │   └── offset_check/                                                                                                                                                                                                  │
     │ │   │       └── main.go       # struct offset 验证工具                                                                                                                                                                     │
     │ │   ├── pkg/                                                                                                                                                                                                               │
     │ │   │   ├── shm/              # ★ POSIX SHM + SPSC Queue（核心）                                                                                                                                                           │
     │ │   │   │   ├── queue.go      #    SPSCQueue[T] 泛型实现                                                                                                                                                                   │
     │ │   │   │   ├── manager.go    #    ShmManager: Create/Open/Close                                                                                                                                                           │
     │ │   │   │   ├── types.go      #    MarketDataRaw/OrderRequestRaw/OrderResponseRaw                                                                                                                                          │
     │ │   │   │   └── queue_test.go #    SHM 读写 + 结构对齐测试                                                                                                                                                                 │
     │ │   │   ├── common/           # ← CommonClient.cpp 翻译                                                                                                                                                                    │
     │ │   │   │   ├── client.go     #    CommonClient struct + 核心分发                                                                                                                                                          │
     │ │   │   │   └── signals.go    #    信号处理（SIGTSTP/SIGUSR1/SIGUSR2）                                                                                                                                                     │
     │ │   │   ├── connector/        # ← Connector 翻译（SHM 版本）                                                                                                                                                               │
     │ │   │   │   └── connector.go  #    SHM 轮询 + 发单/撤单                                                                                                                                                                    │
     │ │   │   ├── strategy/         # ← Strategies/ 翻译                                                                                                                                                                         │
     │ │   │   │   ├── execution_strategy.go  # ExecutionStrategy 基类                                                                                                                                                            │
     │ │   │   │   ├── extra_strategy.go      # ExtraStrategy 多腿辅助                                                                                                                                                            │
     │ │   │   │   ├── pairwise_arb.go        # PairwiseArbStrategy                                                                                                                                                               │
     │ │   │   │   ├── instrument.go          # Instrument 数据模型                                                                                                                                                               │
     │ │   │   │   ├── threshold_set.go       # ThresholdSet                                                                                                                                                                      │
     │ │   │   │   ├── order_map.go           # OrderMap / PriceOrderMap                                                                                                                                                          │
     │ │   │   │   ├── daily_init.go          # LoadMatrix2 / SaveMatrix2                                                                                                                                                         │
     │ │   │   │   └── types.go               # 枚举常量                                                                                                                                                                          │
     │ │   │   └── config/           # 配置加载                                                                                                                                                                                   │
     │ │   │       ├── config.go     #    YAML 配置                                                                                                                                                                               │
     │ │   │       ├── control.go    #    control file 解析                                                                                                                                                                       │
     │ │   │       └── model.go      #    model file / threshold 加载                                                                                                                                                             │
     │ │   ├── api/                  # REST API / WebSocket（后续添加）                                                                                                                                                           │
     │ │   │   └── server.go                                                                                                                                                                                                      │
     │ │   └── scripts/                                                                                                                                                                                                           │
     │ │       └── verify_offsets.sh # 编译运行 offset_check 对比 C++                                                                                                                                                             │
     │ ├── config/                   # 共享配置文件                                                                                                                                                                               │
     │ ├── deploy/                   # 共享部署目录                                                                                                                                                                               │
     │ └── bin/                      # 共享可执行文件输出                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ C++ → Go 文件对照表                                                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ 核心翻译（方法名严格对标）                                                                                                                                                                                                 │
     │ ┌──────────────────────────────────────────────────────┬───────┬────────────────────────────────────┬───────────────────────────────────────────────┐                                                                      │
     │ │                       C++ 文件                       │ 行数  │              Go 文件               │          C++ 类/函数 → Go 类型/方法           │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/main.cpp                                  │ 1,103 │ cmd/trader/main.go                 │ main() → main()                               │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/CommonClient.cpp                          │ 1,136 │ pkg/common/client.go               │ CommonClient → CommonClient                   │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/include/CommonClient.h                    │   131 │ pkg/common/client.go               │ 字段定义                                      │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Strategies/ExecutionStrategy.cpp               │ 2,506 │ pkg/strategy/execution_strategy.go │ ExecutionStrategy → ExecutionStrategy         │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Strategies/include/ExecutionStrategy.h         │   579 │ pkg/strategy/execution_strategy.go │ 字段 + 虚函数签名                             │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Strategies/PairwiseArbStrategy.cpp             │   947 │ pkg/strategy/pairwise_arb.go       │ PairwiseArbStrategy → PairwiseArbStrategy     │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Strategies/include/ExtraStrategy.h/.cpp        │  ~655 │ pkg/strategy/extra_strategy.go     │ ExtraStrategy → ExtraStrategy                 │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Strategies/include/ExecutionStrategyStructs.h  │   ~70 │ pkg/strategy/order_map.go          │ OrderMap → OrderMap                           │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/include/TradeBotUtils.h (ThresholdSet)    │  ~200 │ pkg/strategy/threshold_set.go      │ ThresholdSet → ThresholdSet                   │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/common/Instrument.h/.cpp (核心)                │  ~500 │ pkg/strategy/instrument.go         │ Instrument → Instrument                       │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ hftbase/Ipc/include/multiwritermultireadershmqueue.h │   256 │ pkg/shm/mwmr_queue.go              │ MultiWriterMultiReaderShmQueue → MWMRQueue[T] │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ hftbase/Ipc/include/locklessshmclientstore.h         │   ~90 │ pkg/shm/client_store.go            │ LocklessClientStore → ClientStore             │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ gateway/include/shm_queue.h (struct 定义)            │   ~35 │ pkg/shm/types.go                   │ MarketDataRaw → Go struct                     │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ gateway/include/ors_gateway.h                        │   ~74 │ pkg/shm/types.go                   │ OrderRequestRaw/ResponseRaw → Go struct       │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ hftbase/Connector/                                   │   N/A │ pkg/connector/connector.go         │ Connector → Connector（SHM 直连）             │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Indicators/include/Indicator.h                 │   ~96 │ pkg/indicator/indicator.go         │ Indicator → Indicator 接口                    │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Indicators/include/IndicatorBasket.h           │   ~50 │ pkg/indicator/basket.go            │ IndicatorBasket → IndicatorBasket             │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Indicators/SpreadRatio.cpp                     │  ~200 │ pkg/indicator/spread_ratio.go      │ SpreadRatio → SpreadRatio                     │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Indicators/BookImbalance.cpp                   │  ~100 │ pkg/indicator/book_imbalance.go    │ BookImbalance → BookImbalance                 │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/Indicators/DynamicBeta.cpp                     │  ~150 │ pkg/indicator/dynamic_beta.go      │ DynamicBeta → DynamicBeta                     │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/TradeBotUtils.cpp (GetIndicator)          │  ~200 │ pkg/indicator/factory.go           │ 指标工厂                                      │                                                                      │
     │ ├──────────────────────────────────────────────────────┼───────┼────────────────────────────────────┼───────────────────────────────────────────────┤                                                                      │
     │ │ tbsrc/main/TradeBotUtils.cpp (CalculateTargetPNL)    │  ~100 │ pkg/indicator/target_pnl.go        │ 线性模型                                      │                                                                      │
     │ └──────────────────────────────────────────────────────┴───────┴────────────────────────────────────┴───────────────────────────────────────────────┘                                                                      │
     │ 方法名对照（严格一致）                                                                                                                                                                                                     │
     │ ┌─────────────────────────────────────────────┬───────────────────────────────────────────────────┬────────────────────────┐                                                                                               │
     │ │                  C++ 方法                   │                      Go 方法                      │          所属          │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::SendINDUpdate()               │ (cc *CommonClient) SendINDUpdate()                │ common/client.go       │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::SendInfraMDUpdate()           │ (cc *CommonClient) SendInfraMDUpdate()            │ common/client.go       │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::SendInfraORSUpdate()          │ (cc *CommonClient) SendInfraORSUpdate()           │ common/client.go       │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::SendNewOrder()                │ (cc *CommonClient) SendNewOrder()                 │ common/client.go       │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::SendCancelOrder()             │ (cc *CommonClient) SendCancelOrder()              │ common/client.go       │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ CommonClient::HandleSignals()               │ (cc *CommonClient) HandleSignals()                │ common/signals.go      │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ Connector::StartAsync()                     │ (c *Connector) StartAsync()                       │ connector/connector.go │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ Connector::SendNewOrder()                   │ (c *Connector) SendNewOrder()                     │ connector/connector.go │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ Connector::SendCancelOrder()                │ (c *Connector) SendCancelOrder()                  │ connector/connector.go │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::MDCallBack()             │ (es *ExecutionStrategy) MDCallBack()              │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::ORSCallBack()            │ (es *ExecutionStrategy) ORSCallBack()             │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::SendOrder()              │ 接口方法 Strategy.SendOrder()                     │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::SetTargetValue()         │ (es *ExecutionStrategy) SetTargetValue()          │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::SetThresholds()          │ (es *ExecutionStrategy) SetThresholds()           │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::HandleSquareoff()        │ (es *ExecutionStrategy) HandleSquareoff()         │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::HandleSquareON()         │ (es *ExecutionStrategy) HandleSquareON()          │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::CalculatePNL()           │ (es *ExecutionStrategy) CalculatePNL()            │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::ProcessTrade()           │ (es *ExecutionStrategy) ProcessTrade()            │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::GetBidPrice()            │ (es *ExecutionStrategy) GetBidPrice()             │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ ExecutionStrategy::GetAskPrice()            │ (es *ExecutionStrategy) GetAskPrice()             │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::SendOrder()            │ (pas *PairwiseArbStrategy) SendOrder()            │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::SendAggressiveOrder()  │ (pas *PairwiseArbStrategy) SendAggressiveOrder()  │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::MDCallBack()           │ (pas *PairwiseArbStrategy) MDCallBack()           │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::ORSCallBack()          │ (pas *PairwiseArbStrategy) ORSCallBack()          │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::SetThresholds()        │ (pas *PairwiseArbStrategy) SetThresholds()        │ strategy/              │                                                                                               │
     │ ├─────────────────────────────────────────────┼───────────────────────────────────────────────────┼────────────────────────┤                                                                                               │
     │ │ PairwiseArbStrategy::CalcPendingNetposAgg() │ (pas *PairwiseArbStrategy) CalcPendingNetposAgg() │ strategy/              │                                                                                               │
     │ └─────────────────────────────────────────────┴───────────────────────────────────────────────────┴────────────────────────┘                                                                                               │
     │ ---                                                                                                                                                                                                                        │
     │ 回调架构翻译                                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ C++ 调用链 → Go 调用链（SHM 直连）                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ C++ (SHM 事件循环):                          Go (SHM 直连):                                                                                                                                                                │
     │ ─────────────────                            ──────────────────                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ Connector SHM poll                           Connector SHM poll（同样方式）                                                                                                                                                │
     │   │                                            │                                                                                                                                                                           │
     │   ▼                                            ▼                                                                                                                                                                           │
     │ CommonClient.SendInfraMDUpdate(update)       CommonClient.SendInfraMDUpdate(raw)                                                                                                                                           │
     │   │                                            │ (MarketDataRaw → Instrument 更新)                                                                                                                                         │
     │   ▼                                            ▼                                                                                                                                                                           │
     │ CommonClient.SendINDUpdate(update)           CommonClient.SendINDUpdate(raw)                                                                                                                                               │
     │   ├→ 更新 Instrument                          ├→ 更新 Instrument                                                                                                                                                           │
     │   ├→ 更新 Indicators                          ├→ 更新 Indicators（后续）                                                                                                                                                   │
     │   ├→ m_INDCallBack → SetTargetValue           ├→ INDCallBack → SetTargetValue                                                                                                                                              │
     │   │    → SendOrder() [被动挂单 leg1]           │    → SendOrder() [被动挂单 leg1]                                                                                                                                          │
     │   └→ m_MDCallBack → Strategy.MDCallBack       └→ MDCallBack → Strategy.MDCallBack                                                                                                                                          │
     │        [EWMA, 风控, 时间检查]                       [EWMA, 风控, 时间检查]                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ Connector SHM poll (ORS)                     Connector SHM poll (ORS)（同样方式）                                                                                                                                          │
     │   │                                            │                                                                                                                                                                           │
     │   ▼                                            ▼                                                                                                                                                                           │
     │ CommonClient.SendInfraORSUpdate(resp)        CommonClient.SendInfraORSUpdate(raw)                                                                                                                                          │
     │   │                                            │ (OrderResponseRaw → 更新)                                                                                                                                                 │
     │   ▼                                            ▼                                                                                                                                                                           │
     │ m_ORSCallBack → Strategy.ORSCallBack         ORSCallBack → Strategy.ORSCallBack                                                                                                                                            │
     │   ├→ 更新持仓/订单状态                          ├→ 更新持仓/订单状态                                                                                                                                                       │
     │   └→ SendAggressiveOrder() [直接发单]           └→ SendAggressiveOrder() [直接发单]                                                                                                                                        │
     │        via Connector.SendNewOrder() → SHM           via Connector.SendNewOrder() → SHM                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ 与 C++ 完全一致：Go 的 Connector 通过 SHM 轮询读取行情和订单回报，通过 SHM 写入发送订单请求。没有 NATS/gRPC 中间层。                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ Go 中不需要 Signal/GetSignals 机制                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ C++ 的 ExecutionStrategy::SendNewOrder() 直接调用 m_client->SendNewOrder() 发单。Go 翻译保持同样架构：                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ // C++: ExecutionStrategy::SendNewOrder() → m_client->SendNewOrder() → m_connector->SendNewOrder()                                                                                                                         │
     │ // Go:  同样的链路                                                                                                                                                                                                         │
     │ func (es *ExecutionStrategy) SendNewOrder(side TransactionType, price float64, qty int32, ...) uint32 {                                                                                                                    │
     │     return es.Client.SendNewOrder(es.StrategyID, es.Instru.Symbol, side, price, qty, ...)                                                                                                                                  │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // CommonClient.SendNewOrder → Connector.SendNewOrder → SHM Push(OrderRequestRaw)                                                                                                                                          │
     │ func (cc *CommonClient) SendNewOrder(strategyID int32, symbol string, ...) uint32 {                                                                                                                                        │
     │     return cc.Connector.SendNewOrder(req)                                                                                                                                                                                  │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ Phase 1: 项目初始化 + SHM 包 + Connector                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 1.1 创建项目骨架                                                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ mkdir -p /Users/user/PWorks/RD/quantlink-trade-system/tbsrc-golang/{cmd/{trader,offset_check},pkg/{shm,common,strategy,connector,config},api,scripts}                                                                      │
     │ cd /Users/user/PWorks/RD/quantlink-trade-system/tbsrc-golang                                                                                                                                                               │
     │ go mod init tbsrc-golang                                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 依赖仅需：gopkg.in/yaml.v3（配置加载），golang.org/x/sys（POSIX SHM syscall）                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ 1.2 SHM 包（核心 — 翻译 gateway/include/shm_queue.h）                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ 1.2.1 Go SHM 原始结构（严格对齐 C++）                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ C++ 源: gateway/include/shm_queue.h + gateway/include/ors_gateway.h                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/types.go                                                                                                                                                                                                        │
     │ // 所有结构体必须与 C++ 完全二进制兼容（无 #pragma pack，使用默认对齐）                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ // C++: struct MarketDataRaw (gateway/include/shm_queue.h:18-33)                                                                                                                                                           │
     │ // sizeof ≈ 304 bytes (需用 offset_check 工具验证)                                                                                                                                                                         │
     │ type MarketDataRaw struct {                                                                                                                                                                                                │
     │     Symbol     [16]byte    // char symbol[16]                                                                                                                                                                              │
     │     Exchange   [8]byte     // char exchange[8]                                                                                                                                                                             │
     │     Timestamp  uint64      // uint64_t timestamp (纳秒)                                                                                                                                                                    │
     │     BidPrice   [10]float64 // double bid_price[10]                                                                                                                                                                         │
     │     BidQty     [10]uint32  // uint32_t bid_qty[10]                                                                                                                                                                         │
     │     AskPrice   [10]float64 // double ask_price[10]                                                                                                                                                                         │
     │     AskQty     [10]uint32  // uint32_t ask_qty[10]                                                                                                                                                                         │
     │     LastPrice  float64     // double last_price                                                                                                                                                                            │
     │     LastQty    uint32      // uint32_t last_qty                                                                                                                                                                            │
     │     _pad0      [4]byte     // 4 bytes padding (align total_volume to 8)                                                                                                                                                    │
     │     TotalVolume uint64     // uint64_t total_volume                                                                                                                                                                        │
     │     SeqNum     uint64      // uint64_t seq_num                                                                                                                                                                             │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: struct OrderRequestRaw (gateway/include/ors_gateway.h:25-44)                                                                                                                                                       │
     │ type OrderRequestRaw struct {                                                                                                                                                                                              │
     │     StrategyID    [32]byte // char strategy_id[32]                                                                                                                                                                         │
     │     Symbol        [16]byte // char symbol[16]                                                                                                                                                                              │
     │     Exchange      [8]byte  // char exchange[8]                                                                                                                                                                             │
     │     Side          uint8    // uint8_t side (1=买, 2=卖)                                                                                                                                                                    │
     │     OrderType     uint8    // uint8_t order_type                                                                                                                                                                           │
     │     TimeInForce   uint8    // uint8_t time_in_force                                                                                                                                                                        │
     │     OpenClose     uint8    // uint8_t open_close                                                                                                                                                                           │
     │     _pad0         [4]byte  // 4 bytes padding (align price to 8)                                                                                                                                                           │
     │     Price         float64  // double price                                                                                                                                                                                 │
     │     Quantity      int64    // int64_t quantity                                                                                                                                                                             │
     │     ClientOrderID [32]byte // char client_order_id[32]                                                                                                                                                                     │
     │     Account       [16]byte // char account[16]                                                                                                                                                                             │
     │     ClientToken   uint64   // uint64_t client_token                                                                                                                                                                        │
     │     Timestamp     uint64   // uint64_t timestamp                                                                                                                                                                           │
     │     SeqNum        uint64   // uint64_t seq_num                                                                                                                                                                             │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: struct OrderResponseRaw (gateway/include/ors_gateway.h:47-74)                                                                                                                                                      │
     │ type OrderResponseRaw struct {                                                                                                                                                                                             │
     │     StrategyID    [32]byte  // char strategy_id[32]                                                                                                                                                                        │
     │     OrderID       [32]byte  // char order_id[32]                                                                                                                                                                           │
     │     ClientOrderID [32]byte  // char client_order_id[32]                                                                                                                                                                    │
     │     ClientToken   uint64    // uint64_t client_token                                                                                                                                                                       │
     │     Symbol        [16]byte  // char symbol[16]                                                                                                                                                                             │
     │     Exchange      [8]byte   // char exchange[8]                                                                                                                                                                            │
     │     Side          uint8     // uint8_t side                                                                                                                                                                                │
     │     Status        uint8     // uint8_t status                                                                                                                                                                              │
     │     ErrorCode     uint8     // uint8_t error_code                                                                                                                                                                          │
     │     _pad0         [5]byte   // 5 bytes padding (align price to 8)                                                                                                                                                          │
     │     Price         float64   // double price                                                                                                                                                                                │
     │     Quantity      int64     // int64_t quantity                                                                                                                                                                            │
     │     FilledQty     int64     // int64_t filled_qty                                                                                                                                                                          │
     │     AvgPrice      float64   // double avg_price                                                                                                                                                                            │
     │     LastFillPrice float64   // double last_fill_price                                                                                                                                                                      │
     │     LastFillQty   int64     // int64_t last_fill_qty                                                                                                                                                                       │
     │     ExecID        [32]byte  // char exec_id[32]                                                                                                                                                                            │
     │     ErrorMsg      [128]byte // char error_msg[128]                                                                                                                                                                         │
     │     ExchangeTimestamp uint64 // uint64_t exchange_timestamp                                                                                                                                                                │
     │     Timestamp     uint64    // uint64_t timestamp                                                                                                                                                                          │
     │     SeqNum        uint64    // uint64_t seq_num                                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 1.2.2 MWMRQueue 泛型实现（翻译 hftbase MWMR）                                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ C++ 源: hftbase/Ipc/include/multiwritermultireadershmqueue.h（256 行）                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ MWMR 是通用基础队列，单 producer/consumer 时退化为 SPSC 性能。新 gateway 的 SPSC 队列不翻译——直接用 MWMR 替代（功能超集）。                                                                                                │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/mwmr_queue.go                                                                                                                                                                                                   │
     │ // 翻译 C++: MultiWriterMultiReaderShmQueue<T>                                                                                                                                                                             │
     │ // 无锁 MPMC 队列，基于 atomic fetch_add + seqNo 机制                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ // SHM 内存布局（hftbase 格式）:                                                                                                                                                                                           │
     │ //                                                                                                                                                                                                                         │
     │ //   struct Header {                                                                                                                                                                                                       │
     │ //       atomic<int64_t> head;   // 写入位置（生产者 fetch_add）                                                                                                                                                           │
     │ //       atomic<int64_t> tail;   // 读取位置（消费者 fetch_add，仅多读者时使用）                                                                                                                                           │
     │ //       int64_t         size;   // 队列容量（2 的幂）                                                                                                                                                                     │
     │ //       int64_t         mask;   // size - 1（用于位运算取模）                                                                                                                                                             │
     │ //   };                                                                                                                                                                                                                    │
     │ //                                                                                                                                                                                                                         │
     │ //   struct Slot {                                                                                                                                                                                                         │
     │ //       atomic<int64_t> seqNo;  // 序列号（写完后设为 head 值，标记数据就绪）                                                                                                                                             │
     │ //       T               data;   // 实际数据                                                                                                                                                                               │
     │ //   };                                                                                                                                                                                                                    │
     │ //                                                                                                                                                                                                                         │
     │ //   [Header][Slot[0]][Slot[1]]...[Slot[size-1]]                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ type MWMRQueue[T any] struct {                                                                                                                                                                                             │
     │     base     unsafe.Pointer // mmap 基地址                                                                                                                                                                                 │
     │     elemSize uintptr        // sizeof(Slot) = 8 + sizeof(T)，对齐到 8                                                                                                                                                      │
     │     size     int64          // 队列容量                                                                                                                                                                                    │
     │     mask     int64          // size - 1                                                                                                                                                                                    │
     │     // 单读者优化：本地 tail（避免原子操作开销）                                                                                                                                                                           │
     │     localTail int64                                                                                                                                                                                                        │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // Enqueue — 多生产者安全                                                                                                                                                                                                  │
     │ // C++: int64_t myHead = header->head.fetch_add(1, memory_order_acq_rel);                                                                                                                                                  │
     │ //      slot->data = item; barrier; slot->seqNo = myHead;                                                                                                                                                                  │
     │ func (q *MWMRQueue[T]) Enqueue(item *T) bool {                                                                                                                                                                             │
     │     head := atomic.AddInt64((*int64)(q.headPtr()), 1) - 1  // fetch_add 语义                                                                                                                                               │
     │     slot := q.slotPtr(head & q.mask)                                                                                                                                                                                       │
     │     // 检查队列是否满（slot 的 seqNo 应该 < head - size，表示已被读走）                                                                                                                                                    │
     │     // 写入数据                                                                                                                                                                                                            │
     │     // 设置 seqNo = head（release 语义，通知消费者）                                                                                                                                                                       │
     │     return true                                                                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // Dequeue — 单消费者模式（用 localTail，无原子操作）                                                                                                                                                                      │
     │ // C++: if slot->seqNo < tail → empty; else read & advance tail                                                                                                                                                            │
     │ func (q *MWMRQueue[T]) Dequeue(item *T) bool {                                                                                                                                                                             │
     │     slot := q.slotPtr(q.localTail & q.mask)                                                                                                                                                                                │
     │     seqNo := atomic.LoadInt64((*int64)(slot))  // acquire 语义                                                                                                                                                             │
     │     if seqNo < q.localTail {                                                                                                                                                                                               │
     │         return false  // 队列空                                                                                                                                                                                            │
     │     }                                                                                                                                                                                                                      │
     │     // memcpy 数据到 item                                                                                                                                                                                                  │
     │     q.localTail++                                                                                                                                                                                                          │
     │     return true                                                                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // DequeueMulti — 多消费者模式（用 atomic fetch_add 竞争 tail）                                                                                                                                                            │
     │ // C++: dequeuePtrBlock — tail.fetch_add(1) + spin on seqNo                                                                                                                                                                │
     │ func (q *MWMRQueue[T]) DequeueMulti(item *T) bool {                                                                                                                                                                        │
     │     tail := atomic.AddInt64((*int64)(q.tailPtr()), 1) - 1                                                                                                                                                                  │
     │     slot := q.slotPtr(tail & q.mask)                                                                                                                                                                                       │
     │     // spin 等待 seqNo >= tail（生产者还没写完）                                                                                                                                                                           │
     │     for atomic.LoadInt64((*int64)(slot)) < tail {                                                                                                                                                                          │
     │         runtime.Gosched()                                                                                                                                                                                                  │
     │     }                                                                                                                                                                                                                      │
     │     // memcpy 数据到 item                                                                                                                                                                                                  │
     │     return true                                                                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ func (q *MWMRQueue[T]) IsEmpty() bool { ... }                                                                                                                                                                              │
     │ func (q *MWMRQueue[T]) Size() int64 { ... }                                                                                                                                                                                │
     │                                                                                                                                                                                                                            │
     │ 与新 gateway SPSC 的兼容性：新 gateway 的 SPSCQueue 内存布局不同（alignas(64) head/tail），tbsrc-golang 的 MWMR 不直接与新 gateway 通信。而是：                                                                            │
     │ - 行情：直接对接 md_simulator/ctp_md_gateway 写的 SHM（需确认 md_simulator 用的是 MWMR 还是 SPSC 布局）                                                                                                                    │
     │ - 订单：对接 counter_bridge 的 SHM（需要 counter_bridge 也升级为 MWMR，或保持 SPSC 仅单 trader 使用）                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ Phase 1 验证重点：先实现 MWMR 队列本身，用纯 Go 进程间测试（不依赖 C++ 组件），验证：                                                                                                                                      │
     │ 1. 单生产者单消费者（退化 SPSC）正确性                                                                                                                                                                                     │
     │ 2. 多生产者单消费者（MPSC）并发安全性                                                                                                                                                                                      │
     │ 3. 单生产者多消费者（SPMC）并发安全性                                                                                                                                                                                      │
     │ 4. 与 C++ hftbase MWMR 的二进制兼容性（通过 offset_check 验证内存布局）                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 1.2.3 ShmManager + ClientStore                                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/manager.go                                                                                                                                                                                                      │
     │ // POSIX SHM: shm_open → ftruncate → mmap                                                                                                                                                                                  │
     │ // 纯 Go syscall 实现（无 CGO），兼容 Linux/CentOS + macOS                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ func CreateMWMR[T any](name string, size int64) (*MWMRQueue[T], error) { ... }                                                                                                                                             │
     │ func OpenMWMR[T any](name string) (*MWMRQueue[T], error) { ... }                                                                                                                                                           │
     │ func CloseMWMR[T any](q *MWMRQueue[T]) error { ... }  // munmap                                                                                                                                                            │
     │ func Remove(name string) error { ... }                  // shm_unlink                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/client_store.go                                                                                                                                                                                                 │
     │ // 翻译 C++: LocklessClientStore — 原子计数器分配 clientId                                                                                                                                                                 │
     │ // C++ 源: hftbase/Ipc/include/locklessshmclientstore.h                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ type ClientStore struct {                                                                                                                                                                                                  │
     │     ptr unsafe.Pointer  // mmap 到 SHM                                                                                                                                                                                     │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: getClientIdAndIncrement() → data.fetch_add(1, memory_order_acq_rel)                                                                                                                                                │
     │ func (cs *ClientStore) GetClientID() int32 {                                                                                                                                                                               │
     │     return int32(atomic.AddInt64((*int64)(cs.ptr), 1)) - 1                                                                                                                                                                 │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // SHM 命名规则:                                                                                                                                                                                                           │
     │ //   行情队列:   /hft_md_{name}                                                                                                                                                                                            │
     │ //   订单请求:   /hft_{name}                                                                                                                                                                                               │
     │ //   订单回报:   /hft_{name}                                                                                                                                                                                               │
     │ //   客户端存储: /hft_clientstore_{key}                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 1.2.4 Struct Offset 验证工具                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ // cmd/offset_check/main.go                                                                                                                                                                                                │
     │ // 打印每个 Go struct 的 unsafe.Offsetof + unsafe.Sizeof                                                                                                                                                                   │
     │ // 对比 C++ offsetof() 输出确保二进制兼容                                                                                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │ func main() {                                                                                                                                                                                                              │
     │     var md MarketDataRaw                                                                                                                                                                                                   │
     │     fmt.Printf("MarketDataRaw sizeof=%d\n", unsafe.Sizeof(md))                                                                                                                                                             │
     │     fmt.Printf("  symbol     offset=%d\n", unsafe.Offsetof(md.Symbol))                                                                                                                                                     │
     │     fmt.Printf("  exchange   offset=%d\n", unsafe.Offsetof(md.Exchange))                                                                                                                                                   │
     │     fmt.Printf("  timestamp  offset=%d\n", unsafe.Offsetof(md.Timestamp))                                                                                                                                                  │
     │     // ... 所有字段                                                                                                                                                                                                        │
     │     // 同样打印 OrderRequestRaw, OrderResponseRaw                                                                                                                                                                          │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 同时提供 C++ 小程序验证：                                                                                                                                                                                                  │
     │ // 在 gateway/ 中添加临时 offset_check.cpp                                                                                                                                                                                 │
     │ #include "shm_queue.h"                                                                                                                                                                                                     │
     │ #include "ors_gateway.h"                                                                                                                                                                                                   │
     │ int main() {                                                                                                                                                                                                               │
     │     printf("MarketDataRaw sizeof=%zu\n", sizeof(MarketDataRaw));                                                                                                                                                           │
     │     printf("  symbol     offset=%zu\n", offsetof(MarketDataRaw, symbol));                                                                                                                                                  │
     │     // ...                                                                                                                                                                                                                 │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 1.3 Connector（忠实翻译 hftbase/Connector — 共享 MWMR 队列）                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ 与 C++ 完全一致：一组共享 MWMR 队列，所有交易所共用，多 trader 进程安全。                                                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │ C++ 架构:                                                                                                                                                                                                                  │
     │   N traders ──→ [1 个共享 MWMR Request Queue (key 3872)] ──→ 1 个 ORS/counter_bridge                                                                                                                                       │
     │            ←── [1 个共享 MWMR Response Queue (key 4872)] ←──     ├→ CTP plugin                                                                                                                                             │
     │                                                                    └→ XTP plugin                                                                                                                                           │
     │   N traders ←── [1 个共享 MWMR MD Queue (key 872)] ←── MD feeder                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ Go 翻译（完全对齐）:                                                                                                                                                                                                       │
     │   N go_traders ──→ [1 个共享 MWMR /hft_ors_request] ──→ 1 个 counter_bridge                                                                                                                                                │
     │                ←── [1 个共享 MWMR /hft_ors_response] ←──   ├→ CTP plugin                                                                                                                                                   │
     │                                                               └→ XTP plugin                                                                                                                                                │
     │   N go_traders ←── [1 个共享 MWMR /hft_md_queue] ←── md_simulator/ctp_md_gateway                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ // pkg/connector/connector.go                                                                                                                                                                                              │
     │ // 忠实翻译 C++: hftbase/Connector/include/connector.h                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ type MDCallback func(raw *shm.MarketDataRaw)                                                                                                                                                                               │
     │ type ORSCallback func(raw *shm.OrderResponseRaw)                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ type Connector struct {                                                                                                                                                                                                    │
     │     // C++: MdShmQ *m_mdQueue[MAX_EXCHANGE_COUNT] — 实际共用同一个 SHM                                                                                                                                                     │
     │     mdQueue   *shm.MWMRQueue[shm.MarketDataRaw]                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │     // C++: ReqShmQ *m_requestQueue[MAX_EXCHANGE_COUNT] — 实际共用同一个 SHM                                                                                                                                               │
     │     reqQueue  *shm.MWMRQueue[shm.OrderRequestRaw]                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │     // C++: RespShmQ *m_responseQueue                                                                                                                                                                                      │
     │     respQueue *shm.MWMRQueue[shm.OrderResponseRaw]                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │     // C++: int m_clientId[MAX_EXCHANGE_COUNT]                                                                                                                                                                             │
     │     ClientID  int32  // 由 ClientStore 原子分配                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │     // C++: uint32_t m_OrderCount                                                                                                                                                                                          │
     │     OrderCount uint32                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     mdCallback  MDCallback                                                                                                                                                                                                 │
     │     orsCallback ORSCallback                                                                                                                                                                                                │
     │     running     atomic.Bool                                                                                                                                                                                                │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: Connector::GetUniqueOrderNumber(exchCode)                                                                                                                                                                          │
     │ // OrderID = clientId * 1,000,000 + sequence                                                                                                                                                                               │
     │ const OrderIDRange = 1_000_000                                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ func (c *Connector) GetUniqueOrderNumber() uint32 {                                                                                                                                                                        │
     │     c.OrderCount++                                                                                                                                                                                                         │
     │     return uint32(c.ClientID)*OrderIDRange + c.OrderCount                                                                                                                                                                  │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: Connector::StartAsync() — 启动 SHM 轮询线程                                                                                                                                                                        │
     │ func (c *Connector) StartAsync() {                                                                                                                                                                                         │
     │     go c.pollMDQueue()   // 行情轮询                                                                                                                                                                                       │
     │     go c.pollORSQueue()  // 订单回报轮询                                                                                                                                                                                   │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // 行情轮询（MWMR Dequeue）                                                                                                                                                                                                │
     │ func (c *Connector) pollMDQueue() {                                                                                                                                                                                        │
     │     var raw shm.MarketDataRaw                                                                                                                                                                                              │
     │     for c.running.Load() {                                                                                                                                                                                                 │
     │         if c.mdQueue.Dequeue(&raw) {                                                                                                                                                                                       │
     │             c.mdCallback(&raw)                                                                                                                                                                                             │
     │         } else {                                                                                                                                                                                                           │
     │             runtime.Gosched()                                                                                                                                                                                              │
     │         }                                                                                                                                                                                                                  │
     │     }                                                                                                                                                                                                                      │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // 订单回报轮询（MWMR Dequeue）                                                                                                                                                                                            │
     │ // C++: HandleOrderResponse — 按 clientId 过滤自己的回报                                                                                                                                                                   │
     │ func (c *Connector) pollORSQueue() {                                                                                                                                                                                       │
     │     var raw shm.OrderResponseRaw                                                                                                                                                                                           │
     │     for c.running.Load() {                                                                                                                                                                                                 │
     │         if c.respQueue.Dequeue(&raw) {                                                                                                                                                                                     │
     │             // C++: clientId = OrderID / ORDERID_RANGE — 只处理自己的回报                                                                                                                                                  │
     │             // 多 trader 进程时每个 trader 从同一个 MWMR 队列读，按 clientId 过滤                                                                                                                                          │
     │             c.orsCallback(&raw)                                                                                                                                                                                            │
     │         } else {                                                                                                                                                                                                           │
     │             runtime.Gosched()                                                                                                                                                                                              │
     │         }                                                                                                                                                                                                                  │
     │     }                                                                                                                                                                                                                      │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: Connector::PushRequest(RequestMsg) — MWMR Enqueue（多 trader 安全）                                                                                                                                                │
     │ func (c *Connector) SendNewOrder(req *shm.OrderRequestRaw) bool {                                                                                                                                                          │
     │     return c.reqQueue.Enqueue(req)                                                                                                                                                                                         │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ func (c *Connector) SendCancelOrder(req *shm.OrderRequestRaw) bool {                                                                                                                                                       │
     │     return c.reqQueue.Enqueue(req)                                                                                                                                                                                         │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 1.3.1 counter_bridge 改动（SPSC → MWMR）                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 文件: gateway/src/counter_bridge.cpp、新增 gateway/include/mwmr_queue.h                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 当前 counter_bridge 使用新 gateway 的 SPSC 队列，需要改为 MWMR 以与 Go trader 二进制兼容并支持多 trader。                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │ 改动 1：引入 MWMR 队列头文件                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ 从 hftbase 移植 MultiWriterMultiReaderShmQueue 到 gateway/include/mwmr_queue.h（~300 行）。                                                                                                                                │
     │ C++ 源: hftbase/Ipc/include/multiwritermultireadershmqueue.h                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ 改动 2：counter_bridge.cpp 替换队列类型                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ // 原代码（第 35-36 行）：                                                                                                                                                                                                 │
     │ using OrderReqQueue = hft::shm::SPSCQueue<hft::ors::OrderRequestRaw, 4096>;                                                                                                                                                │
     │ using OrderRespQueue = hft::shm::SPSCQueue<hft::ors::OrderResponseRaw, 4096>;                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ // 改为：                                                                                                                                                                                                                  │
     │ using OrderReqQueue = hft::shm::MWMRQueue<hft::ors::OrderRequestRaw>;                                                                                                                                                      │
     │ using OrderRespQueue = hft::shm::MWMRQueue<hft::ors::OrderResponseRaw>;                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 队列名保持 "ors_request" / "ors_response" 不变，与 C++ 原系统一致。                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ 改动 3：md_simulator + ctp_md_gateway 也改为 MWMR                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 行情队列同样从 SPSC 改为 MWMR，队列名保持 "queue" 不变。                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 改动总量：                                                                                                                                                                                                                 │
     │ - 新文件 gateway/include/mwmr_queue.h（从 hftbase 移植，~300 行）                                                                                                                                                          │
     │ - counter_bridge.cpp 修改（~30 行，替换队列类型 + 创建方式）                                                                                                                                                               │
     │ - md_simulator.cpp 修改（~20 行）                                                                                                                                                                                          │
     │ - ctp_md_gateway.cpp 修改（~20 行）                                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ 1.3.2 配置文件（trader YAML，与 C++ 对齐）                                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ # 与 C++ config 对齐：一组共享队列                                                                                                                                                                                         │
     │ shm:                                                                                                                                                                                                                       │
     │   md_queue: "queue"              # → /hft_md_queue                                                                                                                                                                         │
     │   ors_request_queue: "ors_request"  # → /hft_ors_request                                                                                                                                                                   │
     │   ors_response_queue: "ors_response" # → /hft_ors_response                                                                                                                                                                 │
     │   client_store: "clientstore"    # → /hft_clientstore（ClientID 分配）                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ 1.4 CentOS 兼容性                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ POSIX SHM 系统调用实现（纯 Go，无 CGO）:                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/shm_linux.go  — Linux/CentOS 专用                                                                                                                                                                               │
     │ func shmOpen(name string, oflag int, mode uint32) (int, error) {                                                                                                                                                           │
     │     // 方式1: 直接 open /dev/shm/{name}（最简单，CentOS 7+ 均支持）                                                                                                                                                        │
     │     path := "/dev/shm" + name  // name 已含前缀 "/"                                                                                                                                                                        │
     │     return syscall.Open(path, oflag, mode)                                                                                                                                                                                 │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ func shmUnlink(name string) error {                                                                                                                                                                                        │
     │     path := "/dev/shm" + name                                                                                                                                                                                              │
     │     return syscall.Unlink(path)                                                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // pkg/shm/shm_darwin.go — macOS 开发环境                                                                                                                                                                                  │
     │ func shmOpen(name string, oflag int, mode uint32) (int, error) {                                                                                                                                                           │
     │     // macOS: 使用 syscall.SYS_SHM_OPEN 或 golang.org/x/sys/unix.ShmOpen                                                                                                                                                   │
     │     nameBytes := append([]byte(name), 0)                                                                                                                                                                                   │
     │     fd, _, errno := syscall.Syscall(syscall.SYS_SHM_OPEN,                                                                                                                                                                  │
     │         uintptr(unsafe.Pointer(&nameBytes[0])),                                                                                                                                                                            │
     │         uintptr(oflag), uintptr(mode))                                                                                                                                                                                     │
     │     if errno != 0 { return -1, errno }                                                                                                                                                                                     │
     │     return int(fd), nil                                                                                                                                                                                                    │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 平台分离:                                                                                                                                                                                                                  │
     │ - shm_linux.go (//go:build linux): 通过 /dev/shm/ 文件系统访问                                                                                                                                                             │
     │ - shm_darwin.go (//go:build darwin): 通过 SYS_SHM_OPEN syscall                                                                                                                                                             │
     │ - 共用 mmap/munmap via syscall.Mmap/syscall.Munmap（两平台 API 一致）                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ 交叉编译:                                                                                                                                                                                                                  │
     │ # macOS 上编译 Linux 版本（部署到 CentOS）                                                                                                                                                                                 │
     │ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/trader_linux cmd/trader/main.go                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ CentOS 部署检查:                                                                                                                                                                                                           │
     │ - /dev/shm 目录存在（CentOS 7+ 默认挂载 tmpfs）                                                                                                                                                                            │
     │ - kernel.shmmax 足够大（默认值通常足够）                                                                                                                                                                                   │
     │ - SELinux 不影响 POSIX SHM（通过文件系统访问）                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ 验证                                                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ cd /Users/user/PWorks/RD/quantlink-trade-system/tbsrc-golang                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ # 1. 编译 SHM 包                                                                                                                                                                                                           │
     │ go build ./pkg/shm/...                                                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ # 2. Struct offset 验证（Go vs C++）                                                                                                                                                                                       │
     │ go run cmd/offset_check/main.go > /tmp/go_offsets.txt                                                                                                                                                                      │
     │ cd ../gateway/build && ./offset_check > /tmp/cpp_offsets.txt                                                                                                                                                               │
     │ diff /tmp/go_offsets.txt /tmp/cpp_offsets.txt                                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ # 3. MWMR 队列单元测试                                                                                                                                                                                                     │
     │ go test ./pkg/shm/... -v -run TestMWMR                                                                                                                                                                                     │
     │ #   测试用例：                                                                                                                                                                                                             │
     │ #   - TestMWMR_SingleProducerSingleConsumer   （退化 SPSC）                                                                                                                                                                │
     │ #   - TestMWMR_MultiProducerSingleConsumer    （MPSC，多 goroutine 并发写）                                                                                                                                                │
     │ #   - TestMWMR_SingleProducerMultiConsumer    （SPMC，多 goroutine 并发读）                                                                                                                                                │
     │ #   - TestMWMR_Ordering                       （验证 seqNo 保序）                                                                                                                                                          │
     │ #   - TestMWMR_QueueFull                      （队列满时 Enqueue 返回 false）                                                                                                                                              │
     │ #   - TestMWMR_CrossProcess                   （fork 子进程测试真正的多进程 SHM）                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ # 4. MWMR 与 hftbase C++ 二进制兼容测试（可选，需编译 hftbase 测试程序）                                                                                                                                                   │
     │ #   Go writer → C++ reader / C++ writer → Go reader                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ # 5. ClientStore 测试                                                                                                                                                                                                      │
     │ go test ./pkg/shm/... -v -run TestClientStore                                                                                                                                                                              │
     │ #   - TestClientStore_AtomicIncrement                                                                                                                                                                                      │
     │ #   - TestClientStore_MultiProcess                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ # 6. Connector 编译                                                                                                                                                                                                        │
     │ go build ./pkg/connector/...                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ Phase 2: CommonClient + ExecutionStrategy 基类                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ 2.1 CommonClient（翻译 CommonClient.cpp）                                                                                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/main/CommonClient.cpp（1,136 行）+ CommonClient.h                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ // pkg/common/client.go                                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ // C++: typedef void (*MDcb)(MarketUpdateNew *);                                                                                                                                                                           │
     │ // Go: 使用 SHM raw 类型，由 CommonClient 负责转换                                                                                                                                                                         │
     │ type MDCallback func(raw *shm.MarketDataRaw)                                                                                                                                                                               │
     │ type ORSCallback func(raw *shm.OrderResponseRaw)                                                                                                                                                                           │
     │ type INDCallback func(symbol string)                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ type CommonClient struct {                                                                                                                                                                                                 │
     │     // C++: Connector *m_connector                                                                                                                                                                                         │
     │     Connector *connector.Connector                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │     // C++: MDcb m_MDCallBack, ORScb m_ORSCallBack, INDcb m_INDCallBack                                                                                                                                                    │
     │     mdCallBack  MDCallback                                                                                                                                                                                                 │
     │     orsCallBack ORSCallback                                                                                                                                                                                                │
     │     indCallBack INDCallback                                                                                                                                                                                                │
     │                                                                                                                                                                                                                            │
     │     // C++: SimConfig *m_simConfig                                                                                                                                                                                         │
     │     SimConfig    *config.SimConfig                                                                                                                                                                                         │
     │     ConfigParams *config.ConfigParams                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // C++: bool m_isActive                                                                                                                                                                                                │
     │     IsActive bool                                                                                                                                                                                                          │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::Initialize(MDcb, ORScb, INDcb, ...)                                                                                                                                                                  │
     │ func (cc *CommonClient) Initialize(mdcb MDCallback, orscb ORSCallback, indcb INDCallback, ...) {                                                                                                                           │
     │     cc.mdCallBack = mdcb                                                                                                                                                                                                   │
     │     cc.orsCallBack = orscb                                                                                                                                                                                                 │
     │     cc.indCallBack = indcb                                                                                                                                                                                                 │
     │     cc.IsActive = true                                                                                                                                                                                                     │
     │     // 注册到 Connector 的回调                                                                                                                                                                                             │
     │     cc.Connector.SetMDCallback(func(raw *shm.MarketDataRaw) { cc.SendInfraMDUpdate(raw) })                                                                                                                                 │
     │     cc.Connector.SetORSCallback(func(raw *shm.OrderResponseRaw) { cc.SendInfraORSUpdate(raw) })                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::SendInfraMDUpdate(MarketUpdateNew *update)                                                                                                                                                           │
     │ func (cc *CommonClient) SendInfraMDUpdate(raw *shm.MarketDataRaw) {                                                                                                                                                        │
     │     cc.SendINDUpdate(raw)                                                                                                                                                                                                  │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::SendINDUpdate(MarketUpdateNew *update) — 370 行核心分发                                                                                                                                              │
     │ func (cc *CommonClient) SendINDUpdate(raw *shm.MarketDataRaw) {                                                                                                                                                            │
     │     symbol := shm.CStr(raw.Symbol[:])                                                                                                                                                                                      │
     │     // 1. 更新 Instrument（bid/ask/last price）— 从 raw 字段直接拷贝                                                                                                                                                       │
     │     // 2. 更新 Indicators（后续添加）                                                                                                                                                                                      │
     │     // 3. 调用 indCallBack → SetTargetValue → SendOrder（被动挂单）                                                                                                                                                        │
     │     cc.indCallBack(symbol)                                                                                                                                                                                                 │
     │     // 4. 调用 mdCallBack → Strategy.MDCallBack（EWMA、风控）                                                                                                                                                              │
     │     cc.mdCallBack(raw)                                                                                                                                                                                                     │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::SendInfraORSUpdate(ResponseMsg *response)                                                                                                                                                            │
     │ func (cc *CommonClient) SendInfraORSUpdate(raw *shm.OrderResponseRaw) {                                                                                                                                                    │
     │     cc.orsCallBack(raw)                                                                                                                                                                                                    │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::SendNewOrder(...) → m_connector->SendNewOrder()                                                                                                                                                      │
     │ func (cc *CommonClient) SendNewOrder(req *shm.OrderRequestRaw) bool {                                                                                                                                                      │
     │     return cc.Connector.SendNewOrder(req)                                                                                                                                                                                  │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // C++: CommonClient::SendCancelOrder(...)                                                                                                                                                                                 │
     │ func (cc *CommonClient) SendCancelOrder(req *shm.OrderRequestRaw) bool {                                                                                                                                                   │
     │     return cc.Connector.SendCancelOrder(req)                                                                                                                                                                               │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 2.2 信号处理（翻译 HandleSignals + Squareoff）                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ // pkg/common/signals.go                                                                                                                                                                                                   │
     │ // C++: CommonClient::HandleSignals(SquareOff sqoff)                                                                                                                                                                       │
     │ // C++: SIGTSTP=全部平仓, SIGUSR1=重新激活, SIGUSR2=重载阈值                                                                                                                                                               │
     │ func (cc *CommonClient) HandleSignals(sqoff func(sig os.Signal)) {                                                                                                                                                         │
     │     sigChan := make(chan os.Signal, 1)                                                                                                                                                                                     │
     │     signal.Notify(sigChan, syscall.SIGTSTP, syscall.SIGUSR1, syscall.SIGUSR2, syscall.SIGTERM)                                                                                                                             │
     │     for sig := range sigChan {                                                                                                                                                                                             │
     │         sqoff(sig)                                                                                                                                                                                                         │
     │     }                                                                                                                                                                                                                      │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 2.3 ExecutionStrategy 基类                                                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ C++ 源: ExecutionStrategy.h（579 行）+ ExecutionStrategy.cpp（2,506 行）                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ // pkg/strategy/execution_strategy.go                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │ // Strategy 接口 — 对标 C++ 虚函数                                                                                                                                                                                         │
     │ type Strategy interface {                                                                                                                                                                                                  │
     │     MDCallBack(raw *shm.MarketDataRaw)                                                                                                                                                                                     │
     │     ORSCallBack(raw *shm.OrderResponseRaw)                                                                                                                                                                                 │
     │     SendOrder()                           // C++: pure virtual                                                                                                                                                             │
     │     SetTargetValue(currPrice, targetPrice float64, targetBidPNL, targetAskPNL float64)                                                                                                                                     │
     │     SetThresholds()                                                                                                                                                                                                        │
     │     HandleSquareoff()                                                                                                                                                                                                      │
     │     HandleSquareON()                                                                                                                                                                                                       │
     │     CheckSquareoff()                                                                                                                                                                                                       │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ type ExecutionStrategy struct {                                                                                                                                                                                            │
     │     // C++: CommonClient *m_client                                                                                                                                                                                         │
     │     Client *common.CommonClient                                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │     // C++: int32_t m_strategyID                                                                                                                                                                                           │
     │     StrategyID int32                                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │     // C++: Instrument *m_instru                                                                                                                                                                                           │
     │     Instru *Instrument                                                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │     // 持仓 — C++: int m_netpos, m_netpos_pass, m_netpos_pass_ytd, m_netpos_agg                                                                                                                                            │
     │     NetPos        int32                                                                                                                                                                                                    │
     │     NetPosPass    int32                                                                                                                                                                                                    │
     │     NetPosPassYtd int32                                                                                                                                                                                                    │
     │     NetPosAgg     int32                                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │     // PNL — C++: double m_realisedPNL, m_unrealisedPNL, m_netPNL                                                                                                                                                          │
     │     RealPNL   float64                                                                                                                                                                                                      │
     │     UnrealPNL float64                                                                                                                                                                                                      │
     │     NetPNL    float64                                                                                                                                                                                                      │
     │     GrossPNL  float64                                                                                                                                                                                                      │
     │     MaxPNL    float64                                                                                                                                                                                                      │
     │     Drawdown  float64                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 状态 — C++: bool m_onFlat, m_Active, m_onExit, callSquareOff                                                                                                                                                        │
     │     OnFlat        bool                                                                                                                                                                                                     │
     │     Active        bool                                                                                                                                                                                                     │
     │     OnExit        bool                                                                                                                                                                                                     │
     │     CallSquareOff bool                                                                                                                                                                                                     │
     │     AggFlat       bool                                                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │     // 订单 — C++: OrderMap m_ordMap, m_bidMap, m_askMap                                                                                                                                                                   │
     │     OrdMap *OrderMap                                                                                                                                                                                                       │
     │     BidMap *PriceOrderMap                                                                                                                                                                                                  │
     │     AskMap *PriceOrderMap                                                                                                                                                                                                  │
     │                                                                                                                                                                                                                            │
     │     // 阈值                                                                                                                                                                                                                │
     │     Thold *ThresholdSet                                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │     // 计数器                                                                                                                                                                                                              │
     │     TradeCount  int32                                                                                                                                                                                                      │
     │     OrderCount  int32                                                                                                                                                                                                      │
     │     CancelCount int32                                                                                                                                                                                                      │
     │     RejectCount int32                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 子类 SendOrder 委托                                                                                                                                                                                                 │
     │     sendOrderFunc func()                                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │     // ... 其余 ~100 个 C++ 字段按需翻译                                                                                                                                                                                   │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // 核心方法（逐行翻译 C++）                                                                                                                                                                                                │
     │ func (es *ExecutionStrategy) CalculatePNL() { ... }          // 含 priceMultiplier                                                                                                                                         │
     │ func (es *ExecutionStrategy) ProcessTrade(raw *shm.OrderResponseRaw) { ... }                                                                                                                                               │
     │ func (es *ExecutionStrategy) ProcessCancelConfirm(raw *shm.OrderResponseRaw) { ... }                                                                                                                                       │
     │ func (es *ExecutionStrategy) SendNewOrder(side TransactionType, price float64, qty int32, hitType OrderHitType) uint32 { ... }                                                                                             │
     │ func (es *ExecutionStrategy) SendCancelOrder(orderID uint32) bool { ... }                                                                                                                                                  │
     │ func (es *ExecutionStrategy) GetBidPrice(price float64, level int) float64 { ... }                                                                                                                                         │
     │ func (es *ExecutionStrategy) GetAskPrice(price float64, level int) float64 { ... }                                                                                                                                         │
     │ func (es *ExecutionStrategy) SetThresholds() { ... }                                                                                                                                                                       │
     │ func (es *ExecutionStrategy) SetLinearThresholds() { ... }                                                                                                                                                                 │
     │ func (es *ExecutionStrategy) SetTargetValue(currPrice, targetPrice float64, bidPNL, askPNL float64) {                                                                                                                      │
     │     if !es.OnFlat && es.Active {                                                                                                                                                                                           │
     │         es.sendOrderFunc()  // 调用子类的 SendOrder()                                                                                                                                                                      │
     │     }                                                                                                                                                                                                                      │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 2.4 ExtraStrategy + ThresholdSet + Instrument + OrderMap + Types                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ 按 C++ 结构体逐字段翻译，详见 Phase 1 文件映射表。                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ 验证                                                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ go build ./pkg/strategy/...                                                                                                                                                                                                │
     │ go build ./pkg/common/...                                                                                                                                                                                                  │
     │ go test ./pkg/strategy/... -v                                                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ Phase 3: PairwiseArbStrategy 翻译                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/Strategies/PairwiseArbStrategy.cpp（947 行）                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ 3.1 结构体                                                                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ // pkg/strategy/pairwise_arb.go                                                                                                                                                                                            │
     │ type PairwiseArbStrategy struct {                                                                                                                                                                                          │
     │     *ExecutionStrategy                                                                                                                                                                                                     │
     │     FirstStrat  *ExtraStrategy  // leg1 被动                                                                                                                                                                               │
     │     SecondStrat *ExtraStrategy  // leg2 主动                                                                                                                                                                               │
     │     AvgSpreadRatioOri float64   // C++: avgSpreadRatio_ori                                                                                                                                                                 │
     │     AvgSpreadRatio    float64   // C++: avgSpreadRatio                                                                                                                                                                     │
     │     CurrSpreadRatio   float64   // C++: currSpreadRatio                                                                                                                                                                    │
     │     TValue            float64   // C++: tValue                                                                                                                                                                             │
     │     TholdFirst  *ThresholdSet                                                                                                                                                                                              │
     │     TholdSecond *ThresholdSet                                                                                                                                                                                              │
     │     AggRepeat   int32           // C++: m_agg_repeat                                                                                                                                                                       │
     │     MaxLossLimit float64        // C++: m_maxloss_limit                                                                                                                                                                    │
     │     OrdMap1 *OrderMap           // leg1 被动单                                                                                                                                                                             │
     │     OrdMap2 *OrderMap           // leg2 主动单                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │     // 动态阈值（由 SetThresholds 计算）                                                                                                                                                                                   │
     │     tholdBidPlace  float64                                                                                                                                                                                                 │
     │     tholdAskPlace  float64                                                                                                                                                                                                 │
     │     tholdBidRemove float64                                                                                                                                                                                                 │
     │     tholdAskRemove float64                                                                                                                                                                                                 │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 3.2-3.7 核心方法                                                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ 与原计划一致（MDCallBack、SendOrder、ORSCallBack、SendAggressiveOrder、SetThresholds、daily_init），唯一区别是回调参数类型从 protobuf 改为 SHM raw struct：                                                                │
     │                                                                                                                                                                                                                            │
     │ - MDCallBack(raw *shm.MarketDataRaw) 而非 MDCallBack(md *mdpb.MarketDataUpdate)                                                                                                                                            │
     │ - ORSCallBack(raw *shm.OrderResponseRaw) 而非 ORSCallBack(update *orspb.OrderUpdate)                                                                                                                                       │
     │ - SendNewOrder 构造 shm.OrderRequestRaw 并 Push 到 SHM                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ 验证                                                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ go build ./pkg/strategy/...                                                                                                                                                                                                │
     │ go test ./pkg/strategy/... -v                                                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ Phase 4: main.go + 配置 + 端到端                                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ 4.1 main.go（翻译 main.cpp）                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ // cmd/trader/main.go                                                                                                                                                                                                      │
     │ func main() {                                                                                                                                                                                                              │
     │     // 1. 加载配置（C++: LoadControlFile + LoadModelFile）                                                                                                                                                                 │
     │     cfg := config.LoadConfig(os.Args)                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 2. 创建 Connector（SHM 直连）                                                                                                                                                                                       │
     │     conn := connector.NewConnector(cfg.MDQueueName, cfg.ORSReqQueue, cfg.ORSRespQueue)                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │     // 3. 创建 CommonClient                                                                                                                                                                                                │
     │     client := common.NewCommonClient(conn, cfg)                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │     // 4. 策略工厂（C++: if-else chain on m_execStrat）                                                                                                                                                                    │
     │     var strat strategy.Strategy                                                                                                                                                                                            │
     │     switch cfg.StrategyType {                                                                                                                                                                                              │
     │     case "TB_PAIR_STRAT":                                                                                                                                                                                                  │
     │         strat = strategy.NewPairwiseArbStrategy(client, cfg)                                                                                                                                                               │
     │     }                                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 5. 注册回调                                                                                                                                                                                                         │
     │     client.Initialize(                                                                                                                                                                                                     │
     │         func(raw *shm.MarketDataRaw) { strat.MDCallBack(raw) },                                                                                                                                                            │
     │         func(raw *shm.OrderResponseRaw) { strat.ORSCallBack(raw) },                                                                                                                                                        │
     │         func(symbol string) { /* SetTargetValue → SendOrder */ },                                                                                                                                                          │
     │     )                                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 6. 启动 SHM 轮询                                                                                                                                                                                                    │
     │     conn.StartAsync()                                                                                                                                                                                                      │
     │                                                                                                                                                                                                                            │
     │     // 7. 信号处理                                                                                                                                                                                                         │
     │     client.HandleSignals(func(sig os.Signal) {                                                                                                                                                                             │
     │         switch sig {                                                                                                                                                                                                       │
     │         case syscall.SIGTSTP, syscall.SIGTERM:                                                                                                                                                                             │
     │             strat.HandleSquareoff()                                                                                                                                                                                        │
     │         case syscall.SIGUSR1:                                                                                                                                                                                              │
     │             strat.HandleSquareON()                                                                                                                                                                                         │
     │         case syscall.SIGUSR2:                                                                                                                                                                                              │
     │             config.ReloadThresholds(cfg, strat)                                                                                                                                                                            │
     │         }                                                                                                                                                                                                                  │
     │     })                                                                                                                                                                                                                     │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 4.2 配置参数（C++ 风格命名）                                                                                                                                                                                               │
     │ ┌───────────────────┬───────────────────┬───────────────────────────────────────────┐                                                                                                                                      │
     │ │     配置字段      │     C++ 原名      │                   说明                    │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ md_queue          │ N/A               │ SHM 行情队列名（默认 "queue"）            │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ ors_req_queue     │ N/A               │ SHM 订单请求队列名（默认 "ors_request"）  │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ ors_resp_queue    │ N/A               │ SHM 订单回报队列名（默认 "ors_response"） │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ begin_place       │ BEGIN_PLACE       │ 开始挂单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ long_place        │ LONG_PLACE        │ 做多挂单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ short_place       │ SHORT_PLACE       │ 做空挂单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ begin_remove      │ BEGIN_REMOVE      │ 开始撤单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ long_remove       │ LONG_REMOVE       │ 做多撤单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ short_remove      │ SHORT_REMOVE      │ 做空撤单阈值                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ alpha             │ ALPHA             │ EWMA 衰减因子                             │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ avg_spread_away   │ AVG_SPREAD_AWAY   │ 价差异常保护                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ max_quote_level   │ MAX_QUOTE_LEVEL   │ 最大挂单层数                              │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ supporting_orders │ SUPPORTING_ORDERS │ 每方向最大挂单数                          │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ size              │ SIZE              │ 每单数量                                  │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ max_size          │ MAXSIZE           │ 最大持仓                                  │                                                                                                                                      │
     │ ├───────────────────┼───────────────────┼───────────────────────────────────────────┤                                                                                                                                      │
     │ │ slop              │ SLOP              │ 第3次追单跳价                             │                                                                                                                                      │
     │ └───────────────────┴───────────────────┴───────────────────────────────────────────┘                                                                                                                                      │
     │ 4.3 端到端测试                                                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ # 1. 编译                                                                                                                                                                                                                  │
     │ cd /Users/user/PWorks/RD/quantlink-trade-system/tbsrc-golang                                                                                                                                                               │
     │ go build -o ../../bin/trader_v2 cmd/trader/main.go                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ # 2. 启动 3 进程链路（不需要 nats-server、md_gateway、ors_gateway）                                                                                                                                                        │
     │ cd /Users/user/PWorks/RD/quantlink-trade-system/deploy                                                                                                                                                                     │
     │ ./bin/md_simulator 1000 &       # 生产者：写 SHM hft_md_queue                                                                                                                                                              │
     │ ./bin/counter_bridge &           # 消费者：读 SHM hft_ors_request，写 hft_ors_response                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ # 3. 启动新 Go trader（直接读写 SHM）                                                                                                                                                                                      │
     │ ./bin/trader_v2 -config config/trader.live.yaml                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ # 4. 验证要点：                                                                                                                                                                                                            │
     │ #    ✓ SHM 行情读取正常（无丢包）                                                                                                                                                                                          │
     │ #    ✓ EWMA avgSpreadRatio 更新正确                                                                                                                                                                                        │
     │ #    ✓ leg1 被动挂单在正确价差触发                                                                                                                                                                                         │
     │ #    ✓ leg2 主动对冲在 ORSCallBack 后立即发出（不延迟）                                                                                                                                                                    │
     │ #    ✓ 撤单功能（CROSS 清理 + 价差偏离撤单 + 撤远挂近）                                                                                                                                                                    │
     │ #    ✓ 动态阈值线性插值正确                                                                                                                                                                                                │
     │ #    ✓ daily_init 文件兼容                                                                                                                                                                                                 │
     │ #    ✓ SIGTSTP 平仓 / SIGUSR1 激活 / SIGUSR2 重载                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 4.4 CentOS 部署验证                                                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ # macOS 交叉编译                                                                                                                                                                                                           │
     │ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/trader_v2_linux cmd/trader/main.go                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ # 部署到 CentOS 服务器                                                                                                                                                                                                     │
     │ scp bin/trader_v2_linux user@centos-server:/opt/quantlink/bin/trader_v2                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ # 在 CentOS 上验证                                                                                                                                                                                                         │
     │ ssh user@centos-server                                                                                                                                                                                                     │
     │ ls -la /dev/shm/                  # 确认 tmpfs 挂载                                                                                                                                                                        │
     │ ./bin/trader_v2 -config config/trader.live.yaml                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ 4.5 REST API / 监控（后续）                                                                                                                                                                                                │
     │                                                                                                                                                                                                                            │
     │ 端到端验证通过后，添加 REST API（port 9201）和 WebSocket dashboard。此时可引入 NATS 作为可选的监控数据分发通道（不在交易关键路径上）。                                                                                     │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ Phase 5: Indicator 框架翻译（为后续策略做准备）                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ 背景：C++ tbsrc/Indicators/ 下有 100+ 个指标类，通过 CalculateTargetPNL() 线性模型为非套利策略提供 targetPrice。PairwiseArbStrategy 不依赖此框架（它自己算 EWMA                                                            │
     │ spread），但其他策略类型（AggressiveStrategyInd、UniformStrategy、MultipleInstrumentStrategy 等）需要。                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 5.1 项目结构扩展                                                                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ tbsrc-golang/pkg/                                                                                                                                                                                                          │
     │ ├── indicator/                     # ★ 新增                                                                                                                                                                                │
     │ │   ├── indicator.go               # Indicator 基类接口                                                                                                                                                                    │
     │ │   ├── basket.go                  # IndicatorBasket 加权聚合器                                                                                                                                                            │
     │ │   ├── spread_ratio.go            # SpreadRatio（EWA/SMA/时间衰减）                                                                                                                                                       │
     │ │   ├── book_imbalance.go          # BookImbalance / BookImbalanceLots                                                                                                                                                     │
     │ │   ├── book_delta.go              # BookDelta / BookDeltaEvent                                                                                                                                                            │
     │ │   ├── dynamic_beta.go            # DynamicBeta                                                                                                                                                                           │
     │ │   ├── static_beta.go             # StaticBeta                                                                                                                                                                            │
     │ │   ├── vwap.go                    # VWAP                                                                                                                                                                                  │
     │ │   ├── momentum.go                # PxMomentum / ExpMomentum                                                                                                                                                              │
     │ │   ├── bollinger.go               # Bollinger / BollingerMkt                                                                                                                                                              │
     │ │   ├── trade_volume.go            # TradeVolume / AvgTradeSize                                                                                                                                                            │
     │ │   ├── factory.go                 # GetIndicator() 工厂函数                                                                                                                                                               │
     │ │   └── target_pnl.go              # CalculateTargetPNL 线性模型                                                                                                                                                           │
     │                                                                                                                                                                                                                            │
     │ 5.2 Indicator 基类接口                                                                                                                                                                                                     │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/Indicators/include/Indicator.h                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ // pkg/indicator/indicator.go                                                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ type Indicator interface {                                                                                                                                                                                                 │
     │     QuoteUpdate(instru *strategy.Instrument)  // C++: virtual void QuoteUpdate(Tick *t)                                                                                                                                    │
     │     TickUpdate(instru *strategy.Instrument)   // C++: virtual void TickUpdate(Tick *t)                                                                                                                                     │
     │     Reset()                                   // C++: virtual void Reset()                                                                                                                                                 │
     │     Value() (float64, bool)                   // C++: virtual double Value(bool &status)                                                                                                                                   │
     │     Description() string                                                                                                                                                                                                   │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ // BaseIndicator 提供共用字段（C++: Indicator 成员变量）                                                                                                                                                                   │
     │ type BaseIndicator struct {                                                                                                                                                                                                │
     │     Val       float64  // C++: double value                                                                                                                                                                                │
     │     LastVal   float64  // C++: double last_value                                                                                                                                                                           │
     │     DiffVal   float64  // C++: double diff_value                                                                                                                                                                           │
     │     IsValid   bool     // C++: bool isValid                                                                                                                                                                                │
     │     IsDep     bool     // C++: bool isDep                                                                                                                                                                                  │
     │     Desc      string   // C++: string description                                                                                                                                                                          │
     │     Instru    *strategy.Instrument                                                                                                                                                                                         │
     │     Coeff     float64  // C++: double m_coefficient（模型系数）                                                                                                                                                            │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 5.3 IndicatorBasket（加权聚合）                                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/Indicators/include/IndicatorBasket.h                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ // pkg/indicator/basket.go                                                                                                                                                                                                 │
     │ // C++: IndicatorBasket 继承 Indicator，持有多个子指标，Value() 返回加权和                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ type IndicatorBasket struct {                                                                                                                                                                                              │
     │     BaseIndicator                                                                                                                                                                                                          │
     │     Indicators []Indicator                                                                                                                                                                                                 │
     │     Weights    []float64                                                                                                                                                                                                   │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 5.4 常用指标（优先翻译）                                                                                                                                                                                                   │
     │                                                                                                                                                                                                                            │
     │ 按使用频率排序，优先翻译以下 ~15 个：                                                                                                                                                                                      │
     │ ┌────────┬───────────────┬───────────────────┬──────────────────────────┐                                                                                                                                                  │
     │ │ 优先级 │   C++ 指标    │      Go 文件      │           说明           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P0     │ SpreadRatio   │ spread_ratio.go   │ 价差比率（EWA/SMA 模式） │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P0     │ BookImbalance │ book_imbalance.go │ 订单簿买卖失衡           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P0     │ BookDelta     │ book_delta.go     │ 订单簿深度变化           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P0     │ DynamicBeta   │ dynamic_beta.go   │ 动态 Beta 系数           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ VWAP          │ vwap.go           │ 成交量加权均价           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ PxMomentum    │ momentum.go       │ 价格动量                 │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ Bollinger     │ bollinger.go      │ 布林带                   │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ TradeVolume   │ trade_volume.go   │ 成交量统计               │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ AvgTradeSize  │ trade_volume.go   │ 平均成交量               │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P1     │ OrderBookSkew │ book_imbalance.go │ 订单簿偏斜               │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P2     │ StaticBeta    │ static_beta.go    │ 静态 Beta                │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P2     │ ForceIndex    │ trade_volume.go   │ 成交力度                 │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P2     │ CMF           │ trade_volume.go   │ Chaikin 资金流           │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P2     │ Simple_Trend  │ momentum.go       │ 趋势检测                 │                                                                                                                                                  │
     │ ├────────┼───────────────┼───────────────────┼──────────────────────────┤                                                                                                                                                  │
     │ │ P2     │ ExpMomentum   │ momentum.go       │ 指数动量                 │                                                                                                                                                  │
     │ └────────┴───────────────┴───────────────────┴──────────────────────────┘                                                                                                                                                  │
     │ 其余指标（期权相关、多腿篮子等）按需翻译。                                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ 5.5 CalculateTargetPNL（线性模型）                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/main/TradeBotUtils.cpp:3788+                                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ // pkg/indicator/target_pnl.go                                                                                                                                                                                             │
     │ // C++: CalculateTargetPNL() — 遍历 indicatorList，加权求和得到 targetPrice                                                                                                                                                │
     │                                                                                                                                                                                                                            │
     │ func CalculateTargetPNL(indicators []Indicator) (targetPrice float64, targetBidPNL float64, targetAskPNL float64) {                                                                                                        │
     │     for _, ind := range indicators {                                                                                                                                                                                       │
     │         val, valid := ind.Value()                                                                                                                                                                                          │
     │         if !valid { continue }                                                                                                                                                                                             │
     │         targetPrice += val * ind.(*BaseIndicator).Coeff                                                                                                                                                                    │
     │     }                                                                                                                                                                                                                      │
     │     // ... bidPNL/askPNL 计算                                                                                                                                                                                              │
     │     return                                                                                                                                                                                                                 │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 5.6 集成到 CommonClient                                                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ // 更新 pkg/common/client.go 的 SendINDUpdate：                                                                                                                                                                            │
     │                                                                                                                                                                                                                            │
     │ func (cc *CommonClient) SendINDUpdate(raw *shm.MarketDataRaw) {                                                                                                                                                            │
     │     symbol := shm.CStr(raw.Symbol[:])                                                                                                                                                                                      │
     │     // 1. 更新 Instrument                                                                                                                                                                                                  │
     │     // 2. ★ 更新 Indicators（Phase 5 新增）                                                                                                                                                                                │
     │     for _, ind := range cc.IndicatorList {                                                                                                                                                                                 │
     │         ind.QuoteUpdate(instru)  // 或 TickUpdate                                                                                                                                                                          │
     │     }                                                                                                                                                                                                                      │
     │     // 3. 调用 indCallBack → SetTargetValue → SendOrder                                                                                                                                                                    │
     │     cc.indCallBack(symbol)                                                                                                                                                                                                 │
     │     // 4. 调用 mdCallBack → Strategy.MDCallBack                                                                                                                                                                            │
     │     cc.mdCallBack(raw)                                                                                                                                                                                                     │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 5.7 指标工厂                                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ C++ 源: tbsrc/main/TradeBotUtils.cpp:504+ (GetIndicator())                                                                                                                                                                 │
     │                                                                                                                                                                                                                            │
     │ // pkg/indicator/factory.go                                                                                                                                                                                                │
     │ // C++: GetIndicator(string name, ...) — 根据名称创建指标实例                                                                                                                                                              │
     │                                                                                                                                                                                                                            │
     │ func GetIndicator(name string, instru *strategy.Instrument, params map[string]interface{}) (Indicator, error) {                                                                                                            │
     │     switch name {                                                                                                                                                                                                          │
     │     case "SpreadRatio":       return NewSpreadRatio(instru, params), nil                                                                                                                                                   │
     │     case "BookImbalance":     return NewBookImbalance(instru, params), nil                                                                                                                                                 │
     │     case "DynamicBeta":       return NewDynamicBeta(instru, params), nil                                                                                                                                                   │
     │     // ...                                                                                                                                                                                                                 │
     │     default:                  return nil, fmt.Errorf("unknown indicator: %s", name)                                                                                                                                        │
     │     }                                                                                                                                                                                                                      │
     │ }                                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ 验证                                                                                                                                                                                                                       │
     │                                                                                                                                                                                                                            │
     │ go build ./pkg/indicator/...                                                                                                                                                                                               │
     │ go test ./pkg/indicator/... -v                                                                                                                                                                                             │
     │                                                                                                                                                                                                                            │
     │ # 单指标验证：用 C++ 输出的指标值序列对比 Go 计算结果                                                                                                                                                                      │
     │ go test -run TestSpreadRatio_MatchCpp ./pkg/indicator/... -v                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ ---                                                                                                                                                                                                                        │
     │ 需要修改的 C++ 代码                                                                                                                                                                                                        │
     │                                                                                                                                                                                                                            │
     │ - gateway/include/mwmr_queue.h — 新增，从 hftbase 移植 MWMR 队列（~300 行）                                                                                                                                                │
     │ - gateway/src/counter_bridge.cpp — 队列类型 SPSC→MWMR + -r/-s 参数                                                                                                                                                         │
     │ - gateway/src/md_simulator.cpp — 队列类型 SPSC→MWMR                                                                                                                                                                        │
     │ - gateway/src/ctp_md_gateway.cpp — 队列类型 SPSC→MWMR                                                                                                                                                                      │
     │ - gateway/src/md_gateway.cpp — 可选，保持 NATS 路径兼容                                                                                                                                                                    │
     │                                                                                                                                                                                                                            │
     │ 不修改的内容                                                                                                                                                                                                               │
     │                                                                                                                                                                                                                            │
     │ - quantlink-trade-system/gateway/ 其余文件（include/shm_queue.h 保留，SPSC 可供其他用途）                                                                                                                                  │
     │ - quantlink-trade-system/golang/ — 旧代码保留不动，验证后再删除                                                                                                                                                            │
     │ - config/ — 共享配置目录                                                                                                                                                                                                   │
     │ - deploy/ — 共享部署目录                                                                                                                                                                                                   │
     │ - daily_init.* 文件格式 — 保持兼容                                                                                                                                                                                         │
     │                                                                                                                                                                                                                            │
     │ 删除/不需要的内容                                                                                                                                                                                                          │
     │                                                                                                                                                                                                                            │
     │ - ~~protobuf 生成~~ — SHM 直连不需要 protobuf（REST API 阶段再考虑）                                                                                                                                                       │
     │ - ~~NATS 依赖~~ — 交易关键路径不使用                                                                                                                                                                                       │
     │ - ~~gRPC 依赖~~ — 交易关键路径不使用                                                                                                                                                                                       │
     │ - ~~md_gateway 进程~~ — Go trader 直接读 SHM                                                                                                                                                                               │
     │ - ~~ors_gateway 进程~~ — Go trader 直接写 SHM                                                                                                                                                                              │
     ╰────────────────────────────────────────────────────────────