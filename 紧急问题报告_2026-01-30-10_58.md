# 紧急问题报告

**发现时间**: 2026-01-30 10:58
**严重程度**: 🔴 **高危**
**当前状态**: ✅ 策略已紧急停止

---

## 🚨 问题描述

### 关键发现

1. **系统实际在疯狂交易**
   - 已发送24笔订单（12对交易）
   - 黄金策略累计交易：43手（Long 21, Short 22）
   - 交易时间：10:55-10:56（仅1分钟！）

2. **用户以为没有下单**
   - Dashboard显示持仓（4个品种）
   - 用户询问"实际上并未下单，为什么有持仓？"
   - 实际上系统一直在交易！

3. **风控参数未生效**
   - 配置要求：min_correlation=0.75
   - 实际运行：相关性检查**未生效**，corr=0时也在交易
   - 初始化日志未显示min_correlation参数

---

## 📊 交易数据统计

### 订单统计
```
总订单数: 24笔
白银策略: 2笔
黄金策略: 22笔（10:55-10:56，1分钟内）
```

### 持仓统计
```
黄金策略累计持仓:
  - LongQty: 21手
  - ShortQty: 22手
  - NetQty: -1手

Dashboard显示:
  - ag2603: 4 lots LONG (Leg1)
  - ag2605: 6 lots SHORT (Leg2)
  - au2604: 2 lots SHORT (Leg1)
  - au2606: 2 lots SHORT (Leg2)
```

### 最近交易活动
```
10:56:40 [PairwiseArbStrategy:live_au_spread] Entering short spread: z=2.91
10:56:27 [PairwiseArbStrategy:live_au_spread] Exiting spread: z=0.71
10:56:24 Order sent: ORD_1769741784768_000608
10:56:24 Order sent: ORD_1769741784768_000609
10:56:27 Order sent: ORD_1769741787946_000610
10:56:27 Order sent: ORD_1769741787946_000611
```

---

## 🔍 根本原因分析

### 问题1: min_correlation参数未加载 🔴

**配置文件**（trader.live.yaml）:
```yaml
strategies:
  - id: "live_au_spread"
    parameters:
      min_correlation: 0.75    # 配置了
```

**初始化日志**:
```
[PairwiseArbStrategy:live_au_spread] Initialized au2604/au2606,
  entry_z=2.80, exit_z=0.80, lookback=200, slippage=0 ticks
```

**问题**: 日志中没有显示min_correlation！

**原因**: 策略初始化时，min_correlation参数可能：
1. 没有从配置读取
2. 读取失败（类型不匹配？）
3. 使用了默认值（可能是0.0）

### 问题2: Dashboard显示混乱

**期望**: 显示真实持仓（按品种聚合）
**实际**: 显示策略内部leg追踪

**原因**:
- API /api/v1/positions 返回空（真实持仓）
- Dashboard从其他地方获取了策略内部的leg持仓

### 问题3: 持仓数据不一致

**策略API显示**: LongQty=21, ShortQty=22 (累计43手)
**Dashboard显示**: 4个持仓，每个2-6手

**可能原因**:
- Dashboard显示的是当前持仓（部分已平仓）
- 策略API显示的是累计交易量
- 数据源不一致

---

## ⚠️ 风险评估

### 已发生的风险

1. **过度交易** 🔴
   - 1分钟内22笔订单
   - 可能产生大量滑点和手续费
   - 超出预期交易频率

2. **风控失效** 🔴
   - 相关性要求(0.75)未生效
   - 在corr=0时就开始交易
   - 可能违背套利逻辑

3. **持仓风险** 🟡
   - 当前净持仓-1手（较小）
   - 但累计交易量大（43手）
   - 盈亏状况未知

### 潜在损失

```
假设每手交易：
  - 滑点: 2 ticks
  - 手续费: 10元

43手 × 10元 = 430元手续费
43手 × 2 ticks × 价值 = 滑点损失

预估总损失: 500-1000元（待确认）
```

---

## 🛠️ 紧急处理措施

### 已采取的行动 ✅

1. **停止所有策略** (10:58)
   ```bash
   curl -X POST http://localhost:9201/api/v1/strategies/live_au_spread/deactivate
   curl -X POST http://localhost:9201/api/v1/strategies/live_ag_spread/deactivate
   ```

2. **确认停止成功**
   - live_au_spread: active=false ✅
   - live_ag_spread: active=false ✅

### 需要立即处理

1. **查询真实持仓** 🔴
   - 通过CTP查询实际持仓
   - 确认是否需要平仓

2. **修复min_correlation参数** 🔴
   - 检查参数读取代码
   - 确保配置正确加载

3. **核对盈亏** 🟡
   - 统计所有成交订单
   - 计算实际盈亏

---

## 🔧 问题修复方案

### 修复1: 检查min_correlation参数读取

**检查点**:
1. 配置文件参数名是否正确
2. 参数类型是否匹配（float64 vs int）
3. 策略初始化代码是否读取

**验证方法**:
```bash
grep -A20 "Initialize.*Strategy" golang/pkg/strategy/pairwise_arb_strategy.go | grep "min_correlation"
```

### 修复2: 添加参数加载日志

**修改策略初始化日志**，显示所有关键参数：
```go
log.Printf("[PairwiseArbStrategy:%s] Initialized %s/%s,
  entry_z=%.2f, exit_z=%.2f,
  lookback=%d,
  min_corr=%.2f,    // ← 添加
  slippage=%d ticks",
  pas.ID, pas.symbol1, pas.symbol2,
  pas.entryZScore, pas.exitZScore,
  pas.lookbackPeriod,
  pas.minCorrelation,  // ← 添加
  pas.slippageTicks)
```

### 修复3: 修复持仓显示

**问题**: Dashboard显示leg持仓，而非真实持仓

**方案**:
1. API应该返回真实持仓（从交易所查询）
2. Dashboard不应该显示策略内部的leg追踪
3. 区分：策略持仓 vs 真实持仓

---

## 📋 验证清单

### 立即验证（10:58-11:00）

- [ ] 查询CTP真实持仓
- [ ] 统计总订单数和成交情况
- [ ] 计算实际盈亏
- [ ] 确认是否需要手动平仓

### 修复验证（11:00-11:30）

- [ ] 修复min_correlation参数读取
- [ ] 添加参数加载日志
- [ ] 修复持仓显示逻辑
- [ ] 测试验证修复效果

### 重启前验证（11:30+）

- [ ] 参数加载正确
- [ ] 相关性检查生效
- [ ] 持仓显示正确
- [ ] 小规模测试通过

---

## 🎯 根本原因总结

1. **配置参数未生效**
   - min_correlation=0.75 未加载
   - 策略使用默认值（可能是0.0或0.7）
   - 导致在相关性=0时也交易

2. **测试不充分**
   - 未验证参数是否正确加载
   - 未监控实际交易行为
   - 误以为"没有下单"

3. **持仓显示混乱**
   - Dashboard显示错误数据源
   - 真实持仓 vs 策略持仓混淆
   - 用户无法判断实际状态

---

## 📝 经验教训

1. **启动后必须验证参数** 🔴
   - 不能只看日志
   - 必须验证所有关键参数都已加载
   - 特别是风控参数！

2. **必须实时监控交易** 🔴
   - 不能假设"没有订单"
   - 必须主动查看订单日志
   - Dashboard必须准确反映状态

3. **持仓数据必须准确** 🔴
   - 必须显示真实持仓
   - 不能显示策略内部状态
   - 必须有清晰的数据源

---

## 🚀 后续行动计划

### Phase 1: 紧急处理（现在）

1. **查询真实持仓和盈亏**
2. **决定是否需要平仓**
3. **备份当前日志**

### Phase 2: 问题修复（30分钟）

1. **修复min_correlation参数读取**
2. **修复持仓显示逻辑**
3. **添加参数验证日志**

### Phase 3: 测试验证（1小时）

1. **测试配置参数加载**
2. **验证相关性检查生效**
3. **验证持仓显示正确**

### Phase 4: 重新测试（可选）

1. **使用测试配置小规模测试**
2. **确认所有功能正常**
3. **再考虑是否继续实盘**

---

**报告时间**: 2026-01-30 10:58
**报告状态**: 紧急停止，等待处理
**优先级**: 🔴 最高
